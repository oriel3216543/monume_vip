<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SalaryPro - Professional Calculator</title>
    <link rel="icon" href="/static/favicon.JPG" type="image/jpeg">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <!-- Shared sidebar loader for consistent UI -->
    <script src="/static/sidebar-loader.js"></script>
    <!-- Content adapted from test tt/templates/salary-calculator.html to fit MonuMe structure -->
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap');
        * { margin: 0; padding: 0; box-sizing: border-box; }
        :root {
            --primary:#f5a069;
            --primary-dark:#e8944d;
            --secondary:#2c3e50;
            --success:#27ae60;
            --danger:#e74c3c;
            --gray-100:#f8f9fa;
            --gray-200:#e9ecef;
            --gray-300:#dee2e6;
            --gray-500:#adb5bd;
            --white:#ffffff;
            --shadow:0 10px 30px rgba(0,0,0,.10);
            --shadow-hover:0 18px 40px rgba(0,0,0,.16);
            --glass-bg: rgba(255,255,255,0.88);
            --glass-border: 1px solid rgba(255,255,255,0.6);
        }
        body { font-family:'Inter',system-ui,-apple-system,BlinkMacSystemFont,sans-serif; background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1500"><rect fill="%23ff9562" width="2000" height="1500"/><defs><radialGradient id="a" gradientUnits="objectBoundingBox"><stop offset="0" stop-color="%23ffffff"/><stop offset="1" stop-color="%23ff9562"/></radialGradient><linearGradient id="b" gradientUnits="userSpaceOnUse" x1="0" y1="750" x2="1550" y2="750"><stop offset="0" stop-color="%23ffcab1"/><stop offset="1" stop-color="%23ff9562"/></linearGradient></defs><path fill="url(%23a)" d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z"/><path d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z" fill="url(%23b)"/></svg>') no-repeat center center fixed; background-size: cover; color:#2c3e50; min-height:100vh; }
        .container{max-width:1200px;margin:0 auto;padding:20px}
        .header{background:var(--glass-bg);border-radius:20px;padding:40px;text-align:center;margin-bottom:30px;box-shadow:var(--shadow);border:var(--glass-border);backdrop-filter:blur(10px)}
        .header h1{font-size:2.8rem;font-weight:700;color:var(--primary);margin-bottom:10px}
        .card{background:var(--glass-bg);border-radius:18px;padding:28px;margin-bottom:25px;box-shadow:var(--shadow);border:var(--glass-border);transition:transform .25s ease, box-shadow .25s ease, border-color .25s ease;backdrop-filter:blur(10px)}
        .card:hover{transform:translateY(-3px);box-shadow:var(--shadow-hover);border-color:rgba(255,255,255,0.75)}
        .card-title{font-size:1.25rem;font-weight:700;color:#d96f2d;margin-bottom:20px;display:flex;align-items:center;gap:10px;border-bottom:1px solid rgba(255,255,255,0.6);padding-bottom:10px}
        .user-selection{display:grid;grid-template-columns:1fr auto auto;gap:15px;align-items:center;margin-bottom:20px}
        .form-select,.form-input{background:rgba(255,255,255,0.95);border:1px solid rgba(0,0,0,0.08);border-radius:12px;padding:12px 16px;font-size:1rem;transition:all .2s ease;width:100%}
        .form-select:focus,.form-input:focus{outline:none;border-color:rgba(245,160,105,.8);box-shadow:0 0 0 4px rgba(245,160,105,.15)}
        .btn{background:linear-gradient(135deg,#ff9c6a 0%,#ff7f42 100%);color:#fff;border:1px solid rgba(255,255,255,0.5);border-radius:12px;padding:12px 20px;font-size:1rem;font-weight:700;cursor:pointer;transition:all .2s ease;display:inline-flex;align-items:center;gap:8px;text-decoration:none;box-shadow:0 6px 18px rgba(255,127,66,.25)}
        .btn:hover{transform:translateY(-2px);box-shadow:0 10px 26px rgba(255,127,66,.35)}
        .btn.secondary{background:linear-gradient(135deg,#334155 0%,#1f2937 100%);border:1px solid rgba(255,255,255,0.35)}
        .btn.success{background:linear-gradient(135deg,#34d399 0%,#10b981 100%);border:1px solid rgba(255,255,255,0.35)}
        .upload-section{display:grid;grid-template-columns:1fr 1fr;gap:25px;margin-bottom:25px}
        .upload-area{background:rgba(255,255,255,0.85);border:1px dashed rgba(0,0,0,0.15);border-radius:16px;padding:40px 20px;text-align:center;transition:all .25s ease;cursor:pointer;backdrop-filter:blur(6px)}
        .upload-area:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover);border-color:rgba(245,160,105,.6);background:rgba(255,255,255,0.95)}
        .file-input{display:none}
        .upload-icon{font-size:2rem;margin-bottom:8px}
        .upload-text{font-weight:700;color:#d96f2d}
        .upload-hint{font-size:.9rem;color:#64748b}
        .stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:20px;margin:20px 0}
        .stat-card{background:var(--glass-bg);border:var(--glass-border);border-radius:16px;padding:20px;text-align:center;backdrop-filter:blur(8px);box-shadow:var(--shadow)}
        .stat-icon{font-size:1.25rem;margin-bottom:6px}
        .stat-value{font-size:1.4rem;font-weight:800;color:#1f2937}
        .stat-label{font-size:.9rem;color:#6b7280}
        .table-container{background:rgba(255,255,255,0.9);border-radius:12px;border:1px solid rgba(0,0,0,0.08);overflow:hidden;margin-bottom:20px;backdrop-filter:blur(6px)}
        .table{width:100%;border-collapse:collapse}
        .table th{background:linear-gradient(135deg,#ff9c6a 0%,#ff7f42 100%);color:#fff;padding:15px 12px;text-align:center;font-weight:700}
        .table td{padding:12px;text-align:center;border-bottom:1px solid rgba(0,0,0,0.06);background:rgba(255,255,255,0.95)}
        .table tbody tr:hover{background:rgba(255,149,98,0.06)}
        .editable-cell{cursor:pointer}
        .message{padding:15px 20px;border-radius:12px;margin:15px 0;font-weight:600;border-left:4px solid}
        .message.success{background:rgba(16,185,129,.12);border-color:#10b981;color:#065f46}
        .message.error{background:rgba(239,68,68,.12);border-color:#ef4444;color:#7f1d1d}
        .message.info{background:rgba(59,130,246,.12);border-color:#3b82f6;color:#1e3a8a}
        .message.warning{background:rgba(245,158,11,.12);border-color:#f59e0b;color:#7c2d12}

        /* Mode selection cards */
        .mode-option{background:var(--glass-bg);border:var(--glass-border);border-radius:16px;padding:18px;cursor:pointer;transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease}
        .mode-option:hover{transform:translateY(-2px);box-shadow:var(--shadow-hover)}
        .mode-option.active{border-color:#ff9c6a;box-shadow:0 10px 26px rgba(255,127,66,.25)}
        .mode-icon{font-size:1.6rem}
        .mode-title{font-weight:800;color:#1f2937}
        .mode-description{font-size:.9rem;color:#6b7280}
        .mode-status{font-size:.85rem;color:#065f46}

        /* Two-column layout on large screens */
        .grid-2{display:grid;grid-template-columns:1fr;gap:24px}
        @media(min-width:1000px){.grid-2{grid-template-columns:1fr 1fr}}

        .action-buttons{gap:12px}
        .hidden{display:none !important}
        @media(max-width:768px){.user-selection{grid-template-columns:1fr}.upload-section{grid-template-columns:1fr}}
    </style>
</head>
<body>
    <main class="main-content">
        <div class="container">
        <div class="header">
            <h1>üíº SalaryPro</h1>
            <p>Professional Salary Calculator & Analytics Platform</p>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">üë§</span>Employee Selection</div>
            <div class="user-selection">
                 <select id="userSelect" class="form-select" required>
                     <option value="">Choose an employee to continue...</option>
                 </select>
                 <div style="display:flex;gap:10px;align-items:center;flex-wrap:wrap;justify-content:flex-end">
                    <button class="btn secondary" id="calcModeBtn" onclick="toggleCalcMode()">Mode: Hourly</button>
                    <div id="inlineHourly" style="display:none;align-items:center;gap:10px;">
                    <label style="font-weight:600;color:#2c3e50;font-size:1rem;">üí∞ Base Hourly Pay:</label>
                    <input type="number" id="baseHourlyPay" class="form-input" placeholder="18.00" value="18.00" step="0.01" min="0" style="width:120px;">
                    <span style="color:#2c3e50;font-weight:500;">$/hour</span>
                </div>
                    <a href="/salary/history" class="btn">üìä History</a>
                 </div>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">üìÅ</span>Data Import Center</div>
            <div class="upload-section">
                <div class="upload-area" onclick="document.getElementById('noveFile').click()">
                    <div class="upload-icon">üìä</div>
                    <div class="upload-text">Nove Sheet</div>
                    <div class="upload-hint">Sales & Revenue Data</div>
                    <input type="file" id="noveFile" class="file-input" accept=".xlsx,.xls,.csv">
                </div>
                <div class="upload-area" onclick="document.getElementById('connecteamFile').click()">
                    <div class="upload-icon">‚è∞</div>
                    <div class="upload-text">Connecteam Sheet</div>
                    <div class="upload-hint">Time & Hours Data</div>
                    <input type="file" id="connecteamFile" class="file-input" accept=".xlsx,.xls,.csv">
                </div>
            </div>
            <div class="stats-grid" id="fileStats">
                <div class="stat-card"><div class="stat-icon">üìÑ</div><div class="stat-value" id="noveRows">0</div><div class="stat-label">Nove Records</div></div>
                <div class="stat-card"><div class="stat-icon">üïí</div><div class="stat-value" id="connecteamRows">0</div><div class="stat-label">Time Records</div></div>
            </div>
        </div>

        <div class="card">
            <div class="card-title"><span class="icon">‚öôÔ∏è</span>Data Processing</div>
            <div style="text-align:center;display:flex;gap:10px;justify-content:center;flex-wrap:wrap">
                <button id="processBtn" class="btn success" disabled onclick="processAndCombineData()">üîÑ Process & Combine Data</button>
            </div>
        </div>

        <div class="card hidden" id="combinedDataSection">
            <div class="card-title" style="display:flex;align-items:center;gap:10px"><span class="icon">üîÑ</span>Data Preview 
                <div style="margin-left:auto;display:flex;gap:8px;">
                    <button class="btn" onclick="recalculateFromPreview()">üîÑ Recalculate</button>
                    <button class="btn secondary" id="tabHoursBtn" onclick="showDataTab('hours')">‚è∞ Hours</button>
                    <button class="btn secondary" id="tabSalesBtn" onclick="showDataTab('sales')">üìä Sales</button>
                    <button class="btn secondary" id="tabDemosBtn" onclick="showDataTab('demos')">üéØ Demos</button>
                </div>
            </div>
            <div id="dataTabsContent">
                <div id="tabHours" class="tab-pane">
                    <div class="table-container">
                        <table class="table" id="connecteamDataTable">
                            <thead><tr><th>Date</th><th>Hours Worked</th></tr></thead>
                            <tbody id="connecteamDataBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tabSales" class="tab-pane hidden">
                    <div class="table-container">
                        <table class="table" id="noveDataTable">
                            <thead><tr><th>Date</th><th>Net Sales ($)</th><th>Refund ($)</th><th>Reimburs. ($)</th><th>Deductions ($)</th></tr></thead>
                            <tbody id="noveDataBody"></tbody>
                        </table>
                    </div>
                </div>
                <div id="tabDemos" class="tab-pane hidden">
                    <div class="table-container">
                        <table class="table" id="demosDataTable">
                            <thead><tr><th>Date</th><th>Demos</th><th>Status</th></tr></thead>
                            <tbody id="demosDataBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <div class="card hidden" id="salaryResultsSection">
            <div class="card-title"><span class="icon">üí∞</span>Salary Calculation Results</div>
            <div class="action-buttons" style="display:flex;gap:15px;justify-content:center;flex-wrap:wrap;margin:20px 0;">
                
                <button class="btn secondary" onclick="saveSession()">üíæ Save Session</button>
                <button class="btn" onclick="openCompareModal()">üìä Compare</button>
                <button class="btn success" onclick="exportResults()">üìÑ Export</button>
                <button class="btn" onclick="copyResults()">üìã Copy</button>
            </div>
            <div class="table-container">
                <table class="table" id="salaryResultsTable">
                    <thead><tr><th>Date</th><th>Sales ($)</th><th>Rate</th><th>Hours</th><th>Salary ($)</th><th>Cost (%)</th></tr></thead>
                    <tbody id="salaryResultsBody"></tbody>
                </table>
            </div>
            <div class="stats-grid" id="summaryStats"></div>
        </div>

            <div id="messages"></div>
        </div>
    </main>

    <!-- Compare Modal kept from original template (logic below) -->
    <div id="compareModal" class="modal" style="display:none;">
        <div class="modal-content" style="max-width:800px;max-height:90vh;overflow-y:auto;">
            <div class="modal-header"><h3>üìä Compare Sessions</h3><button class="close-btn" onclick="closeCompareModal()">&times;</button></div>
            <div class="modal-body">
                <div style="margin-bottom:30px;">
                    <h4 style="color:var(--primary);margin-bottom:15px;">Select Sessions to Compare:</h4>
                    <div id="sessionsList" style="max-height:200px;overflow-y:auto;border:1px solid var(--gray-200);border-radius:8px;padding:15px;"></div>
                    <div style="margin-top:15px;text-align:center;">
                        <button class="btn" onclick="generateComparison()" id="generateCompareBtn" disabled>üìä Generate Comparison</button>
                        <button class="btn success" onclick="exportComparisonPDF()" id="exportCompareBtn" disabled>üìÑ Export PDF</button>
                    </div>
                </div>
                <div id="comparisonResults" style="display:none;">
                    <h4 style="color:var(--primary);margin-bottom:15px;">üìà Comparison Results:</h4>
                    <div id="comparisonContent"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Inline logic from original template (trimmed formatting only) -->
    <script>
        let currentUser=null,users=[],locations=[],noveData=[],connecteamData=[],combinedData=[],calculationMode='hourly';
        window.addEventListener('error',e=>{console.error('üí• JavaScript Error:',e.error);if(typeof showMessage==='function'){showMessage('‚ùå An error occurred. Check console for details.','error')}});
        if(typeof window.showMessage!=="function"){window.showMessage=function(msg,type){try{const box=document.getElementById('messages');if(box){const div=document.createElement('div');div.style.padding='10px';div.style.margin='6px 0';div.style.borderRadius='8px';div.style.fontSize='.95rem';div.style.border='1px solid #e5e7eb';div.style.background= type==='error'? '#fee2e2' : (type==='success'? '#e9fbe6' : '#eef2ff');div.style.color= type==='error'? '#b91c1c' : (type==='success'? '#166534' : '#1e3a8a');div.textContent=String(msg||'');box.appendChild(div);setTimeout(()=>{if(div&&div.parentNode){div.parentNode.removeChild(div)}},5000)}else{console.log('[MSG]',type||'info',msg)}}catch(err){console.log(msg)}}}
        function selectCalculationMode(mode){calculationMode=mode;updateCalcModeUI();setTimeout(()=>{updateTableHeaders();if(combinedData.length>0){calculateSalaries()}},100)}
        function toggleCalcMode(){calculationMode=calculationMode==='hourly'?'commission':'hourly';updateCalcModeUI();updateTableHeaders();if(combinedData.length>0){calculateSalaries()}}
        function updateCalcModeUI(){const btn=document.getElementById('calcModeBtn');const inlineHourly=document.getElementById('inlineHourly');if(calculationMode==='hourly'){btn.textContent='Mode: Hourly';if(inlineHourly) inlineHourly.style.display='none'}else{btn.textContent='Mode: Comm + Hourly';if(inlineHourly) inlineHourly.style.display='flex'}}
        function updateTableHeaders(){const table=document.getElementById('salaryResultsTable');if(!table)return;const thead=table.querySelector('thead tr');if(!thead)return;if(calculationMode==='commission'){thead.innerHTML='<th>Date</th><th>Sales ($)</th><th>Hours</th><th>Hourly Pay ($)</th><th>Comm ($)</th><th>Salary ($)</th><th>Cost (%)</th>'}else{thead.innerHTML='<th>Date</th><th>Sales ($)</th><th>Rate ($/hr)</th><th>Hours</th><th>Salary ($)</th><th>Cost (%)</th>'}}
        document.addEventListener('DOMContentLoaded',()=>{try{loadUsers();renderUserSelect();setupEventListeners();checkProcessReady();setTimeout(()=>{selectCalculationMode('hourly')},50)}catch(e){console.error('‚ùå Error during initialization:',e)}});
        function setupEventListeners(){document.getElementById('userSelect').addEventListener('change',handleUserSelection);document.getElementById('noveFile').addEventListener('change',e=>handleFileUpload(e,'nove'));document.getElementById('connecteamFile').addEventListener('change',e=>handleFileUpload(e,'connecteam'));document.getElementById('baseHourlyPay').addEventListener('input',function(){if(combinedData.length>0&&calculationMode==='commission'){calculateSalaries()}});window.addEventListener('focus',function(){loadUsers();renderUserSelect();if(currentUser){const userStillExists=users.find(u=>u.id===currentUser.id);if(userStillExists){document.getElementById('userSelect').value=currentUser.id;currentUser=userStillExists;displayUserInfo()}else{currentUser=null;hideUserInfo();showMessage('Previously selected user no longer exists','info')}checkProcessReady()}})}
        async function loadUsers(){
            try {
                // Prefer tracking-safe endpoint that applies location filtering
                let resp = await fetch('/get_users_for_tracking', { credentials: 'include' });
                if (!resp.ok) {
                    // Fallback to generic users API
                    resp = await fetch('/api/users?per_page=1000&page=1', { credentials: 'include', headers: { 'X-Requested-With': 'XMLHttpRequest' }});
                }
                if (resp.ok) {
                    const data = await resp.json();
                    const list = Array.isArray(data) ? data : (data.users || data.tiers || data.data || []);
                    // Map only lightweight user info for fast Employee Selection load
                    users = (list || []).map(u => ({
                        id: String(u.id),
                        name: u.name || u.username,
                        location: u.location_name || u.location || 'Unknown',
                        base_rate: parseFloat(u.base_hourly_rate || 0) || 0
                    }));
                    if (!users.length && data.success && Array.isArray(data.users)) {
                        users = data.users.map(u => ({
                            id: String(u.id),
                            name: u.name || u.username,
                            location: u.location_name || 'Unknown',
                            base_rate: parseFloat(u.base_hourly_rate || 0) || 0
                        }));
                    }
                    
                } else {
                    console.warn('Users API failed with status', resp.status);
                }
            } catch (e) { console.error('loadUsers error', e); }
            const l=localStorage.getItem('salaryCalc_locations'); if(l){locations=JSON.parse(l)}
        }
        function renderUserSelect(){const select=document.getElementById('userSelect');if(!select)return;const currentValue=select.value;select.innerHTML='<option value="">Choose an employee to continue...</option>';(users||[]).forEach(user=>{if(!user||!user.id)return;const option=document.createElement('option');option.value=user.id;option.textContent=`${user.name||'User'}${user.location?` (${user.location})`:''}`;select.appendChild(option)});if(currentValue){select.value=currentValue}}
        function handleUserSelection(){const userId=document.getElementById('userSelect').value;if(userId){currentUser=users.find(u=>u.id===userId)||{id:userId};showMessage(`Selected employee: ${currentUser.name||'User'}`,'success');displayUserInfo();checkProcessReady();}else{currentUser=null;hideUserInfo();checkProcessReady()}}
        async function loadUserProfileFromServer(userId){
            try{
                const res=await fetch(`/api/users/${userId}`,{credentials:'include',headers:{'X-Requested-With':'XMLHttpRequest'}});
                const data=await res.json();
                if(res.ok&&data.success&&data.user){
                    currentUser.name=currentUser.name||data.user.name||data.user.username;
                    currentUser.location=data.user.location_name||currentUser.location;
                    // Ensure we capture the base hourly defined in user info
                    if(typeof data.user.base_hourly_rate!== 'undefined'){
                        const br=parseFloat(data.user.base_hourly_rate||0);
                        if(!isNaN(br)) currentUser.base_rate=br;
                        const baseInput=document.getElementById('baseHourlyPay');
                        if(baseInput && !isNaN(br) && br>0){
                            baseInput.value = br.toFixed(2);
                        }
                    }
                }
            }catch(e){console.error('profile load',e)}
        }
        async function loadUserTiersFromServer(userId){try{const res=await fetch(`/api/users/${userId}/tiers`);const data=await res.json();const tiers=Array.isArray(data)?data:(data.tiers||[]);currentUser.tiersServer=(tiers||[]).map(t=>({type:(t.tier_type||'hourly'),sales_goal_in_day:parseInt(t.sales_goal_in_day||0),min_demo:parseInt(t.daily_demo_min||0),hourly_rate:parseFloat(t.hourly_rate||0),commission_rate_pct:parseFloat(t.commission_rate_pct||0),demo_bonus:parseFloat(t.demo_bonus||0)}))}catch(e){console.error('tiers load',e);currentUser.tiersServer=[]}}
        function displayUserInfo(){const container=document.getElementById('userInfoDisplay');const section=document.getElementById('userInfoSection');if(!container||!section){return}if(!currentUser){section.classList.add('hidden');return}let tiersHtml='';if(currentUser.tiers&&currentUser.tiers.length>0){tiersHtml=`<div class="tier-display">${currentUser.tiers.map(tier=>`<div class=\"tier-card\"><div style=\"font-weight:600;color:var(--primary);margin-bottom:5px;\">$${tier.threshold}+ Sales</div><div style=\"font-size:1.1rem;font-weight:700;\">${tier.type==='commission'?`${tier.rate}%`:`$${tier.rate}/hr`}</div><div style=\"font-size:.8rem;color:var(--gray-500);\">${tier.type==='commission'?'Commission':'Hourly Rate'}</div></div>`).join('')}</div>`}
            container.innerHTML=`<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:20px;margin-bottom:15px;"><div><strong>üë§ Name:</strong> ${currentUser.name||''}</div><div><strong>üìç Location:</strong> ${currentUser.location||''}</div><div><strong>‚≠ê Tiers:</strong> ${currentUser.tiers?.length||0} configured</div></div>${tiersHtml}`;section.classList.remove('hidden');const profileToggleBtn=document.getElementById('profileToggleBtn');if(profileToggleBtn&&!profileToggleBtn.innerHTML.includes('Hide')){container.classList.add('hidden')}}
        function hideUserInfo(){const s=document.getElementById('userInfoSection');if(s){s.classList.add('hidden')}}
        function handleFileUpload(event,type){const file=event.target.files[0];if(!file)return;const uploadArea=event.target.closest('.upload-area');uploadArea.classList.add('file-selected');const reader=new FileReader();reader.onload=function(e){try{let jsonData=[];const name=(file.name||'').toLowerCase();if(name.endsWith('.csv')){const text=e.target.result;const rows=text.split(/\r?\n/).map(line=>line.split(','));jsonData=rows}else{const data=new Uint8Array(e.target.result);const workbook=XLSX.read(data,{type:'array'});const firstSheetName=workbook.SheetNames[0];const worksheet=workbook.Sheets[firstSheetName];jsonData=XLSX.utils.sheet_to_json(worksheet,{header:1})}if(type==='nove'){processNoveData(jsonData)}else if(type==='connecteam'){processConnecteamData(jsonData)}updateFileStats();checkProcessReady();showMessage(`‚úÖ ${type} file uploaded successfully`,'success')}catch(error){console.error('handleFileUpload',error);showMessage(`‚ùå Error processing ${type} file: ${error.message}`,'error')}};if((file.name||'').toLowerCase().endsWith('.csv')){reader.readAsText(file)}else{reader.readAsArrayBuffer(file)}}
        function processNoveData(jsonData){try{noveData=[];if(!Array.isArray(jsonData)||jsonData.length<2){showMessage('‚ùå Nove sheet is empty or invalid','error');return}
            const norm=s=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'');
            // Find header row within first 10 rows
            let headerRowIdx=0;let header=jsonData[0]||[];
            for(let r=0;r<Math.min(10,jsonData.length);r++){
                const row=jsonData[r]||[];const hasDateHeader=row.some(c=>{const h=norm(c);return h.includes('date')||['workdate','day','businessdate','orderdate','saledate','invoicedate','postingdate','postdate','transactiondate','tradedate'].includes(h)});
                if(hasDateHeader){headerRowIdx=r;header=row;break}
            }
            const idx=(matchers)=>{for(let i=0;i<header.length;i++){const h=norm(header[i]);for(const m of matchers){if(typeof m==='string'){if(h===m||h.includes(m))return i}else if(m instanceof RegExp){if(m.test(h))return i}}}return -1};
            // Locate columns (flexible)
            let iDate=idx(['date','workdate','businessdate','orderdate','saledate','invoicedate','postingdate','postdate','transactiondate','tradedate','day']);
            const iSales=idx(['netsales','sales','totalsales','net','netamount']);
            const iRefund=idx(['refund','refunds','return','returns']);
            const iDeductions=idx(['deductions','deduction','deduct']);
            const iReimb=idx(['reimburs','reimburse','reimbursement','reimbursed','reimburs.','reimbursals','reimbursements']);
            const iComm=idx(['commission','comm']);
            // If date header not found, heuristic: pick the column that looks most like a date in next rows
            if(iDate<0){
                const start=headerRowIdx+1;const end=Math.min(jsonData.length,start+20);let bestCol=-1;let bestScore=-1;const colCount=Math.max(...jsonData.slice(headerRowIdx).map(r=>r.length));
                const isDateLike=(v)=>{if(v===undefined||v===null||v==='')return false; if(typeof v==='number'){return v>20000&&v<60000} const t=String(v); const d=Date.parse(t); return !isNaN(d)};
                for(let c=0;c<colCount;c++){let score=0,tot=0;for(let r=start;r<end;r++){const row=jsonData[r]||[];const val=row[c];if(val!==undefined){tot++;if(isDateLike(val))score++}}if(tot>0&&score>bestScore){bestScore=score;bestCol=c}}
                if(bestScore>0){iDate=bestCol}
            }
            const processed=new Set();
            for(let r=headerRowIdx+1;r<jsonData.length;r++){
                const row=jsonData[r]; if(row==null||row.length===0)continue;
                const rawDate=(iDate>=0)?row[iDate]:row[0]; if(rawDate===undefined||rawDate===null||rawDate==='')continue;
                const date=convertExcelDate(rawDate);
                const commission=(iComm>=0)?parseFloat(row[iComm])||0:0;
                const salesRaw=(iSales>=0)?parseFloat(row[iSales])||0:0;
                const refund=(iRefund>=0)?parseFloat(row[iRefund])||0:0;
                const deductions=(iDeductions>=0)?parseFloat(row[iDeductions])||0:0;
                const reimbur=(iReimb>=0)?parseFloat(row[iReimb])||0:0;
                const sales=(iSales>=0)?(salesRaw- (iRefund>=0?refund:0)):0;
                if(!processed.has(date)){
                    processed.add(date);
                    noveData.push({date,commission,salesTotal:salesRaw,refund,sales,deductions,reimbur});
                }
            }
            updateFileStats();
            checkProcessReady();
            showMessage(`‚úÖ Nove data processed (${noveData.length} days)`, 'success');
        }catch(err){console.error('processNoveData error',err);showMessage('‚ùå Failed to process Nove sheet','error')}}
        function processConnecteamData(jsonData){connecteamData=[];if(!Array.isArray(jsonData)||jsonData.length<2){return}const header=jsonData[0]||[];const norm=s=>String(s||'').toLowerCase().replace(/[^a-z0-9]+/g,'');const idx=(names)=>{for(let i=0;i<header.length;i++){const h=norm(header[i]);if(names.includes(h))return i}return -1};const iDate=idx(['date','workdate','day']);const iHours=idx(['hours','totalhours','workedhours','duration']);const seen=new Set();for(let r=1;r<jsonData.length;r++){const row=jsonData[r];if(!row)continue;const dVal=(iDate>=0)?row[iDate]:row[6];const hVal=(iHours>=0)?row[iHours]:row[11];if(dVal===undefined||dVal===null||dVal==='')continue;const date=convertExcelDate(dVal);const hours=parseHoursInput(hVal||0);if(!seen.has(date)){seen.add(date);connecteamData.push({date,hours})}}}
        function updateFileStats(){document.getElementById('noveRows').textContent=noveData.length;document.getElementById('connecteamRows').textContent=connecteamData.length}
        function checkProcessReady(){const btn=document.getElementById('processBtn');if(currentUser&&(noveData.length>0||connecteamData.length>0)){btn.disabled=false;btn.textContent='üîÑ Process & Combine Data';btn.classList.remove('disabled')}else{btn.disabled=true;btn.textContent=currentUser?'üìÅ Upload Nove &/or Connecteam first':'‚ùå Select an employee first'}}
        async function processAndCombineData(){if(!currentUser){showMessage('‚ùå Please select a user','error');return}combinedData=[];const noveByDate={},connecteamByDate={};noveData.forEach(r=>{noveByDate[r.date]={sales:r.sales,commission:r.commission||0,refund:r.refund||0,reimbur:r.reimbur||0,deductions:r.deductions||0}});connecteamData.forEach(r=>{connecteamByDate[r.date]=r.hours});const allDates=Array.from(new Set([...Object.keys(noveByDate),...Object.keys(connecteamByDate)])).sort();if(allDates.length===0){showMessage('‚ùå No dates found in uploads','error');return}const start=allDates[0];const end=allDates[allDates.length-1];let demosByDate={};try{const dm=await fetch(`/api/demos?userId=${currentUser.id}&start=${start}&end=${end}`);const j=await dm.json();if(dm.ok&&j.success){j.demos.forEach(d=>{demosByDate[d.date]=parseInt(d.demos||0)})}}catch(e){console.error('demos load',e)}
            // Ensure we have latest base hourly from user profile and then load tiers lazily here
            await loadUserProfileFromServer(currentUser.id);
            await loadUserTiersFromServer(currentUser.id);
            allDates.forEach(date=>{const n=noveByDate[date]||{sales:0,commission:0,refund:0,reimbur:0,deductions:0};const h=connecteamByDate[date]||0;const demos=(demosByDate[date]!==undefined)?demosByDate[date]:0;const missingDemo=(demosByDate[date]===undefined);combinedData.push({date,sales:n.sales,commission:n.commission,hours:h,demos,missingDemo,refund:n.refund,reimbur:n.reimbur,deductions:n.deductions})});displayCombinedData();showDataTab('hours');calculateSalaries();showMessage(`‚úÖ Combined ${combinedData.length} unique dates`,'success')}

        async function loadSystemData(){try{const userId=document.getElementById('userSelect').value;if(!userId){showMessage('‚ùå Select a user first','error');return}const start=document.getElementById('periodStart').value||new Date(new Date().getFullYear(),new Date().getMonth(),1).toISOString().slice(0,10);const end=document.getElementById('periodEnd').value||new Date().toISOString().slice(0,10);const dm=await fetch(`/api/daily-metrics?userId=${userId}&start=${start}&end=${end}`);const json=await dm.json();if(!dm.ok||!json.success){showMessage(json.message||'‚ùå Failed to load system data','error');return}noveData=[];connecteamData=[];combinedData=[];json.data.forEach(d=>{combinedData.push({date:d.date,sales:d.sales||0,hours:d.hours||0,commission:0})});displayCombinedData();calculateSalaries();checkProcessReady();showMessage('‚úÖ Loaded system data','success')}catch(e){console.error(e);showMessage('‚ùå Failed to load system data','error')}}
        function useSystemOnly(){if(!currentUser){showMessage('‚ùå Select a user first','error');return}noveData=[];connecteamData=[];processAndCombineData()}
        function displayCombinedData(){const section=document.getElementById('combinedDataSection');const noveBody=document.getElementById('noveDataBody');noveBody.innerHTML='';combinedData.forEach((row,idx)=>{const tr=document.createElement('tr');tr.innerHTML=`<td class="editable-cell" onclick="editPreviewDate(this, ${idx})">${formatDateForDisplay(row.date)}</td>`+
            `<td class=\"editable-cell\" onclick=\"editPreviewCell(this, ${idx}, 'sales')\">$${(row.sales||0).toFixed(2)}</td>`+
            `<td>$${((row.refund)||0).toFixed(2)}</td>`+
            `<td>$${((row.reimbur)||0).toFixed(2)}</td>`+
            `<td>$${((row.deductions)||0).toFixed(2)}</td>`;noveBody.appendChild(tr)});
            const connecteamBody=document.getElementById('connecteamDataBody');connecteamBody.innerHTML='';combinedData.forEach((row,idx)=>{const tr=document.createElement('tr');tr.innerHTML=`<td class="editable-cell" onclick="editPreviewDate(this, ${idx})">${formatDateForDisplay(row.date)}</td>`+
            `<td class="editable-cell" onclick="editPreviewCell(this, ${idx}, 'hours')">${formatHoursForDisplay(row.hours)}</td>`;connecteamBody.appendChild(tr)});
            const demosBody=document.getElementById('demosDataBody');demosBody.innerHTML='';combinedData.forEach((row,idx)=>{const status=row.missingDemo?'‚ùó missing in system':'‚úì';const tr=document.createElement('tr');tr.innerHTML=`<td class="editable-cell" onclick="editPreviewDate(this, ${idx})">${formatDateForDisplay(row.date)}</td>`+
            `<td class="editable-cell" onclick="editPreviewCell(this, ${idx}, 'demos')">${row.demos}</td><td>${status}</td>`;demosBody.appendChild(tr)});section.classList.remove('hidden')}

        function editPreviewDate(cell,index){if(cell.classList.contains('editing'))return;const current=combinedData[index].date||'';cell.classList.add('editing');cell.innerHTML=`<input type="date" class="cell-input" value="${current}" onblur="savePreviewDate(this, ${index})" onkeydown="handleDateKeydown(event, this, ${index})">`;const input=cell.querySelector('.cell-input');input.focus();}
        function handleDateKeydown(e,input,index){if(e.key==='Enter'){savePreviewDate(input,index)}else if(e.key==='Escape'){const cell=input.parentElement;cell.innerHTML=formatDateForDisplay(combinedData[index].date);cell.classList.remove('editing')}}
        function savePreviewDate(input,index){const cell=input.parentElement;const v=input.value;try{if(!v){throw new Error('empty')}combinedData[index].date=v;cell.innerHTML=formatDateForDisplay(v);combinedData.sort((a,b)=>a.date.localeCompare(b.date));displayCombinedData();showMessage('‚úÖ Date updated','success')}catch(e){cell.innerHTML=formatDateForDisplay(combinedData[index].date);showMessage('‚ùå Invalid date','error')}cell.classList.remove('editing')}

        function editPreviewCell(cell,index,field){if(cell.classList.contains('editing'))return;let displayVal=combinedData[index][field];if(field==='hours'){displayVal=formatHoursForDisplay(displayVal)}else if(typeof displayVal==='number'){displayVal=displayVal.toFixed(2)}cell.classList.add('editing');cell.innerHTML=`<input type="text" class="cell-input" value="${displayVal}" onblur="savePreviewEdit(this, ${index}, '${field}')" onkeydown="handleCellKeydown(event, this, ${index}, '${field}')">`;const input=cell.querySelector('.cell-input');input.focus();input.select()}
        function savePreviewEdit(input,index,field){const cell=input.parentElement;const v=input.value.trim();try{if(field==='hours'){combinedData[index][field]=parseHoursInput(v);cell.innerHTML=formatHoursForDisplay(combinedData[index][field])}
            else if(field==='demos'){combinedData[index][field]=parseInt(v)||0;cell.innerHTML=combinedData[index][field]}
            else{const num=parseFloat(v.replace(/\$/g,''))||0;combinedData[index][field]=num;cell.innerHTML=`$${num.toFixed(2)}`}
            showMessage('‚úÖ Preview value updated','success')
        }catch(e){showMessage('‚ùå Invalid value','error');cell.innerHTML = (field==='hours')?formatHoursForDisplay(combinedData[index][field]) : (field==='demos'?combinedData[index][field] : `$${(combinedData[index][field]||0).toFixed(2)}`)}
        cell.classList.remove('editing')}
        function recalculateFromPreview(){
            if(combinedData.length===0){showMessage('‚ùå No data to recalculate','error');return}
            // Commit any in-progress cell edits so the latest numbers are used
            const activeInputs = document.querySelectorAll('#combinedDataSection .cell-input');
            activeInputs.forEach(inp => { try { inp.blur(); } catch(_) {} });
            // Slight delay to allow blur handlers to persist values, then recompute
            setTimeout(() => {
                // Re-render preview in case dates or fields changed order
                displayCombinedData();
                calculateSalaries();
                showMessage('‚úÖ Salaries recalculated','success');
            }, 50);
        }
        function calculateSalaries(){
            if(!currentUser){console.error('‚ùå No user selected');return}
            // If base rate missing or zero, use inline fallback
            if(currentUser.base_rate==null || currentUser.base_rate<=0){
                const inline=document.getElementById('baseHourlyPay');
                if(inline){
                    const v=parseFloat(inline.value||'0');
                    if(!isNaN(v) && v>0) currentUser.base_rate=v;
                }
            }
            combinedData.forEach((row)=>{
                const t=computePayByServerTiers(row,currentUser.tiersServer||[]);
                row.rate=t.hourly_rate;row.salary=t.computed_pay;row.tierType=t.tier_type||'hourly';row.hourlyPay=t.hourly_component||0;row.commissionAmount=t.commission_component||0;row.demoAmount=t.demo_component||0
            });
            displaySalaryResults()
        }
        function computePayByServerTiers(row,tiers){const sales=row.sales||0;const hours=row.hours||0;const demos=row.demos||0;const reimbur=row.reimbur||0;const deductions=row.deductions||0;const candidates=[];tiers.forEach(t=>{const salesOk=sales>= (t.sales_goal_in_day||0);const demosOk=(t.min_demo||0)===0?true:(demos>=(t.min_demo||0));if(salesOk&&demosOk){const base=(t.type==='commission')?((t.commission_rate_pct||0)/100)*sales: (t.hourly_rate||0)*hours;candidates.push({tier:t,base})}});let chosen=null;if(candidates.length){candidates.sort((a,b)=> b.base - a.base || (b.tier.demo_bonus||0)-(a.tier.demo_bonus||0) || (b.tier.sales_goal_in_day||0)-(a.tier.sales_goal_in_day||0));chosen=candidates[0].tier}let tier_type='hourly',hourly_rate=0,commission_pct=0,demo_bonus=0;let hourly_component=0,commission_component=0,demo_component=0;if(chosen){tier_type=chosen.type||'hourly';hourly_rate=tier_type==='hourly'?(chosen.hourly_rate||0):0;commission_pct=tier_type==='commission'?(chosen.commission_rate_pct||0):0;demo_bonus=chosen.demo_bonus||0;if(tier_type==='commission'){commission_component=(commission_pct/100)*sales}else{hourly_component=hourly_rate*hours}demo_component=(demo_bonus||0)*demos}else{const baseRate=parseFloat(currentUser?.base_rate||0);if(baseRate>0){tier_type='hourly';hourly_rate=baseRate;hourly_component=baseRate*hours}}const variable_component=(tier_type==='commission')?commission_component:hourly_component;let computed_pay=variable_component+demo_component;computed_pay += (reimbur||0)-(deductions||0);const rate_display=(tier_type==='commission')? ((sales>0)?((commission_component/sales)*100):0) : hourly_rate;return{tier_type,hourly_rate:rate_display,commission_rate_pct:commission_pct,demo_bonus,computed_pay,hourly_component,commission_component,demo_component};}
        function displaySalaryResults(){const section=document.getElementById('salaryResultsSection');const tbody=document.getElementById('salaryResultsBody');tbody.innerHTML='';combinedData.forEach((row,index)=>{const employeeCost=row.sales>0?(row.salary/row.sales*100):0;const warn=row.missingDemo?'‚ùó':'';const reimb=row.reimbur||0;const ded=row.deductions||0;const demoDollars=row.demoAmount||0;if(calculationMode==='commission'){const hourlyPay=row.hourlyPay||0;const comm=row.commissionAmount||0;const tr=document.createElement('tr');tr.innerHTML=`<td>${formatDateForDisplay(row.date)} ${warn}</td><td>$${row.sales.toFixed(2)}</td><td class="editable-cell" onclick="editCell(this, ${index}, 'hours')">${formatHoursForDisplay(row.hours)}</td><td>$${hourlyPay.toFixed(2)}</td><td>$${comm.toFixed(2)}</td><td>$${demoDollars.toFixed(2)}</td><td>$${reimb.toFixed(2)}</td><td>-$${ded.toFixed(2)}</td><td>$${row.salary.toFixed(2)}</td><td>${employeeCost.toFixed(1)}%</td>`;tbody.appendChild(tr)}else{const rateDisplay=row.tierType==='commission'?`${((row.salary/row.sales)*100).toFixed(1)}%`:`$${row.rate.toFixed(2)}/hr`;const tr=document.createElement('tr');tr.innerHTML=`<td>${formatDateForDisplay(row.date)} ${warn}</td><td>$${row.sales.toFixed(2)}</td><td>${rateDisplay}</td><td class="editable-cell" onclick="editCell(this, ${index}, 'hours')">${formatHoursForDisplay(row.hours)}</td><td>$${demoDollars.toFixed(2)}</td><td>$${reimb.toFixed(2)}</td><td>-$${ded.toFixed(2)}</td><td>$${row.salary.toFixed(2)}</td><td>${employeeCost.toFixed(1)}%</td>`;tbody.appendChild(tr)}});updateSummaryStats();section.classList.remove('hidden');updateTableHeadersWithAdditions()}
        function updateTableHeadersWithAdditions(){const table=document.getElementById('salaryResultsTable');if(!table)return;const thead=table.querySelector('thead tr');if(!thead)return;if(calculationMode==='commission'){thead.innerHTML='<th>Date</th><th>Sales ($)</th><th>Hours</th><th>Hourly Pay ($)</th><th>Comm ($)</th><th>Demo ($)</th><th>Reimburs. ($)</th><th>Deductions ($)</th><th>Salary ($)</th><th>Cost (%)</th>'}else{thead.innerHTML='<th>Date</th><th>Sales ($)</th><th>Rate ($/hr)</th><th>Hours</th><th>Demo ($)</th><th>Reimburs. ($)</th><th>Deductions ($)</th><th>Salary ($)</th><th>Cost (%)</th>'}}
        function updateSummaryStats(){const container=document.getElementById('summaryStats');const totalSales=combinedData.reduce((s,r)=>s+r.sales,0);const totalHours=combinedData.reduce((s,r)=>s+r.hours,0);const totalSalary=combinedData.reduce((s,r)=>s+r.salary,0);const totalCost=totalSales>0?(totalSalary/totalSales*100):0;if(calculationMode==='commission'){const totalHourlyPay=combinedData.reduce((s,r)=>s+(r.hourlyPay||0),0);const totalCommission=combinedData.reduce((s,r)=>s+(r.commissionAmount||0),0);container.innerHTML=`<div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">$${totalSales.toLocaleString()}</div><div class="stat-label">Total Sales</div></div><div class="stat-card"><div class="stat-icon">‚è∞</div><div class="stat-value">${formatHoursForDisplay(totalHours)}</div><div class="stat-label">Total Hours</div></div><div class="stat-card"><div class="stat-icon">üïí</div><div class="stat-value">$${totalHourlyPay.toLocaleString()}</div><div class="stat-label">Hourly Pay</div></div><div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-value">$${totalCommission.toLocaleString()}</div><div class="stat-label">Total Comm</div></div><div class="stat-card"><div class="stat-icon">üíµ</div><div class="stat-value">$${totalSalary.toLocaleString()}</div><div class="stat-label">Total Salary</div></div><div class="stat-card"><div class="stat-icon">üìâ</div><div class="stat-value">${totalCost.toFixed(1)}%</div><div class="stat-label">Total Cost</div></div>`}else{const avgRate=totalHours>0?(totalSalary/totalHours):0;container.innerHTML=`<div class="stat-card"><div class="stat-icon">üí∞</div><div class="stat-value">$${totalSales.toLocaleString()}</div><div class="stat-label">Total Sales</div></div><div class="stat-card"><div class="stat-icon">‚è∞</div><div class="stat-value">${formatHoursForDisplay(totalHours)}</div><div class="stat-label">Total Hours</div></div><div class="stat-card"><div class="stat-icon">üíµ</div><div class="stat-value">$${totalSalary.toLocaleString()}</div><div class="stat-label">Total Salary</div></div><div class="stat-card"><div class="stat-icon">üìä</div><div class="stat-value">${totalCost.toFixed(1)}%</div><div class="stat-label">Total Cost</div></div><div class="stat-card"><div class="stat-icon">üìà</div><div class="stat-value">$${avgRate.toFixed(2)}</div><div class="stat-label">Avg Rate/hr</div></div><div class="stat-card"><div class="stat-icon">üìù</div><div class="stat-value">${combinedData.length}</div><div class="stat-label">Records</div></div>`}}
        function editCell(cell,index,field){if(cell.classList.contains('editing'))return;const currentValue=field==='hours'?formatHoursForDisplay(combinedData[index][field]):combinedData[index][field];cell.classList.add('editing');cell.innerHTML=`<input type="text" class="cell-input" value="${currentValue}" onblur="saveEdit(this, ${index}, '${field}')" onkeydown="handleCellKeydown(event, this, ${index}, '${field}')">`;const input=cell.querySelector('.cell-input');input.focus();input.select()}
        function saveEdit(input,index,field){const cell=input.parentElement;const newValue=input.value.trim();try{if(field==='hours'){const parsedHours=parseHoursInput(newValue);combinedData[index][field]=parsedHours;cell.innerHTML=formatHoursForDisplay(parsedHours)}else{const parsedValue=parseFloat(newValue)||0;combinedData[index][field]=parsedValue;cell.innerHTML=parsedValue.toFixed(2)}calculateSalaries();showMessage('‚úÖ Value updated successfully','success')}catch(e){cell.innerHTML=field==='hours'?formatHoursForDisplay(combinedData[index][field]):combinedData[index][field];showMessage('‚ùå Invalid value entered','error')}cell.classList.remove('editing')}
        function handleCellKeydown(event,input,index,field){if(event.key==='Enter'){saveEdit(input,index,field)}else if(event.key==='Escape'){const cell=input.parentElement;const original=field==='hours'?formatHoursForDisplay(combinedData[index][field]):combinedData[index][field];cell.innerHTML=original;cell.classList.remove('editing')}}
        function recalculateSalaries(){if(combinedData.length===0){showMessage('‚ùå No data to recalculate','error');return}processAndCombineData();showMessage('‚úÖ Data reprocessed and salaries recalculated','success')}
        // Open the save modal (compat shim for existing onclick)
        function saveSession(){ try { showSessionDateModal(); } catch(e) { console.error('saveSession error', e); } }
        function autoBiweekly(){const today=new Date();const y=today.getFullYear();const m=today.getMonth();const d=today.getDate();let start,end;if(d<=15){const lastMonth=new Date(y,m-1,1);const ly=lastMonth.getFullYear();const lm=lastMonth.getMonth();start=new Date(ly,lm,16);end=new Date(ly,lm+1,0);}else{start=new Date(y,m,1);end=new Date(y,m,15);}const fmt=x=>`${x.getFullYear()}-${String(x.getMonth()+1).padStart(2,'0')}-${String(x.getDate()).padStart(2,'0')}`;return{start:fmt(start),end:fmt(end)}}
        function showSessionDateModal(){const biw=autoBiweekly();const html=`<div id="sessionDateModal" class="modal" style="display:flex;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.35);z-index:9999;"><div class="modal-content" style="max-width:520px;width:calc(100% - 40px);max-height:90vh;overflow:auto;background:#fff;border-radius:14px;box-shadow:0 10px 30px rgba(0,0,0,.2);"><div class="modal-header" style="display:flex;justify-content:space-between;align-items:center;padding:14px 16px;border-bottom:1px solid #eee;"><h3 style="margin:0;color:#2c3e50">üìÖ Save Session</h3><button class="close-btn" onclick="closeSessionDateModal()" style="font-size:22px;background:none;border:none;cursor:pointer;">&times;</button></div><div class="modal-body" style="padding:16px 16px 20px 16px;"><div class="form-row" style="display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px"><div><label style="font-weight:600;color:#2c3e50;margin-bottom:6px;display:block;">Period Start</label><input type="date" id="periodStart" class="form-input" value="${biw.start}"></div><div><label style="font-weight:600;color:#2c3e50;margin-bottom:6px;display:block;">Period End</label><input type="date" id="periodEnd" class="form-input" value="${biw.end}"></div></div><div style="margin-bottom:12px;"><label style="font-weight:600;color:#2c3e50;margin-bottom:6px;display:block;">Label Date (for listing)</label><input type="date" id="sessionDate" class="form-input" style="width:100%;" value="${new Date().toISOString().split('T')[0]}"></div><div style="font-size:.9rem;color:var(--gray-500);margin-bottom:16px;">üí° Default is last biweekly period.</div><div style="text-align:center;display:flex;gap:10px;justify-content:center;"><button class="btn success" onclick="confirmSaveSession()">üíæ Save Session</button><button class="btn" onclick="closeSessionDateModal()">‚ùå Cancel</button></div></div></div></div>`;const existing=document.getElementById('sessionDateModal');if(existing)existing.remove();document.body.insertAdjacentHTML('beforeend',html)}
        function closeSessionDateModal(){const m=document.getElementById('sessionDateModal');if(m)m.remove()}
        function confirmSaveSession(){const sessionDate=document.getElementById('sessionDate').value;if(!sessionDate){showMessage('‚ùå Please select a session date','error');return}const start=document.getElementById('periodStart')?.value||autoBiweekly().start;const end=document.getElementById('periodEnd')?.value||autoBiweekly().end;const baseHourlyPay=calculationMode==='commission'?parseFloat(document.getElementById('baseHourlyPay').value)||0:0;const totalCommission=calculationMode==='commission'?combinedData.reduce((s,r)=>s+(r.commissionAmount||0),0):0;const totalHourlyPay=calculationMode==='commission'?combinedData.reduce((s,r)=>s+(r.hourlyPay||0),0):0;const session={id:'session-'+Date.now(),userId:currentUser.id,userName:currentUser.name,userLocation:currentUser.location,userTiers:currentUser.tiers,sessionDate:sessionDate,period:{start,end},calculationMode:calculationMode,baseHourlyPay:baseHourlyPay,createdAt:new Date().toISOString(),data:[...combinedData],summary:{totalSales:combinedData.reduce((s,r)=>s+r.sales,0),totalHours:combinedData.reduce((s,r)=>s+r.hours,0),totalSalary:combinedData.reduce((s,r)=>s+r.salary,0),totalCommission:totalCommission,totalHourlyPay:totalHourlyPay,recordCount:combinedData.length}};const sessions=JSON.parse(localStorage.getItem('salaryCalc_sessions')||'[]');sessions.push(session);localStorage.setItem('salaryCalc_sessions',JSON.stringify(sessions));closeSessionDateModal();showMessage('‚úÖ Session saved successfully','success')}
        let selectedSessions=[],comparisonData=null;function openCompareModal(){const sessions=JSON.parse(localStorage.getItem('salaryCalc_sessions')||'[]');if(sessions.length<2){showMessage('‚ùå Need at least 2 saved sessions to compare','error');return}selectedSessions=[];populateSessionsList(sessions);document.getElementById('compareModal').style.display='block'}
        function closeCompareModal(){document.getElementById('compareModal').style.display='none';selectedSessions=[];comparisonData=null;document.getElementById('comparisonResults').style.display='none'}
        function populateSessionsList(sessions){const container=document.getElementById('sessionsList');container.innerHTML='';if(sessions.length===0){container.innerHTML='<div style="color: var(--gray-500); text-align: center;">No saved sessions found</div>';return}sessions.forEach(session=>{const sessionDate=new Date(session.sessionDate||session.createdAt).toLocaleDateString();const createdDate=new Date(session.createdAt).toLocaleDateString();const modeText=session.calculationMode==='commission'?'Comm + H Pay':'H Rate';const div=document.createElement('div');div.className='session-select-card';div.innerHTML=`<div style="display:flex;align-items:center;gap:15px;padding:15px;border:2px solid var(--gray-200);border-radius:8px;margin-bottom:10px;cursor:pointer;transition:all .3s;"><input type="checkbox" onchange="toggleSessionSelection('${session.id}')" id="session_${session.id}"><div style="flex:1;"><div style="font-weight:600;color:#2c3e50;">${session.userName} - ${session.userLocation}</div><div style="font-size:.9rem;color:var(--gray-500);">üìÖ Work Date: ${sessionDate} | üîß Mode: ${modeText} | üí∞ $${session.summary.totalSalary.toFixed(2)}</div><div style="font-size:.8rem;color:#94a3b8;">Created: ${createdDate}</div></div></div>`;container.appendChild(div)})}
        function toggleSessionSelection(id){const cb=document.getElementById(`session_${id}`);if(cb.checked){if(!selectedSessions.includes(id))selectedSessions.push(id)}else{selectedSessions=selectedSessions.filter(x=>x!==id)}document.getElementById('generateCompareBtn').disabled=selectedSessions.length<2}
        function generateComparison(){if(selectedSessions.length<2){showMessage('‚ùå Please select at least 2 sessions to compare','error');return}const all=JSON.parse(localStorage.getItem('salaryCalc_sessions')||'[]');const sessions=selectedSessions.map(id=>all.find(s=>s.id===id)).filter(Boolean);comparisonData={sessions: sessions,generatedAt:new Date()};displayComparison(sessions);document.getElementById('exportCompareBtn').disabled=false}
        function displayComparison(sessions){const container=document.getElementById('comparisonContent');let html=`<div style="margin-bottom:30px;"><h5 style="color:var(--primary);margin-bottom:15px;">üìä Summary Comparison</h5><div class="table-container"><table class="table"><thead><tr><th>Employee</th><th>Work Date</th><th>Mode</th><th>Sales ($)</th><th>Hours</th><th>Salary ($)</th><th>Cost (%)</th></tr></thead><tbody>`;sessions.forEach(s=>{const work=new Date(s.sessionDate||s.createdAt).toLocaleDateString();const mode=s.calculationMode==='commission'?'Comm + H Pay':'H Rate';const cost=s.summary.totalSales>0?((s.summary.totalSalary/s.summary.totalSales)*100):0;html+=`<tr><td>${s.userName}</td><td>${work}</td><td>${mode}</td><td>$${s.summary.totalSales.toFixed(2)}</td><td>${formatHoursForDisplay(s.summary.totalHours)}</td><td>$${s.summary.totalSalary.toFixed(2)}</td><td>${cost.toFixed(1)}%</td></tr>`});html+='</tbody></table></div></div>';container.innerHTML=html;document.getElementById('comparisonResults').style.display='block'}
        function exportComparisonPDF(){if(!comparisonData||!comparisonData.sessions){showMessage('‚ùå Please generate comparison first','error');return}const printWindow=window.open('', '_blank');const sessions=comparisonData.sessions;let html=`<!DOCTYPE html><html><head><title>Session Comparison Report</title><style>body{font-family:Arial,sans-serif;margin:20px;color:#333}.header{text-align:center;margin-bottom:30px;border-bottom:2px solid #f5a069;padding-bottom:15px}.header h1{color:#f5a069;margin:0}.summary-table{width:100%;border-collapse:collapse;margin-bottom:30px}.summary-table th,.summary-table td{border:1px solid #ddd;padding:12px;text-align:left}.summary-table th{background-color:#f5a069;color:white}.session-detail{margin-bottom:30px;border:2px solid #f5a069;border-radius:8px;padding:15px}.detail-table{width:100%;border-collapse:collapse;font-size:.9em}.detail-table th,.detail-table td{border:1px solid #ddd;padding:8px}.detail-table th{background-color:#f8f9fa}.total-row{font-weight:bold;background-color:#fff3cd}@media print{body{margin:0}}</style></head><body><div class="header"><h1>üìä Session Comparison Report</h1><div>Generated: ${comparisonData.generatedAt.toLocaleString()}</div><div>Comparing ${sessions.length} sessions</div></div><h2>üìà Summary Comparison</h2><table class="summary-table"><thead><tr><th>Employee</th><th>Work Date</th><th>Calculation Mode</th><th>Total Sales</th><th>Total Hours</th><th>Total Salary</th><th>Cost %</th></tr></thead><tbody>`;sessions.forEach(s=>{const work=new Date(s.sessionDate||s.createdAt).toLocaleDateString();const mode=s.calculationMode==='commission'?'Comm + H Pay':'H Rate';const cost=s.summary.totalSales>0?((s.summary.totalSalary/s.summary.totalSales)*100):0;html+=`<tr><td>${s.userName}</td><td>${work}</td><td>${mode}</td><td>$${s.summary.totalSales.toFixed(2)}</td><td>${formatHoursForDisplay(s.summary.totalHours)}</td><td>$${s.summary.totalSalary.toFixed(2)}</td><td>${cost.toFixed(1)}%</td></tr>`});html+='</tbody></table></body></html>';printWindow.document.write(html);printWindow.document.close();setTimeout(()=>{printWindow.print();printWindow.close()},500);showMessage('‚úÖ PDF export opened. Use your browser\'s print dialog to save as PDF','success')}
        function exportResults(){if(combinedData.length===0){showMessage('‚ùå No data to export','error');return}const html=generateHTMLTable();const blob=new Blob([html],{type:'text/html'});const url=URL.createObjectURL(blob);const a=document.createElement('a');a.href=url;a.download=`salary-report-${currentUser.name}-${new Date().toISOString().split('T')[0]}.html`;document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showMessage('‚úÖ Report exported successfully','success')}
        function copyResults(){if(combinedData.length===0){showMessage('‚ùå No data to copy','error');return}const text=generateTextTable();navigator.clipboard.writeText(text).then(()=>{showMessage('‚úÖ Data copied to clipboard','success')}).catch(()=>{showMessage('‚ùå Failed to copy data','error')})}
        function convertExcelDate(excelDate){let d;if(typeof excelDate==='string'){d=new Date(excelDate)}else{const epoch=new Date(1899,11,30);d=new Date(epoch.getTime()+excelDate*86400*1000)}const y=d.getFullYear();const m=String(d.getMonth()+1).padStart(2,'0');const day=String(d.getDate()).padStart(2,'0');return `${y}-${m}-${day}`}
        function formatDateForDisplay(standardDate){const d=new Date(standardDate+'T00:00:00');return d.toLocaleDateString('en-US',{year:'numeric',month:'short',day:'numeric'})}
        function parseHoursInput(input){if(typeof input==='number')return input;const str=input.toString().trim();if(str.includes(':')){const [h,min]=str.split(':').map(Number);return h+(min/60)}return parseFloat(str)||0}
        function formatHoursForDisplay(hours){if(!hours||hours===0)return '0:00';const wh=Math.floor(hours);const m=Math.round((hours-wh)*60);return `${wh}:${m.toString().padStart(2,'0')}`}
        function generateHTMLTable(){return `<!DOCTYPE html><html><head><title>Salary Report - ${currentUser.name}</title><style>body{font-family:Inter,sans-serif;margin:20px;color:#2c3e50}h1{color:#f5a069;border-bottom:2px solid #f5a069;padding-bottom:10px}table{width:100%;border-collapse:collapse;margin:20px 0}th,td{padding:12px;text-align:center;border:2px solid #f5a069}th{background:#f5a069;color:white;font-weight:600}tr:nth-child(even){background:#f8f9fa}.summary{background:#fff3e0;font-weight:bold}</style></head><body><h1>üíº Salary Report - ${currentUser.name}</h1><p><strong>Location:</strong> ${currentUser.location}</p><p><strong>Generated:</strong> ${new Date().toLocaleDateString()}</p>${document.getElementById('salaryResultsTable').outerHTML}</body></html>`}
        function generateTextTable(){const headers=['Date','Sales','Rate','Hours','Salary','Cost %'];let text=`Salary Report - ${currentUser.name}\n`;text+=`Generated: ${new Date().toLocaleDateString()}\n\n`;text+=headers.join('\t')+'\n';combinedData.forEach(row=>{const cost=row.sales>0?(row.salary/row.sales*100):0;const rateDisplay=row.tierType==='commission'?`${((row.salary/row.sales)*100).toFixed(1)}%`:`$${row.rate.toFixed(2)}/hr`;text+=[row.date,`$${row.sales.toFixed(2)}`,rateDisplay,formatHoursForDisplay(row.hours),`$${row.salary.toFixed(2)}`,`${cost.toFixed(1)}%`].join('\t')+'\n'});return text}
        function showDataTab(which){const hours=document.getElementById('tabHours');const sales=document.getElementById('tabSales');const demos=document.getElementById('tabDemos');hours.classList.add('hidden');sales.classList.add('hidden');demos.classList.add('hidden');if(which==='hours'){hours.classList.remove('hidden')}else if(which==='sales'){sales.classList.remove('hidden')}else{demos.classList.remove('hidden')}}
        function toggleEmployeeProfile(){const content=document.getElementById('userInfoDisplay');const btn=document.getElementById('profileToggleBtn');if(content.classList.contains('hidden')){content.classList.remove('hidden');btn.innerHTML='üôà Hide Profile'}else{content.classList.add('hidden');btn.innerHTML='üëÅÔ∏è Show Profile'}}
        window.addEventListener('load',function(){const id=sessionStorage.getItem('loadSessionId');if(id){sessionStorage.removeItem('loadSessionId');const sessions=JSON.parse(localStorage.getItem('salaryCalc_sessions')||'[]');const session=sessions.find(s=>s.id===id);if(session){currentUser=users.find(u=>u.id===session.userId);if(currentUser){document.getElementById('userSelect').value=currentUser.id;displayUserInfo();combinedData=[...session.data];displayCombinedData();displaySalaryResults();showMessage(`‚úÖ Session loaded: ${session.userName}`,'success')}}}});
        
    </script>
</body>
</html>