<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Analytics Hub - MonuMe Performance</title>
    <link rel="icon" type="image/png" href="/icon.png">
    
    <!-- Modern Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <!-- Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        /* ===== CORE VARIABLES ===== */
        :root {
            /* Main Orange Theme - Matching MonuMe branding */
            --main-color: #ff9562;
            --primary-color: #ff9562;
            --primary-color-rgb: 255, 149, 98;
            --gradient-start: #ff7f42;
            --gradient-end: #ff9562;
            
            /* Classic Light Theme */
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-tertiary: #f3f4f6;
            --text-primary: #333333;
            --text-secondary: #666666;
            --text-light: #f8f9fa;
            --text-accent: var(--main-color);
            
            /* Card Colors */
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-hover-bg: rgba(255, 255, 255, 0.95);
            --card-border: rgba(255, 255, 255, 0.2);
            --card-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            
            /* Sidebar */
            --sidebar-bg: #272430;
            
            /* Modern spacing */
            --space-xs: 0.5rem;
            --space-sm: 1rem;
            --space-md: 1.5rem;
            --space-lg: 2rem;
            --space-xl: 3rem;
            
            /* Shadows */
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 10px 25px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.15);
            
            /* Border radius */
            --border-radius: 16px;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            
            /* Animations */
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --transition-fast: 0.2s ease;
            --transition-smooth: 0.4s cubic-bezier(0.4, 0.0, 0.2, 1);
        }

        /* ===== GLOBAL RESET ===== */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1500"><rect fill="%23ff9562" width="2000" height="1500"/><defs><radialGradient id="a" gradientUnits="objectBoundingBox"><stop offset="0" stop-color="%23ffffff"/><stop offset="1" stop-color="%23ff9562"/></radialGradient><linearGradient id="b" gradientUnits="userSpaceOnUse" x1="0" y1="750" x2="1550" y2="750"><stop offset="0" stop-color="%23ffcab1"/><stop offset="1" stop-color="%23ff9562"/></linearGradient></defs><path fill="url(%23a)" d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z"/><path d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z" fill="url(%23b)"/></svg>') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary);
            overflow-x: hidden;
            min-height: 100vh;
            position: relative;
            margin: 0;
            padding: 0;
        }

        /* ===== LAYOUT ===== */
        .dashboard {
            display: flex;
            min-height: 100vh;
        }

        /* ===== SIDEBAR ===== */
        .sidebar {
            width: 280px;
            background: var(--sidebar-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transition: var(--transition);
            z-index: 100;
            box-shadow: var(--shadow-md);
            border-right: 1px solid rgba(255, 255, 255, 0.05);
            padding: var(--space-lg);
            overflow-y: auto;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-toggle {
            position: absolute;
            top: var(--space-lg);
            right: -40px;
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border: 2px solid var(--main-color);
            border-radius: 50%;
            color: var(--main-color);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition-smooth);
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }

        .sidebar-toggle:hover {
            background: var(--main-color);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(255, 149, 98, 0.4);
        }

        .sidebar-header {
            padding: 35px 25px 15px;
            border-bottom: none;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 30px;
            background: transparent;
            box-shadow: none;
            position: relative;
        }

        .sidebar-header:after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 15%;
            width: 70%;
            height: 1px;
            background: linear-gradient(to right, transparent, rgba(255, 255, 255, 0.1), transparent);
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .sidebar-brand a {
            text-decoration: none;
            border-bottom: none;
            box-shadow: none;
            outline: none;
        }

        .sidebar-title {
            color: var(--main-color);
            font-size: 42px;
            font-weight: 800;
            font-family: 'Poppins', 'Segoe UI', sans-serif;
            text-shadow: none;
            letter-spacing: 1px;
            margin: 0;
            transition: transform 0.3s ease;
            text-align: center;
            background: linear-gradient(135deg, var(--main-color), var(--gradient-start));
            background-clip: text;
            -webkit-background-clip: text;
            color: transparent;
            border: none;
            padding: 5px 10px;
            border-radius: 18px;
        }
        
        .sidebar-title:hover {
            transform: scale(1.05);
        }

        .sidebar-menu {
            list-style: none;
            padding: 0 15px;
            margin-top: 30px;
        }

        .sidebar-menu li {
            margin-bottom: 10px;
            border-radius: 12px;
            overflow: hidden;
            transition: var(--transition);
        }

        .sidebar-menu li a {
            display: flex;
            align-items: center;
            padding: 16px 20px;
            color: rgba(255, 255, 255, 0.8);
            text-decoration: none;
            font-size: 16px;
            border-radius: 12px;
            font-weight: 500;
            transition: var(--transition);
            position: relative;
            z-index: 1;
        }

        .sidebar-menu li a i {
            min-width: 24px;
            margin-right: 15px;
            font-size: 18px;
            transition: transform 0.3s ease;
        }

        .sidebar-menu li a::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 0;
            height: 100%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            opacity: 0.8;
            z-index: -1;
            transition: width 0.3s ease;
            border-radius: 12px;
        }

        .sidebar-menu li:hover a::before,
        .sidebar-menu li.active a::before {
            width: 100%;
        }

        .sidebar-menu li:hover a,
        .sidebar-menu li.active a {
            color: white;
            transform: translateX(5px);
        }
        
        .sidebar-menu li:hover a i,
        .sidebar-menu li.active a i {
            transform: scale(1.2);
        }

        .filter-section {
            margin-bottom: var(--space-lg);
            padding: var(--space-md);
            background: var(--card-bg);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            backdrop-filter: blur(15px);
            position: relative;
            transition: var(--transition);
            box-shadow: var(--shadow-sm);
        }

        .filter-section:hover {
            background: var(--card-hover-bg);
            border-color: rgba(255, 149, 98, 0.3);
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .filter-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--main-color), var(--gradient-start));
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            opacity: 0.8;
        }

        .filter-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: var(--space-sm);
            font-size: 1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .filter-title i {
            opacity: 0.8;
        }

        .filter-count {
            background: rgba(255, 149, 98, 0.2);
            color: var(--main-color);
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 0.7rem;
            font-weight: 700;
            margin-left: auto;
        }

        .filter-help {
            margin-top: 5px;
            opacity: 0.7;
        }

        .filter-help small {
            color: var(--text-secondary);
            font-size: 0.75rem;
            font-style: italic;
        }

        .filter-select[multiple] {
            min-height: 80px;
            padding: 8px 12px;
        }

        .filter-select[multiple] option {
            padding: 5px;
            border-radius: 4px;
            margin: 2px 0;
        }

        .filter-select[multiple] option:checked {
            background: var(--main-color) !important;
            color: white !important;
        }

        .filter-input, .filter-select {
            width: 100%;
            padding: 12px 16px;
            background: white;
            border: 2px solid var(--border-color);
            border-radius: var(--radius-md);
            color: var(--text-primary);
            font-family: 'Poppins', sans-serif;
            font-weight: 500;
            font-size: 14px;
            transition: var(--transition);
            margin-bottom: var(--space-sm);
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%23ff9562' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
            background-repeat: no-repeat;
            background-position: right 12px center;
            background-size: 16px;
            padding-right: 40px;
        }

        .filter-input:focus, .filter-select:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.1);
            background: white;
            transform: translateY(-1px);
        }

        .filter-select option {
            background: var(--bg-secondary);
            color: var(--text-primary);
            padding: 10px;
            border: none;
        }

        .filter-select option:checked {
            background: var(--main-color);
            color: white;
        }

        /* ===== MAIN CONTENT ===== */
        .main-content {
            margin-left: 280px;
            width: calc(100% - 280px);
            padding: 40px;
            transition: var(--transition);
            display: block;
            min-height: 100vh;
            position: relative;
            z-index: 1;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
        }

        .dashboard-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-xl);
            padding: var(--space-lg);
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--card-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-sm);
        }

        .dashboard-title {
            font-family: 'Poppins', sans-serif;
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .export-buttons {
            display: flex;
            gap: var(--space-sm);
        }

        .export-btn {
            padding: var(--space-sm) var(--space-md);
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            border-radius: var(--radius-md);
            color: white;
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
            overflow: hidden;
        }

        .export-btn::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transform: rotate(45deg);
            transition: var(--transition-smooth);
            opacity: 0;
        }

        .export-btn:hover::before {
            animation: shine 0.6s ease-in-out;
        }

        .export-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(255, 149, 98, 0.4);
        }

        @keyframes shine {
            0% { transform: translateX(-100%) rotate(45deg); opacity: 0; }
            50% { opacity: 1; }
            100% { transform: translateX(100%) rotate(45deg); opacity: 0; }
        }

        /* ===== METRICS GRID ===== */
        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 149, 98, 0.2);
            border-radius: var(--border-radius);
            padding: var(--space-lg);
            position: relative;
            overflow: hidden;
            transition: var(--transition);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .metric-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--main-color), var(--gradient-start), var(--gradient-end), var(--neon-orange-light));
            background-size: 200% 100%;
            animation: gradientShift 3s ease-in-out infinite;
        }

        @keyframes gradientShift {
            0% { background-position: 200% 0; }
            100% { background-position: -200% 0; }
        }

        .metric-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(255, 149, 98, 0.3);
            background: var(--card-hover-bg);
        }

        .metric-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .metric-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--text-secondary);
            font-size: 1rem;
        }

        .metric-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            color: white;
        }

        .metric-icon.opal-demos { background: linear-gradient(45deg, var(--main-color), var(--neon-orange-light)); }
        .metric-icon.opal-sales { background: linear-gradient(45deg, var(--gradient-start), var(--main-color)); }
        .metric-icon.scan-demos { background: linear-gradient(45deg, var(--neon-orange-dark), var(--gradient-end)); }
        .metric-icon.scan-sold { background: linear-gradient(45deg, var(--gradient-end), var(--neon-orange-light)); }

        .metric-value {
            font-family: 'Poppins', sans-serif;
            font-size: 3.5rem;
            font-weight: 800;
            color: var(--main-color);
            margin-bottom: var(--space-xs);
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .metric-change {
            font-family: 'Poppins', sans-serif;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .metric-change.positive { color: #4CAF50; }
        .metric-change.negative { color: #f44336; }

        /* ===== USER COMPARISON SECTION ===== */
        .user-comparison-section {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 149, 98, 0.2);
            border-radius: var(--border-radius);
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .user-comparison-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--main-color), var(--gradient-start), var(--gradient-end));
            border-radius: var(--border-radius) var(--border-radius) 0 0;
            opacity: 0.8;
        }

        .comparison-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-lg);
            flex-wrap: wrap;
            gap: var(--space-md);
        }

        .section-title {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 1.4rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .comparison-count {
            background: rgba(255, 149, 98, 0.2);
            color: var(--main-color);
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-left: 10px;
        }

        .comparison-controls {
            display: flex;
            gap: 10px;
        }

        .comparison-btn {
            padding: 8px 16px;
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            border: none;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition-smooth);
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 0.9rem;
        }

        .comparison-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 149, 98, 0.3);
        }

        .comparison-btn.active {
            background: var(--main-color);
            box-shadow: 0 4px 15px rgba(255, 149, 98, 0.4);
        }

        .no-comparison {
            text-align: center;
            padding: var(--space-xl);
            color: var(--text-secondary);
        }

        .no-comparison i {
            font-size: 3rem;
            color: var(--main-color);
            opacity: 0.5;
            margin-bottom: var(--space-md);
        }

        .no-comparison h4 {
            margin-bottom: var(--space-sm);
            color: var(--text-primary);
        }

        /* User Comparison Table */
        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--radius-md);
            overflow: hidden;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
            font-size: 14px;
        }

        .comparison-table th {
            background: linear-gradient(135deg, var(--main-color), var(--gradient-start));
            color: white;
            padding: 18px 15px;
            text-align: left;
            font-weight: 700;
            font-family: 'Poppins', sans-serif;
            font-size: 15px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .comparison-table td {
            padding: 16px 15px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
            font-weight: 500;
        }

        .comparison-table tr:hover {
            background: rgba(255, 149, 98, 0.05);
        }

        .comparison-table .user-name {
            font-weight: 600;
            color: var(--main-color);
        }

        .comparison-table .metric-value {
            font-weight: 600;
            text-align: center;
        }

        /* User Comparison Cards */
        .comparison-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: var(--space-lg);
        }

        .user-card {
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            padding: var(--space-lg);
            position: relative;
            transition: var(--transition-smooth);
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--main-color), var(--gradient-end));
            border-radius: 16px 16px 0 0;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(255, 149, 98, 0.2);
        }

        .user-card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: var(--space-md);
        }

        .user-card-name {
            font-weight: 700;
            color: var(--main-color);
            font-size: 1.2rem;
        }

        .user-card-location {
            background: rgba(255, 149, 98, 0.2);
            color: var(--main-color);
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .user-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--space-sm);
        }

        .user-metric {
            text-align: center;
            padding: var(--space-sm);
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
        }

        .user-metric-label {
            font-size: 0.8rem;
            color: var(--text-secondary);
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .user-metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--main-color);
        }

        .user-total-score {
            margin-top: var(--space-md);
            padding: var(--space-sm);
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
            border-radius: 8px;
            text-align: center;
            color: white;
        }

        .user-total-score .score-label {
            font-size: 0.8rem;
            opacity: 0.9;
        }

        .user-total-score .score-value {
            font-size: 1.6rem;
            font-weight: 700;
            margin-top: 4px;
        }

        /* ===== CHARTS SECTION ===== */
        .charts-section {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: var(--space-lg);
            margin-bottom: var(--space-xl);
        }

        .chart-container {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 149, 98, 0.2);
            border-radius: 20px;
            padding: var(--space-lg);
            position: relative;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .chart-title {
            font-family: 'Exo', sans-serif;
            font-weight: 600;
            color: var(--main-color);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .chart-canvas {
            max-height: 500px;
            min-height: 400px;
            width: 100% !important;
            height: auto !important;
        }

        /* ===== CONVERSION RATE CARD ===== */
        .conversion-card {
            text-align: center;
        }

        .donut-container {
            position: relative;
            width: 200px;
            height: 200px;
            margin: 0 auto var(--space-md);
        }

        .donut-chart {
            width: 100%;
            height: 100%;
        }

        .donut-center {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-family: 'Orbitron', monospace;
            font-weight: 900;
            font-size: 2rem;
            color: var(--main-color);
            text-shadow: 0 0 15px rgba(255, 149, 98, 0.7);
        }

        /* ===== TIMELINE VIEW ===== */
        .timeline-section {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border: 2px solid rgba(255, 149, 98, 0.2);
            border-radius: 20px;
            padding: var(--space-lg);
            margin-bottom: var(--space-xl);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.15);
        }

        .timeline-header {
            font-family: 'Exo', sans-serif;
            font-weight: 600;
            color: var(--main-color);
            margin-bottom: var(--space-md);
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .timeline-item {
            display: flex;
            align-items: center;
            padding: var(--space-md);
            margin-bottom: var(--space-sm);
            background: rgba(255, 149, 98, 0.05);
            border: 1px solid rgba(255, 149, 98, 0.1);
            border-radius: 12px;
            transition: var(--transition-fast);
        }

        .timeline-item:hover {
            background: rgba(255, 149, 98, 0.1);
            border-color: rgba(255, 149, 98, 0.3);
            transform: translateX(5px);
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.2);
        }

        .timeline-time {
            font-family: 'Poppins', sans-serif;
            font-weight: 700;
            color: var(--main-color);
            margin-right: var(--space-md);
            min-width: 100px;
            font-size: 14px;
        }

        .timeline-event {
            flex: 1;
            color: var(--text-primary);
            font-weight: 500;
            font-size: 15px;
        }

        .timeline-value {
            font-weight: 700;
            color: var(--main-color);
            font-size: 16px;
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 1024px) {
            .charts-section {
                grid-template-columns: 1fr;
            }
            
            .dashboard-title {
                font-size: 2rem;
            }
            
            .metrics-grid {
                grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                position: fixed;
                z-index: 1000;
                height: 100vh;
                transform: translateX(-100%);
            }
            
            .sidebar.open {
                transform: translateX(0);
            }
            
            .main-content {
                margin-left: 0;
                width: 100%;
                padding: var(--space-sm);
            }
            
            .dashboard-header {
                flex-direction: column;
                gap: var(--space-md);
                text-align: center;
            }
            
            .dashboard-title {
                font-size: 1.8rem;
            }
            
            .metrics-grid {
                grid-template-columns: 1fr;
                gap: var(--space-md);
            }
            
            .metric-value {
                font-size: 2.5rem;
            }
            
            .chart-canvas {
                max-height: 300px;
                min-height: 250px;
            }
            
            .comparison-table {
                font-size: 12px;
            }
            
            .comparison-table th,
            .comparison-table td {
                padding: 10px 8px;
            }
            
            #mobileMenuToggle {
                display: block !important;
            }
            
            .sidebar-toggle {
                display: none;
            }
        }

        /* ===== LOADING ANIMATIONS ===== */
        .loading-shimmer {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.1) 0%, 
                rgba(255, 255, 255, 0.2) 50%, 
                rgba(255, 255, 255, 0.1) 100%);
            background-size: 200% 100%;
            animation: shimmer 1.5s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* ===== SCROLLBAR STYLING ===== */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(45deg, var(--main-color), var(--gradient-start));
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(45deg, var(--gradient-start), var(--gradient-end));
        }

        /* ===== ENHANCED VISIBILITY ===== */
        .dashboard-title {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section-title {
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .metric-title {
            font-weight: 700;
            color: var(--text-primary);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }

        .chart-title {
            font-weight: 700;
            color: var(--main-color);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        .timeline-header {
            font-weight: 700;
            color: var(--main-color);
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
        }

        /* ===== BETTER CONTRAST ===== */
        .filter-input, .filter-select {
            background: white !important;
            color: var(--text-primary) !important;
            border: 2px solid rgba(255, 149, 98, 0.3) !important;
        }

        .filter-input:focus, .filter-select:focus {
            border-color: var(--main-color) !important;
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.2) !important;
        }

        /* ===== ENHANCED BUTTONS ===== */
        .export-btn {
            font-weight: 700;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
        }

        .export-btn:hover {
            box-shadow: 0 6px 20px rgba(255, 149, 98, 0.4);
        }
    </style>
</head>

<body>
    <div class="dashboard">
        <!-- Sidebar with Filters -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-toggle" onclick="toggleSidebar()">
                <i class="fas fa-bars"></i>
            </div>
            
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <a href="dashboard.html">
                    <div class="sidebar-title">MonuMe</div>
                </a>
            </div>
        </div>
        
        <!-- Navigation Menu -->
        <ul class="sidebar-menu">
            <li><a href="dashboard.html"><i class="fas fa-chart-pie"></i> Dashboard</a></li>
            <li class="active"><a href="analytics.html"><i class="fas fa-chart-bar"></i> Analytics</a></li>
            <li><a href="clients.html"><i class="fas fa-users"></i> Clients</a></li>
            <li><a href="appointments.html"><i class="fas fa-calendar"></i> Appointments</a></li>
            <li><a href="services.html"><i class="fas fa-concierge-bell"></i> Services</a></li>
            <li><a href="locations.html"><i class="fas fa-map-marker-alt"></i> Locations</a></li>
            <li><a href="reports.html"><i class="fas fa-file-alt"></i> Reports</a></li>
            <li><a href="settings.html"><i class="fas fa-cog"></i> Settings</a></li>
            <li><a href="#" onclick="logout()"><i class="fas fa-sign-out-alt"></i> Logout</a></li>
        </ul>
            
            <!-- Date Range Filter -->
            <div class="filter-section">
                <h3 class="filter-title"><i class="fas fa-calendar-alt"></i> Date Range</h3>
                <input type="date" class="filter-input" id="startDate" placeholder="Start Date">
                <input type="date" class="filter-input" id="endDate" placeholder="End Date">
                <button class="export-btn" onclick="applyDateFilter()" style="width: 100%; margin-top: 10px;">
                    <i class="fas fa-filter"></i> Apply Filter
                </button>
        </div>
            
            <!-- User Selector -->
            <div class="filter-section">
                <h3 class="filter-title">
                    <i class="fas fa-user-tie"></i> Sales Rep 
                    <span class="filter-count" id="userCount">0</span>
                </h3>
                <select class="filter-select" id="userFilter" multiple>
                    <option value="">All Users</option>
                </select>
                <div class="filter-help">
                    <small>Hold Ctrl/Cmd to select multiple users</small>
                </div>
    </div>

            <!-- Location Filter -->
            <div class="filter-section">
                <h3 class="filter-title">
                    <i class="fas fa-map-marker-alt"></i> Location 
                    <span class="filter-count" id="locationCount">0</span>
                </h3>
                <select class="filter-select" id="locationFilter">
                    <option value="">All Locations</option>
                </select>
            </div>
            
                        <!-- Quick Actions -->
            <div class="filter-section">
                <h3 class="filter-title">Quick Actions</h3>
                <button class="export-btn" onclick="refreshData()" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
                <button class="export-btn" onclick="resetFilters()" style="width: 100%; margin-bottom: 10px;">
                    <i class="fas fa-undo"></i> Reset Filters
                </button>
                <button class="export-btn" onclick="verifyDataSources()" style="width: 100%;">
                    <i class="fas fa-search"></i> Verify Data
                </button>
            </div>
                    </div>

    <!-- Main Content -->
    <div class="main-content">
            <!-- Dashboard Header -->
            <div class="dashboard-header">
                <div style="display: flex; align-items: center; gap: 20px;">
                    <button class="export-btn" onclick="goBackToManagement()" style="background: rgba(255,255,255,0.1); border: 1px solid var(--main-color);">
                        <i class="fas fa-arrow-left"></i> Back to Management
                    </button>
                    <h1 class="dashboard-title">Analytics Hub</h1>
                </div>
                <div class="export-buttons">
                    <button class="export-btn" onclick="exportToPDF()">
                        <i class="fas fa-file-pdf"></i> Export PDF
                    </button>
                    <button class="export-btn" onclick="exportToCSV()">
                        <i class="fas fa-file-csv"></i> Export CSV
                    </button>
                    <button class="export-btn" onclick="toggleSidebar()" style="display: none;" id="mobileMenuToggle">
                        <i class="fas fa-bars"></i> Menu
                    </button>
                </div>
            </div>
            
            <!-- Key Metrics -->
            <div class="metrics-grid">
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Opal Demos</h3>
                        <div class="metric-icon opal-demos">
                            <i class="fas fa-eye"></i>
                    </div>
                    </div>
                    <div class="metric-value" id="opalDemosCount">0</div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="opalDemosChange">+0%</span> from last period
                </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Opal Sales</h3>
                        <div class="metric-icon opal-sales">
                            <i class="fas fa-check-circle"></i>
                    </div>
                </div>
                    <div class="metric-value" id="opalSalesCount">0</div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="opalSalesChange">+0%</span> from last period
            </div>
        </div>

                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Scan Demos</h3>
                        <div class="metric-icon scan-demos">
                            <i class="fas fa-qrcode"></i>
                    </div>
                </div>
                    <div class="metric-value" id="scanDemosCount">0</div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="scanDemosChange">+0%</span> from last period
                    </div>
                </div>
                
                <div class="metric-card">
                    <div class="metric-header">
                        <h3 class="metric-title">Scan Sold</h3>
                        <div class="metric-icon scan-sold">
                            <i class="fas fa-shopping-cart"></i>
                    </div>
                    </div>
                    <div class="metric-value" id="scanSoldCount">0</div>
                    <div class="metric-change positive">
                        <i class="fas fa-arrow-up"></i>
                        <span id="scanSoldChange">+0%</span> from last period
                </div>
            </div>
        </div>
        
                        <!-- User Comparison Section -->
            <div class="user-comparison-section">
                <div class="comparison-header">
                    <h3 class="section-title">
                        <i class="fas fa-users"></i>
                        User Performance Comparison
                        <span class="comparison-count" id="comparisonCount">0 users selected</span>
                    </h3>
                    <div class="comparison-controls">
                        <button class="comparison-btn" onclick="toggleComparisonView('table')">
                            <i class="fas fa-table"></i> Table View
                        </button>
                        <button class="comparison-btn" onclick="toggleComparisonView('cards')">
                            <i class="fas fa-th-large"></i> Card View
                        </button>
                        <button class="comparison-btn" onclick="exportComparison()">
                            <i class="fas fa-download"></i> Export
                        </button>
                    </div>
                </div>
                
                <div id="userComparisonContent">
                    <div class="no-comparison">
                        <i class="fas fa-users-slash"></i>
                        <h4>No users selected for comparison</h4>
                        <p>Select users from the sidebar to compare their performance</p>
                    </div>
                </div>
            </div>

            <!-- Charts Section -->
            <div class="charts-section">
                <div class="chart-container">
                    <h3 class="chart-title">Performance Trends</h3>
                    <canvas id="trendsChart" class="chart-canvas"></canvas>
                </div>
                
                <div class="chart-container conversion-card">
                    <h3 class="chart-title">Conversion Rates</h3>
                    <div class="donut-container">
                        <canvas id="conversionChart" class="donut-chart"></canvas>
                        <div class="donut-center" id="conversionRate">0%</div>
                    </div>
                    <div style="margin-top: 20px;">
                        <div style="color: #4CAF50; margin-bottom: 5px;">
                            <i class="fas fa-circle" style="font-size: 0.8rem;"></i>
                            Opal: <span id="opalConversion">0%</span>
                        </div>
                        <div style="color: var(--main-color);">
                            <i class="fas fa-circle" style="font-size: 0.8rem;"></i>
                            Scan: <span id="scanConversion">0%</span>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Timeline Section -->
            <div class="timeline-section">
                <h3 class="timeline-header">Recent Activity Timeline</h3>
                <div id="timelineContainer">
                    <div class="timeline-item">
                        <div class="timeline-time">--:--</div>
                        <div class="timeline-event">
                            No recent activity found. Start tracking to see data here.
            </div>
        </div>
            </div>
            </div>
        </div>
    </div>

    <script>
        // ===== UTILITY FUNCTIONS =====
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                localStorage.removeItem("username");
                localStorage.removeItem("isLoggedIn");
                localStorage.removeItem("isAdmin");
                localStorage.removeItem("currentLocationCode");
                localStorage.removeItem("adminDashboardMode");
                
                // If we're in a location context, redirect to main login
                if (currentLocationContext && currentLocationContext.url_name) {
                    window.location.href = "/login";
                } else {
                    window.location.href = "index.html";
                }
            }
        }
        
        // ===== GLOBAL VARIABLES =====
        let trendsChart, conversionChart;
        let currentData = {
            opalDemos: 0,
            opalSales: 0,
            scanDemos: 0,
            scanSold: 0
        };
        
        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing Analytics Dashboard...');
            
            // Check for location context from URL or window context
            checkLocationContext();
            
            initializeDashboard();
            
            // Load locations first, then users (so users can show location names)
            await loadLocations();
            await loadUsers();
            
            loadAnalyticsData();
            setDefaultDates();
            
            // Initialize comparison view
            initializeComparisonView();
            
            // Verify data sources integration
            verifyDataSources();
            
            // Auto-refresh every 30 seconds
            setInterval(refreshData, 30000);
            
            console.log('✅ Analytics Dashboard initialized successfully');
        });
        
        // ===== LOCATION CONTEXT HANDLING =====
        let currentLocationContext = null;
        
        function checkLocationContext() {
            // Check for location context from window object (set by server)
            if (window.LOCATION_CONTEXT) {
                currentLocationContext = window.LOCATION_CONTEXT;
                console.log('📍 Location context from server:', currentLocationContext);
            }
            
            // Check for location parameters in URL
            const urlParams = new URLSearchParams(window.location.search);
            const locationId = urlParams.get('location');
            const locationName = urlParams.get('name');
            const locationUrlName = urlParams.get('url_name');
            
            if (locationId || locationName || locationUrlName) {
                currentLocationContext = {
                    id: locationId,
                    name: locationName,
                    url_name: locationUrlName
                };
                console.log('📍 Location context from URL:', currentLocationContext);
            }
            
            // Update UI based on location context
            if (currentLocationContext) {
                updateLocationUI();
            }
        }
        
        function updateLocationUI() {
            if (!currentLocationContext) return;
            
            // Update page title
            const title = document.querySelector('title');
            if (title && currentLocationContext.name) {
                title.textContent = `${currentLocationContext.name} - Analytics Hub - MonuMe Performance`;
            }
            
            // Update dashboard title
            const dashboardTitle = document.querySelector('.dashboard-title');
            if (dashboardTitle && currentLocationContext.name) {
                dashboardTitle.textContent = `${currentLocationContext.name} Analytics Hub`;
            }
            
            // Update navigation links to be location-specific
            updateNavigationLinks();
            
            // Pre-select location in filter
            if (currentLocationContext.id) {
                setTimeout(() => {
                    const locationSelect = document.getElementById('locationFilter');
                    if (locationSelect) {
                        locationSelect.value = currentLocationContext.id;
                        // Trigger location filtering after a short delay to ensure data is loaded
                        setTimeout(() => {
                            filterUsersByLocation();
                        }, 500);
                    }
                }, 1000); // Wait for locations to load
            }
        }
        
        function updateNavigationLinks() {
            if (!currentLocationContext || !currentLocationContext.url_name) return;
            
            // Update sidebar navigation links to be location-specific
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('http') && !href.startsWith('#') && !href.includes('logout')) {
                    // Convert to location-specific URL
                    const newHref = `/location/${currentLocationContext.url_name}${href.replace('.html', '')}`;
                    link.setAttribute('href', newHref);
                }
            });
            
            // Update "Back to Management" button
            const backButton = document.querySelector('[onclick="goBackToManagement()"]');
            if (backButton) {
                backButton.onclick = function() {
                    window.location.href = `/location/${currentLocationContext.url_name}/management`;
                };
            }
            
            // Update logout link to go to main login page
            const logoutLink = document.querySelector('.sidebar-menu a[onclick="logout()"]');
            if (logoutLink) {
                logoutLink.onclick = function() {
                    logout();
                };
            }
        }
        
        function initializeComparisonView() {
            // Set cards view as default active
            document.querySelector(`[onclick="toggleComparisonView('cards')"]`).classList.add('active');
            currentComparisonView = 'cards';
        }
        
        function initializeDashboard() {
            console.log('🚀 Initializing Futuristic Analytics Dashboard');
            
            // Initialize charts
            initializeTrendsChart();
            initializeConversionChart();
            
            // Start counter animations
            setTimeout(() => {
                animateCounters();
            }, 500);
        }
        
        // ===== SIDEBAR FUNCTIONALITY =====
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('collapsed');
            
            // Change icon
            const toggle = document.querySelector('.sidebar-toggle i');
            if (sidebar.classList.contains('collapsed')) {
                toggle.className = 'fas fa-arrow-right';
                } else {
                toggle.className = 'fas fa-bars';
            }
        }
        
        // ===== CHARTS INITIALIZATION =====
        function initializeTrendsChart() {
            const ctx = document.getElementById('trendsChart').getContext('2d');
            
            // Create gradient backgrounds
            const gradient1 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient1.addColorStop(0, 'rgba(255, 149, 98, 0.3)');
            gradient1.addColorStop(1, 'rgba(255, 149, 98, 0.05)');
            
            const gradient2 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient2.addColorStop(0, 'rgba(255, 127, 66, 0.3)');
            gradient2.addColorStop(1, 'rgba(255, 127, 66, 0.05)');
            
            const gradient3 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient3.addColorStop(0, 'rgba(255, 176, 136, 0.3)');
            gradient3.addColorStop(1, 'rgba(255, 176, 136, 0.05)');
            
            const gradient4 = ctx.createLinearGradient(0, 0, 0, 400);
            gradient4.addColorStop(0, 'rgba(255, 104, 66, 0.3)');
            gradient4.addColorStop(1, 'rgba(255, 104, 66, 0.05)');
            
            trendsChart = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: ['Week 1', 'Week 2', 'Week 3', 'Week 4'],
                    datasets: [
                        {
                            label: 'Opal Demos',
                            data: [12, 19, 15, 25],
                            borderColor: '#ff9562',
                            backgroundColor: gradient1,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#ff9562',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Opal Sales',
                            data: [8, 12, 10, 18],
                            borderColor: '#ff7f42',
                            backgroundColor: gradient2,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#ff7f42',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Scan Demos',
                            data: [15, 22, 18, 28],
                            borderColor: '#ffb088',
                            backgroundColor: gradient3,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#ffb088',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        },
                        {
                            label: 'Scan Sold',
                            data: [10, 15, 12, 20],
                            borderColor: '#ff6842',
                            backgroundColor: gradient4,
                            borderWidth: 3,
                            fill: true,
                            tension: 0.4,
                            pointBackgroundColor: '#ff6842',
                            pointBorderColor: '#ffffff',
                            pointBorderWidth: 2,
                            pointRadius: 6,
                            pointHoverRadius: 8
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: '#ffffff',
                                font: {
                                    family: 'Exo',
                                    size: 12,
                                    weight: '500'
                                },
                                usePointStyle: true
                            }
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ff9562',
                            bodyColor: '#ffffff',
                            borderColor: '#ff9562',
                            borderWidth: 1,
                            cornerRadius: 12,
                            titleFont: {
                                family: 'Exo',
                                weight: '600'
                            },
                            bodyFont: {
                                family: 'Inter'
                            }
                        }
                    },
                    scales: {
                        x: { 
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            }, 
                            ticks: { 
                                color: '#b0b3b8',
                                font: {
                                    family: 'Inter',
                                    size: 11
                                }
                            }
                        },
                        y: { 
                            grid: { 
                                color: 'rgba(255, 255, 255, 0.1)',
                                drawBorder: false
                            }, 
                            ticks: { 
                                color: '#b0b3b8',
                                font: {
                                    family: 'Inter',
                                    size: 11
                                }
                            }
                        }
                    },
                    interaction: {
                        intersect: false,
                        mode: 'index'
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        function initializeConversionChart() {
            const ctx = document.getElementById('conversionChart').getContext('2d');
            
            conversionChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: ['Opal Conversion', 'Scan Conversion', 'Remaining'],
                    datasets: [{
                        data: [65, 45, 35],
                        backgroundColor: [
                            '#4CAF50',
                            '#ff9562',
                            'rgba(255, 255, 255, 0.1)'
                        ],
                        borderWidth: 0,
                        cutout: '70%'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            display: false
                        },
                        tooltip: {
                            backgroundColor: 'rgba(0, 0, 0, 0.8)',
                            titleColor: '#ff9562',
                            bodyColor: '#ffffff',
                            borderColor: '#ff9562',
                            borderWidth: 1,
                            cornerRadius: 12
                        }
                    },
                    animation: {
                        duration: 2000,
                        easing: 'easeInOutQuart'
                    }
                }
            });
        }
        
        // ===== COUNTER ANIMATIONS =====
        function animateCounters() {
            animateCounter('opalDemosCount', currentData.opalDemos, 2000);
            animateCounter('opalSalesCount', currentData.opalSales, 2200);
            animateCounter('scanDemosCount', currentData.scanDemos, 2400);
            animateCounter('scanSoldCount', currentData.scanSold, 2600);
        }
        
        function animateCounter(elementId, target, duration) {
            const element = document.getElementById(elementId);
            const start = 0;
            const startTime = performance.now();
            
            function updateCounter(currentTime) {
                const elapsed = currentTime - startTime;
                const progress = Math.min(elapsed / duration, 1);
                
                // Easing function for smooth animation
                const easeOut = 1 - Math.pow(1 - progress, 3);
                const current = Math.floor(start + (target - start) * easeOut);
                
                element.textContent = current.toLocaleString();
                
                if (progress < 1) {
                    requestAnimationFrame(updateCounter);
                } else {
                    element.textContent = target.toLocaleString();
                }
            }
            
            requestAnimationFrame(updateCounter);
        }
        
        // ===== DATA LOADING =====
        async function loadAnalyticsData() {
            try {
                console.log('📊 Loading real analytics data...');
                
                // Get current filter values
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                let selectedLocationId = document.getElementById('locationFilter').value;
                
                // If we have location context and no specific location is selected, use the context
                if (currentLocationContext && currentLocationContext.id && !selectedLocationId) {
                    selectedLocationId = currentLocationContext.id;
                    console.log('📍 Using location context for analytics:', selectedLocationId);
                }
                
                console.log('🔍 Applied filters:', {
                    startDate, endDate, selectedLocationId,
                    locationContext: currentLocationContext
                });
                
                // Load real tracking data
                const realData = await loadRealTrackingData(startDate, endDate, selectedLocationId);
                updateDashboardData(realData);
                
            } catch (error) {
                console.error('Error loading analytics data:', error);
                // Fallback to empty data instead of demo data
                updateDashboardData({
                    opalDemos: 0,
                    opalSales: 0,
                    scanDemos: 0,
                    scanSold: 0
                });
            }
        }
        
        async function loadRealTrackingData(startDate, endDate, locationId) {
            let trackingData = [];
            
            try {
                // Try to load from server first
                const response = await fetch('/api/tracking_data');
                if (response.ok) {
                    trackingData = await response.json();
                    console.log('📡 Loaded tracking data from server:', trackingData.length, 'records');
                }
            } catch (error) {
                console.log('Server not available, checking localStorage...');
            }
            
            // Fallback to localStorage
            if (trackingData.length === 0) {
                const localData = JSON.parse(localStorage.getItem('trackingData')) || [];
                trackingData = localData;
                console.log('💾 Loaded tracking data from localStorage:', trackingData.length, 'records');
            }
            
            // Filter data based on criteria
            let filteredData = trackingData;
            
            // Filter by date range
            if (startDate || endDate) {
                filteredData = filteredData.filter(record => {
                    const recordDate = record.date || record.timestamp?.split('T')[0];
                    if (!recordDate) return true; // Include records without dates
                    
                    if (startDate && recordDate < startDate) return false;
                    if (endDate && recordDate > endDate) return false;
                    return true;
                });
            }
            
            // Filter by user(s) - support multiple selection
            const userSelect = document.getElementById('userFilter');
            const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value).filter(v => v);
            
            if (selectedUsers.length > 0) {
                filteredData = filteredData.filter(record => {
                    const recordUserId = record.userId || record.user_id;
                    return selectedUsers.some(selectedId => 
                        recordUserId === selectedId || 
                        recordUserId === parseInt(selectedId) ||
                        recordUserId?.toString() === selectedId
                    );
                });
                console.log('👥 User filter applied for:', selectedUsers.length, 'users');
            }
            
            // Filter by location (filter users first, then their data)
            if (locationId) {
                const usersInLocation = allUsers.filter(user => {
                    const userLocation = user.location || user.locationId || user.location_id;
                    return userLocation === locationId || 
                           userLocation === parseInt(locationId) ||
                           (typeof userLocation === 'string' && userLocation.toLowerCase() === locationId.toLowerCase());
                });
                
                const userIdsInLocation = usersInLocation.map(u => u.id);
                filteredData = filteredData.filter(record => 
                    userIdsInLocation.includes(record.userId) ||
                    userIdsInLocation.includes(record.user_id) ||
                    userIdsInLocation.includes(parseInt(record.user_id))
                );
                
                console.log('🏢 Location filter applied:', {
                    locationId,
                    usersInLocation: usersInLocation.length,
                    filteredRecords: filteredData.length
                });
            }
            
            console.log('✅ Filtered tracking data:', filteredData.length, 'records');
            
            // Aggregate the filtered data
            const aggregatedData = {
                opalDemos: 0,
                opalSales: 0,
                scanDemos: 0,
                scanSold: 0
            };
            
            filteredData.forEach(record => {
                aggregatedData.opalDemos += parseInt(record.opalDemos || record.opal_demos || 0);
                aggregatedData.opalSales += parseInt(record.opalSales || record.opal_sales || 0);
                aggregatedData.scanDemos += parseInt(record.scanDemos || record.scan_demos || 0);
                aggregatedData.scanSold += parseInt(record.scanSold || record.scan_sold || 0);
            });
            
            console.log('📈 Aggregated totals:', aggregatedData);
            
            return aggregatedData;
        }
        
        function updateDashboardData(data) {
            currentData = data;
            
            // Animate counters
            animateCounters();
            
            // Update conversion rates
            const opalConversion = data.opalSales > 0 ? ((data.opalSales / data.opalDemos) * 100).toFixed(1) : 0;
            const scanConversion = data.scanSold > 0 ? ((data.scanSold / data.scanDemos) * 100).toFixed(1) : 0;
            const overallConversion = ((opalConversion + scanConversion) / 2).toFixed(1);
            
            document.getElementById('conversionRate').textContent = overallConversion + '%';
            document.getElementById('opalConversion').textContent = opalConversion + '%';
            document.getElementById('scanConversion').textContent = scanConversion + '%';
            
            // Update conversion chart
            if (conversionChart) {
                conversionChart.data.datasets[0].data = [opalConversion, scanConversion, 100 - overallConversion];
                conversionChart.update('active');
            }
            
            // Update timeline with recent activity
            updateTimelineData();
            
            // Update user comparison
            updateUserComparison();
            
            console.log('📊 Dashboard data updated:', data);
        }
        
        // ===== USER COMPARISON FUNCTIONALITY =====
        let currentComparisonView = 'cards';
        
        function toggleComparisonView(view) {
            currentComparisonView = view;
            
            // Update button states
            document.querySelectorAll('.comparison-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            document.querySelector(`[onclick="toggleComparisonView('${view}')"]`).classList.add('active');
            
            // Update comparison display
            updateUserComparison();
        }
        
        function updateUserComparison() {
            const userSelect = document.getElementById('userFilter');
            const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value).filter(v => v);
            const comparisonContent = document.getElementById('userComparisonContent');
            const comparisonCount = document.getElementById('comparisonCount');
            
            // Update counter
            comparisonCount.textContent = `${selectedUsers.length} user${selectedUsers.length !== 1 ? 's' : ''} selected`;
            
            if (selectedUsers.length === 0) {
                comparisonContent.innerHTML = `
                    <div class="no-comparison">
                        <i class="fas fa-users-slash"></i>
                        <h4>No users selected for comparison</h4>
                        <p>Select users from the sidebar to compare their performance</p>
                    </div>
                `;
                return;
            }
            
            // Get tracking data for selected users
            const trackingData = JSON.parse(localStorage.getItem('trackingData')) || [];
            const userData = getFilteredUserData(selectedUsers, trackingData);
            
            if (currentComparisonView === 'table') {
                comparisonContent.innerHTML = generateComparisonTable(userData);
            } else {
                comparisonContent.innerHTML = generateComparisonCards(userData);
            }
        }
        
        function getFilteredUserData(selectedUsers, trackingData) {
            const userData = {};
            
            selectedUsers.forEach(userId => {
                const user = allUsers.find(u => u.id === userId);
                if (!user) return;
                
                const userRecords = trackingData.filter(record => {
                    const recordUserId = record.userId || record.user_id;
                    return recordUserId === userId || recordUserId === parseInt(userId) || recordUserId?.toString() === userId;
                });
                
                const aggregated = {
                    opal_demos: 0,
                    opal_sales: 0,
                    scan_demos: 0,
                    scan_sold: 0,
                    net_sales: 0,
                    hours_worked: 0,
                    sessions: userRecords.length
                };
                
                userRecords.forEach(record => {
                    aggregated.opal_demos += parseInt(record.opal_demos || 0);
                    aggregated.opal_sales += parseInt(record.opal_sales || 0);
                    aggregated.scan_demos += parseInt(record.scan_demos || 0);
                    aggregated.scan_sold += parseInt(record.scan_sold || 0);
                    aggregated.net_sales += parseFloat(record.net_sales || 0);
                    aggregated.hours_worked += parseFloat(record.hours_worked || 0);
                });
                
                userData[userId] = {
                    user: user,
                    data: aggregated,
                    location: allLocations.find(loc => (loc.id || loc.name) === user.location)?.name || user.location || 'No Location'
                };
            });
            
            return userData;
        }
        
        function generateComparisonTable(userData) {
            if (Object.keys(userData).length === 0) {
                return '<div class="no-comparison"><i class="fas fa-exclamation-circle"></i><h4>No data found for selected users</h4></div>';
            }
            
            let tableHTML = `
                <table class="comparison-table">
                    <thead>
                        <tr>
                            <th>User</th>
                            <th>Location</th>
                            <th>Opal Demos</th>
                            <th>Opal Sales</th>
                            <th>Scan Demos</th>
                            <th>Scan Sold</th>
                            <th>Net Sales</th>
                            <th>Hours</th>
                            <th>Total Score</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            Object.values(userData).forEach(({ user, data, location }) => {
                const totalScore = data.opal_sales + data.scan_sold;
                tableHTML += `
                    <tr>
                        <td class="user-name">${user.name || user.username}</td>
                        <td>${location}</td>
                        <td class="metric-value">${data.opal_demos}</td>
                        <td class="metric-value">${data.opal_sales}</td>
                        <td class="metric-value">${data.scan_demos}</td>
                        <td class="metric-value">${data.scan_sold}</td>
                        <td class="metric-value">$${data.net_sales.toFixed(2)}</td>
                        <td class="metric-value">${data.hours_worked.toFixed(1)}h</td>
                        <td class="metric-value" style="color: var(--main-color); font-weight: 700;">${totalScore}</td>
                    </tr>
                `;
            });
            
            tableHTML += '</tbody></table>';
            return tableHTML;
        }
        
        function generateComparisonCards(userData) {
            if (Object.keys(userData).length === 0) {
                return '<div class="no-comparison"><i class="fas fa-exclamation-circle"></i><h4>No data found for selected users</h4></div>';
            }
            
            let cardsHTML = '<div class="comparison-cards">';
            
            Object.values(userData).forEach(({ user, data, location }) => {
                const totalScore = data.opal_sales + data.scan_sold;
                cardsHTML += `
                    <div class="user-card">
                        <div class="user-card-header">
                            <div class="user-card-name">${user.name || user.username}</div>
                            <div class="user-card-location">${location}</div>
                        </div>
                        <div class="user-metrics">
                            <div class="user-metric">
                                <div class="user-metric-label">Opal Demos</div>
                                <div class="user-metric-value">${data.opal_demos}</div>
                            </div>
                            <div class="user-metric">
                                <div class="user-metric-label">Opal Sales</div>
                                <div class="user-metric-value">${data.opal_sales}</div>
                            </div>
                            <div class="user-metric">
                                <div class="user-metric-label">Scan Demos</div>
                                <div class="user-metric-value">${data.scan_demos}</div>
                            </div>
                            <div class="user-metric">
                                <div class="user-metric-label">Scan Sold</div>
                                <div class="user-metric-value">${data.scan_sold}</div>
                            </div>
                        </div>
                        <div class="user-total-score">
                            <div class="score-label">Total Sales</div>
                            <div class="score-value">${totalScore}</div>
                        </div>
                    </div>
                `;
            });
            
            cardsHTML += '</div>';
            return cardsHTML;
        }
        
        function exportComparison() {
            const userSelect = document.getElementById('userFilter');
            const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value).filter(v => v);
            
            if (selectedUsers.length === 0) {
                alert('Please select users to export comparison data.');
                return;
            }
            
            const trackingData = JSON.parse(localStorage.getItem('trackingData')) || [];
            const userData = getFilteredUserData(selectedUsers, trackingData);
            
            // Generate CSV
            const csvData = [
                ['User', 'Location', 'Opal Demos', 'Opal Sales', 'Scan Demos', 'Scan Sold', 'Net Sales', 'Hours Worked', 'Total Sales']
            ];
            
            Object.values(userData).forEach(({ user, data, location }) => {
                csvData.push([
                    user.name || user.username,
                    location,
                    data.opal_demos,
                    data.opal_sales,
                    data.scan_demos,
                    data.scan_sold,
                    data.net_sales.toFixed(2),
                    data.hours_worked.toFixed(1),
                    data.opal_sales + data.scan_sold
                ]);
            });
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `user-comparison-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('📊 User comparison data exported');
        }
        
        function updateTimelineData() {
            try {
                // Get tracking data from localStorage
                let trackingData = JSON.parse(localStorage.getItem('trackingData')) || [];
                
                // Apply current filters to timeline data
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
                const selectedLocationId = document.getElementById('locationFilter').value;
                const userSelect = document.getElementById('userFilter');
                const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value).filter(v => v);
                
                let filteredData = trackingData;
                
                // Apply date filter
                if (startDate || endDate) {
                    filteredData = filteredData.filter(record => {
                        const recordDate = record.date || record.timestamp?.split('T')[0];
                        if (!recordDate) return true;
                        
                        if (startDate && recordDate < startDate) return false;
                        if (endDate && recordDate > endDate) return false;
                        return true;
                    });
                }
                
                // Apply user filter
                if (selectedUsers.length > 0) {
                    filteredData = filteredData.filter(record => {
                        const recordUserId = record.userId || record.user_id;
                        return selectedUsers.some(selectedId => 
                            recordUserId === selectedId || 
                            recordUserId === parseInt(selectedId) ||
                            recordUserId?.toString() === selectedId
                        );
                    });
                }
                
                // Apply location filter
                if (selectedLocationId) {
                    const usersInLocation = allUsers.filter(user => {
                        const userLocation = user.location || user.locationId || user.location_id;
                        return userLocation === selectedLocationId || 
                               userLocation === parseInt(selectedLocationId) ||
                               (typeof userLocation === 'string' && userLocation.toLowerCase() === selectedLocationId.toLowerCase());
                    });
                    
                    const userIdsInLocation = usersInLocation.map(u => u.id);
                    filteredData = filteredData.filter(record => {
                        const recordUserId = record.userId || record.user_id;
                        return userIdsInLocation.includes(recordUserId) ||
                               userIdsInLocation.includes(parseInt(recordUserId));
                    });
                }
                
                // Sort by timestamp (most recent first)
                filteredData.sort((a, b) => {
                    const timeA = new Date(a.timestamp || a.date).getTime();
                    const timeB = new Date(b.timestamp || b.date).getTime();
                    return timeB - timeA;
                });
                
                // Get the 10 most recent entries
                const recentData = filteredData.slice(0, 10);
                
                // Update timeline container
                const timelineContainer = document.getElementById('timelineContainer');
                
                if (recentData.length === 0) {
                    timelineContainer.innerHTML = `
                        <div class="timeline-item">
                            <div class="timeline-time">--:--</div>
                            <div class="timeline-event">
                                No activity found for current filters.
                                </div>
                            </div>
                        `;
                    return;
                }
                
                // Generate timeline items
                timelineContainer.innerHTML = recentData.map(record => {
                    const timestamp = new Date(record.timestamp || record.date);
                    const timeStr = timestamp.toLocaleTimeString('en-US', { 
                        hour: '2-digit', 
                        minute: '2-digit' 
                    });
                    const dateStr = timestamp.toLocaleDateString('en-US');
                    
                    // Create activity summary
                    const activities = [];
                    if (record.opal_demos > 0) activities.push(`${record.opal_demos} Opal demos`);
                    if (record.opal_sales > 0) activities.push(`${record.opal_sales} Opal sales`);
                    if (record.scan_demos > 0) activities.push(`${record.scan_demos} Scan demos`);
                    if (record.scan_sold > 0) activities.push(`${record.scan_sold} Scan sales`);
                    
                    const activityText = activities.length > 0 ? activities.join(', ') : 'Session completed';
                    const userName = record.username || 'Unknown User';
                    
                    return `
                        <div class="timeline-item">
                            <div class="timeline-time">${timeStr}</div>
                            <div class="timeline-event">
                                ${activityText} by <span class="timeline-value">${userName}</span>
                                <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 2px;">
                                    ${dateStr}
                                </div>
                            </div>
                        </div>
                    `;
                }).join('');
                
                console.log('📋 Timeline updated with', recentData.length, 'recent activities');
                
            } catch (error) {
                console.error('Error updating timeline:', error);
            }
        }
        
        let allUsers = [];
        let allLocations = [];
        
        async function loadUsers() {
            try {
                // Load users from localStorage (same source as users.html)
                let users = JSON.parse(localStorage.getItem('users')) || [];
                
                // If no local users, try to get from server
                if (users.length === 0) {
                    try {
                        const response = await fetch('/get_users');
                        if (response.ok) {
                            const serverUsers = await response.json();
                            users = serverUsers;
                            // Save to localStorage for consistency
                            localStorage.setItem('users', JSON.stringify(users));
                        }
                    } catch (err) {
                        console.log('Server not available for users');
                    }
                }
                
                // Filter users by location context if available
                if (currentLocationContext && currentLocationContext.id) {
                    users = users.filter(user => {
                        const userLocation = user.location || user.locationId || user.location_id;
                        return userLocation == currentLocationContext.id;
                    });
                    console.log(`📍 Filtered users for location ${currentLocationContext.id}:`, users.length);
                }
                
                allUsers = users;
                
                const userSelect = document.getElementById('userFilter');
                userSelect.innerHTML = '<option value="">All Users</option>';
                
                allUsers.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.id;
                    // Display name with location info for better UX
                    const userName = user.name || user.username;
                    const userLocation = user.location || '';
                    const locationName = allLocations.find(loc => 
                        (loc.id || loc.name) === userLocation
                    )?.name || userLocation;
                    
                    option.textContent = locationName ? `${userName} (${locationName})` : userName;
                    option.dataset.location = userLocation;
                    userSelect.appendChild(option);
                });
                
                // Update user count
                document.getElementById('userCount').textContent = allUsers.length;
                
                // Add event listener for user filtering
                userSelect.addEventListener('change', function() {
                    // Update user count display
                    const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value).filter(v => v);
                    if (selectedUsers.length > 0) {
                        document.getElementById('userCount').textContent = `${selectedUsers.length}/${allUsers.length}`;
                        } else {
                        document.getElementById('userCount').textContent = allUsers.length;
                    }
                    
                    // Trigger data refresh
                    onFilterChange();
                });
                
                console.log('👥 Loaded users from system:', allUsers);
                console.log('🔗 User-location mapping:', allUsers.map(u => ({
                    name: u.name || u.username,
                    location: u.location
                })));
            } catch (error) {
                console.error('Error loading users:', error);
            }
        }
        
        async function loadLocations() {
            try {
                // Load locations from localStorage (same source as locations.html)
                let locations = JSON.parse(localStorage.getItem('locations')) || [];
                
                // If no local locations, try to get from server
                if (locations.length === 0) {
                    try {
                        const response = await fetch('/get_locations');
                        if (response.ok) {
                            const serverLocations = await response.json();
                            locations = serverLocations;
                            // Save to localStorage for consistency
                            localStorage.setItem('locations', JSON.stringify(locations));
                        }
                    } catch (err) {
                        console.log('Server not available for locations');
                    }
                }
                
                // If we have location context, filter to show only that location
                if (currentLocationContext && currentLocationContext.id) {
                    locations = locations.filter(location => 
                        location.id == currentLocationContext.id || 
                        location.name === currentLocationContext.name
                    );
                    console.log(`📍 Filtered locations for context ${currentLocationContext.id}:`, locations.length);
                }
                
                allLocations = locations;
                
                const locationSelect = document.getElementById('locationFilter');
                locationSelect.innerHTML = '<option value="">All Locations</option>';
                
                allLocations.forEach(location => {
                    const option = document.createElement('option');
                    option.value = location.id || location.name; // Use id or name as fallback
                    option.textContent = location.name;
                    locationSelect.appendChild(option);
                });
                
                // Update location count
                document.getElementById('locationCount').textContent = allLocations.length;
                
                // Add event listener for location filtering
                locationSelect.addEventListener('change', function() {
                    filterUsersByLocation();
                    onFilterChange(); // Reload analytics data when location changes
                });
                
                console.log('📍 Loaded locations from system:', allLocations);
            } catch (error) {
                console.error('Error loading locations:', error);
            }
        }
        
        function filterUsersByLocation() {
            const selectedLocationId = document.getElementById('locationFilter').value;
            const userSelect = document.getElementById('userFilter');
            
            // Clear current users
            userSelect.innerHTML = '<option value="">All Users</option>';
            
            console.log('🔍 Filtering users by location:', selectedLocationId);
            console.log('📋 All users data:', allUsers);
            console.log('📍 All locations data:', allLocations);
            console.log('📍 Current location context:', currentLocationContext);
            
            // Filter users by location
            let filteredUsers = [];
            if (selectedLocationId) {
                // Find users assigned to the selected location
                filteredUsers = allUsers.filter(user => {
                    // Check multiple possible location field names
                    const userLocation = user.location || user.locationId || user.location_id;
                    console.log(`👤 User ${user.name || user.username}: location = ${userLocation}`);
                    return userLocation === selectedLocationId || 
                           userLocation === parseInt(selectedLocationId) ||
                           (typeof userLocation === 'string' && userLocation.toLowerCase() === selectedLocationId.toLowerCase());
                });
            } else {
                // If no location selected but we have location context, use that
                if (currentLocationContext && currentLocationContext.id) {
                    filteredUsers = allUsers.filter(user => {
                        const userLocation = user.location || user.locationId || user.location_id;
                        return userLocation == currentLocationContext.id;
                    });
                    console.log(`📍 Using location context for filtering: ${currentLocationContext.id}`);
                } else {
                    filteredUsers = allUsers;
                }
            }
            
            // Populate the user dropdown with filtered users
            filteredUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.id;
                
                // Show name without location in filtered view (since we're already filtering by location)
                const userName = user.name || user.username;
                const userLocation = user.location || '';
                
                if (selectedLocationId || currentLocationContext) {
                    // If filtering by location, just show the name and auto-select
                    option.textContent = userName;
                    option.selected = true; // Auto-select users in the chosen location
                } else {
                    // If showing all users, show name with location
                    const locationName = allLocations.find(loc => 
                        (loc.id || loc.name) === userLocation
                    )?.name || userLocation;
                    option.textContent = locationName ? `${userName} (${locationName})` : userName;
                }
                
                option.dataset.location = userLocation;
                userSelect.appendChild(option);
            });
            
            // Update user count to show filtered count
            document.getElementById('userCount').textContent = filteredUsers.length;
            
            // Update the count to show selected users if any are selected
            setTimeout(() => {
                const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value).filter(v => v);
                if (selectedUsers.length > 0 && selectedUsers.length < filteredUsers.length) {
                    document.getElementById('userCount').textContent = `${selectedUsers.length}/${filteredUsers.length}`;
                }
            }, 100);
            
            // Find location name for logging
            const selectedLocation = allLocations.find(loc => 
                (loc.id || loc.name) === selectedLocationId
            );
            const locationName = selectedLocation ? selectedLocation.name : selectedLocationId;
            
            console.log(`✅ Filtered ${filteredUsers.length} users for location "${locationName}"`);
            
            if (filteredUsers.length === 0 && selectedLocationId) {
                console.warn('⚠️ No users found for selected location. Check user-location assignments.');
            }
            
            // Trigger data refresh when location filter changes
            onFilterChange();
            
            // Update user comparison when location changes
            setTimeout(() => {
                updateUserComparison();
            }, 200);
        }
        
        // ===== FILTER FUNCTIONS =====
        function setDefaultDates() {
            const today = new Date();
            const lastWeek = new Date(today.getTime() - 7 * 24 * 60 * 60 * 1000);
            
            document.getElementById('startDate').value = lastWeek.toISOString().split('T')[0];
            document.getElementById('endDate').value = today.toISOString().split('T')[0];
        }
        
        function applyDateFilter() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const locationId = document.getElementById('locationFilter').value;
            const userSelect = document.getElementById('userFilter');
            const selectedUsers = Array.from(userSelect.selectedOptions).map(option => option.value).filter(v => v);
            
            console.log('🔍 Applying filters:', { 
                startDate, 
                endDate, 
                locationId, 
                selectedUsers: selectedUsers.length 
            });
            
            // Show loading animation
            showLoadingState();
            
            // Load analytics data with current filters
            setTimeout(async () => {
                await loadAnalyticsData();
                hideLoadingState();
            }, 500);
        }
        
        // Update data when user or location filter changes
        function onFilterChange() {
            console.log('🔄 Filter changed, reloading data...');
            showLoadingState();
            
            setTimeout(async () => {
                await loadAnalyticsData();
                hideLoadingState();
            }, 300);
        }
        
        function resetFilters() {
            document.getElementById('userFilter').value = '';
            document.getElementById('locationFilter').value = '';
            setDefaultDates();
            applyDateFilter();
        }
        
        function refreshData() {
            console.log('🔄 Refreshing dashboard data...');
            showLoadingState();
            
            setTimeout(() => {
                loadAnalyticsData();
                hideLoadingState();
            }, 800);
        }
        
        // ===== LOADING STATES =====
        function showLoadingState() {
            document.querySelectorAll('.metric-value').forEach(el => {
                el.classList.add('loading-shimmer');
            });
        }
        
        function hideLoadingState() {
            document.querySelectorAll('.metric-value').forEach(el => {
                el.classList.remove('loading-shimmer');
            });
        }
        
        // ===== NAVIGATION FUNCTIONS =====
        function goBackToManagement() {
            if (currentLocationContext && currentLocationContext.url_name) {
                window.location.href = `/location/${currentLocationContext.url_name}/management`;
            } else {
                window.location.href = 'management.html';
            }
        }
        
        // ===== DATA STORAGE VERIFICATION =====
        function verifyDataSources() {
            console.log('🔍 ===== DATA SOURCES VERIFICATION =====');
            
            // Check Users Data (from users.html)
            const users = JSON.parse(localStorage.getItem('users')) || [];
            console.log('👥 Users (from users.html):', users.length, 'entries');
            if (users.length > 0) {
                console.log('Sample user:', users[0]);
            }
            
            // Check Locations Data (from locations.html)
            const locations = JSON.parse(localStorage.getItem('locations')) || [];
            console.log('📍 Locations (from locations.html):', locations.length, 'entries');
            if (locations.length > 0) {
                console.log('Sample location:', locations[0]);
            }
            
            // Check Tracking Data (from tracking.html)
            const trackingData = JSON.parse(localStorage.getItem('trackingData')) || [];
            console.log('📊 Tracking Data (from tracking.html):', trackingData.length, 'entries');
            if (trackingData.length > 0) {
                console.log('Sample tracking record:', trackingData[0]);
            }
            
            // Verify User-Location Relationships
            console.log('🔗 User-Location Relationships:');
            users.forEach(user => {
                const location = locations.find(loc => 
                    (loc.id || loc.name) === user.location
                );
                console.log(`User: ${user.name || user.username} → Location: ${location?.name || user.location || 'No Location'}`);
            });
            
            // Verify Data Integration
            console.log('✅ Data Integration Status:');
            console.log(`- ${users.length} users loaded from users.html`);
            console.log(`- ${locations.length} locations loaded from locations.html`);
            console.log(`- ${trackingData.length} tracking records from tracking.html`);
            
            const userTrackingCount = {};
            trackingData.forEach(record => {
                const userId = record.userId || record.user_id;
                userTrackingCount[userId] = (userTrackingCount[userId] || 0) + 1;
            });
            
            console.log('📊 Tracking records per user:', userTrackingCount);
            console.log('🔍 ===== END VERIFICATION =====');
        }
        
        // ===== EXPORT FUNCTIONS =====
        function exportToPDF() {
            console.log('📄 Generating End of Day Report PDF...');
            
                const startDate = document.getElementById('startDate').value;
                const endDate = document.getElementById('endDate').value;
            const selectedUser = document.getElementById('userFilter').value;
            const selectedLocation = document.getElementById('locationFilter').value;
            
            // Get selected user name
            const userSelect = document.getElementById('userFilter');
            const userName = userSelect.selectedOptions[0] ? userSelect.selectedOptions[0].textContent : 'All Users';
            
            // Get selected location name
            const locationSelect = document.getElementById('locationFilter');
            const locationName = locationSelect.selectedOptions[0] ? locationSelect.selectedOptions[0].textContent : 'All Locations';
            
            generatePDFReport({
                startDate,
                endDate,
                userName,
                locationName,
                data: currentData
            });
        }
        
        function generatePDFReport(filters) {
            // Create a new window for the PDF content
            const printWindow = window.open('', '_blank', 'width=800,height=600');
            
            // Calculate conversion rates
            const opalConversion = filters.data.opalDemos > 0 ? 
                ((filters.data.opalSales / filters.data.opalDemos) * 100).toFixed(0) : 0;
            const scanConversion = filters.data.scanDemos > 0 ? 
                ((filters.data.scanSold / filters.data.scanDemos) * 100).toFixed(0) : 0;
            
            // Calculate totals (this would come from your actual data in real implementation)
            const dailyGross = Math.floor(Math.random() * 100) + 50; // Demo data
            const dailyNet = Math.floor(dailyGross * 0.7); // Demo calculation
            const monthlyGross = dailyGross * 20; // Demo data
            const monthlyNet = dailyNet * 20; // Demo calculation
            
            const reportHTML = `
            <!DOCTYPE html>
            <html>
            <head>
                <meta charset="UTF-8">
                <title>MonuMe Performance - End of Day Report</title>
                <style>
                    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');
                    
                    * {
                        margin: 0;
                        padding: 0;
                        box-sizing: border-box;
                    }
                    
                    body {
                        font-family: 'Inter', sans-serif;
                        background: #ffffff;
                        color: #333;
                        padding: 40px;
                        line-height: 1.6;
                    }
                    
                    .header {
                        text-align: center;
                        margin-bottom: 40px;
                        border-bottom: 3px solid #ff9562;
                        padding-bottom: 20px;
                    }
                    
                    .company-name {
                        color: #ff9562;
                        font-size: 24px;
                        font-weight: 600;
                        margin-bottom: 8px;
                    }
                    
                    .report-title {
                        color: #333;
                        font-size: 32px;
                        font-weight: 700;
                        margin-bottom: 8px;
                    }
                    
                    .report-date {
                        color: #666;
                        font-size: 16px;
                        font-weight: 400;
                    }
                    
                    .summary-section {
                        display: flex;
                        justify-content: space-around;
                        margin: 40px 0;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                    }
                    
                    .summary-item {
                        text-align: center;
                    }
                    
                    .summary-label {
                        color: #666;
                        font-size: 14px;
                        font-weight: 500;
                        text-transform: uppercase;
                        letter-spacing: 1px;
                        margin-bottom: 5px;
                    }
                    
                    .summary-value {
                        color: #ff9562;
                        font-size: 28px;
                        font-weight: 700;
                    }
                    
                    .performance-section {
                        margin-top: 40px;
                    }
                    
                    .section-title {
                        color: #333;
                        font-size: 20px;
                        font-weight: 600;
                        margin-bottom: 20px;
                        border-left: 4px solid #ff9562;
                        padding-left: 15px;
                    }
                    
                    .metrics-grid {
                        display: grid;
                        grid-template-columns: 1fr 1fr;
                        gap: 20px;
                        margin-bottom: 30px;
                    }
                    
                    .metric-row {
                        display: flex;
                        justify-content: space-between;
                        align-items: center;
                        padding: 15px;
                        background: #ffffff;
                        border: 1px solid #e5e7eb;
                        border-radius: 8px;
                        border-left: 4px solid #ff9562;
                    }
                    
                    .metric-info {
                        display: flex;
                        justify-content: space-between;
                        width: 100%;
                    }
                    
                    .metric-label {
                        color: #666;
                        font-weight: 500;
                        text-transform: uppercase;
                        font-size: 12px;
                        letter-spacing: 1px;
                    }
                    
                    .metric-value {
                        color: #333;
                        font-weight: 700;
                        font-size: 24px;
                    }
                    
                    .success-rate {
                        background: #4CAF50;
                        color: white;
                        padding: 4px 12px;
                        border-radius: 20px;
                        font-size: 12px;
                        font-weight: 600;
                        margin-left: 10px;
                    }
                    
                    .filter-info {
                        margin-top: 40px;
                        padding: 20px;
                        background: #f8f9fa;
                        border-radius: 8px;
                        border-left: 4px solid #ff9562;
                    }
                    
                    .filter-title {
                        color: #333;
                        font-weight: 600;
                        margin-bottom: 10px;
                    }
                    
                    .filter-details {
                        display: grid;
                        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
                        gap: 15px;
                    }
                    
                    .filter-item {
                        color: #666;
                        font-size: 14px;
                    }
                    
                    .filter-value {
                        color: #ff9562;
                        font-weight: 600;
                    }
                    
                    .footer {
                        margin-top: 50px;
                        text-align: center;
                        color: #999;
                        font-size: 12px;
                        border-top: 1px solid #e5e7eb;
                        padding-top: 20px;
                    }
                    
                    @media print {
                        body { padding: 20px; }
                        .no-print { display: none; }
                    }
                </style>
            </head>
            <body>
                <div class="header">
                    <div class="company-name">MonuMe Performance</div>
                    <div class="report-title">End of Day Report</div>
                    <div class="report-date">${new Date().toLocaleDateString('en-US', { 
                        weekday: 'long', 
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric' 
                    })}</div>
                </div>
                
                <div class="summary-section">
                    <div class="summary-item">
                        <div class="summary-label">Monthly Gross</div>
                        <div class="summary-value">$${monthlyGross}</div>
                    </div>
                    <div class="summary-item">
                        <div class="summary-label">Monthly Net</div>
                        <div class="summary-value">$${monthlyNet}</div>
                    </div>
                </div>
                
                <div class="performance-section">
                    <div class="section-title">Today's Performance</div>
                    
                    <div class="metrics-grid">
                        <div class="metric-row">
                            <div class="metric-info">
                                <div>
                                    <div class="metric-label">Daily Gross</div>
                                    <div class="metric-value">$${dailyGross}</div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-info">
                                <div>
                                    <div class="metric-label">Daily Net</div>
                                    <div class="metric-value">$${dailyNet}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-row">
                            <div class="metric-info">
                                <div>
                                    <div class="metric-label">Scan Demos</div>
                                    <div class="metric-value">${filters.data.scanDemos}</div>
                                </div>
                                <div>
                                    <div class="metric-label">Scan Sales</div>
                                    <div class="metric-value">${filters.data.scanSold}</div>
                                </div>
                                <div class="success-rate">Success ${scanConversion}%</div>
                            </div>
                        </div>
                        
                        <div class="metric-row">
                            <div class="metric-info">
                                <div>
                                    <div class="metric-label">Opal Demos</div>
                                    <div class="metric-value">${filters.data.opalDemos}</div>
                                </div>
                                <div>
                                    <div class="metric-label">Opal Sales</div>
                                    <div class="metric-value">${filters.data.opalSales}</div>
                                </div>
                                <div class="success-rate">Success ${opalConversion}%</div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="filter-info">
                    <div class="filter-title">Report Filters Applied</div>
                    <div class="filter-details">
                        <div class="filter-item">
                            <strong>Date Range:</strong> 
                            <span class="filter-value">${filters.startDate || 'Not specified'} to ${filters.endDate || 'Not specified'}</span>
                        </div>
                        <div class="filter-item">
                            <strong>User:</strong> 
                            <span class="filter-value">${filters.userName}</span>
                        </div>
                        <div class="filter-item">
                            <strong>Location:</strong> 
                            <span class="filter-value">${filters.locationName}</span>
                        </div>
                    </div>
                </div>
                
                <div class="footer">
                    Generated on ${new Date().toLocaleDateString('en-US', { 
                        weekday: 'long',
                        year: 'numeric', 
                        month: 'long', 
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    })}
                </div>
                
                <div class="no-print" style="margin-top: 30px; text-align: center;">
                    <button onclick="window.print()" style="
                        background: linear-gradient(45deg, #ff7f42, #ff9562);
                        color: white;
                        border: none;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                        margin-right: 10px;
                    ">Print Report</button>
                    <button onclick="window.close()" style="
                        background: transparent;
                        color: #666;
                        border: 1px solid #ddd;
                        padding: 12px 24px;
                        border-radius: 8px;
                        font-weight: 600;
                        cursor: pointer;
                    ">Close</button>
                </div>
            </body>
            </html>
            `;
            
            printWindow.document.write(reportHTML);
            printWindow.document.close();
            
            // Auto-focus the new window
            printWindow.focus();
        }
        
        function exportToCSV() {
            console.log('📊 Exporting to CSV...');
            
            const csvData = [
                ['Metric', 'Value'],
                ['Opal Demos', currentData.opalDemos],
                ['Opal Sales', currentData.opalSales],
                ['Scan Demos', currentData.scanDemos],
                ['Scan Sold', currentData.scanSold]
            ];
            
            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-data-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
        }
        
        // ===== MOBILE RESPONSIVENESS =====
        window.addEventListener('resize', function() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.add('collapsed');
            }
        });
        
        // Initialize mobile state
        if (window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.add('collapsed');
        }
    </script>
</body>
</html>