<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MonuMe Analytics - Performance Dashboard</title>
    <link rel="icon" type="image/jpeg" href="/static/favicon.JPG">
    <!-- Authentication Check -->
    <script>
        // Immediate authentication check - runs before page loads
        (function() {
            const username = localStorage.getItem("username");
            const isLoggedIn = localStorage.getItem("isLoggedIn");
            
            if (!username || !isLoggedIn) {
                console.log("Authentication failed, redirecting to login page");
                window.location.href = "/login";
                return;
            }

            // Check for location-specific access
            const urlParams = new URLSearchParams(window.location.search);
            const locationParam = urlParams.get('location');
            const locationCode = localStorage.getItem("locationCode") || localStorage.getItem("location_username") || localStorage.getItem("location_name");
            const isAdmin = localStorage.getItem("isAdmin") === "true";
            const role = localStorage.getItem("role");

            // If URL has location parameter and user is not admin
            if (locationParam && !isAdmin) {
                // Verify user has access to this location
                if (locationCode !== locationParam) {
                    console.log("Access denied to location:", locationParam);
                    alert("Access denied. You don't have permission to access this location.");
                    window.location.href = "/login";
                    return;
                }
            }

            // If user is not admin and no location parameter, redirect to their location
            if (!isAdmin && locationCode && !locationParam) {
                console.log("Redirecting user to their location analytics:", locationCode);
                window.location.href = `/analytics?location=${locationCode}`;
                return;
            }

            console.log("Authentication successful for:", username, "Role:", role, "Location:", locationParam || locationCode || "all");
        })();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css">
    <link rel="stylesheet" href="style.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --main-color: #ff9562;
            --primary-color: #ff9562;
            --primary-color-rgb: 255, 149, 98;
            --gradient-start: #ff7f42;
            --gradient-end: #ff9562;
            --sidebar-bg: #272430;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-hover-bg: rgba(255, 255, 255, 0.98);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.7);
            --text-light: #f8f9fa;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.25);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 12px;
            --border-color: rgba(255, 255, 255, 0.2);
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
        }

        body {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1500"><rect fill="%23ff9562" width="2000" height="1500"/><defs><radialGradient id="a" gradientUnits="objectBoundingBox"><stop offset="0" stop-color="%23ffffff"/><stop offset="1" stop-color="%23ff9562"/></radialGradient><linearGradient id="b" gradientUnits="userSpaceOnUse" x1="0" y1="750" x2="1550" y2="750"><stop offset="0" stop-color="%23ffcab1"/><stop offset="1" stop-color="%23ff9562"/></linearGradient></defs><path fill="url(%23a)" d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z"/><path d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z" fill="url(%23b)"/></svg>') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
            margin: 0;
            padding: 0;
        }

        /* Enhanced Sidebar Styles - Same as Dashboard */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--main-color) 0%, #e8824d 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transition: var(--transition);
            z-index: 100;
            box-shadow: var(--shadow-lg);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 32px 24px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 24px;
            right: 24px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            opacity: 0.8;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .sidebar-brand a {
            text-decoration: none;
            color: inherit;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: var(--transition);
        }

        .sidebar-logo {
            max-width: 200px;
            max-height: 100px;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: var(--transition);
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
        }

        .logo-container:hover .sidebar-logo {
            transform: scale(1.05);
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
        }

        .sidebar-navigation {
            flex: 1;
            overflow-y: auto;
            padding: 40px 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        .sidebar-navigation::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-navigation::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-navigation::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .menu-item {
            margin: 0 16px;
            border-radius: 12px;
            overflow: hidden;
            transition: var(--transition);
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            border-radius: 12px;
            transition: var(--transition);
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .menu-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            border-radius: 12px;
        }

        .menu-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            margin-right: 16px;
            transition: var(--transition);
            font-size: 18px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .menu-icon i {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-text {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            color: white;
        }

        .menu-arrow {
            opacity: 0;
            transform: translateX(-8px);
            transition: var(--transition);
            color: white;
            font-size: 14px;
        }

        /* Hover and Active States */
        .menu-item:hover .menu-link {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(6px);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .menu-item:hover .menu-link::before {
            width: 4px;
        }

        .menu-item:hover .menu-icon {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .menu-item:hover .menu-arrow {
            opacity: 1;
            transform: translateX(0);
            color: white;
        }

        /* Active State */
        .menu-item .menu-link.active {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(6px);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .menu-item .menu-link.active::before {
            width: 4px;
        }

        .menu-item .menu-link.active .menu-icon {
            background: rgba(255, 255, 255, 0.4);
            color: white;
            box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .menu-item .menu-link.active .menu-arrow {
            opacity: 1;
            transform: translateX(0);
            color: white;
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.05);
            position: relative;
        }

        .user-profile {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.15);
            transform: translateY(-2px);
        }

        .user-profile .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 12px;
            color: var(--white);
            font-size: 16px;
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            font-size: 14px;
            font-weight: var(--font-weight-semibold);
            color: var(--white);
            margin-bottom: 2px;
        }

        .user-status {
            font-size: 12px;
            color: var(--text-muted);
        }

        .user-menu-toggle {
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-muted);
            transition: var(--transition);
        }

        .user-profile:hover .user-menu-toggle {
            color: var(--white);
        }

        .user-menu {
            position: absolute;
            bottom: 100%;
            left: 24px;
            right: 24px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 12px;
            padding: 8px;
            box-shadow: var(--shadow-lg);
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: var(--transition);
        }

        .user-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            padding: 12px 16px;
            color: #374151;
            text-decoration: none;
            border-radius: 8px;
            transition: var(--transition);
            cursor: pointer;
            font-size: 14px;
            font-weight: var(--font-weight-medium);
        }

        .user-menu-item:hover {
            background: var(--main-color);
            color: var(--white);
        }

        .user-menu-item i {
            margin-right: 12px;
            font-size: 16px;
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            width: 48px;
            height: 48px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @media screen and (max-width: 768px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        .mobile-menu-btn:hover {
            transform: scale(1.05);
            box-shadow: var(--shadow-lg);
        }

        /* Main Content */
        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 40px;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Enhanced Page Header */
        .page-header {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 32px 40px;
            margin-bottom: 32px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            flex-wrap: wrap;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .page-header:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.18);
        }

        .page-header-content {
            flex: 1;
            min-width: 300px;
        }
        
        .page-header-actions {
            display: flex;
            gap: 12px;
            margin-top: 10px;
        }

        .page-header h1 {
            font-size: 2.5rem;
            font-weight: 800;
            color: white;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            gap: 16px;
            letter-spacing: -0.5px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .page-header h1 i {
            color: white;
            font-size: 2.2rem;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
            background: rgba(255, 255, 255, 0.1);
            width: 60px;
            height: 60px;
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .page-header p {
            font-size: 1.1rem;
            color: var(--text-secondary);
            margin: 0;
            font-weight: var(--font-weight-medium);
            line-height: 1.6;
            max-width: 800px;
        }
        
        .date-range-pill {
            display: inline-flex;
            align-items: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 50px;
            padding: 8px 16px;
            font-size: 0.9rem;
            color: white;
            font-weight: 600;
            margin-top: 16px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        .date-range-pill i {
            margin-right: 8px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .animated-indicator {
            position: relative;
            display: flex;
            align-items: center;
            gap: 8px;
            margin-top: 16px;
        }
        
        .pulse-dot {
            width: 8px;
            height: 8px;
            background-color: #10b981;
            border-radius: 50%;
            position: relative;
        }
        
        .pulse-dot::after {
            content: '';
            position: absolute;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            background-color: rgba(16, 185, 129, 0.7);
            border-radius: 50%;
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            70% {
                transform: scale(3);
                opacity: 0;
            }
            100% {
                transform: scale(1);
                opacity: 0;
            }
        }
        
        .live-text {
            font-size: 0.8rem;
            color: rgba(255, 255, 255, 0.9);
            font-weight: 500;
        }

        /* Enhanced Analytics Sections with glassmorphism */
        .analytics-section {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            margin-bottom: 32px;
        }

        .analytics-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .analytics-section:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.18);
        }

        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 28px;
            padding-bottom: 16px;
            border-bottom: 2px solid rgba(255, 149, 98, 0.1);
        }

        .section-title {
            font-size: 1.8rem;
            font-weight: 700;
            color: white;
            display: flex;
            align-items: center;
            gap: 12px;
            letter-spacing: -0.3px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .section-title i {
            color: white;
            font-size: 1.6rem;
            filter: drop-shadow(0 3px 6px rgba(0, 0, 0, 0.3));
        }

        /* Filter Section */
        .filter-section {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            border-radius: 20px;
            padding: 24px;
            margin-bottom: 32px;
            border: 1px solid rgba(255, 255, 255, 0.18);
        }

        .filter-row {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            align-items: end;
        }

        .filter-group {
            display: flex;
            flex-direction: column;
        }

        .filter-label {
            color: white;
            font-weight: 600;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .filter-input,
        .filter-select {
            padding: 12px 16px;
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .filter-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        .filter-input:focus,
        .filter-select:focus {
            outline: none;
            border-color: white;
            background: rgba(255, 255, 255, 0.15);
        }

        .filter-btn {
            padding: 12px 24px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 149, 98, 0.3);
        }

        /* Enhanced Data Grid */
        .data-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            padding: 0;
        }
        
        /* Data grid animations */
        .data-grid > * {
            animation: card-fade-in 0.5s ease-out forwards;
            opacity: 0;
            transform: translateY(15px);
        }
        
        @keyframes card-fade-in {
            from {
                opacity: 0;
                transform: translateY(15px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        /* Add sequential animation delay to cards */
        .data-grid > *:nth-child(1) { animation-delay: 0.1s; }
        .data-grid > *:nth-child(2) { animation-delay: 0.15s; }
        .data-grid > *:nth-child(3) { animation-delay: 0.2s; }
        .data-grid > *:nth-child(4) { animation-delay: 0.25s; }
        .data-grid > *:nth-child(5) { animation-delay: 0.3s; }
        .data-grid > *:nth-child(6) { animation-delay: 0.35s; }
        .data-grid > *:nth-child(7) { animation-delay: 0.4s; }
        .data-grid > *:nth-child(8) { animation-delay: 0.45s; }
        
        /* Improved responsive design for data grid */
        @media (max-width: 1200px) {
            .data-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            }
        }
        
        @media (max-width: 768px) {
            .data-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }
        }

        /* Enhanced Location Cards - Redesigned */
        .location-card {
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.06);
            border: 1px solid rgba(255, 255, 255, 0.7);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
        }

        .location-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);
        }

        .location-card-header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            padding: 20px;
            color: white;
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .location-card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMTAwJSIgaGVpZ2h0PSIxMDAlIiB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciPjxkZWZzPjxwYXR0ZXJuIGlkPSJwYXR0ZXJuIiB4PSIwIiB5PSIwIiB3aWR0aD0iNDAiIGhlaWdodD0iNDAiIHBhdHRlcm5Vbml0cz0idXNlclNwYWNlT25Vc2UiIHBhdHRlcm5UcmFuc2Zvcm09InJvdGF0ZSgzMCkiPjxyZWN0IHg9IjAiIHk9IjAiIHdpZHRoPSIyIiBoZWlnaHQ9IjIiIGZpbGw9IiNmZmZmZmYiIG9wYWNpdHk9IjAuMSIvPjwvcGF0dGVybj48L2RlZnM+PHJlY3QgeD0iMCIgeT0iMCIgd2lkdGg9IjEwMCUiIGhlaWdodD0iMTAwJSIgZmlsbD0idXJsKCNwYXR0ZXJuKSIvPjwvc3ZnPg==');
            opacity: 0.2;
        }

        .location-title-row {
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 2;
        }

        .location-name {
            font-size: 1.5rem;
            font-weight: 800;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            margin-bottom: 4px;
            letter-spacing: -0.5px;
        }

        .location-subtitle {
            font-size: 0.9rem;
            opacity: 0.9;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .location-subtitle i {
            font-size: 12px;
            opacity: 0.8;
        }

        .location-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            border: 2px solid rgba(255, 255, 255, 0.4);
            flex-shrink: 0;
        }

        .location-stats {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-top: 16px;
            position: relative;
            z-index: 2;
            gap: 5px;
        }

        .location-stat {
            text-align: center;
            flex: 1;
            padding: 8px 5px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            transition: all 0.3s ease;
        }
        
        .location-stat:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-2px);
        }

        .stat-value {
            font-size: 1.6rem;
            font-weight: 800;
            line-height: 1;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 0.7rem;
            opacity: 0.95;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .location-card-body {
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        /* Location performance metrics */
        .location-metrics-grid {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
        }

        .location-metric-item {
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.03);
            border-radius: 10px;
            padding: 12px 10px;
            text-align: center;
            transition: all 0.3s ease;
        }
        
        .location-metric-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.03);
        }

        .location-metric-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }

        .location-metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a1a1a;
        }
        
        /* Location total container */
        .location-totals {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-top: 5px;
        }
        
        .location-total {
            background: linear-gradient(to right, rgba(255, 149, 98, 0.08), rgba(255, 149, 98, 0.03));
            border-radius: 10px;
            padding: 12px;
            text-align: center;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .location-total-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .location-total-value {
            font-size: 1.3rem;
            font-weight: 800;
            color: var(--main-color);
            margin-top: 4px;
        }
        
        .location-user-count {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            background: rgba(255, 149, 98, 0.05);
            border-radius: 8px;
            margin-top: 10px;
            gap: 6px;
        }
        
        .location-user-count i {
            color: var(--main-color);
            font-size: 14px;
        }
        
        .location-user-count span {
            font-size: 0.9rem;
            font-weight: 600;
            color: #4b5563;
        }

        /* Enhanced User Cards - Improved Design */
        .user-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-radius: 16px;
            padding: 24px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
            border: 1px solid rgba(255, 255, 255, 0.6);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
        }

        .user-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        }

        .user-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
            background: rgba(255, 255, 255, 1);
        }

        .user-header {
            display: flex;
            align-items: center;
            gap: 16px;
            margin-bottom: 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            padding-bottom: 16px;
        }

        .user-avatar {
            width: 56px;
            height: 56px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 24px;
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.3);
            border: 3px solid white;
            flex-shrink: 0;
        }

        .user-info {
            flex: 1;
        }

        .user-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-bottom: 4px;
        }

        .user-location {
            font-size: 0.85rem;
            color: #6b7280;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-location i {
            color: var(--main-color);
            font-size: 12px;
        }

        /* Advanced performance metrics layout */
        .session-card { padding:18px; }
        .primary-metrics.compact .primary-metric-value{font-size:18px}
        .sales-metrics.compact .sales-metric-value{font-size:16px}
        .user-performance-grid.compact{grid-template-columns:repeat(4,1fr);gap:10px}
        .conversion-rates.compact{display:flex;gap:12px;justify-content:space-between}
        .date-pill{background:rgba(255,255,255,0.2);padding:4px 8px;border-radius:999px;font-size:12px}
        .user-performance-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .user-performance-metric {
            background: rgba(255, 255, 255, 0.9);
            border: 1px solid rgba(0, 0, 0, 0.04);
            border-radius: 12px;
            padding: 12px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.02);
            display: flex;
            flex-direction: column;
        }

        .user-performance-metric:hover {
            background: rgba(255, 255, 255, 1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            transform: translateY(-2px);
        }

        .metric-header {
            display: flex;
            align-items: center;
            gap: 8px;
            margin-bottom: 8px;
        }

        .metric-icon {
            width: 24px;
            height: 24px;
            border-radius: 6px;
            background: rgba(255, 149, 98, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--main-color);
            font-size: 12px;
        }

        .metric-name {
            font-size: 0.75rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 1.2rem;
            font-weight: 700;
            color: #1a1a1a;
            margin-top: auto;
        }
        
        /* Primary metrics section */
        .primary-metrics {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
            margin-bottom: 16px;
        }

        .primary-metric {
            background: linear-gradient(to right, rgba(255, 149, 98, 0.08), rgba(255, 149, 98, 0.03));
            border-radius: 10px;
            padding: 12px;
            text-align: center;
        }
        
        .primary-metric-label {
            font-size: 0.7rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }
        
        .primary-metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--main-color);
        }
        
        /* Sales metrics row */
        .sales-metrics {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }
        
        .sales-metric {
            flex: 1;
            background: rgba(255, 255, 255, 0.7);
            border: 1px solid rgba(0, 0, 0, 0.04);
            border-radius: 8px;
            padding: 8px;
            text-align: center;
        }
        
        .sales-metric-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: #6b7280;
            margin-bottom: 2px;
        }
        
        .sales-metric-value {
            font-size: 1rem;
            font-weight: 700;
            color: #1a1a1a;
        }
        
        /* Conversion rates container */
        .conversion-rates {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }
        
        .conversion-rate {
            flex: 1;
            padding: 10px;
            background: linear-gradient(to right, rgba(255, 149, 98, 0.08), rgba(255, 149, 98, 0.02));
            border-radius: 8px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .conversion-label {
            font-size: 0.65rem;
            font-weight: 600;
            color: #4b5563;
            text-transform: uppercase;
            letter-spacing: 0.3px;
        }
        
        .conversion-value {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--main-color);
            margin-top: 2px;
        }

        .data-card {
            display: none; /* Hide old card style */
        }

        .card-total {
            text-align: center;
            padding: 16px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 12px;
            color: white;
            margin-top: 16px;
        }

        .total-label {
            font-size: 12px;
            opacity: 0.9;
            margin-bottom: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .total-value {
            font-size: 1.8rem;
            font-weight: 800;
            line-height: 1;
        }

        .metric-label {
            font-size: 11px;
            color: #6b7280;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            font-weight: 600;
            margin-bottom: 4px;
        }

        .metric-value {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--main-color);
            line-height: 1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }

            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .main-content {
                margin-left: 0;
                padding: 80px 20px 20px;
            }

            .page-header {
                padding: 24px 20px;
            }

            .page-header h1 {
                font-size: 1.8rem;
            }

            .analytics-section {
                padding: 24px 20px;
            }

            .data-grid {
                grid-template-columns: 1fr;
            }

            .filter-row {
                grid-template-columns: 1fr;
            }
        }

                 /* Overview Stats Section */
         .overview-stats {
             display: grid;
             grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
             gap: 20px;
             margin-bottom: 0;
         }

         .overview-card {
             background: rgba(255, 255, 255, 0.95);
             backdrop-filter: blur(20px);
             border-radius: 16px;
             padding: 24px;
             display: flex;
             align-items: center;
             gap: 16px;
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
             border: 1px solid rgba(255, 255, 255, 0.6);
             transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
             position: relative;
             overflow: hidden;
         }

         .overview-card::before {
             content: '';
             position: absolute;
             top: 0;
             left: 0;
             right: 0;
             height: 3px;
             background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
         }

         .overview-card:hover {
             transform: translateY(-8px);
             box-shadow: 0 20px 40px rgba(0, 0, 0, 0.12);
             background: rgba(255, 255, 255, 1);
         }

         .overview-icon {
             width: 60px;
             height: 60px;
             border-radius: 50%;
             background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
             display: flex;
             align-items: center;
             justify-content: center;
             color: white;
             font-size: 24px;
             box-shadow: 0 8px 20px rgba(255, 149, 98, 0.3);
             flex-shrink: 0;
         }

         .overview-content {
             flex: 1;
         }

         .overview-value {
             font-size: 2rem;
             font-weight: 800;
             color: var(--main-color);
             line-height: 1;
             margin-bottom: 4px;
         }

         .overview-label {
             font-size: 13px;
             color: #6b7280;
             font-weight: 600;
             text-transform: uppercase;
             letter-spacing: 0.5px;
             margin-bottom: 4px;
         }

         .overview-change {
             font-size: 12px;
             font-weight: 600;
             color: #10b981;
         }

         .overview-change.negative {
             color: #ef4444;
         }

         .overview-actions {
             display: flex;
             gap: 12px;
         }

         /* Enhanced Filter Section */
         .filter-select {
             appearance: none;
             background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='white' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpolyline points='6,9 12,15 18,9'%3e%3c/polyline%3e%3c/svg%3e");
             background-repeat: no-repeat;
             background-position: right 12px center;
             background-size: 16px;
             padding-right: 40px;
         }

         .filter-select option {
             background: #1f2937;
             color: white;
             padding: 8px;
         }

         /* Performance Comparison */
         .comparison-section {
             display: grid;
             grid-template-columns: 1fr 1fr;
             gap: 24px;
             margin-top: 20px;
         }

         .comparison-chart {
             background: rgba(255, 255, 255, 0.95);
             border-radius: 16px;
             padding: 24px;
             box-shadow: 0 8px 25px rgba(0, 0, 0, 0.08);
         }

         .chart-title {
             font-size: 1.2rem;
             font-weight: 700;
             color: #1a1a1a;
             margin-bottom: 16px;
             display: flex;
             align-items: center;
             gap: 8px;
         }

         .chart-container {
             position: relative;
             height: 200px;
         }

         /* Loading States */
         .loading {
             opacity: 0.6;
             pointer-events: none;
         }

         .loading::after {
             content: '';
             position: absolute;
             top: 50%;
             left: 50%;
             width: 20px;
             height: 20px;
             margin: -10px 0 0 -10px;
             border: 2px solid var(--main-color);
             border-top: 2px solid transparent;
             border-radius: 50%;
             animation: spin 1s linear infinite;
         }

         @keyframes spin {
             0% { transform: rotate(0deg); }
             100% { transform: rotate(360deg); }
         }

        .analytics-section + .analytics-section { margin-top: 28px; }
        .section-header .section-title span.badge {
            background: rgba(255,255,255,0.2);
            color: #fff;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 999px;
            padding: 6px 10px;
            font-size: 12px;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <a href="/dashboard" title="Go to Dashboard">
                    <div class="logo-container">
                                                    <img src="/static/logo11.png" alt="MonuMe Logo" class="sidebar-logo">
                    </div>
                </a>
            </div>
        </div>
        
        <nav class="sidebar-navigation">
            <ul class="sidebar-menu">
                <li class="menu-item">
                    <a href="/dashboard" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <span class="menu-text">Dashboard</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/management" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <span class="menu-text">Management</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                

                
                <li class="menu-item">
                    <a href="/users" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-users"></i>
                        </div>
                        <span class="menu-text">Users</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/locations" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                        <span class="menu-text">Locations</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/analytics" class="menu-link active">
                        <div class="menu-icon">
                            <i class="fas fa-chart-bar"></i>
                        </div>
                        <span class="menu-text">Analytics</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/emails" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-envelope"></i>
                        </div>
                        <span class="menu-text">Emails</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-profile" id="user-profile" onclick="toggleUserMenu()">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-status" id="user-status">Online</div>
                </div>
                <div class="user-menu-toggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            
            <!-- User Menu Dropdown -->
            <div class="user-menu" id="user-menu">
                <div class="user-menu-item" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main Content -->
    <div class="main-content">
        <!-- Enhanced Page Header -->
        <div class="page-header">
            <div class="page-header-content">
                <h1><i class="fas fa-chart-bar"></i> Advanced Analytics</h1>
                <p>Comprehensive performance metrics and insights across all locations with real-time data visualization and combined location statistics</p>
                
                <div class="date-range-pill" id="currentDateRange">
                    <i class="fas fa-calendar-alt"></i> Showing data for: <span id="dateRangeText">Last 30 days</span>
                </div>
                
                <div class="animated-indicator">
                    <div class="pulse-dot"></div>
                    <div class="live-text">Real-time data processing enabled</div>
                </div>
            </div>
            
            <div class="page-header-actions">
                <button class="filter-btn" onclick="exportToCSV()">
                    <i class="fas fa-download"></i> Export CSV
                </button>
                <button class="filter-btn primary-btn" onclick="refreshData()" style="background: var(--main-color); color: white; font-weight: bold;">
                    <i class="fas fa-sync-alt"></i> Refresh Data
                </button>
            </div>
        </div>

        <!-- Date Filter Section - Moved above overview -->
        <div class="filter-section">
            <div class="filter-row">
                <div class="filter-group">
                    <label class="filter-label">Start Date</label>
                    <input type="date" class="filter-input" id="startDate">
                </div>
                <div class="filter-group">
                    <label class="filter-label">End Date</label>
                    <input type="date" class="filter-input" id="endDate">
                </div>
                <div class="filter-group">
                    <label class="filter-label">Time Period</label>
                    <select class="filter-select" id="timePeriod" onchange="applyQuickFilter()">
                        <option value="custom">Custom Range</option>
                        <option value="today">Today</option>
                        <option value="yesterday">Yesterday</option>
                        <option value="week">This Week</option>
                        <option value="month">This Month</option>
                        <option value="quarter">This Quarter</option>
                    </select>
                </div>
                <div class="filter-group">
                    <label class="filter-label">Comparison</label>
                    <select class="filter-select" id="comparisonPeriod">
                        <option value="previous">Compare to Previous Period</option>
                        <option value="lastYear">Compare to Same Period Last Year</option>
                        <option value="none">No Comparison</option>
                    </select>
                </div>
                <div class="filter-group">
                    <button class="filter-btn" onclick="applyDateFilter()">
                        <i class="fas fa-filter"></i> Apply Filter
                    </button>
                </div>
            </div>
        </div>

        <!-- Enhanced Analytics Overview Section -->
        <div class="analytics-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-chart-line"></i>
                    Performance Overview
                </div>
                <div class="overview-actions"></div>
            </div>
            <div class="overview-stats">
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-eye"></i>
                    </div>
                    <div class="overview-content">
                        <div class="overview-value" id="totalDemos">0</div>
                        <div class="overview-label">Total Demonstrations</div>
                        <div class="overview-change" id="demosChange">+0%</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-shopping-cart"></i>
                    </div>
                    <div class="overview-content">
                        <div class="overview-value" id="totalSales">0</div>
                        <div class="overview-label">Total Sales</div>
                        <div class="overview-change" id="salesChange">+0%</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-percentage"></i>
                    </div>
                    <div class="overview-content">
                        <div class="overview-value" id="conversionRate">0%</div>
                        <div class="overview-label">Overall Conversion Rate</div>
                        <div class="overview-change" id="conversionChange">+0%</div>
                    </div>
                </div>
                <div class="overview-card">
                    <div class="overview-icon">
                        <i class="fas fa-dollar-sign"></i>
                    </div>
                    <div class="overview-content">
                        <div class="overview-value" id="totalRevenue">$0</div>
                        <div class="overview-label">Total Net Revenue</div>
                        <div class="overview-change" id="revenueChange">+0%</div>
                    </div>
                </div>
            </div>
            
            <!-- Performance Chart -->

        </div>

        <!-- Locations Data Section -->
        <div class="analytics-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-map-marker-alt"></i>
                    Locations Performance <span class="badge" id="locationsCountBadge"></span>
                </div>
                <div class="overview-actions">
                    <select class="filter-select" id="locationSort" onchange="sortLocationData()" style="width: auto; min-width: 200px;">
                        <option value="name">Sort by Name</option>
                        <option value="sales">Sort by Total Sales</option>
                        <option value="demos">Sort by Total Demos</option>
                        <option value="conversion">Sort by Conversion Rate</option>
                    </select>
                </div>
            </div>
            <div class="data-grid" id="locations-grid">
                <!-- Location cards will be dynamically populated here -->
            </div>
        </div>


        <!-- Users Data Section -->
        <div class="analytics-section">
            <div class="section-header">
                <div class="section-title">
                    <i class="fas fa-users"></i>
                    Individual Performance <span class="badge" id="sessionsCountBadge"></span>
                </div>
                <div class="overview-actions">
                    <select class="filter-select" id="userSort" onchange="sortUserData()" style="width: auto; min-width: 200px;">
                        <option value="name">Sort by Name</option>
                        <option value="sales">Sort by Total Sales</option>
                        <option value="demos">Sort by Total Demos</option>
                        <option value="sessions">Sort by Sessions</option>
                    </select>
                </div>
            </div>
            <div class="data-grid" id="users-grid">
                <!-- User cards will be dynamically populated here -->
            </div>

        </div>
    </div>

    <script>
        // ===== GLOBAL VARIABLES =====
        let allUsers = [];
        let allLocations = [];
        let allTrackingData = [];
        let currentLocationContext = null;

        function isAdmin() {
            const role = (localStorage.getItem('role') || '').toLowerCase();
            const flag = (localStorage.getItem('isAdmin') || '').toLowerCase();
            return role === 'admin' || flag === 'true';
        }

        // ===== INITIALIZATION =====
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('🚀 Initializing Analytics Dashboard...');
            
            // Check for location context from URL or window context
            checkLocationContext();
            
            // Load current user info
            loadCurrentUser();
            
            // Load data
            await loadLocations();
            await loadUsers();
            await loadTrackingData();
            
            // Set default dates
            setDefaultDates();
            
            // Generate analytics once dates are set
            setTimeout(async () => {
                await loadTrackingData();
                generateAnalytics();
                initializeCharts();
                // Force default sort rendering to ensure cards appear immediately
                sortUserData();
            }, 0);
            
            console.log('✅ Analytics Dashboard initialized successfully');
        });
        
        function setDefaultDates() {
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 29);
    const toYmd = d => d.toISOString().split('T')[0];
    const startEl = document.getElementById('startDate');
    const endEl = document.getElementById('endDate');
    if (startEl && endEl) {
        startEl.value = toYmd(start);
        endEl.value = toYmd(end);
        const pill = document.getElementById('dateRangeText');
        if (pill) pill.textContent = 'Last 30 days';
    }
}

function applyQuickFilter() {
    const period = document.getElementById('timePeriod')?.value || 'custom';
    const today = new Date();
    let start = new Date(today);
    let end = new Date(today);
    if (period === 'today') {
        // already set
    } else if (period === 'yesterday') {
        start.setDate(today.getDate() - 1);
        end.setDate(today.getDate() - 1);
    } else if (period === 'week') {
        const day = today.getDay();
        const diff = (day === 0 ? 6 : day - 1);
        start.setDate(today.getDate() - diff);
    } else if (period === 'month') {
        start = new Date(today.getFullYear(), today.getMonth(), 1);
    } else if (period === 'quarter') {
        const qStartMonth = Math.floor(today.getMonth() / 3) * 3;
        start = new Date(today.getFullYear(), qStartMonth, 1);
    } else {
        // custom - do not auto-change
        generateAnalytics();
        return;
    }
    const toYmd = d => new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())).toISOString().split('T')[0];
    document.getElementById('startDate').value = toYmd(start);
    document.getElementById('endDate').value = toYmd(end);
    // Trigger data reload and re-generate
    (async ()=>{ await loadTrackingData(); generateAnalytics(); })();
}

// ===== CHART FUNCTIONALITY =====
        // Charts removed
        function initializeCharts() { /* charts removed */ }

        
        function toggleChartView() {
            const chartContainer = document.getElementById('performance-chart-container');
            if (!chartContainer) { return; }
            if (chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
            } else {
                chartContainer.style.display = 'none';
            }
        }
        
        function toggleLocationChart() {
            const chartContainer = document.getElementById('location-chart-container');
            if (!chartContainer) { return; }
            if (chartContainer.style.display === 'none') {
                chartContainer.style.display = 'block';
            } else {
                chartContainer.style.display = 'none';
            }
        }
        
        function updatePerformanceChart() { return; /* charts removed */
            if (!performanceChart) return;
            
            // Get top performers data
            const topUsers = [];
            const topLocations = [];
            
            if (Array.isArray(allUsers) && allUsers.length > 0) {
                // Get user data
                const userData = [];
                for (let i = 0; i < allUsers.length; i++) {
                    const user = allUsers[i];
                    const data = getUserData(user);
                    userData.push({
                        user: user,
                        data: data
                    });
                }
                
                // Sort and get top users
                userData.sort((a, b) => b.data.totalSales - a.data.totalSales);
                const top5Users = userData.slice(0, 5);
                
                for (let i = 0; i < top5Users.length; i++) {
                    topUsers.push({
                        name: top5Users[i].user.name || top5Users[i].user.username || 'Unknown',
                        sales: top5Users[i].data.totalSales,
                        demos: top5Users[i].data.opalDemos + top5Users[i].data.scanDemos
                    });
                }
            }
            
            if (Array.isArray(allLocations) && allLocations.length > 0) {
                // Get location data
                const locationData = [];
                for (let i = 0; i < allLocations.length; i++) {
                    const location = allLocations[i];
                    const data = getLocationData(location);
                    locationData.push({
                        location: location,
                        data: data
                    });
                }
                
                // Sort and get top locations
                locationData.sort((a, b) => b.data.totalSales - a.data.totalSales);
                const top5Locations = locationData.slice(0, 5);
                
                for (let i = 0; i < top5Locations.length; i++) {
                    topLocations.push({
                        name: top5Locations[i].location.name || top5Locations[i].location.location_name || 'Unknown',
                        sales: top5Locations[i].data.totalSales,
                        demos: top5Locations[i].data.opalDemos + top5Locations[i].data.scanDemos
                    });
                }
            }
            
            // Update chart data
            performanceChart.data = {
                labels: topUsers.map(u => u.name),
                datasets: [
                    {
                        label: 'Sales',
                        data: topUsers.map(u => u.sales),
                        backgroundColor: 'rgba(255, 149, 98, 0.7)',
                        borderColor: 'rgba(255, 149, 98, 1)',
                        borderWidth: 1
                    },
                    {
                        label: 'Demos',
                        data: topUsers.map(u => u.demos),
                        backgroundColor: 'rgba(255, 255, 255, 0.5)',
                        borderColor: 'rgba(255, 255, 255, 0.8)',
                        borderWidth: 1
                    }
                ]
            };
            
            // Update chart options
            performanceChart.options.plugins.title.text = 'Top Performers - Sales vs Demos';
            
            // Update chart
            performanceChart.update();
        }
        
        function updateLocationChart() { return; /* charts removed */
            if (!locationChart) return;
            
            // Get location data
            const locationData = [];
            
            if (Array.isArray(allLocations) && allLocations.length > 0) {
                for (let i = 0; i < allLocations.length; i++) {
                    const location = allLocations[i];
                    const data = getLocationData(location);
                    
                    // Only include locations with sales
                    if (data.totalSales > 0) {
                        locationData.push({
                            name: location.name || location.location_name || 'Unknown Location',
                            sales: data.totalSales
                        });
                    }
                }
                
                // Sort by sales
                locationData.sort((a, b) => b.sales - a.sales);
                
                // Take top 6 locations for the chart
                const topLocations = locationData.slice(0, 6);
                
                // Update chart data
                locationChart.data = {
                    labels: topLocations.map(loc => loc.name),
                    datasets: [{
                        data: topLocations.map(loc => loc.sales),
                        backgroundColor: [
                            'rgba(255, 149, 98, 0.8)',
                            'rgba(255, 180, 98, 0.8)',
                            'rgba(255, 210, 98, 0.8)',
                            'rgba(255, 240, 98, 0.8)',
                            'rgba(220, 255, 98, 0.8)',
                            'rgba(180, 255, 98, 0.8)'
                        ],
                        borderColor: [
                            'rgba(255, 149, 98, 1)',
                            'rgba(255, 180, 98, 1)',
                            'rgba(255, 210, 98, 1)',
                            'rgba(255, 240, 98, 1)',
                            'rgba(220, 255, 98, 1)',
                            'rgba(180, 255, 98, 1)'
                        ],
                        borderWidth: 1
                    }]
                };
                
                // Update chart
                locationChart.update();
            } else {
                // No location data
                locationChart.data = {
                    labels: ['No Data Available'],
                    datasets: [{
                        data: [1],
                        backgroundColor: ['rgba(200, 200, 200, 0.5)'],
                        borderColor: ['rgba(200, 200, 200, 1)'],
                        borderWidth: 1
                    }]
                };
                locationChart.update();
            }
        }

        // ===== LOCATION CONTEXT HANDLING =====
        function checkLocationContext() {
            // Check for location context from window object (set by server)
            if (window.LOCATION_CONTEXT) {
                currentLocationContext = window.LOCATION_CONTEXT;
                console.log('📍 Location context from server:', currentLocationContext);
            }
            
            // Check for location parameters in URL
            const urlParams = new URLSearchParams(window.location.search);
            const locationId = urlParams.get('location');
            const locationName = urlParams.get('name');
            const locationUrlName = urlParams.get('url_name');
            
            if (locationId || locationName || locationUrlName) {
                currentLocationContext = {
                    id: locationId,
                    name: locationName,
                    url_name: locationUrlName
                };
                console.log('📍 Location context from URL:', currentLocationContext);
            }
            
            // Update UI based on location context
            if (currentLocationContext && !isAdmin()) {
                updateLocationUI();
            }
        }

        function updateLocationUI() {
            if (!currentLocationContext) return;
            
            // Update page title
            const title = document.querySelector('title');
            if (title && currentLocationContext.name) {
                title.textContent = `${currentLocationContext.name} - Analytics Dashboard`;
            }
            
            // Update dashboard title
            const dashboardTitle = document.querySelector('.page-header h1');
            if (dashboardTitle && currentLocationContext.name) {
                dashboardTitle.innerHTML = `<i class="fas fa-chart-bar"></i> ${currentLocationContext.name} Analytics`;
            }
            
            // Update navigation links to be location-specific
            updateNavigationLinks();
        }

        function updateNavigationLinks() {
            if (!currentLocationContext || !currentLocationContext.url_name || isAdmin()) return;
            
            // Update sidebar navigation links to be location-specific
            const sidebarLinks = document.querySelectorAll('.sidebar-menu a');
            sidebarLinks.forEach(link => {
                const href = link.getAttribute('href');
                if (href && !href.startsWith('http') && !href.startsWith('#')) {
                    // Convert to location-specific URL
                    const newHref = `/location/${currentLocationContext.url_name}${href}`;
                    link.setAttribute('href', newHref);
                }
            });
        }

        // ===== DATA LOADING =====
        async function loadCurrentUser() {
            const username = localStorage.getItem("username");
            const role = localStorage.getItem("role");
            
            if (username) {
                document.getElementById('user-name').textContent = username;
                document.getElementById('user-status').textContent = role || 'Online';
            }
        }

        async function loadLocations() {
            try {
                // Always fetch fresh data from the server
                try {
                    const response = await fetch('/api/locations', { credentials: 'include' }).catch(()=>({ok:false,json:async()=>[]}));
                    if (response.ok) {
                        const json = await response.json();
                        allLocations = Array.isArray(json) ? json : (json.locations || []);
                        console.log('📍 Loaded fresh locations from server:', allLocations.length);
                    } else {
                        // Fallback to localStorage only if server request fails
                        let locations = JSON.parse(localStorage.getItem('locations')) || [];
                        allLocations = locations;
                        console.log('📍 Using cached locations data:', allLocations.length);
                    }
                } catch (err) {
                    // Fallback to localStorage
                    let locations = JSON.parse(localStorage.getItem('locations')) || [];
                    allLocations = locations;
                    console.log('📍 Server not available, using cached locations data:', allLocations.length);
                }
            } catch (error) {
                console.error('Error loading locations:', error);
                allLocations = [];
            }
        }

        async function loadUsers() {
            try {
                // Always fetch fresh data from the server
                try {
                    const response = await fetch('/api/users?all=true&per_page=1000', { credentials: 'include' }).catch(()=>({ok:false,json:async()=>[]}));
                    if (response.ok) {
                        const json = await response.json();
                        allUsers = Array.isArray(json) ? json : (json.users || []);
                        console.log('👥 Loaded fresh users from server (all=true):', allUsers.length);
                    } else {
                        // Fallback to localStorage only if server request fails
                        let users = JSON.parse(localStorage.getItem('users')) || [];
                        allUsers = users;
                        console.log('👥 Using cached users data:', allUsers.length);
                    }
                } catch (err) {
                    // Fallback to localStorage
                    let users = JSON.parse(localStorage.getItem('users')) || [];
                    allUsers = users;
                    console.log('👥 Server not available, using cached users data:', allUsers.length);
                }
            } catch (error) {
                console.error('Error loading users:', error);
                allUsers = [];
            }
        }

        async function loadTrackingData() {
            try {
                // Prefer TRinfo (file-based sessions) if available
                try {
                    const startDate = document.getElementById('startDate')?.value || '';
                    const endDate = document.getElementById('endDate')?.value || '';
                    const params = new URLSearchParams();
                    if (startDate) params.append('start_date', startDate);
                    if (endDate) params.append('end_date', endDate);
                    let trinfoUrl = '/api/trinfo';
                    if (params.toString()) trinfoUrl += '?' + params.toString();
                    const trRes = await fetch(trinfoUrl, { credentials: 'include' }).catch(() => ({ ok: false, status: 0, json: async () => ({success:false,data:[]}) }));
                    if (trRes.ok) {
                        const trJson = await trRes.json();
                        if (trJson && trJson.success) {
                            allTrackingData = trJson.data || [];
                            console.log('📊 Loaded TRinfo records:', allTrackingData.length);
                            return;
                        }
                    } else {
                        console.warn('TRinfo not available:', trRes.status);
                    }
                } catch (e) {
                    console.warn('TRinfo fetch failed, falling back to DB');
                }

                // Authenticated DB endpoint fallback
                try {
                    const response = await fetch('/api/tracking_data', { credentials: 'include' }).catch(() => ({ ok: false, json: async () => ([])}));
                    if (response.ok) {
                        const dbData = await response.json();
                        allTrackingData = Array.isArray(dbData) ? dbData : (dbData.data || []);
                        console.log('📊 Loaded tracking data from DB:', allTrackingData.length);
                    } else {
                        // Fallback to localStorage
                        allTrackingData = JSON.parse(localStorage.getItem('trackingData')) || [];
                        console.log('📊 Using cached tracking data:', allTrackingData.length);
                    }
                } catch (err) {
                    allTrackingData = JSON.parse(localStorage.getItem('trackingData')) || [];
                    console.log('📊 Server not available, using cached data:', allTrackingData.length);
                }
            } catch (error) {
                console.error('Error loading tracking data:', error);
                allTrackingData = [];
            }
        }

        // ===== ANALYTICS GENERATION =====
        function generateAnalytics() {
            updateOverviewStats();
            generateLocationAnalytics();
            generateUserAnalytics();
            
            // Charts removed (Top Performers section deleted)
        }

        function updateOverviewStats() {
            // Calculate totals from all data
            let totalDemos = 0;
            let totalSales = 0;
            let totalRevenue = 0;

            // Filter data by current context and date range
            let dataToUse = allTrackingData;
            
            // Apply location filter if needed
            if (currentLocationContext && currentLocationContext.id) {
                const usersInLocation = allUsers.filter(user => {
                    const userLocation = user.location || user.locationId || user.location_id;
                    return userLocation == currentLocationContext.id;
                });
                const userIdsInLocation = usersInLocation.map(u => u.id);
                dataToUse = allTrackingData.filter(record => {
                    const recordUserId = record.userId || record.user_id;
                    return userIdsInLocation.includes(recordUserId) || userIdsInLocation.includes(parseInt(recordUserId));
                });
            }

            // Apply date filter
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            // Ensure valid range; if only one date set, use it for both bounds
            const safeStart = startDate || endDate || '';
            const safeEnd = endDate || startDate || '';
            const filteredData = filterDataByDate(dataToUse, safeStart, safeEnd, true);

            // Calculate totals
            filteredData.forEach(record => {
                const opalDemos = parseInt(record.opalDemos || record.opal_demos || 0);
                const opalSales = parseInt(record.opalSales || record.opal_sales || 0);
                const scanDemos = parseInt(record.scanDemos || record.scan_demos || 0);
                const scanSold = parseInt(record.scanSold || record.scan_sold || 0);
                const netSales = parseFloat(record.netSales || record.net_sales || 0);

                totalDemos += opalDemos + scanDemos;
                totalSales += opalSales + scanSold;
                totalRevenue += netSales;
            });

            // Calculate conversion rate
            const conversionRate = totalDemos > 0 ? ((totalSales / totalDemos) * 100).toFixed(1) : 0;

            // Update UI
            document.getElementById('totalDemos').textContent = totalDemos.toLocaleString();
            document.getElementById('totalSales').textContent = totalSales.toLocaleString();
            document.getElementById('conversionRate').textContent = conversionRate + '%';
            document.getElementById('totalRevenue').textContent = '$' + totalRevenue.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2});

            // Hide change indicators since we're only showing real data
            document.getElementById('demosChange').style.display = 'none';
            document.getElementById('salesChange').style.display = 'none';
            document.getElementById('conversionChange').style.display = 'none';
            document.getElementById('revenueChange').style.display = 'none';
            
            // Show a message if no data is available
            if (filteredData.length === 0) {
                const noDataMessage = document.createElement('div');
                noDataMessage.className = 'no-data-message';
                noDataMessage.innerHTML = `
                    <div style="text-align: center; padding: 20px; background: rgba(255, 149, 98, 0.1); border-radius: 12px; margin: 20px 0;">
                        <i class="fas fa-info-circle" style="font-size: 24px; color: var(--main-color); margin-bottom: 10px;"></i>
                        <h3 style="margin: 10px 0; color: #4a5568;">No Data Available</h3>
                        <p style="color: #6b7280;">No tracking data found for the selected filters. Try adjusting your date range or filters.</p>
                    </div>
                `;
                
                // Insert after the overview stats
                const overviewStats = document.querySelector('.overview-stats');
                if (overviewStats && !document.querySelector('.no-data-message')) {
                    overviewStats.parentNode.insertBefore(noDataMessage, overviewStats.nextSibling);
                }
            } else {
                // Remove no data message if it exists
                const noDataMessage = document.querySelector('.no-data-message');
                if (noDataMessage) {
                    noDataMessage.remove();
                }
            }
        }

        function generateLocationAnalytics() {
            const locationsGrid = document.getElementById('locations-grid');
            locationsGrid.innerHTML = '';

            // Remove test locations by safe filter
            allLocations = Array.isArray(allLocations) ? allLocations.filter(loc => {
                const fields = [loc?.name, loc?.location_name, loc?.location_username, loc?.mall, loc?.address];
                return !fields.some(v => (v||'').toString().toLowerCase().includes('test'));
            }) : [];

            if (!allLocations || allLocations.length === 0) {
                locationsGrid.innerHTML = '<div style="color: white; text-align: center; grid-column: 1/-1;">No locations found</div>';
                const badge = document.getElementById('locationsCountBadge');
                if (badge) badge.textContent = '';
                return;
            }

            // Filter locations by context if needed
            let locationsToShow = Array.isArray(allLocations) ? allLocations : [];
            if (currentLocationContext && currentLocationContext.id) {
                locationsToShow = locationsToShow.filter(loc => 
                    loc.id == currentLocationContext.id || 
                    loc.name === currentLocationContext.name
                );
            }

            // Deduplicate locations by normalized key (prefer name, fallback to id)
            const seenLocationKeys = new Set();
            locationsToShow = locationsToShow.filter(loc => {
                const nameKey = (loc.name || loc.location_name || '').toString().trim().toLowerCase();
                const idKey = Number.isFinite(parseInt(loc.id)) ? `id:${parseInt(loc.id)}` : '';
                const key = nameKey || idKey || JSON.stringify(loc);
                if (seenLocationKeys.has(key)) return false;
                seenLocationKeys.add(key);
                return true;
            });

            const badge = document.getElementById('locationsCountBadge');
            if (badge) badge.textContent = `${locationsToShow.length}`;

            // Get location data and sort
            const locationDataArray = [];
            for (let i = 0; i < locationsToShow.length; i++) {
                const location = locationsToShow[i];
                const data = getLocationData(location);
                locationDataArray.push({
                    location: location,
                    data: data
                });
            }

            // Sort locations
            const sortBy = document.getElementById('locationSort')?.value || 'name';
            locationDataArray.sort((a, b) => {
                switch(sortBy) {
                    case 'sales':
                        return b.data.totalSales - a.data.totalSales;
                    case 'demos':
                        return (b.data.opalDemos + b.data.scanDemos) - (a.data.opalDemos + a.data.scanDemos);
                    case 'conversion':
                        const aConversion = (a.data.opalDemos + a.data.scanDemos) > 0 ? 
                            (a.data.totalSales / (a.data.opalDemos + a.data.scanDemos)) : 0;
                        const bConversion = (b.data.opalDemos + b.data.scanDemos) > 0 ? 
                            (b.data.totalSales / (b.data.opalDemos + b.data.scanDemos)) : 0;
                        return bConversion - aConversion;
                    default: // name
                        return (a.location.name || a.location.location_name || '').localeCompare(b.location.name || b.location.location_name || '');
                }
            });

            // Create location cards
            if (locationDataArray.length === 0) {
                locationsGrid.innerHTML = '<div style="color: white; text-align: center; grid-column: 1/-1;">No location data available</div>';
            } else {
                locationDataArray.forEach(({location, data}) => {
                    const locationCard = createLocationCard(location, data);
                    locationsGrid.appendChild(locationCard);
                });
            }

            // Update top locations (guard if container exists)
            if (document.getElementById('topLocations')) {
                updateTopLocations(locationDataArray);
            }
        }

        function generateUserAnalytics() {
            const usersGrid = document.getElementById('users-grid');
            usersGrid.innerHTML = '';

            if (!allUsers || allUsers.length === 0) {
                usersGrid.innerHTML = '<div style="color: white; text-align: center; grid-column: 1/-1;">No users found</div>';
                const badge = document.getElementById('sessionsCountBadge');
                if (badge) badge.textContent = '';
                return;
            }

            // Filter users by location context if needed
            let usersToShow = Array.isArray(allUsers) ? allUsers : [];
            // Normalize user id and location for consistent matching
            usersToShow = usersToShow.map(u => ({
                ...u,
                id: parseInt(u.id || u.user_id || u.userId),
                location_id: parseInt(u.location_id || u.locationId || u.location)
            })).filter(u => u.id && !String(u.username||u.name||'').toLowerCase().includes('test'));

            if (currentLocationContext && currentLocationContext.id && !isAdmin()) {
                const locId = parseInt(currentLocationContext.id);
                usersToShow = usersToShow.filter(user => {
                    const userLocation = user.location_id;
                    return userLocation == locId;
                });
            }

            // Build one aggregated card per user within date range
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const safeStart = startDate || endDate || '';
            const safeEnd = endDate || startDate || '';

            const aggregateItems = [];

            // Ensure admin sees all users that have sessions in the range (even if not returned by /api/users)
            if (isAdmin()) {
                try {
                    let trackingScope = allTrackingData.slice();
                    const scopeByDate = filterDataByDate(trackingScope, safeStart, safeEnd, true);
                    const existingIds = new Set(usersToShow.map(u => parseInt(u.id)));
                    for (let i = 0; i < scopeByDate.length; i++) {
                        const rec = scopeByDate[i];
                        const uid = parseInt(rec.userId || rec.user_id);
                        const uname = (rec.username || rec.user_name || '').toLowerCase();
                        if (uid && !existingIds.has(uid)) {
                            const stub = {
                                id: uid,
                                username: uname || `user_${uid}`,
                                name: (uname ? uname.charAt(0).toUpperCase()+uname.slice(1) : `User ${uid}`),
                                location_id: parseInt(rec.locationId || rec.location_id)
                            };
                            usersToShow.push(stub);
                            existingIds.add(uid);
                        }
                    }
                } catch (e) {
                    console.warn('Aggregation fallback could not add missing users:', e);
                }
            }

            for (let i = 0; i < usersToShow.length; i++) {
                const user = usersToShow[i];
                if (!user || user.is_test_user) continue;
                const sessions = getUserSessions(user, safeStart, safeEnd);
                if (!sessions || sessions.length === 0) continue;
                const metrics = buildUserAggregateMetrics(sessions);
                aggregateItems.push({ user, metrics });
            }

            const badge = document.getElementById('sessionsCountBadge');
            if (badge) badge.textContent = `${aggregateItems.length}`;

            // Sorting
            const sortBy = document.getElementById('userSort')?.value || 'name';
            aggregateItems.sort((a, b) => {
                switch (sortBy) {
                    case 'sales':
                        return (b.metrics.totalSales || 0) - (a.metrics.totalSales || 0);
                    case 'demos':
                        return ((b.metrics.opalDemos + b.metrics.scanDemos) || 0) - ((a.metrics.opalDemos + a.metrics.scanDemos) || 0);
                    case 'sessions':
                        return (b.metrics.sessionsCount || 0) - (a.metrics.sessionsCount || 0);
                    default:
                        return (a.user.name || a.user.username || '').localeCompare(b.user.name || b.user.username || '');
                }
            });

            if (aggregateItems.length === 0) {
                usersGrid.innerHTML = '<div style="color: white; text-align: center; grid-column: 1/-1;">No user activity in selected range</div>';
            } else {
                for (let k = 0; k < aggregateItems.length; k++) {
                    const { user, metrics } = aggregateItems[k];
                    const card = createUserAggregateCard(user, metrics);
                    usersGrid.appendChild(card);
                }
            }
        }

        function buildUserAggregateMetrics(records) {
            let opalDemos = 0, opalSales = 0, scanDemos = 0, scanSold = 0;
            let netSales = 0, hoursWorked = 0;
            const sessionsCount = records.length;
            for (let i = 0; i < records.length; i++) {
                const r = records[i];
                opalDemos += parseInt(r.opalDemos || r.opal_demos || 0);
                opalSales += parseInt(r.opalSales || r.opal_sales || 0);
                scanDemos += parseInt(r.scanDemos || r.scan_demos || 0);
                scanSold += parseInt(r.scanSold || r.scan_sold || 0);
                netSales += parseFloat(r.netSales || r.net_sales || 0);
                hoursWorked += parseFloat(r.hoursWorked || r.hours_worked || 0);
            }
            const salesPerHour = hoursWorked > 0 ? Number((netSales / hoursWorked).toFixed(1)) : 0;
            const opalRate = opalDemos > 0 ? Number(((opalSales / opalDemos) * 100).toFixed(1)) : 0;
            const scanRate = scanDemos > 0 ? Number(((scanSold / scanDemos) * 100).toFixed(1)) : 0;
            return {
                opalDemos, opalSales, scanDemos, scanSold,
                netSales, hoursWorked, salesPerHour,
                opalRate, scanRate,
                sessionsCount,
                totalSales: opalSales + scanSold
            };
        }

        function createUserAggregateCard(user, m) {
            const card = document.createElement('div');
            card.className = 'user-card session-card';
            const locationName = (allLocations.find(l => (l.id||l.name)===(user.location||user.locationId||user.location_id))||{}).name || user.location || '';
            const initials = (user.name||user.username||'U').split(' ').map(s=>s[0]).slice(0,2).join('').toUpperCase();
            card.innerHTML = `
                <div class="user-header" style="margin-bottom:10px">
                    <div class="user-avatar">${initials}</div>
                    <div class="user-info">
                        <div class="user-title">${user.name || user.username}</div>
                        <div class="user-location"><i class="fas fa-map-marker-alt"></i> ${locationName} • <span class="date-pill"><i class="fas fa-layer-group"></i> ${m.sessionsCount} sessions</span></div>
                    </div>
                </div>
                <div class="primary-metrics compact">
                    <div class="primary-metric"><div class="primary-metric-label">Net Sales</div><div class="primary-metric-value">$${m.netSales.toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
                    <div class="primary-metric"><div class="primary-metric-label">Hours</div><div class="primary-metric-value">${m.hoursWorked.toLocaleString(undefined,{minimumFractionDigits:1,maximumFractionDigits:1})}</div></div>
                </div>
                
                <div class="user-performance-grid compact" style="display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:10px">
                    <div class="user-performance-metric"><div class="metric-header"><div class="metric-icon"><i class="fas fa-eye"></i></div><div class="metric-name">Opal Demo</div></div><div class="metric-value">${m.opalDemos}</div></div>
                    <div class="user-performance-metric"><div class="metric-header"><div class="metric-icon"><i class="fas fa-shopping-cart"></i></div><div class="metric-name">Opal Sales</div></div><div class="metric-value" style="font-weight:900;color:#111">${m.opalSales}</div></div>
                    <div class="user-performance-metric"><div class="metric-header"><div class="metric-icon"><i class="fas fa-qrcode"></i></div><div class="metric-name">Scan Demo</div></div><div class="metric-value">${m.scanDemos}</div></div>
                    <div class="user-performance-metric"><div class="metric-header"><div class="metric-icon"><i class="fas fa-check-circle"></i></div><div class="metric-name">Scan Sold</div></div><div class="metric-value" style="font-weight:900;color:#111">${m.scanSold}</div></div>
                </div>
                <div class="conversion-rates compact">
                    <div class="conversion-rate"><div class="conversion-label">Opal Rate</div><div class="conversion-value">${m.opalRate}%</div></div>
                    <div class="conversion-rate"><div class="conversion-label">Scan Rate</div><div class="conversion-value">${m.scanRate}%</div></div>
                </div>
                <div style="display:flex;justify-content:flex-end;margin-top:12px;">
                    <button class="filter-btn primary-btn" onclick="openUserSessions(${user.id||'null'}, '${(user.username||user.name||'').replace(/'/g, "\\'")}')">
                        <i class="fas fa-list"></i> See Sessions
                    </button>
                </div>
            `;
            return card;
        }

                 function getUserSessions(user, startDate, endDate) {
            const userId = parseInt(user.id);
            const uname = (user.username || user.name || '').toLowerCase();
            const records = allTrackingData.filter(r => {
                const uid = parseInt(r.userId || r.user_id);
                const rname = (r.username || r.user_name || '').toLowerCase();
                if (uid) {
                    if (userId && uid !== userId) return false;
                } else if (uname) {
                    if (!rname || rname !== uname) return false;
                } else {
                    return false;
                }
                // date filter
                const d = (r.date || (r.timestamp ? r.timestamp.split('T')[0] : ''));
                if (startDate && d && d < startDate) return false;
                if (endDate && d && d > endDate) return false;
                return true;
            });
            return records;
        }

        function sortLocationData() {
            generateLocationAnalytics();
        }

        function sortUserData() {
            generateUserAnalytics();
        }

        function updateTopLocations(locationDataArray) {
            const topLocationsContainer = document.getElementById('topLocations');
            
            if (!locationDataArray || locationDataArray.length === 0) {
                topLocationsContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No location data available</p>';
                return;
            }
            
            // Sort and get top 5
            const topLocations = [...locationDataArray]
                .sort((a, b) => b.data.totalSales - a.data.totalSales)
                .slice(0, 5);

            if (topLocations.length === 0) {
                topLocationsContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No location data available</p>';
                return;
            }

            let html = '';
            for (let i = 0; i < topLocations.length; i++) {
                const item = topLocations[i];
                const rank = i + 1;
                const medalIcon = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
                const locationName = item.location.name || item.location.location_name || 'Unknown Location';
                
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255, 149, 98, 0.05); border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 18px; font-weight: bold; min-width: 40px;">${medalIcon}</span>
                            <div>
                                <div style="font-weight: 600; color: #1a1a1a;">${locationName}</div>
                                <div style="font-size: 12px; color: #6b7280;">${item.data.userCount} users</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: var(--main-color);">${item.data.totalSales}</div>
                            <div style="font-size: 12px; color: #6b7280;">sales</div>
                        </div>
                    </div>
                `;
            }
            
            topLocationsContainer.innerHTML = html;
        }

        function updateTopUsers(userDataArray) {
            const topUsersContainer = document.getElementById('topUsers');
            
            if (!userDataArray || userDataArray.length === 0) {
                topUsersContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No user data available</p>';
                return;
            }
            
            // Sort and get top 5
            const topUsers = [...userDataArray]
                .sort((a, b) => b.data.totalSales - a.data.totalSales)
                .slice(0, 5);

            if (topUsers.length === 0) {
                topUsersContainer.innerHTML = '<p style="color: #6b7280; text-align: center;">No user data available</p>';
                return;
            }

            let html = '';
            for (let i = 0; i < topUsers.length; i++) {
                const item = topUsers[i];
                const rank = i + 1;
                const medalIcon = rank === 1 ? '🥇' : rank === 2 ? '🥈' : rank === 3 ? '🥉' : `#${rank}`;
                
                let locationName = 'No Location';
                if (item.user && (item.user.location || item.user.locationId || item.user.location_id)) {
                    const locationId = item.user.location || item.user.locationId || item.user.location_id;
                    if (Array.isArray(allLocations)) {
                        const matchedLocation = allLocations.find(loc => 
                            (loc.id || loc.name) === locationId
                        );
                        if (matchedLocation) {
                            locationName = matchedLocation.name || matchedLocation.location_name || locationId;
                        } else {
                            locationName = locationId;
                        }
                    } else {
                        locationName = locationId;
                    }
                }
                
                const userName = item.user.name || item.user.username || 'Unknown User';
                
                html += `
                    <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px; background: rgba(255, 149, 98, 0.05); border-radius: 8px; margin-bottom: 8px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <span style="font-size: 18px; font-weight: bold; min-width: 40px;">${medalIcon}</span>
                            <div>
                                <div style="font-weight: 600; color: #1a1a1a;">${userName}</div>
                                <div style="font-size: 12px; color: #6b7280;">${locationName}</div>
                            </div>
                        </div>
                        <div style="text-align: right;">
                            <div style="font-weight: 700; color: var(--main-color);">${item.data.totalSales}</div>
                            <div style="font-size: 12px; color: #6b7280;">sales</div>
                        </div>
                    </div>
                `;
            }
            
            topUsersContainer.innerHTML = html;
        }

        function getLocationData(location) {
            // Normalize location id/name
            const locId = parseInt(location.id || location.location_id);
            const locName = location.name || location.location_name;

            // Find all users that belong to this location, normalize ids
            const locationUsers = (Array.isArray(allUsers) ? allUsers : []).filter(user => {
                const userLocationRaw = user.location || user.locationId || user.location_id;
                const userLocationId = parseInt(userLocationRaw);
                if (!Number.isNaN(locId) && userLocationId === locId) return true;
                // fallback to name match when ids are not available (case-insensitive)
                if (!locName || userLocationRaw == null) return false;
                return String(userLocationRaw).toLowerCase() === String(locName).toLowerCase();
            });

            // Build a Set of integer user IDs for efficient lookup
            const locationUserIdSet = new Set(
                locationUsers
                    .map(u => parseInt(u.id || u.user_id || u.userId))
                    .filter(id => Number.isInteger(id))
            );
            // Build a Set of usernames (or names) for fallback matching when userId is missing in records
            const locationUsernameSet = new Set(
                locationUsers
                    .map(u => (u.username || u.name || '').toString().trim().toLowerCase())
                    .filter(Boolean)
            );
            
            // Get all tracking data for users in this location
            const locationTrackingData = (Array.isArray(allTrackingData) ? allTrackingData : []).filter(record => {
                const recordUserId = parseInt(record.userId || record.user_id);
                if (Number.isInteger(recordUserId) && locationUserIdSet.has(recordUserId)) return true;
                const recordUsername = (record.username || record.user_name || '').toString().trim().toLowerCase();
                if (recordUsername && locationUsernameSet.has(recordUsername)) return true;
                return false;
            });

            // Apply date filter
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const safeStart = startDate || endDate || '';
            const safeEnd = endDate || startDate || '';
            const filteredData = filterDataByDate(locationTrackingData, safeStart, safeEnd);

            // Initialize aggregate data structure
            const data = {
                opalDemos: 0,
                opalSales: 0,
                scanDemos: 0,
                scanSold: 0,
                netSales: 0,
                hoursWorked: 0,
                totalSales: 0,
                activeUserIds: new Set(), // Track unique users who have submitted data
                userCount: locationUsers.length, // Default user count from assignment
                dailyStats: {}, // For time-based aggregations
                sessionsCount: 0
            };

            // Aggregate the data
            filteredData.forEach(record => {
                // Track this as an active session
                data.sessionsCount++;
                
                // Track this user as active
                const userId = parseInt(record.userId || record.user_id);
                if (Number.isInteger(userId)) {
                    data.activeUserIds.add(userId);
                } else {
                    const uName = (record.username || record.user_name || '').toString().trim().toLowerCase();
                    if (uName && locationUsernameSet.has(uName)) {
                        // Try to map username to a user id if possible
                        const matchedUser = locationUsers.find(u => (u.username || u.name || '').toString().trim().toLowerCase() === uName);
                        const matchedId = parseInt(matchedUser && (matchedUser.id || matchedUser.user_id || matchedUser.userId));
                        if (Number.isInteger(matchedId)) data.activeUserIds.add(matchedId);
                    }
                }
                
                // Track daily stats for time-based analysis
                const recordDate = record.date || (record.timestamp ? record.timestamp.split('T')[0] : null);
                if (recordDate) {
                    if (!data.dailyStats[recordDate]) {
                        data.dailyStats[recordDate] = {
                            opalDemos: 0,
                            opalSales: 0, 
                            scanDemos: 0,
                            scanSold: 0,
                            netSales: 0,
                            hoursWorked: 0,
                            users: new Set()
                        };
                    }
                    
                    // Add this user to the daily stats
                    if (userId) {
                        data.dailyStats[recordDate].users.add(userId);
                    }
                    
                    // Add metrics to daily stats
                    data.dailyStats[recordDate].opalDemos += parseInt(record.opalDemos || record.opal_demos || 0);
                    data.dailyStats[recordDate].opalSales += parseInt(record.opalSales || record.opal_sales || 0);
                    data.dailyStats[recordDate].scanDemos += parseInt(record.scanDemos || record.scan_demos || 0);
                    data.dailyStats[recordDate].scanSold += parseInt(record.scanSold || record.scan_sold || 0);
                    data.dailyStats[recordDate].netSales += parseFloat(record.netSales || record.net_sales || 0);
                    data.dailyStats[recordDate].hoursWorked += parseFloat(record.hoursWorked || record.hours_worked || 0);
                }
                
                // Aggregate to location totals
                data.opalDemos += parseInt(record.opalDemos || record.opal_demos || 0);
                data.opalSales += parseInt(record.opalSales || record.opal_sales || 0);
                data.scanDemos += parseInt(record.scanDemos || record.scan_demos || 0);
                data.scanSold += parseInt(record.scanSold || record.scan_sold || 0);
                data.netSales += parseFloat(record.netSales || record.net_sales || 0);
                data.hoursWorked += parseFloat(record.hoursWorked || record.hours_worked || 0);
            });

            // Calculate derived metrics
            data.totalSales = data.opalSales + data.scanSold;
            
            // Use active user count if available and non-zero
            if (data.activeUserIds.size > 0) {
                data.activeUserCount = data.activeUserIds.size;
            } else {
                data.activeUserCount = data.userCount;
            }
            
            return data;
        }

        function getUserData(user) {
            // Get all tracking data for this user
            const userTrackingData = allTrackingData.filter(record => {
                const recordUserId = record.userId || record.user_id;
                return recordUserId == user.id || recordUserId === parseInt(user.id);
            });

            // Apply date filter
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const safeStart = startDate || endDate || '';
            const safeEnd = endDate || startDate || '';
            const filteredData = filterDataByDate(userTrackingData, safeStart, safeEnd);

            // Initialize user data structure
            const data = {
                opalDemos: 0,
                opalSales: 0,
                scanDemos: 0,
                scanSold: 0,
                netSales: 0,
                hoursWorked: 0,
                dailyStats: {},  // For time-based aggregations
                dailyEntries: {} // Keep track of days with entries
            };

            // Aggregate the data
            filteredData.forEach(record => {
                // Track daily stats for time-based analysis
                const recordDate = record.date || (record.timestamp ? record.timestamp.split('T')[0] : null);
                if (recordDate) {
                    if (!data.dailyStats[recordDate]) {
                        data.dailyStats[recordDate] = {
                            opalDemos: 0,
                            opalSales: 0, 
                            scanDemos: 0,
                            scanSold: 0,
                            netSales: 0,
                            hoursWorked: 0,
                            entriesCount: 0
                        };
                    }
                    
                    // Count entries for this day
                    data.dailyStats[recordDate].entriesCount++;
                    
                    // Add metrics to daily stats
                    data.dailyStats[recordDate].opalDemos += parseInt(record.opalDemos || record.opal_demos || 0);
                    data.dailyStats[recordDate].opalSales += parseInt(record.opalSales || record.opal_sales || 0);
                    data.dailyStats[recordDate].scanDemos += parseInt(record.scanDemos || record.scan_demos || 0);
                    data.dailyStats[recordDate].scanSold += parseInt(record.scanSold || record.scan_sold || 0);
                    data.dailyStats[recordDate].netSales += parseFloat(record.netSales || record.net_sales || 0);
                    data.dailyStats[recordDate].hoursWorked += parseFloat(record.hoursWorked || record.hours_worked || 0);
                    
                    // Mark that we have data for this day
                    data.dailyEntries[recordDate] = true;
                }
                
                // Aggregate to user totals
                data.opalDemos += parseInt(record.opalDemos || record.opal_demos || 0);
                data.opalSales += parseInt(record.opalSales || record.opal_sales || 0);
                data.scanDemos += parseInt(record.scanDemos || record.scan_demos || 0);
                data.scanSold += parseInt(record.scanSold || record.scan_sold || 0);
                data.netSales += parseFloat(record.netSales || record.net_sales || 0);
                data.hoursWorked += parseFloat(record.hoursWorked || record.hours_worked || 0);
            });

            // Calculate derived metrics
            data.totalSales = data.opalSales + data.scanSold;
            data.sessionsCount = filteredData.length;
            data.daysWithData = Object.keys(data.dailyEntries).length;
            
            // Calculate conversion rates
            const totalDemos = data.opalDemos + data.scanDemos;
            data.conversionRate = totalDemos > 0 ? ((data.totalSales / totalDemos) * 100).toFixed(1) : 0;
            data.opalConversionRate = data.opalDemos > 0 ? ((data.opalSales / data.opalDemos) * 100).toFixed(1) : 0;
            data.scanConversionRate = data.scanDemos > 0 ? ((data.scanSold / data.scanDemos) * 100).toFixed(1) : 0;
            
            // Calculate average metrics
            data.salesPerSession = data.sessionsCount > 0 ? (data.totalSales / data.sessionsCount).toFixed(1) : 0;
            data.salesPerDay = data.daysWithData > 0 ? (data.totalSales / data.daysWithData).toFixed(1) : 0;
            
            // Removed salesPerHour metric per requirement
            
            return data;
        }

        function filterDataByDate(data, startDate, endDate) {
            if (!startDate && !endDate) return data;
            
            return data.filter(record => {
                const recordDate = record.date || (record.timestamp ? record.timestamp.split('T')[0] : '');
                if (!recordDate && (startDate || endDate)) return false;
                
                if (startDate && recordDate < startDate) return false;
                if (endDate && recordDate > endDate) return false;
                return true;
            });
        }

        function createLocationCard(location, data) {
            const card = document.createElement('div');
            card.className = 'location-card';
            
            // Calculate conversion rates
            const totalDemos = data.opalDemos + data.scanDemos;
            const conversionRate = totalDemos > 0 ? ((data.totalSales / totalDemos) * 100).toFixed(1) : 0;
            const opalConversionRate = data.opalDemos > 0 ? ((data.opalSales / data.opalDemos) * 100).toFixed(1) : 0;
            const scanConversionRate = data.scanDemos > 0 ? ((data.scanSold / data.scanDemos) * 100).toFixed(1) : 0;
            
            // Calculate sales per hour for location-only display
            const salesPerHour = data.hoursWorked > 0 ? (data.totalSales / data.hoursWorked).toFixed(1) : 0;

            // Date badge reflects current selected range; fallback to today's date
            const todayText = new Date().toLocaleDateString('en-US', {
                month: 'short', day: 'numeric', year: 'numeric'
            });
            const selectedRangeText = (document.getElementById('dateRangeText')?.textContent || '').trim();
            const currentDateText = selectedRangeText || todayText;

            // Build concatenated user list for this location
            const usersInThisLocation = (Array.isArray(allUsers) ? allUsers : []).filter(u => {
                const userLoc = u.location || u.locationId || u.location_id;
                if (userLoc == location.id) return true;
                const locName = location.name || location.location_name;
                if (locName && userLoc) {
                    return String(userLoc).toLowerCase() === String(locName).toLowerCase();
                }
                return false;
            });
            const userNamesUnique = Array.from(new Set(usersInThisLocation
                .map(u => (u.name || u.username || '').trim())
                .filter(Boolean)));
            const userNamesJoined = userNamesUnique.length ? userNamesUnique.join(', ') : 'No users assigned';
            
            card.innerHTML = `
                <div class="location-card-header">
                    <div class="location-title-row">
                        <div>
                            <div class="location-name">${location.name || location.location_name}</div>
                            <div class="location-subtitle">
                                <i class="fas fa-building"></i> ${location.mall || 'Branch Location'}
                                <span style="margin-left:8px; padding:2px 8px; border-radius:12px; background: rgba(255,255,255,0.6); color:#374151; font-size:12px;">
                                    <i class="fas fa-calendar-day" style="margin-right:4px;"></i>${currentDateText}
                                </span>
                            </div>
                        </div>
                        <div class="location-icon">
                            <i class="fas fa-map-marker-alt"></i>
                        </div>
                    </div>
                    
                    <div class="location-stats">
                        <div class="location-stat">
                            <div class="stat-value">${totalDemos}</div>
                            <div class="stat-label">Demos</div>
                        </div>
                        <div class="location-stat">
                            <div class="stat-value">${data.totalSales}</div>
                            <div class="stat-label">Sales</div>
                        </div>
                        <div class="location-stat">
                            <div class="stat-value">${conversionRate}%</div>
                            <div class="stat-label">Conversion</div>
                        </div>
                        <div class="location-stat">
                            <div class="stat-value">${salesPerHour}</div>
                            <div class="stat-label">Sales/Hr</div>
                        </div>
                    </div>
                </div>
                
                <div class="location-card-body">
                    <div class="location-metrics-grid">
                        <div class="location-metric-item">
                            <div class="location-metric-label">Opal Demos</div>
                            <div class="location-metric-value">${data.opalDemos}</div>
                        </div>
                        <div class="location-metric-item">
                            <div class="location-metric-label">Opal Sales</div>
                            <div class="location-metric-value">${data.opalSales}</div>
                        </div>
                        <div class="location-metric-item">
                            <div class="location-metric-label">Scan Demos</div>
                            <div class="location-metric-value">${data.scanDemos}</div>
                        </div>
                        <div class="location-metric-item">
                            <div class="location-metric-label">Scan Sales</div>
                            <div class="location-metric-value">${data.scanSold}</div>
                        </div>
                    </div>
                    
                    <div class="location-totals">
                        <div class="location-total">
                            <div class="location-total-label">Total Revenue</div>
                            <div class="location-total-value">$${data.netSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                        </div>
                        <div class="location-total">
                            <div class="location-total-label">Total Hours</div>
                            <div class="location-total-value">${data.hoursWorked.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div>
                        </div>
                    </div>
                    
                    <div class="location-user-count">
                        <i class="fas fa-users"></i>
                        <span>${userNamesUnique.length} Team Members</span>
                    </div>
                    <div class="location-user-list" style="margin-top:8px; color:#374151; font-size: 12px; line-height:1.4;">
                        <i class="fas fa-user" style="margin-right:6px; color:#6b7280;"></i>
                        <span>${userNamesJoined}</span>
                    </div>
                </div>
            `;
            
            return card;
        }

        function createUserCard(user, data) {
            const card = document.createElement('div');
            card.className = 'user-card';
            
            const locationName = allLocations.find(loc => 
                (loc.id || loc.name) === (user.location || user.locationId || user.location_id)
            )?.name || user.location || 'No Location';
            
            // Get user initials for avatar
            const nameParts = (user.name || user.username || '').split(' ');
            const initials = nameParts.length > 1 
                ? (nameParts[0][0] + nameParts[1][0]).toUpperCase()
                : (nameParts[0] ? nameParts[0][0].toUpperCase() : 'U');
                
            // Removed sales per hour from user card per requirement
            const salesPerHour = null;
            
            // Calculate costs (placeholder for postage cost)
            const costEstimate = data.totalSales * 0.15; // Assuming 15% cost for demonstration
            
            // Calculate conversion rates
            const opalConversionRate = data.opalDemos > 0 ? ((data.opalSales / data.opalDemos) * 100).toFixed(1) : 0;
            const scanConversionRate = data.scanDemos > 0 ? ((data.scanSold / data.scanDemos) * 100).toFixed(1) : 0;

            card.innerHTML = `
                <div class="user-header">
                    <div class="user-avatar">
                        ${initials}
                    </div>
                    <div class="user-info">
                        <div class="user-title">${user.name || user.username}</div>
                        <div class="user-location">
                            <i class="fas fa-map-marker-alt"></i> ${locationName}
                        </div>
                    </div>
                </div>
                
                <!-- Primary Metrics: Net Sales and Hours Worked -->
                <div class="primary-metrics">
                    <div class="primary-metric">
                        <div class="primary-metric-label">Net Sales</div>
                        <div class="primary-metric-value">$${data.netSales.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    <div class="primary-metric">
                        <div class="primary-metric-label">Hours Worked</div>
                        <div class="primary-metric-value">${data.hoursWorked.toLocaleString(undefined, {minimumFractionDigits: 1, maximumFractionDigits: 1})}</div>
                    </div>
                </div>
                
                <!-- Sales Performance Metrics -->
                <div class="sales-metrics">
                    <div class="sales-metric">
                        <div class="sales-metric-label">Cost</div>
                        <div class="sales-metric-value">$${costEstimate.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</div>
                    </div>
                    
                </div>
                
                <!-- Opal and Scan Metrics -->
                <div class="user-performance-grid">
                    <div class="user-performance-metric">
                        <div class="metric-header">
                            <div class="metric-icon"><i class="fas fa-eye"></i></div>
                            <div class="metric-name">Opal Demo</div>
                        </div>
                        <div class="metric-value">${data.opalDemos}</div>
                    </div>
                    <div class="user-performance-metric">
                        <div class="metric-header">
                            <div class="metric-icon"><i class="fas fa-shopping-cart"></i></div>
                            <div class="metric-name">Opal Sales</div>
                        </div>
                        <div class="metric-value" style="font-weight:900;color:#111">${data.opalSales}</div>
                    </div>
                    <div class="user-performance-metric">
                        <div class="metric-header">
                            <div class="metric-icon"><i class="fas fa-qrcode"></i></div>
                            <div class="metric-name">Scan Demo</div>
                        </div>
                        <div class="metric-value">${data.scanDemos}</div>
                    </div>
                    <div class="user-performance-metric">
                        <div class="metric-header">
                            <div class="metric-icon"><i class="fas fa-check-circle"></i></div>
                            <div class="metric-name">Scan Sold</div>
                        </div>
                        <div class="metric-value">${data.scanSold}</div>
                    </div>
                </div>
                
                <!-- Conversion Rates -->
                <div class="conversion-rates">
                    <div class="conversion-rate">
                        <div class="conversion-label">Opal Rate</div>
                        <div class="conversion-value">${opalConversionRate}%</div>
                    </div>
                    <div class="conversion-rate">
                        <div class="conversion-label">Scan Rate</div>
                        <div class="conversion-value">${scanConversionRate}%</div>
                    </div>
                </div>
            `;
            
            return card;
        }

        // ===== UTILITY FUNCTIONS =====
                 function setDefaultDates() {
    // Default: Last 30 days, using LOCAL date components (no UTC shift)
    const end = new Date();
    const start = new Date();
    start.setDate(end.getDate() - 29);
    const toYMDLocal = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
    const startVal = toYMDLocal(start);
    const endVal = toYMDLocal(end);
    document.getElementById('startDate').value = startVal;
    document.getElementById('endDate').value = endVal;
    document.getElementById('dateRangeText').textContent = 'Last 30 days';
}


        function applyQuickFilter() {
            const period = document.getElementById('timePeriod').value;
            const today = new Date();
            let startDate, endDate;
            let periodName = '';

            switch(period) {
                case 'today':
                    const toYMDLocal = d => `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}-${String(d.getDate()).padStart(2,'0')}`;
                    startDate = endDate = toYMDLocal(today);
                    periodName = 'Today';
                    break;
                case 'yesterday':
                    const yesterday = new Date(today.getTime() - 24 * 60 * 60 * 1000);
                    startDate = endDate = toYMDLocal(yesterday);
                    periodName = 'Yesterday';
                    break;
                case 'week':
                    const weekStart = new Date(today.getTime() - (today.getDay() * 24 * 60 * 60 * 1000));
                    startDate = toYMDLocal(weekStart);
                    endDate = toYMDLocal(today);
                    periodName = 'This Week';
                    break;
                case 'month':
                    const monthStart = new Date(today.getFullYear(), today.getMonth(), 1);
                    startDate = toYMDLocal(monthStart);
                    endDate = toYMDLocal(today);
                    periodName = 'This Month';
                    break;
                case 'quarter':
                    const quarterStart = new Date(today.getFullYear(), Math.floor(today.getMonth() / 3) * 3, 1);
                    startDate = toYMDLocal(quarterStart);
                    endDate = toYMDLocal(today);
                    periodName = 'This Quarter';
                    break;
                default:
                    return; // Custom range, don't change dates
            }

            if (startDate && endDate) {
                // Update date inputs
                document.getElementById('startDate').value = startDate;
                document.getElementById('endDate').value = endDate;
                
                // Update date range pill
                document.getElementById('dateRangeText').textContent = periodName;
                
                // Generate analytics with new filter
                generateAnalytics();
            }
        }

        function applyDateFilter() {
            // Update the date range pill
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            let dateRangeText;
            
            if (startDate && endDate) {
                // Format dates for display
                const start = new Date(startDate);
                const end = new Date(endDate);
                const startFormatted = start.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
                const endFormatted = end.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'});
                
                if (startDate === endDate) {
                    dateRangeText = startFormatted;
                } else {
                    dateRangeText = `${startFormatted} - ${endFormatted}`;
                }
            } else if (startDate) {
                const start = new Date(startDate);
                dateRangeText = `From ${start.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            } else if (endDate) {
                const end = new Date(endDate);
                dateRangeText = `Until ${end.toLocaleDateString('en-US', {month: 'short', day: 'numeric', year: 'numeric'})}`;
            } else {
                dateRangeText = 'All available data';
            }
            
            document.getElementById('dateRangeText').textContent = dateRangeText;
            
            // Generate analytics with the new filter
            generateAnalytics();
        }

        function refreshData() {
            console.log('🔄 Refreshing analytics data...');
            document.querySelectorAll('.analytics-section').forEach(section => section.classList.add('loading'));
            
            // Clear localStorage to force fresh data fetch
            localStorage.removeItem('trackingData');
            localStorage.removeItem('users');
            localStorage.removeItem('locations');
            
            // Show loading message
            const refreshMessage = document.createElement('div');
            refreshMessage.id = 'refresh-message';
            refreshMessage.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(255, 255, 255, 0.9); padding: 15px 20px; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); z-index: 1000; display: flex; align-items: center; gap: 10px;';
            refreshMessage.innerHTML = '<i class="fas fa-sync-alt fa-spin" style="color: var(--main-color);"></i> <span>Loading real-time data...</span>';
            document.body.appendChild(refreshMessage);
            
            Promise.all([loadTrackingData(), loadUsers(), loadLocations()]).then(() => {
                generateAnalytics();
                document.querySelectorAll('.analytics-section').forEach(section => section.classList.remove('loading'));
                
                // Update refresh message
                refreshMessage.innerHTML = '<i class="fas fa-check-circle" style="color: #10b981;"></i> <span>Data refreshed successfully!</span>';
                refreshMessage.style.background = 'rgba(16, 185, 129, 0.1)';
                
                // Remove message after 3 seconds
                setTimeout(() => {
                    refreshMessage.style.opacity = '0';
                    setTimeout(() => refreshMessage.remove(), 500);
                }, 3000);
            }).catch(error => {
                console.error('Error refreshing data:', error);
                
                // Update refresh message for error
                refreshMessage.innerHTML = '<i class="fas fa-exclamation-circle" style="color: #ef4444;"></i> <span>Error refreshing data</span>';
                refreshMessage.style.background = 'rgba(239, 68, 68, 0.1)';
                
                // Remove message after 3 seconds
                setTimeout(() => {
                    refreshMessage.style.opacity = '0';
                    setTimeout(() => refreshMessage.remove(), 500);
                }, 3000);
            });
        }

        function exportToCSV() {
            const csvData = [
                ['Type', 'Name', 'Location', 'Opal Demos', 'Opal Sales', 'Scan Demos', 'Scan Sales', 'Total Sales', 'Sessions/Users']
            ];

            // Add location data
            let locationsToShow = allLocations;
            if (currentLocationContext && currentLocationContext.id) {
                locationsToShow = allLocations.filter(loc => 
                    loc.id == currentLocationContext.id || 
                    loc.name === currentLocationContext.name
                );
            }

            locationsToShow.forEach(location => {
                const data = getLocationData(location);
                csvData.push([
                    'Location',
                    location.name || location.location_name,
                    location.mall || 'N/A',
                    data.opalDemos,
                    data.opalSales,
                    data.scanDemos,
                    data.scanSold,
                    data.totalSales,
                    data.userCount
                ]);
            });

            // Add user data
            let usersToShow = allUsers;
            if (currentLocationContext && currentLocationContext.id) {
                usersToShow = allUsers.filter(user => {
                    const userLocation = user.location || user.locationId || user.location_id;
                    return userLocation == currentLocationContext.id;
                });
            }

            usersToShow.forEach(user => {
                const data = getUserData(user);
                const locationName = allLocations.find(loc => 
                    (loc.id || loc.name) === (user.location || user.locationId || user.location_id)
                )?.name || user.location || 'No Location';

                csvData.push([
                    'User',
                    user.name || user.username,
                    locationName,
                    data.opalDemos,
                    data.opalSales,
                    data.scanDemos,
                    data.scanSold,
                    data.totalSales,
                    data.sessionsCount
                ]);
            });

            const csvContent = csvData.map(row => row.join(',')).join('\n');
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            
            const a = document.createElement('a');
            a.href = url;
            a.download = `analytics-export-${new Date().toISOString().split('T')[0]}.csv`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            window.URL.revokeObjectURL(url);
            
            console.log('📊 Analytics data exported to CSV');
        }

        function toggleUserMenu() {
            const menu = document.getElementById('user-menu');
            menu.classList.toggle('show');
        }

        function signOut() {
            if (confirm('Are you sure you want to sign out?')) {
                localStorage.removeItem("username");
                localStorage.removeItem("isLoggedIn");
                localStorage.removeItem("isAdmin");
                localStorage.removeItem("role");
                localStorage.removeItem("currentLocationCode");
                localStorage.removeItem("adminDashboardMode");
                
                if (currentLocationContext && currentLocationContext.url_name) {
                    window.location.href = "/login";
                } else {
                    window.location.href = "/login";
                }
            }
        }

        // ===== MOBILE MENU =====
        document.getElementById('mobile-menu-btn').addEventListener('click', function() {
            document.querySelector('.sidebar').classList.toggle('mobile-open');
        });

        // Close mobile menu when clicking outside
        document.addEventListener('click', function(e) {
            const sidebar = document.querySelector('.sidebar');
            const mobileBtn = document.getElementById('mobile-menu-btn');
            
            if (!sidebar.contains(e.target) && !mobileBtn.contains(e.target)) {
                sidebar.classList.remove('open');
            }
        });

        // Close user menu when clicking outside
        document.addEventListener('click', function(e) {
            const userProfile = document.getElementById('user-profile');
            const userMenu = document.getElementById('user-menu');
            
            if (!userProfile.contains(e.target)) {
                userMenu.classList.remove('show');
            }
        });
    </script>

    <!-- Sessions Modal -->
    <div id="sessions-modal" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2000; align-items:center; justify-content:center;">
        <div style="background:#fff; width:90%; max-width:900px; max-height:80vh; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.3); display:flex; flex-direction:column;">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color:#fff; border-radius:16px 16px 0 0;">
                <div id="sessions-modal-title" style="font-weight:800;">Sessions</div>
                <button onclick="closeSessionsModal()" class="simple-modal-close" style="background:transparent; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="sessions-modal-body" style="padding:16px; overflow:auto;"></div>
        </div>
    </div>

    <!-- Demo Details Modal -->
    <div id="demo-details-viewer" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.5); z-index:2100; align-items:center; justify-content:center;">
        <div style="background:#fff; width:90%; max-width:600px; max-height:80vh; border-radius:16px; box-shadow:0 20px 60px rgba(0,0,0,0.3); display:flex; flex-direction:column;">
            <div style="padding:16px 20px; border-bottom:1px solid #eee; display:flex; justify-content:space-between; align-items:center; background:linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color:#fff; border-radius:16px 16px 0 0;">
                <div id="demo-modal-title" style="font-weight:800;">Demo Details</div>
                <button onclick="closeDemoDetailsModal()" class="simple-modal-close" style="background:transparent; border:none; color:#fff; font-size:24px; cursor:pointer;">&times;</button>
            </div>
            <div id="demo-modal-body" style="padding:20px; overflow:auto;"></div>
        </div>
    </div>

    <script>
        function openUserSessions(userId, username) {
            const modal = document.getElementById('sessions-modal');
            const body = document.getElementById('sessions-modal-body');
            const title = document.getElementById('sessions-modal-title');
            const user = (allUsers || []).find(u => parseInt(u.id) === parseInt(userId)) || { id: userId, username: username, name: username };
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;
            const sessions = getUserSessions(user, startDate, endDate);
            title.textContent = `${user.name || user.username || 'User'} • ${sessions.length} sessions`;
            if (!sessions.length) {
                body.innerHTML = '<div style="padding:20px; color:#555;">No sessions found for selected range.</div>';
            } else {
                let html = '';
                sessions.forEach((s, idx) => {
                    const date = s.date || (s.timestamp ? s.timestamp.split('T')[0] : '');
                    const time = s.time || (s.timestamp ? s.timestamp.split('T')[1]?.slice(0,8) : '');
                    html += `
                    <div style="border:1px solid #eee; border-radius:12px; padding:12px 14px; margin-bottom:10px; background:#fafafa;">
                        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <div style="font-weight:700; color:#111;">Session ${idx+1} • ${date} ${time?('• '+time):''}</div>
                            <button class="filter-btn" onclick='openDemoDetailsModal(${JSON.stringify(idx)}, ${JSON.stringify(s.opal_demo_numbers||[])}, ${JSON.stringify(s.scan_demo_numbers||[])})'>
                                <i class="fas fa-list"></i> See Demo Details
                            </button>
                        </div>
                        <div style="display:grid; grid-template-columns:repeat(6,minmax(0,1fr)); gap:8px;">
                            <div><div class="sales-metric-label">Opal Demo</div><div class="sales-metric-value">${parseInt(s.opalDemos||s.opal_demos||0)}</div></div>
                            <div><div class="sales-metric-label">Opal Sales</div><div class="sales-metric-value">${parseInt(s.opalSales||s.opal_sales||0)}</div></div>
                            <div><div class="sales-metric-label">Scan Demo</div><div class="sales-metric-value">${parseInt(s.scanDemos||s.scan_demos||0)}</div></div>
                            <div><div class="sales-metric-label">Scan Sold</div><div class="sales-metric-value">${parseInt(s.scanSold||s.scan_sold||0)}</div></div>
                            <div><div class="sales-metric-label">Net Sales</div><div class="sales-metric-value">$${parseFloat(s.netSales||s.net_sales||0).toLocaleString(undefined,{minimumFractionDigits:2,maximumFractionDigits:2})}</div></div>
                            <div><div class="sales-metric-label">Hours</div><div class="sales-metric-value">${parseFloat(s.hoursWorked||s.hours_worked||0).toFixed(1)}</div></div>
                        </div>
                    </div>`;
                });
                body.innerHTML = html;
            }
            modal.style.display = 'flex';
        }

        function closeSessionsModal() {
            document.getElementById('sessions-modal').style.display = 'none';
        }

        function openDemoDetailsModal(index, opalList, scanList) {
            const modal = document.getElementById('demo-details-viewer');
            const body = document.getElementById('demo-modal-body');
            const title = document.getElementById('demo-modal-title');
            title.textContent = `Demo Details`;
            const renderList = (title, arr) => {
                if (!Array.isArray(arr) || arr.length === 0) {
                    return `<div style='margin-bottom:10px'><div class='metric-label'>${title}</div><div style='color:#666'>No detailed numbers</div></div>`;
                }
                return `<div style='margin-bottom:10px'><div class='metric-label'>${title}</div><div style='display:flex;flex-wrap:wrap;gap:8px;'>${arr.map(v=>`<span style='background:#f3f4f6;border:1px solid #e5e7eb;border-radius:8px;padding:6px 10px;font-weight:600;color:#111'>${v}</span>`).join('')}</div></div>`;
            };
            body.innerHTML = renderList('OPAL Demo Numbers', opalList) + renderList('Scan Demo Numbers', scanList);
            modal.style.display = 'flex';
        }

        function closeDemoDetailsModal() {
            document.getElementById('demo-details-viewer').style.display = 'none';
        }
    </script>

    <script>
        // Robust local-date filter helper used by analytics
        function filterDataByDate(records, startDate, endDate, local) {
            if (!Array.isArray(records) || (!startDate && !endDate)) {
                return records || [];
            }
            const s = startDate || null;
            const e = endDate || null;
            return records.filter(rec => {
                const d = (rec.date || (rec.timestamp ? String(rec.timestamp).split('T')[0] : ''));
                if (!d) return false;
                if (s && d < s) return false;
                if (e && d > e) return false;
                return true;
            });
        }
    </script>
</body>
</html> 