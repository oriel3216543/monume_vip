<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport"="width=device-width, initial-scale=1.0">
    <title>MonuMe Tracker - Dashboard</title>
    <link rel="icon" type="image/x-icon" href="/favicon.ico">
    <!-- Authentication Check -->
    <script>
        // Immediate authentication check - runs before page loads
        (function() {
            const username = localStorage.getItem("username");
            const isLoggedIn = localStorage.getItem("isLoggedIn");
            
            if (!username || !isLoggedIn) {
                console.log("Authentication failed, redirecting to login page");
                window.location.href = "/login";
                return;
            }

            // Check for location-specific access
            const urlParams = new URLSearchParams(window.location.search);
            const locationParam = urlParams.get('location');
            const locationCode = localStorage.getItem("locationCode") || localStorage.getItem("location_username") || localStorage.getItem("location_name");
            const isAdmin = localStorage.getItem("isAdmin") === "true";
            const role = localStorage.getItem("role");

            // If URL has location parameter and user is not admin
            if (locationParam && !isAdmin) {
                // Verify user has access to this location
                if (locationCode !== locationParam) {
                    console.log("Access denied to location:", locationParam);
                    alert("Access denied. You don't have permission to access this location.");
                    window.location.href = "/login";
                    return;
                }
            }

            // If user is not admin and no location parameter, redirect to their location
            if (!isAdmin && locationCode && !locationParam) {
                console.log("Redirecting user to their location dashboard:", locationCode);
                window.location.href = `/dashboard?location=${locationCode}`;
                return;
            }

            console.log("Authentication successful for:", username, "Role:", role, "Location:", locationCode || "all");
        })();
    </script>
    <!-- Load sidebar loader immediately for instant sidebar display -->
    <script src="/sidebar-loader.js"></script>
    
    <!-- Preload critical resources -->
    <link rel="preload" href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@300;400;500;600;700;800&display=swap" as="style">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" as="style">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --main-color: #ff9562;
            --primary-color: #ff9562; /* For compatibility with appointment.html */
            --primary-color-rgb: 255, 149, 98; /* RGB values for rgba() usage */
            --gradient-start: #ff7f42;
            --gradient-end: #ff9562;
            --sidebar-bg: #272430; /* Updated to match sidebar.html */
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-hover-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #f8f9fa;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 10px 25px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 16px;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
            --border-color: #e5e7eb;
            --radius-sm: 0.375rem;
            --radius-md: 0.5rem;
            --radius-lg: 0.75rem;
            --radius-xl: 1rem;
            --radius-2xl: 1.5rem;
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --transition-fast: all 0.15s ease;
            --transition-normal: all 0.3s ease;
        }

        body {
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1500"><rect fill="%23ff9562" width="2000" height="1500"/><defs><radialGradient id="a" gradientUnits="objectBoundingBox"><stop offset="0" stop-color="%23ffffff"/><stop offset="1" stop-color="%23ff9562"/></radialGradient><linearGradient id="b" gradientUnits="userSpaceOnUse" x1="0" y1="750" x2="1550" y2="750"><stop offset="0" stop-color="%23ffcab1"/><stop offset="1" stop-color="%23ff9562"/></linearGradient></defs><path fill="url(%23a)" d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z"/><path d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z" fill="url(%23b)"/></svg>') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Enhanced Sidebar Styles - Same as Management Page */
        .sidebar {
            width: 280px;
            background: linear-gradient(180deg, var(--main-color) 0%, #e8824d 100%);
            min-height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            transition: var(--transition);
            z-index: 100;
            box-shadow: var(--shadow-lg);
            border-right: 1px solid rgba(255, 255, 255, 0.3);
            display: flex;
            flex-direction: column;
        }

        .sidebar-header {
            padding: 32px 24px 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
            position: relative;
        }

        .sidebar-header::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 24px;
            right: 24px;
            height: 2px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.6), transparent);
            opacity: 0.8;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%;
        }

        .sidebar-brand a {
            text-decoration: none;
            color: inherit;
            display: block;
            width: 100%;
        }

        .logo-container {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 8px;
            transition: var(--transition);
            width: 100%;
            min-height: 80px;
        }

        .logo-container:hover {
            transform: scale(1.05);
        }

        .sidebar-logo {
            max-width: 200px;
            max-height: 100px;
            width: auto;
            height: auto;
            object-fit: contain;
            transition: var(--transition);
            filter: drop-shadow(0 2px 8px rgba(0, 0, 0, 0.2));
            display: block;
            margin: 0 auto;
        }

        .sidebar-logo:hover {
            transform: translateY(-2px) scale(1.05);
            filter: drop-shadow(0 4px 12px rgba(0, 0, 0, 0.3));
        }

        .sidebar-divider {
            height: 1px;
            background: rgba(255, 255, 255, 0.2);
            margin-top: 24px;
            opacity: 0.6;
        }

        .sidebar-navigation {
            flex: 1;
            overflow-y: auto;
            padding: 40px 0;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 255, 255, 0.3) transparent;
        }

        .sidebar-navigation::-webkit-scrollbar {
            width: 4px;
        }

        .sidebar-navigation::-webkit-scrollbar-track {
            background: transparent;
        }

        .sidebar-navigation::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
        }

        .sidebar-menu {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .menu-item {
            margin: 0 16px;
            border-radius: 12px;
            overflow: hidden;
            transition: var(--transition);
        }

        .menu-link {
            display: flex;
            align-items: center;
            padding: 18px 20px;
            color: rgba(255, 255, 255, 0.9);
            text-decoration: none;
            font-size: 16px;
            font-weight: 500;
            border-radius: 12px;
            transition: var(--transition);
            position: relative;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .menu-link::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 0;
            background: rgba(255, 255, 255, 0.2);
            transition: var(--transition);
            border-radius: 12px;
        }

        .menu-icon {
            width: 44px;
            height: 44px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 10px;
            margin-right: 16px;
            transition: var(--transition);
            font-size: 18px;
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
        }

        .menu-icon i {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            line-height: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .menu-text {
            flex: 1;
            font-size: 16px;
            font-weight: 600;
            transition: var(--transition);
            color: white;
        }

        .menu-arrow {
            opacity: 0;
            transform: translateX(-8px);
            transition: var(--transition);
            color: white;
            font-size: 14px;
        }

        /* Hover and Active States - Fixed Icon Position */
        .menu-item:hover .menu-link {
            color: white;
            background: rgba(255, 255, 255, 0.2);
            transform: translateX(6px);
            border-color: rgba(255, 255, 255, 0.4);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.1);
        }

        .menu-item:hover .menu-link::before {
            width: 4px;
        }

        .menu-item:hover .menu-icon {
            background: rgba(255, 255, 255, 0.3);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            /* Icon stays in place - no transform */
        }

        .menu-item:hover .menu-arrow {
            opacity: 1;
            transform: translateX(0);
            color: white;
        }

        /* Active State - Fixed Icon Position */
        .menu-item.active .menu-link {
            color: white;
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(6px);
            border-color: rgba(255, 255, 255, 0.5);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        .menu-item.active .menu-link::before {
            width: 4px;
        }

        .menu-item.active .menu-icon {
            background: rgba(255, 255, 255, 0.4);
            color: white;
            box-shadow: 0 6px 16px rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
            /* Icon stays in place - no transform */
        }

        .menu-item.active .menu-arrow {
            opacity: 1;
            transform: translateX(0);
            color: white;
        }

        .sidebar-footer {
            padding: 24px;
            border-top: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(255, 255, 255, 0.1);
        }

        .user-profile {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px;
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            transition: var(--transition);
            border: 1px solid rgba(255, 255, 255, 0.2);
            cursor: pointer;
            position: relative;
        }

        .user-profile:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            border-color: rgba(255, 255, 255, 0.4);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .user-info {
            flex: 1;
        }

        .user-name {
            color: white;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 2px;
        }

        .user-status {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .user-status::before {
            content: '';
            width: 6px;
            height: 6px;
            background: #4caf50;
            border-radius: 50%;
            animation: pulse 2s infinite;
        }

        .user-menu-toggle {
            color: rgba(255, 255, 255, 0.8);
            font-size: 12px;
            transition: var(--transition);
        }

        .user-profile:hover .user-menu-toggle {
            color: white;
            transform: rotate(180deg);
        }

        .user-menu {
            position: absolute;
            bottom: 100%;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 12px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.2);
            border: 1px solid rgba(255, 255, 255, 0.3);
            margin-bottom: 8px;
            opacity: 0;
            visibility: hidden;
            transform: translateY(10px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            z-index: 1000;
        }

        .user-menu.show {
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
        }

        .user-menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 16px 20px;
            color: #333;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            border-radius: 12px;
            margin: 4px;
        }

        .user-menu-item:hover {
            background: rgba(255, 149, 98, 0.1);
            color: var(--main-color);
            transform: translateX(4px);
        }

        .user-menu-item i {
            font-size: 16px;
            width: 20px;
            text-align: center;
        }

        @keyframes pulse {
            0% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.2); opacity: 0.7; }
            100% { transform: scale(1); opacity: 1; }
        }

        /* Main content styles - FIXED FOR FULL DISPLAY */
        .main-content {
            margin-left: 280px;
            width: calc(100% - 280px);
            padding: 40px;
            transition: var(--transition);
            display: block;
            min-height: 100vh;
            position: relative;
            z-index: 1;
        }

        .welcome-container {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border-radius: 32px;
            box-shadow: 
                0 20px 40px rgba(255, 127, 66, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            padding: 64px 48px;
            margin-bottom: 64px;
            text-align: center;
            position: relative;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.15);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .welcome-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.6), 
                transparent);
        }

        .welcome-container::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.1) 0%, transparent 70%);
            border-radius: 50%;
            z-index: 0;
        }

        .welcome-container h1 {
            font-size: 3.5rem;
            font-weight: 900;
            margin-bottom: 16px;
            color: white;
            position: relative;
            z-index: 1;
            line-height: 1.1;
            letter-spacing: -2px;
        }

        .welcome-container p {
            font-size: 1.375rem;
            color: rgba(255, 255, 255, 0.85);
            margin: 0 auto;
            max-width: 600px;
            position: relative;
            z-index: 1;
            font-weight: 400;
            line-height: 1.5;
        }

        .welcome-container:hover {
            transform: translateY(-8px) scale(1.02);
            box-shadow: 
                0 25px 50px rgba(255, 127, 66, 0.3),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
        }

        /* Stats cards with improved glassmorphism */
        .stats-card {
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .welcome-container:hover::before {
            opacity: 1;
        }

        .welcome-container h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .welcome-container p {
            opacity: 0.9;
            font-size: 18px;
            max-width: 600px;
        }

        /* Modern Stats Grid Layout */
        .dashboard-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-bottom: 48px;
            padding: 0;
        }

        /* Enhanced Stat Cards with Premium Glass Design */
        .stat-card {
            background: rgba(255, 255, 255, 0.08);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border-radius: 24px;
            padding: 32px;
            box-shadow: 
                0 8px 32px rgba(0, 0, 0, 0.12),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            border: 1px solid rgba(255, 255, 255, 0.12);
            position: relative;
            overflow: hidden;
            min-height: 200px;
            display: flex;
            flex-direction: column;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                var(--gradient-start), 
                var(--gradient-end), 
                var(--gradient-start));
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .stat-card:hover {
            transform: translateY(-12px) scale(1.02);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.2),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.15);
        }

        .stat-card:hover::before {
            opacity: 1;
        }

        .stat-card-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            margin-bottom: 24px;
            flex-shrink: 0;
        }

        .stat-card-icon {
            width: 64px;
            height: 64px;
            border-radius: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: rgba(255, 255, 255, 0.15);
            color: white;
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 
                0 8px 25px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .stat-card-icon::before {
            content: '';
            position: absolute;
            inset: 0;
            border-radius: 20px;
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), transparent);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover .stat-card-icon {
            transform: translateY(-4px) rotate(5deg) scale(1.1);
            background: rgba(255, 255, 255, 0.25);
            box-shadow: 
                0 15px 35px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .stat-card:hover .stat-card-icon::before {
            opacity: 1;
        }

        .team-monume-title {
            font-size: 22px;
            color: rgba(255, 255, 255, 0.95);
            font-weight: 700;
            margin: 0;
            line-height: 1.3;
            letter-spacing: -0.5px;
        }

        .stat-card-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
        }

        .stat-card-value {
            font-size: 48px;
            font-weight: 900;
            margin: 20px 0 8px 0;
            color: rgba(255, 255, 255, 0.95);
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            line-height: 1;
            letter-spacing: -1px;
        }

        .stat-card:hover .stat-card-value {
            transform: scale(1.05);
            color: white;
            text-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
        }

        .stat-card-description {
            font-size: 16px;
            color: rgba(255, 255, 255, 0.75);
            margin-bottom: 24px;
            font-weight: 500;
            line-height: 1.4;
            flex: 1;
        }

        .appointments-card-value, .team-members-card-value, 
        .active-projects-card-value, .analytics-card-value, 
        .performance-card-value {
            font-family: 'Poppins', sans-serif;
            font-variant-numeric: tabular-nums;
        }

        /* Modern Action Buttons */
        .stat-card-actions {
            display: flex;
            gap: 8px;
            margin-top: auto;
            padding-top: 16px;
        }

        .stat-card-actions .action-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 16px 20px;
            border: none;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.1);
            color: rgba(255, 255, 255, 0.9);
            border-radius: 16px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            text-transform: none;
            letter-spacing: 0;
            min-height: 48px;
        }

        .stat-card-actions .action-button::before {
            content: '';
            position: absolute;
            inset: 0;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            opacity: 0;
            transition: opacity 0.3s ease;
            border-radius: 16px;
        }

        .stat-card-actions .action-button i {
            margin-right: 8px;
            font-size: 16px;
            transition: transform 0.3s ease;
            color: white;
        }

        .stat-card-actions .action-button:hover {
            transform: translateY(-2px);
            color: white;
            border-color: rgba(255, 255, 255, 0.3);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .stat-card-actions .action-button:hover::before {
            opacity: 1;
        }

        .stat-card-actions .action-button:active {
            transform: translateY(0);
        }

        .stat-card-actions .action-button:hover i {
            transform: scale(1.1);
        }

        /* Special styling for primary actions */
        .stat-card-actions .action-button.primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border-color: rgba(255, 255, 255, 0.2);
        }

        .stat-card-actions .action-button.primary::before {
            background: linear-gradient(135deg, var(--gradient-end), var(--gradient-start));
        }

        /* Coming soon overlay for disabled cards */
        .stat-card.coming-soon,
        .dashboard-bottom-card.coming-soon {
            position: relative;
        }
        .stat-card.coming-soon .coming-soon-overlay,
        .dashboard-bottom-card.coming-soon .coming-soon-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.55);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 5;
            color: #fff;
            text-transform: uppercase;
            font-weight: 800;
            letter-spacing: 1px;
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
            cursor: not-allowed;
        }
        .stat-card.coming-soon .coming-soon-overlay span,
        .dashboard-bottom-card.coming-soon .coming-soon-overlay span {
            display: inline-flex;
            align-items: center;
            gap: 10px;
            padding: 10px 16px;
            border-radius: 999px;
            background: rgba(255, 255, 255, 0.12);
            border: 1px solid rgba(255,255,255,0.3);
        }
        .stat-card.coming-soon .stat-card-actions,
        .stat-card.coming-soon .stat-card-content button,
        .stat-card.coming-soon a,
        .dashboard-bottom-card.coming-soon .modern-card-header .header-action-btn,
        .dashboard-bottom-card.coming-soon .chat-input,
        .dashboard-bottom-card.coming-soon .send-button,
        .dashboard-bottom-card.coming-soon a {
            pointer-events: none !important;
            opacity: 0.6;
        }

        /* Dashboard sections - Clean Modern Layout */
        .dashboard-sections {
            display: grid;
            grid-template-columns: 1fr;
            gap: 32px;
            margin-bottom: 40px;
        }

        /* Dashboard cards - Enhanced Glassmorphism */
        .dashboard-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 24px;
            padding: 40px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.18);
            position: relative;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.4), transparent);
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.18);
        }

        .dashboard-card h3 {
            margin-bottom: 24px;
            color: white;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            position: relative;
            padding-bottom: 12px;
        }

        .dashboard-card h3::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 60px;
            height: 3px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
            border-radius: 2px;
        }

        .chart-container {
            height: 300px;
            width: 100%;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            overflow: hidden;
            position: relative;
        }

        /* Quick actions */
        .quick-actions {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .action-button {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 20px 15px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            text-decoration: none;
            color: var (--text-primary);
            transition: var (--transition);
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }

        .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 0;
            background: linear-gradient(to bottom, rgba(255, 149, 98, 0.2), transparent);
            transition: height 0.3s ease;
        }

        .action-button:hover {
            transform: translateY(-8px);
            background: rgba(255, 255, 255, 0.8);
        }

        .action-button:hover::before {
            height: 100%;
        }

        .action-button i {
            font-size: 26px;
            margin-bottom: 10px;
            color: var(--main-color);
            transition: var (--transition);
        }

        .action-button:hover i {
            transform: scale(1.2);
        }

        .action-button span {
            font-size: 14px;
            text-align: center;
            font-weight: 500;
        }

        /* Recent items */
        .recent-items {
            list-style: none;
        }

        .recent-item {
            display: flex;
            align-items: center;
            padding: 15px 0;
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            transition: var (--transition);
        }

        .recent-item:last-child {
            border-bottom: none;
        }

        .recent-item:hover {
            transform: translateX(5px);
        }

        .recent-item-icon {
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            color: white;
            font-size: 18px;
        }

        .recent-item-details h4 {
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--text-primary);
            font-weight: 600;
        }

        .recent-item-details p {
            font-size: 14px;
            color: var (--text-secondary);
        }

        /* Modal Styles */
        .login-modal, .verification-modal {
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
        }

        .login-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .login-modal h2 {
            margin-top: 0;
            color: var(--main-color);
            font-weight: 700;
            margin-bottom: 20px;
            font-size: 24px;
        }

        .login-modal .input-field {
            width: 100%;
            padding: 12px 15px;
            margin: 12px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .login-modal .input-field:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.2);
        }

        .login-modal .login-btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 14px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            width: 100%;
            margin-top: 15px;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .login-modal .login-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.4);
        }

        .login-modal .error {
            color: #ff3333;
            font-size: 14px;
            margin-top: 10px;
        }

        /* Password Verification Modal Styles */
        .verification-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        
        .verification-modal-content {
            background-color: white;
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: var (--shadow-lg);
            width: 380px;
            text-align: center;
            border: 1px solid rgba(255, 255, 255, 0.2);
            animation: modalFadeIn 0.3s;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        .verification-modal-content h3 {
            margin-top: 0;
            color: var(--main-color);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
        }
        
        .verification-modal-content p {
            margin-bottom: 20px;
            color: var(--text-secondary);
        }
        
        .verification-modal-content input {
            width: 100%;
            padding: 12px 15px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.3s;
        }
        
        .verification-modal-content input:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.2);
        }
        
        .verification-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 20px;
        }
        
        .verification-buttons button {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }
        
        .verification-buttons button:first-child {
            background-color: #f0f0f0;
            color: var(--text-secondary);
        }
        
        .verification-buttons button:first-child:hover {
            background-color: #e0e0e0;
        }
        
        .verification-buttons button:last-child {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
        }
        
        .verification-buttons button:last-child:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.4);
        }

        /* Enhanced Particle Background Effect */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }

        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.15);
            animation: float 25s infinite linear;
            box-shadow: 0 0 10px rgba(255, 255, 255, 0.1);
        }

        @keyframes float {
            0% { 
                transform: translateY(0) rotate(0deg) scale(0); 
                opacity: 0; 
            }
            10% { 
                opacity: 1; 
                transform: scale(1);
            }
            90% { 
                opacity: 1; 
            }
            100% { 
                transform: translateY(-100vh) rotate(360deg) scale(0); 
                opacity: 0; 
            }
        }

        /* Smooth Page Load Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .main-content {
            animation: fadeInUp 0.8s ease-out;
        }

        .stat-card {
            animation: fadeInUp 0.6s ease-out;
            animation-fill-mode: both;
        }

        .stat-card:nth-child(1) { animation-delay: 0.1s; }
        .stat-card:nth-child(2) { animation-delay: 0.2s; }
        .stat-card:nth-child(3) { animation-delay: 0.3s; }
        .stat-card:nth-child(4) { animation-delay: 0.4s; }
        .stat-card:nth-child(5) { animation-delay: 0.5s; }

        /* Scroll Animations */
        @media (prefers-reduced-motion: no-preference) {
            .dashboard-card {
                animation: fadeInUp 0.6s ease-out;
            }
        }

        /* Team Modal Styles */
        .team-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            z-index: 1000;
            justify-content: center;
            align-items: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .team-modal.show {
            display: flex;
            opacity: 1;
            visibility: visible;
        }

        .team-modal-content {
            background: white;
            border-radius: 20px;
            padding: 30px;
            width: 600px;
            max-width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.15);
            animation: modalFadeIn 0.3s ease;
            position: relative;
        }

        .team-modal-header {
            text-align: center;
            margin-bottom: 25px;
            position: relative;
            padding-bottom: 15px;
            border-bottom: 1px solid #eee;
        }

        .team-modal-header h3 {
            color: var(--main-color);
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 10px 0;
        }

        .team-modal-header p {
            color: var(--text-secondary);
            margin: 0;
            font-size: 16px;
        }

        .team-modal-close {
            position: absolute;
            top: -15px;
            right: -15px;
            background: #f0f0f0;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #666;
        }

        .team-modal-close:hover {
            background: var(--main-color);
            color: white;
            transform: scale(1.1);
        }

        .team-user-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 15px;
            margin-bottom: 25px;
        }

        .user-item {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 20px 15px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            border: 2px solid transparent;
        }

        .user-item:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(255, 127, 66, 0.3);
        }

        .user-item-avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: 600;
            margin: 0 auto 10px;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        .user-item-name {
            font-size: 16px;
            font-weight: 600;
            margin-bottom: 5px;
        }

        .user-item-role {
            font-size: 14px;
            opacity: 0.8;
        }

        .no-users-message {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .no-users-icon {
            font-size: 60px;
            color: var(--text-tertiary);
            margin-bottom: 20px;
        }

        .no-users-message h4 {
            font-size: 20px;
            margin-bottom: 10px;
            color: var(--text-primary);
        }

        .team-modal-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .team-modal-button {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .team-modal-button.cancel {
            background: #f0f0f0;
            color: #666;
        }

        .team-modal-button.cancel:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .team-modal-button.primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
        }

        .team-modal-button.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.3);
        }

        /* Team MonuMe card - removed clickable functionality */
        .stat-card#team-monume-card {
            cursor: default;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        /* Only buttons are clickable now */
        .stat-card#team-monume-card .action-button {
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .stat-card#team-monume-card .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 127, 66, 0.3);
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 4px;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: linear-gradient(135deg, var(--gradient-end), var(--gradient-start));
        }

        /* Loading State for Cards */
        .stat-card.loading {
            pointer-events: none;
        }

        .stat-card.loading .stat-card-value {
            background: linear-gradient(90deg, 
                rgba(255, 255, 255, 0.2) 25%, 
                rgba(255, 255, 255, 0.4) 50%, 
                rgba(255, 255, 255, 0.2) 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            color: transparent;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Loading States for Chat and Appointments */
        .chat-loading-state,
        .appointments-loading-state {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: rgba(255, 255, 255, 0.7);
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(255, 255, 255, 0.2);
            border-top: 3px solid rgba(255, 255, 255, 0.8);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .chat-loading-state p,
        .appointments-loading-state p {
            margin: 0;
            font-size: 14px;
            font-weight: 500;
        }

        /* No appointments state */
        .no-appointments-week {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 200px;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        .no-appointments-week i {
            font-size: 48px;
            margin-bottom: 16px;
            color: rgba(255, 255, 255, 0.4);
        }

        .no-appointments-week h4 {
            margin: 0 0 8px 0;
            color: rgba(255, 255, 255, 0.9);
            font-size: 18px;
            font-weight: 600;
        }

        .no-appointments-week p {
            margin: 0;
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        /* Enhanced Responsive Design */
        @media screen and (max-width: 1400px) {
            .dashboard-stats {
                grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            }
        }

        @media screen and (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
            .main-content {
                margin-left: 240px;
                width: calc(100% - 240px);
                padding: 32px;
            }
            .dashboard-stats {
                grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
                gap: 20px;
            }
            .stat-card {
                padding: 28px;
            }
        }

        @media screen and (max-width: 992px) {
            .sidebar {
                width: 80px;
                overflow: hidden;
            }
            
            .sidebar-header .app-title {
                font-size: 24px;
                writing-mode: vertical-rl;
                text-orientation: mixed;
            }
            
            .sidebar-menu li a span {
                display: none;
            }
            
            .sidebar-menu li a {
                justify-content: center;
                padding: 16px 12px;
            }
            
            .sidebar-menu li a i {
                margin-right: 0;
                font-size: 20px;
            }
            
            .main-content {
                margin-left: 80px;
                width: calc(100% - 80px);
                padding: 32px 24px;
            }
            
            .welcome-container {
                padding: 48px 32px;
                margin-bottom: 48px;
            }
            
            .welcome-container h1 {
                font-size: 2.8rem;
            }
        }

        @media screen and (max-width: 768px) {
            .dashboard-stats {
                grid-template-columns: 1fr;
                gap: 16px;
            }
            
            .stat-card {
                padding: 24px;
                min-height: 180px;
            }
            
            .stat-card-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }
            
            .stat-card-value {
                font-size: 40px;
            }
            
            .welcome-container {
                padding: 40px 24px;
                border-radius: 24px;
            }
            
            .welcome-container h1 {
                font-size: 2.2rem;
                letter-spacing: -1px;
            }
            
            .welcome-container p {
                font-size: 1.125rem;
            }
        }

        @media screen and (max-width: 576px) {
            .main-content {
                padding: 24px 16px;
                margin-left: 0;
                width: 100%;
            }
            
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }
            
            .sidebar.mobile-open {
                transform: translateX(0);
            }
            
            .welcome-container {
                padding: 32px 20px;
                margin-bottom: 32px;
            }
            
            .welcome-container h1 {
                font-size: 1.875rem;
                margin-bottom: 12px;
            }
            
            .welcome-container p {
                font-size: 1rem;
            }
            
            .stat-card {
                padding: 20px;
                min-height: 160px;
            }
            
            .stat-card-value {
                font-size: 32px;
            }
            
            .stat-card-actions {
                flex-direction: column;
                gap: 8px;
            }
            
            .stat-card-actions .action-button {
                padding: 14px 16px;
                font-size: 13px;
            }
        }

        /* Mobile menu button */
        .mobile-menu-btn {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 101;
            background: rgba(255, 255, 255, 0.15);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 12px;
            width: 48px;
            height: 48px;
            color: white;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .mobile-menu-btn:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: scale(1.05);
        }

        @media screen and (max-width: 576px) {
            .mobile-menu-btn {
                display: flex;
                align-items: center;
                justify-content: center;
            }
        }

        /* Notification Banner Styles */
        .notification-banner {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 12px 20px;
            text-align: center;
            font-weight: 500;
            z-index: 1000;
            box-shadow: var(--shadow-sm);
            display: none; /* Hidden by default */
            justify-content: space-between;
            align-items: center;
        }
        
        .notification-banner .close-notification {
            background: none;
            border: none;
            color: white;
            font-size: 20px;
            cursor: pointer;
            margin-left: 15px;
        }
        
        /* Adjust main content when notification is visible */
        body.has-notification .sidebar,
        body.has-notification .main-content {
            margin-top: 46px; /* Height of the notification banner */
        }

        /* Logo upload modal */
        .logo-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            padding: 35px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-lg);
            z-index: 1001;
            width: 380px;
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .logo-modal h2 {
            margin-top: 0;
            color: var(--main-color);
            font-weight: 700;
            margin-bottom: 20px;
            font-size: 24px;
            text-align: center;
        }

        .logo-upload-area {
            border: 2px dashed #ddd;
            border-radius: 10px;
            padding: 25px;
            text-align: center;
            margin-bottom: 20px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .logo-upload-area:hover {
            border-color: var(--main-color);
            background: rgba(255, 149, 98, 0.05);
        }

        .logo-upload-area i {
            font-size: 40px;
            color: var(--main-color);
            margin-bottom: 10px;
        }

        .logo-upload-area p {
            color: var(--text-secondary);
        }

        .logo-preview {
            width: 100%;
            height: 100px;
            object-fit: contain;
            margin-bottom: 20px;
        }

        /* Modal Styles - Enhanced for reliability */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(8px);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            opacity: 0;
            visibility: hidden;
            transition: var(--transition);
        }

        .modal-overlay.active {
            display: flex !important;
            opacity: 1 !important;
            visibility: visible !important;
        }

        .modal-container {
            background: var(--white);
            border-radius: var(--radius-2xl);
            width: 95%;
            max-width: 550px;
            max-height: 85vh;
            overflow: hidden; /* Remove scrolling completely */
            box-shadow: var(--shadow-xl);
            transform: translateY(20px) scale(0.95);
            transition: var(--transition);
        }

        .modal-overlay.active .modal-container {
            transform: translateY(0) scale(1);
        }

        .modal-header {
            padding: 1.25rem 1.5rem 0.75rem;
            border-bottom: 1px solid var(--border-color);
            position: relative;
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0.25rem;
        }

        .modal-subtitle {
            color: var(--text-secondary);
            font-size: 0.8rem;
        }

        .modal-close {
            position: absolute;
            top: 1rem;
            right: 1rem;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            background: var(--gray-100);
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-secondary);
            transition: var(--transition);
            font-size: 0.9rem;
        }

        .modal-close:hover {
            background: var(--gray-200);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 1.5rem;
            overflow-y: auto;
            max-height: calc(85vh - 120px); /* Account for header and actions */
        }

        /* Form Styles - Compact version */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 1rem;
            margin-bottom: 1rem;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 0.375rem;
        }

        .form-label {
            font-weight: 500;
            color: var(--text-primary);
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            gap: 0.375rem;
        }

        .form-input,
        .form-select,
        .form-textarea {
            padding: 0.75rem 0.875rem;
            border: 1px solid var(--border-color);
            border-radius: var(--radius-md);
            font-size: 0.8rem;
            transition: var(--transition);
            background: var(--white);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 60px;
            max-height: 80px;
        }

        /* Time Selection Grid - Optimized with smaller AM/PM */
        .time-selection-grid {
            display: grid;
            grid-template-columns: 1fr 1fr 0.7fr; /* Make AM/PM column smaller */
            gap: 0.5rem;
        }

        .time-select {
            font-size: 0.8rem;
            text-align: center;
            padding: 0.75rem 0.5rem; /* Reduce horizontal padding */
        }

        /* Make AM/PM dropdown specifically smaller */
        .time-select:nth-child(3) {
            font-size: 0.75rem;
            padding: 0.75rem 0.25rem;
        }

        /* Additional compact styles for perfect fit */
        @media (max-height: 800px) {
            .modal-container {
                max-height: 90vh;
            }
            
            .modal-body {
                max-height: calc(90vh - 110px);
            }
            
            .form-grid {
                gap: 0.875rem;
                margin-bottom: 0.875rem;
            }
            
            .form-group {
                gap: 0.25rem;
            }
            
            .form-textarea {
                min-height: 50px;
                max-height: 65px;
            }
        }

        /* Ensure no horizontal scrolling */
        .form-grid .form-group:has(#client-phone) {
            grid-column: span 2;
        }

        .form-grid .form-group:has(#appointment-notes) {
            grid-column: span 2;
        }

        /* Enhanced Upcoming Appointments Styles */
        .upcoming-appointment-item {
            display: flex;
            align-items: center;
            padding: 16px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 12px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border-left: 4px solid var(--primary-color);
        }

        .upcoming-appointment-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.15);
        }

        .upcoming-appointment-item.completed {
            opacity: 0.8;
            border-left-color: #10b981;
            background: rgba(16, 185, 129, 0.05);
        }

        .appointment-date-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            margin-right: 16px;
            position: relative;
        }

        .appointment-date-main {
            display: flex;
            flex-direction: column;
            align-items: center;
            margin-bottom: 8px;
        }

        .appointment-date-number {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary-color);
            line-height: 1;
        }

        .appointment-date-month {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
        }



        /* Past appointment styling */
        .upcoming-appointment-item.past {
            opacity: 0.7;
            border-left-color: #6b7280;
        }

        .upcoming-appointment-item.past .appointment-client-name {
            color: var(--text-secondary);
        }

        .appointment-info-section {
            flex: 1;
            margin-right: 16px;
        }

        .appointment-client-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 6px;
        }

        .appointment-type-time {
            display: flex;
            gap: 12px;
            align-items: center;
            margin-bottom: 6px;
        }

        .appointment-type {
            background: rgba(var(--primary-color-rgb), 0.1);
            color: var(--primary-color);
            padding: 4px 10px;
            border-radius: 16px;
            font-size: 12px;
            font-weight: 600;
        }

        .appointment-time {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        .appointment-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: capitalize;
        }

        .appointment-status-badge.status-completed {
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
        }

        .appointment-status-badge.status-confirmed {
            background: rgba(59, 130, 246, 0.1);
            color: #3b82f6;
        }

        .appointment-status-badge.status-rescheduled {
            background: rgba(245, 158, 11, 0.1);
            color: #f59e0b;
        }

        .appointment-actions-section {
            display: flex;
            align-items: center;
            min-width: 120px;
        }

        .appointment-status-section {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 100px;
        }

        .completed-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: rgba(16, 185, 129, 0.1);
            color: #10b981;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .extra-appointments-indicator {
            background: rgba(255, 255, 255, 0.9);
            border: 2px dashed var(--primary-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            margin-top: 8px;
        }

        .extra-indicator-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
        }

        .extra-indicator-content i {
            color: var(--primary-color);
            font-size: 20px;
            margin-bottom: 4px;
        }

        .extra-indicator-content span {
            color: var(--primary-color);
            font-weight: 600;
            font-size: 14px;
        }

        .extra-indicator-content small {
            color: var(--text-secondary);
            font-size: 11px;
        }

        /* Completion Modal Styles */
        .completion-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            backdrop-filter: blur(4px);
        }

        .completion-modal.active {
            display: flex;
        }

        .completion-modal-content {
            background: white;
            border-radius: 16px;
            padding: 24px;
            width: 90%;
            max-width: 400px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            transform: scale(0.9);
            transition: transform 0.3s ease;
        }

        .completion-modal.active .completion-modal-content {
            transform: scale(1);
        }

        .completion-modal-header {
            text-align: center;
            margin-bottom: 20px;
        }

        .completion-modal-header h3 {
            color: var(--text-primary);
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 6px;
        }

        .completion-modal-header p {
            color: var(--text-secondary);
            font-size: 14px;
        }

        .completion-form-group {
            margin-bottom: 16px;
        }

        .completion-form-label {
            display: block;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            margin-bottom: 6px;
        }

        .completion-form-select,
        .completion-form-input {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-color);
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s ease;
        }

        .completion-form-select:focus,
        .completion-form-input:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .completion-modal-actions {
            display: flex;
            gap: 12px;
            margin-top: 24px;
        }

        .completion-btn {
            flex: 1;
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 44px;
        }

        .completion-btn-cancel {
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.2);
        }

        .completion-btn-cancel:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.3);
        }

        .completion-btn-confirm {
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
        }

        .completion-btn-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
            background: var(--gradient-start);
        }

        .completion-btn-confirm:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        .form-actions {
            display: flex;
            justify-content: flex-end;
            gap: 0.75rem;
            margin-top: 1rem;
            padding-top: 1rem;
            border-top: 1px solid var(--border-color);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            text-decoration: none;
            min-height: 44px;
        }

        .btn-primary {
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
            background: var(--gradient-start);
        }

        .btn-secondary {
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.2);
        }

        .btn-secondary:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.3);
        }

        /* Success/Error Messages */
        .appointment-message {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            color: white;
            font-weight: 600;
            z-index: 1001;
            transform: translateX(100%);
            transition: transform 0.3s ease;
        }

        .appointment-message.show {
            transform: translateX(0);
        }

        .appointment-message.success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .appointment-message.error {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        .logo-buttons {
            display: none;
        }

        .logo-buttons {
            display: flex;
            justify-content: space-between;
        }

        .logo-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
            flex-grow: 1;
            margin: 0 5px;
        }

        .cancel-btn {
            background-color: #f0f0f0;
            color: var(--text-secondary);
        }

        .save-btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
        }

        .cancel-btn:hover {
            background-color: #e0e0e0;
        }

        .save-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.4);
        }

        #file-input {
            display: none;
        }

        /* Chat box styling enhancements */
        .mini-chat-container {
            display: flex;
            flex-direction: column;
            height: 350px;
            background: white;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .chat-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 15px;
            background: var(--main-color);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            position: relative;
        }
        
        .chat-title {
            font-size: 14px;
            color: white;
            font-weight: 500;
        }
        
        .users-btn {
            background: white;
            border: none;
            color: var(--main-color);
            padding: 6px 15px;
            border-radius: 20px;
            font-size: 13px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
            transition: all 0.3s ease;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.3);
        }
        
        .users-btn:hover {
            background: white;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.4);
        }
        
        .users-btn i {
            font-size: 11px;
            transition: transform 0.3s ease;
            color: var(--main-color);
        }
        
        .users-btn:hover i {
            transform: rotate(180deg);
        }
        
        .users-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            width: 150px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
            z-index: 100;
            overflow: hidden;
            display: none;
            margin-top: 5px;
            border: 1px solid var(--main-color);
            animation: slideDown 0.25s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .users-dropdown.show {
            display: block;
        }
        
        .dropdown-user {
            padding: 10px 16px;
            color: var(--main-color);
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }
        
        .dropdown-user:before {
            content: '';
            display: inline-block;
            width: 8px;
            height: 8px;
            background: var(--main-color);
            border-radius: 50%;
            margin-right: 10px;
            opacity: 0;
            transform: scale(0);
            transition: all 0.2s ease;
        }
        
        .dropdown-user:hover {
            background: rgba(255, 149, 98, 0.1);
            padding-left: 20px;
        }
        
        .dropdown-user:hover:before {
            opacity: 1;
            transform: scale(1);
        }
        
        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 15px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            scrollbar-width: thin;
            background-color: white;
            scrollbar-color: rgba(255, 255, 255, 0.2) transparent;
        }
        
        .chat-messages::-webkit-scrollbar {
            width: 6px;
        }
        
        .chat-messages::-webkit-scrollbar-track {
            background: transparent;
        }
        
        .chat-messages::-webkit-scrollbar-thumb {
            background-color: rgba(255, 149, 98, 0.2);
            border-radius: 6px;
        }
        
        .chat-message {
            max-width: 85%;
            padding: 10px 14px;
            border-radius: 14px;
            position: relative;
            font-size: 13px;
            line-height: 1.4;
            animation: fadeIn 0.3s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .chat-message.received {
            align-self: flex-start;
            background: rgba(255, 149, 98, 0.1);
            color: var(--main-color);
            border-bottom-left-radius: 4px;
        }
        
        .chat-message.sent {
            align-self: flex-end;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
            font-size: 11px;
            opacity: 0.8;
        }
        
        .message-sender {
            font-weight: 600;
            color: var(--main-color);
        }
        
        .message-time {
            opacity: 0.8;
            color: var(--main-color);
        }
        
        .message-content {
            word-break: break-word;
            color: var(--main-color) !important;
            font-weight: 500;
        }
        
        .chat-message.sent .message-content {
            color: white !important;
        }

        /* Chat message header color fixes for sent messages */
        .chat-message.sent .message-header {
            color: white;
            opacity: 0.9;
        }
        
        .chat-message.sent .message-sender,
        .chat-message.sent .message-time {
            color: white !important;
        }
        
        .chat-input-wrapper {
            padding: 10px 15px;
            background: var(--main-color);
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .message-input-container {
            display: flex;
            align-items: center;
            background: white;
            border-radius: 20px;
            padding: 2px;
            transition: all 0.3s ease;
        }
        
        .message-input-container:focus-within {
            background: white;
            box-shadow: 0 0 0 2px rgba(255, 149, 98, 0.3);
        }
        
        .message-input {
            flex: 1;
            background: transparent;
            border: none;
            padding: 8px 15px;
            color: var(--main-color);
            font-size: 13px;
            outline: none;
            border-radius: 20px;
        }
        
        .message-input::placeholder {
            color: rgba(255, 149, 98, 0.5);
        }
        
        .send-btn {
            background: var(--main-color);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            margin-right: 2px;
        }
        
        .send-btn:hover:not(:disabled) {
            background: var(--gradient-start);
            transform: scale(1.1);
        }
        
        .send-btn:disabled {
            background: rgba(255, 149, 98, 0.15);
            cursor: not-allowed;
        }

        /* User Authentication Modal - Enhanced Design */
        .user-auth-modal {
            display: none;
            position: fixed;
            z-index: 1001;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }
        
        .user-auth-modal .modal-content {
            background-color: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            width: 400px;
            text-align: center;
            animation: modalFadeIn 0.4s ease-out;
            border: 1px solid rgba(255, 255, 255, 0.2);
            position: relative;
            overflow: hidden;
        }
        
        .user-auth-modal .modal-content::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 6px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        }
        
        .user-auth-modal h3 {
            margin-top: 5px;
            color: var(--main-color);
            font-size: 26px;
            font-weight: 700;
            margin-bottom: 20px;
            position: relative;
            display: inline-block;
        }
        
        .user-auth-modal h3::after {
            content: '';
            position: absolute;
            bottom: -10px;
            left: 50%;
            transform: translateX(-50%);
            width: 50px;
            height: 3px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-radius: 3px;
        }
        
        .user-auth-modal p {
            margin-bottom: 25px;
            color: var(--text-secondary);
            font-size: 16px;
            line-height: 1.5;
        }
        
        .user-auth-modal #selected-username {
            color: var(--main-color);
            font-weight: 700;
            font-size: 18px;
        }
        
        .user-auth-modal .auth-input {
            width: 100%;
            padding: 15px 20px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) inset;
            background-color: #f9f9f9;
        }
        
        .user-auth-modal .auth-input:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.15);
            background-color: #fff;
        }
        
        .user-auth-modal .auth-buttons {
            display: flex;
            justify-content: space-between;
            margin-top: 30px;
            gap: 15px;
        }
        
        .user-auth-modal .auth-buttons button {
            padding: 14px 0;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
            width: 48%;
            position: relative;
            overflow: hidden;
        }
        
        .user-auth-modal .auth-buttons button::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            transform: translate(-50%, -50%);
            transition: width 0.5s, height 0.5s;
        }
        
        .user-auth-modal .auth-buttons button:active::before {
            width: 300px;
            height: 300px;
        }
        
        .user-auth-modal .cancel-btn {
            background-color: #f0f0f0;
            color: #777;
        }
        
        .user-auth-modal .cancel-btn:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }
        
        .user-auth-modal .confirm-btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
        }
        
        .user-auth-modal .confirm-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 7px 15px rgba(255, 127, 66, 0.4);
        }
        
        /* Enhanced modal animation */
        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: translateY(-30px) scale(0.95);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        /* Dashboard split container styles */
        .dashboard-split-container {
            display: flex;
            gap: 20px;
        }

        .dashboard-split-section {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-sm);
            position: relative;
            overflow: hidden;
        }

        .dashboard-split-section.left-section {
            display: flex;
            justify-content: center;
            align-items: center;
            text-align: center;
        }

        .dashboard-split-section.left-section .placeholder-content {
            color: var(--text-secondary);
            font-size: 18px;
        }

        .dashboard-split-section.left-section .placeholder-content i {
            font-size: 48px;
            margin-bottom: 10px;
            color: var(--main-color);
        }

        /* Custom style for Team MonuMe card */
        .active-users-info {
            margin-bottom: 15px;
        }

        .stat-card-actions {
            display: flex;
            gap: 15px;
            margin-top: 40px; /* Increased top margin to push buttons further down */
            position: relative;
            bottom: -10px; /* Additional offset to push buttons further down */
        }

        .stat-card-actions .action-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 10px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: rgba(255, 149, 98, 0.15);
            color: #ff7f42;
        }

        .stat-card-actions .start-btn {
            background: rgba(76, 175, 80, 0.15);
            color: #4caf50;
        }

        .stat-card-actions .view-btn {
            background: rgba(63, 135, 245, 0.15);
            color: #3f87f5;
        }

        .stat-card-actions .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.2);
        }

        .stat-card-actions .start-btn:hover {
            background: rgba(255, 158, 94, 0.3);
            box-shadow: 0 5px 15px rgba(255, 158, 94, 0.3);
        }

        .stat-card-actions .view-btn:hover {
            background: rgba(255, 203, 107, 0.3);
            box-shadow: 0 5px 15px rgba(255, 203, 107, 0.3);
        }

        .stat-card-actions .start-btn {
            background: rgba(255, 127, 66, 0.15);
            color: #ff7f42;
        }

        .stat-card-actions .view-btn {
            background: rgba(255, 185, 120, 0.15);
            color: #ffb978;
        }

        .stat-card-actions .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.2);
        }

        .stat-card-actions .start-btn:hover {
            background: rgba(255, 127, 66, 0.25);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.2);
        }

        .stat-card-actions .view-btn:hover {
            background: rgba(255, 185, 120, 0.25);
            box-shadow: 0 5px 15px rgba(255, 185, 120, 0.2);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideIn {
            from { transform: translateY(-30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        @keyframes slideInFromRight {
            from { 
                transform: translateX(100%); 
                opacity: 0; 
            }
            to { 
                transform: translateX(0); 
                opacity: 1; 
            }
        }

        /* Chat notification styles */
        .unread-message {
            background: rgba(255, 107, 53, 0.1) !important;
            border-left: 3px solid #ff6b35 !important;
        }

        .new-message-badge {
            background: linear-gradient(135deg, #ff6b35, #f7931e);
            color: white;
            font-size: 0.6rem;
            padding: 2px 6px;
            border-radius: 8px;
            margin-left: 6px;
            font-weight: 600;
            animation: pulse 2s infinite;
        }

        .notification-badge {
            animation: pulse 2s infinite;
        }

        .team-modal-title {
            color: #ff7f42;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
            text-align: center;
        }

        .team-modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #aaa;
            transition: all 0.2s;
        }

        .team-modal-close:hover {
            color: #ff7f42;
            transform: scale(1.2);
        }

        .user-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-bottom: 25px;
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }

        .user-item {
            background: linear-gradient(135deg, #ff7f42, #ff9562);
            color: white;
            padding: 12px 15px;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }

        .user-item:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 127, 66, 0.3);
        }

        .user-item.active {
            background: linear-gradient(135deg, #4caf50, #2e7d32);
        }

        .active-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #eee;
            transition: all 0.2s;
        }

        .active-user-item:last-child {
            border-bottom: none;
        }

        .active-user-name {
            font-weight: 600;
            color: #333;
        }

        .active-user-time {
            font-size: 13px;
            color: #666;
        }

        .active-user-actions {
            display: flex;
            gap: 10px;
        }

        .active-user-action {
            padding: 8px 12px;
            border: none;
            border-radius: 8px;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .deactivate-btn {
            background-color: rgba(255, 149, 98, 0.15);
            color: #ff9562;
        }

        .deactivate-btn:hover {
            background-color: rgba(255, 149, 98, 0.25);
            transform: translateY(-2px);
            box-shadow: 0 3px 10px rgba(255, 127, 66, 0.2);
        }

        .team-modal-buttons {
            display: flex;
            justify-content: center;
            margin-top: 20px;
        }

        .team-modal-button {
            padding: 12px 30px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
            min-height: 44px;
        }

        .team-modal-button:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
        }



        /* Unified Stat Card Action Buttons - All Main Color */
        .stat-card-actions {
            display: flex;
            gap: 12px;
            margin-top: 20px;
        }

        .stat-card-actions .action-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 16px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: var(--main-color);
            color: white;
            position: relative;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
            text-transform: none;
            letter-spacing: 0;
            min-height: 48px;
        }

        .stat-card-actions .action-button::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: all 0.5s ease;
        }

        .stat-card-actions .action-button i {
            margin-right: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
            color: white;
        }

        .stat-card-actions .action-button:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
            background: var(--gradient-start);
        }
        
        .stat-card-actions .action-button:hover::before {
            left: 100%;
        }
        
        .stat-card-actions .action-button:active {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
        }

        .stat-card-actions .action-button:hover i {
            transform: scale(1.1);
            color: white;
        }

        /* Primary button variant (same styling for consistency) */
        .stat-card-actions .action-button.primary {
            background: var(--main-color);
            color: white;
        }

        .stat-card-actions .action-button.primary:hover {
            background: var(--gradient-start);
        }

        /* Simple Modal Styles - FORCE CENTER POSITIONING */
        .simple-modal {
            position: fixed !important;
            top: 0 !important;
            left: 0 !important;
            width: 100vw !important;
            height: 100vh !important;
            background-color: rgba(0, 0, 0, 0.6) !important;
            z-index: 10000 !important;
            backdrop-filter: blur(8px) !important;
            -webkit-backdrop-filter: blur(8px) !important;
            display: none !important;
            justify-content: center !important;
            align-items: center !important;
            margin: 0 !important;
            padding: 0 !important;
        }
        
        .simple-modal.show {
            display: flex !important;
        }

        .simple-modal-content {
            background: white !important;
            border-radius: 20px !important;
            padding: 30px !important;
            width: 500px !important;
            max-width: 90vw !important;
            max-height: 80vh !important;
            overflow-y: auto !important;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
            animation: modalFadeIn 0.3s ease !important;
            border: 2px solid var(--main-color) !important;
            position: relative !important;
            margin: 0 auto !important;
            transform: none !important;
            top: auto !important;
            left: auto !important;
            right: auto !important;
            bottom: auto !important;
        }

        @keyframes modalFadeIn {
            from {
                opacity: 0;
                transform: scale(0.8) translateY(-20px);
            }
            to {
                opacity: 1;
                transform: scale(1) translateY(0);
            }
        }

        .simple-modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #f0f0f0;
        }

        .simple-modal-header h3 {
            margin: 0;
            color: var(--main-color);
            font-size: 24px;
            font-weight: 700;
        }

        .simple-modal-close {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #999;
            transition: color 0.2s ease;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .simple-modal-close:hover {
            color: var(--main-color);
        }

        .users-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .user-card {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            border: none;
            font-size: 16px;
            font-weight: 600;
        }

        .user-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 25px rgba(255, 127, 66, 0.3);
        }

        .user-card .user-name {
            font-size: 18px;
            margin-bottom: 5px;
        }

        .user-card .user-role {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
        }

        /* Enhanced User Card Styles for Location Filtering and Active Status */
        .user-card.user-already-active {
            background: linear-gradient(135deg, #ccc, #999);
            opacity: 0.6;
            cursor: not-allowed;
        }

        .user-card.user-already-active:hover {
            transform: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .user-location {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            margin-top: 4px;
            font-style: italic;
        }

        .user-status {
            font-size: 11px;
            color: #fff;
            margin-top: 6px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            background: rgba(255, 255, 255, 0.2);
            padding: 2px 6px;
            border-radius: 4px;
        }

        .no-available-users {
            grid-column: 1 / -1;
        }

        /* Password Modal Styles */
        .password-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .user-avatar {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
        }

        .user-details .user-name {
            font-size: 18px;
            font-weight: 600;
            color: var(--main-color);
            margin-bottom: 5px;
        }

        .user-details .user-role {
            font-size: 14px;
            color: #666;
        }

        .password-input-section {
            margin-bottom: 20px;
        }

        .password-input-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--main-color);
        }

        .password-field {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            transition: border-color 0.2s ease;
            box-sizing: border-box;
        }

        .password-field:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 127, 66, 0.1);
        }

        .password-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .cancel-btn, .confirm-btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 14px;
            min-height: 44px;
        }

        .cancel-btn {
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.2);
        }

        .cancel-btn:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.3);
        }

        .confirm-btn {
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
        }

        .confirm-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
            background: var(--gradient-start);
        }

        /* Active Users List Styles */
        .active-users-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .active-user-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px;
            border: 1px solid #e0e0e0;
            border-radius: 10px;
            margin-bottom: 10px;
            background: white;
            transition: all 0.2s ease;
        }

        .active-user-item:hover {
            border-color: var(--main-color);
            box-shadow: 0 2px 8px rgba(255, 127, 66, 0.1);
        }

        .active-user-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .active-user-info .user-avatar {
            width: 40px;
            height: 40px;
            font-size: 16px;
        }

        .active-user-info .user-name {
            font-weight: 600;
            color: var(--main-color);
            margin-bottom: 3px;
        }

        .active-user-info .session-time {
            font-size: 12px;
            color: #666;
        }

        .user-actions {
            display: flex;
            gap: 10px;
        }

        .inactive-btn, .forceout-btn {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            min-height: 36px;
        }

        .inactive-btn {
            background: var(--main-color);
            color: white;
            box-shadow: 0 3px 8px rgba(255, 149, 98, 0.3);
        }

        .inactive-btn:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 98, 0.4);
        }

        .forceout-btn {
            background: var(--main-color);
            color: white;
            margin-left: 8px;
            box-shadow: 0 3px 8px rgba(255, 149, 98, 0.3);
        }

        .forceout-btn:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 98, 0.4);
        }

        .forceout-btn {
            background-color: #f44336;
            color: white;
        }

        .forceout-btn:hover {
            background-color: #da190b;
            transform: translateY(-2px);
        }

        /* Inactive Modal Styles */
        .inactive-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #e8f5e8;
            border-radius: 10px;
            border-left: 4px solid #4caf50;
        }

        .inactive-user-info .user-avatar {
            background: linear-gradient(135deg, #4caf50, #81c784);
        }

        /* Force Out Modal Styles */
        .forceout-user-info {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 20px;
            padding: 15px;
            background: #fff3e0;
            border-radius: 10px;
            border-left: 4px solid #ff9800;
        }

        .warning-icon {
            color: #ff9800;
            font-size: 24px;
        }

        .forceout-details p {
            margin: 0 0 8px 0;
            color: #666;
        }

        .target-user {
            font-weight: 600;
            color: #f44336;
            font-size: 16px;
        }

        .admin-selection-section, .admin-password-section {
            margin-bottom: 20px;
        }

        .admin-selection-section label, .admin-password-section label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--main-color);
        }

        .admin-dropdown {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            background-color: white;
            cursor: pointer;
            transition: border-color 0.2s ease;
        }

        .admin-dropdown:focus {
            outline: none;
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 127, 66, 0.1);
        }

        .forceout-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        .forceout-actions .forceout-btn {
            padding: 12px 25px;
            font-size: 14px;
        }



        /* Force Out Modal - updated to only confirm role and password for the user you clicked */
        .forceout-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            z-index: 2000;
            backdrop-filter: blur(5px);
            -webkit-backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
        }

        .forceout-content {
            background-color: white;
            border-radius: 20px;
            padding: 30px;
            width: 400px;
            max-width: 90%;
            box-shadow: var(--shadow-lg);
            animation: modalFadeIn 0.3s ease;
            position: relative;
            border-top: 6px solid #f44336;
        }

        .forceout-content h3 {
            margin-top: 0;
            color: #f44336;
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 15px;
            text-align: center;
        }

        .forceout-content p {
            margin-bottom: 20px;
            color: var(--text-secondary);
            text-align: center;
        }

        .forceout-user-dropdown {
            position: relative;
            margin-bottom: 25px;
        }

        .forceout-user-select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            appearance: none;
            -webkit-appearance: none;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="%23666" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-chevron-down"><polyline points="6 9 12 15 18 9"></polyline></svg>') no-repeat;
            background-position: right 15px center;
            background-color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .forceout-user-select:focus {
            outline: none;
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
        }

        .forceout-password-field {
            width: 100%;
            padding: 12px 15px;
            margin: 15px 0;
            border: 1px solid #ddd;
            border-radius: 10px;
            font-size: 16px;
            transition: all 0.2s;
            box-sizing: border-box;
        }

        .forceout-password-field:focus {
            outline: none;
            border-color: #f44336;
            box-shadow: 0 0 0 3px rgba(244, 67, 54, 0.2);
        }

        .forceout-buttons {
            display: flex;
            justify-content: space-between;
            gap: 15px;
        }

        .forceout-buttons button {
            flex: 1;
            padding: 12px 0;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .forceout-cancel {
            background-color: #f0f0f0;
            color: #666;
        }

        .forceout-cancel:hover {
            background-color: #e0e0e0;
            transform: translateY(-2px);
        }

        .forceout-confirm {
            background-color: #f44336;
            color: white;
        }

        .forceout-confirm:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(244, 67, 54, 0.3);
        }

        /* Redesigned buttons for 'Start,' 'View,' and 'Active' actions */
        .stat-card-actions .start-btn {
            background: linear-gradient(135deg, #4caf50, #81c784);
            color: white;
            border-radius: 30px;
            padding: 12px 20px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(76, 175, 80, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card-actions .start-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(76, 175, 80, 0.5);
        }

        .stat-card-actions .view-btn {
            background: linear-gradient(135deg, #3f87f5, #64b5f6);
            color: white;
            border-radius: 30px;
            padding: 12px 20px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(63, 135, 245, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card-actions .view-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(63, 135, 245, 0.5);
        }

        .stat-card-actions .active-btn {
            background: linear-gradient(135deg, #ff7f42, #ff9562);
            color: white;
            border-radius: 30px;
            padding: 12px 20px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 4px 10px rgba(255, 127, 66, 0.3);
            transition: all 0.3s ease;
        }

        .stat-card-actions .active-btn:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(255, 127, 66, 0.5);
        }

        /* Special design for Team MonuMe card */
        .team-monume-card {
            background: linear-gradient(135deg, #ff7f42, #ff9562);
            color: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 25px rgba(255, 127, 66, 0.3);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .team-monume-card:hover {
            transform: translateY(-10px);
            box-shadow: 0 15px 30px rgba(255, 127, 66, 0.5);
        }

        .team-monume-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .team-monume-card:hover::before {
            opacity: 1;
        }

        /* Special buttons for Team MonuMe card */
        .team-monume-card .team-actions {
            display: flex;
            gap: 15px;
            margin-top: 20px;
        }

        .team-monume-card .team-actions .team-action-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 14px 20px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #ff7f42;
            box-shadow: 0 4px 10px rgba(255, 127, 66, 0.3);
            text-transform: uppercase;
        }

        .team-monume-card .team-actions .team-action-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 15px rgba(255, 127, 66, 0.5);
            background: rgba(255, 255, 255, 0.9);
        }

        .team-monume-card .team-actions .team-action-button:active {
            transform: translateY(-2px);
        }

        /* Unique and stunning design for Active Users card */
        .active-users-card {
            background: linear-gradient(135deg, #6a1b9a, #ab47bc); /* Purple gradient */
            color: white;
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 15px 30px rgba(106, 27, 154, 0.4); /* Purple shadow */
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .active-users-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 20px 40px rgba(106, 27, 154, 0.6); /* Enhanced purple shadow on hover */
        }

        .active-users-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .active-users-card:hover::before {
            opacity: 1;
        }

        .active-users-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .active-users-card-header .icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            background: rgba(255, 255, 255, 0.2);
            color: white; /* Icon in white */
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
            transition: all 0.3s ease;
        }

        .active-users-card:hover .active-users-card-header .icon {
            transform: scale(1.2) rotate(15deg);
            box-shadow: 0 6px 15px rgba(171, 71, 188, 0.4); /* Softer purple hover shadow */
        }

        .active-users-card-value {
            font-size: 48px;
            font-weight: 900;
            margin: 20px 0 10px;
            color: white; /* Stat card value in white */
            text-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
        }

        .active-users-card:hover .active-users-card-value {
            transform: scale(1.1);
            color: #d1c4e9; /* Softer purple on hover */
        }

        .active-users-card-description {
            font-size: 18px;
            color: white; /* Stat card description in white */
            margin-bottom: 25px;
            font-weight: 600;
            opacity: 0.9;
        }

        .active-users-card-actions {
            display: flex;
            gap: 20px;
            margin-top: 30px;
        }

        .active-users-card-actions .action-button {
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 15px 20px;
            border: none;
            border-radius: 30px;
            font-weight: bold;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s ease;
            background: white;
            color: #3f87f5;
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.3);
            text-transform: uppercase;
        }

        .active-users-card-actions .action-button:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(255, 255, 255, 0.5);
            background: rgba(255, 255, 255, 0.9);
            color: #81c784;
        }

        .active-users-card-actions .action-button:active {
            transform: translateY(-2px);
        }

        /* Adjusted hover effect and smaller icon for Active Users card */
        .active-users-card:hover {
            transform: translateY(-8px); /* Reduced lift on hover */
            box-shadow: 0 15px 30px rgba(63, 135, 245, 0.5); /* Softer shadow */
        }

        .active-users-card-header .icon {
            width: 50px; /* Reduced size */
            height: 50px; /* Reduced size */
            font-size: 24px; /* Smaller font size */
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2); /* Softer shadow */
        }

        .active-users-card:hover .active-users-card-header .icon {
            transform: scale(1.1) rotate(10deg); /* Reduced scale and rotation */
            box-shadow: 0 6px 15px rgba(255, 255, 255, 0.4); /* Softer hover shadow */
        }

        /* Updated Active Users card to make the line under the title and stat-card-value white, and simplified hover effect */
        .active-users-card-header .team-monume-title {
            color: white; /* Title in white */
        }

        .active-users-card-header .team-monume-title::after {
            background: white; /* Line under the title in white */
        }

        .active-users-card-value {
            color: white; /* Stat card value in white */
        }

        .active-users-card:hover {
            transform: translateY(-5px); /* Simplified hover effect */
            box-shadow: 0 10px 20px rgba(106, 27, 154, 0.5); /* Softer shadow */
        }

        /* Ensure stat-card-value is white */
        .active-users-card-value {
            color: white !important; /* Force white color for the number */
        }

        /* Ensure stat-card-value inside active-users-info is white */
        .active-users-info .stat-card-value {
            color: white !important; /* Force white color for the number */
        }

        /* Simplified and enhanced hover effect for Active Users card */
        .active-users-card:hover {
            transform: translateY(-6px); /* Subtle lift */
            box-shadow: 0 12px 24px rgba(106, 27, 154, 0.5); /* Softer shadow */
            background: linear-gradient(135deg, #7b1fa2, #ba68c8); /* Slightly brighter purple gradient */
        }

        .active-users-card:hover .active-users-card-header .icon {
            transform: none; /* Ensure the icon does not change on hover */
            box-shadow: none; /* Remove hover shadow effect on the icon */
        }

        /* Duplicate the style and design of the Active Users card to the Appointments card */
        .appointments-card {
            background: linear-gradient(135deg, #6a1b9a, #ab47bc); /* Purple gradient */
            color: white;
            border-radius: 25px;
            padding: 35px;
            box-shadow: 0 15px 30px rgba(106, 27, 154, 0.4); /* Purple shadow */
            position: relative;
            overflow: hidden;
            transition: all 0.4s ease;
        }

        .appointments-card:hover {
            transform: translateY(-12px);
            box-shadow: 0 20px 40px rgba(106, 27, 154, 0.6); /* Enhanced purple shadow on hover */
            background: linear-gradient(135deg, #6a1b9a, #ab47bc); /* Ensure background color remains consistent */
        }

        .appointments-card::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.2), transparent);
            z-index: -1;
            opacity: 0;
            transition: opacity 0.4s ease;
        }

        .appointments-card:hover::before {
            opacity: 1;
        }

        .appointments-card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 25px;
        }

        .appointments-card-header .icon {
            width: 50px; /* Reduced size */
            height: 50px; /* Reduced size */
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            background: rgba(255, 255, 255, 0.2);
            color: white; /* Icon in white */
            box-shadow: 0 4px 10px rgba(255, 255, 255, 0.2); /* Softer shadow */
            transition: all 0.3s ease;
        }

        .appointments-card-header .team-monume-title {
            color: white; /* Title in white */
        }

        .appointments-card-header .team-monume-title::after {
            content: '';
            display: block;
            width: 40px;
            height: 3px;
            background: white; /* Line under the title in white */
            margin-top: 5px;
            border-radius: 3px;
        }
        .dashboard-split-section .upcoming-events-box {
            background: linear-gradient(135deg, #6a1b9a, #ab47bc);
            border-radius: 20px;
            padding: 25px;
            height: 100%;
            display: flex;
            flex-direction: column;
            box-shadow: 0 10px 30px rgba(106, 27, 154, 0.4);
            border: 2px solid rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }
        
        .dashboard-split-section .upcoming-events-box:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 35px rgba(106, 27, 154, 0.5);
        }
        
        .upcoming-events-title {
            font-size: 24px;
            font-weight: 700;
            color: white;
            margin-bottom: 20px;
            text-align: center;
            position: relative;
            padding-bottom: 12px;
        }
        
        .upcoming-events-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            width: 60px;
            height: 3px;
            background: white;
            border-radius: 3px;
        }
        
        .event-item {
            background: rgba(255, 255, 255, 0.15);
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            transition: all 0.3s ease;
            display: flex;
            flex-direction: column;
            border-left: 3px solid rgba(255, 255, 255, 0.5);
        }
        
        .event-item:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateX(5px);
        }
        
        .event-item.priority-high {
            border-left-color: #ff5252;
        }
        
        .event-item.priority-medium {
            border-left-color: #ffaa00;
        }
        
        .event-item.priority-low {
            border-left-color: #2ecc71;
        }
        
        .event-title {
            font-weight: 700;
            font-size: 16px;
            color: white;
            margin-bottom: 5px;
        }
        
        .event-date {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 5px;
            display: flex;
            align-items: center;
        }
        
        .event-date i {
            margin-right: 5px;
            font-size: 12px;
        }
        
        .event-location {
            font-size: 13px;
            color: rgba(255, 255, 255, 0.7);
            display: flex;
            align-items: center;
        }
        
        .event-location i {
            margin-right: 5px;
            font-size: 12px;
        }
        
        .no-events {
            text-align: center;
            padding: 30px 0;
            color: rgba(255, 255, 255, 0.7);
            font-style: italic;
        }

        /* Newly redesigned upcoming events section */
        .upcoming-events-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 20px;
        }
        
        .upcoming-events-controls {
            display: flex;
            gap: 10px;
        }
        
        .event-control-btn {
            width: 38px;
            height: 38px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: background 0.3s ease;
        }
        
        .event-control-btn:hover {
            background: rgba(255, 255, 255, 0.4);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.2);
        }
        
        .event-date-indicator {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 10px 15px;
        }
        
        .today-marker {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: white;
            color: #6a1b9a;
            width: 50px;
            height: 50px;
            border-radius: 12px;
            margin-right: 15px;
            font-weight: bold;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.2);
        }
        
        .today-date {
            font-size: 20px;
            line-height: 1;
        }
        
        .today-month {
            font-size: 12px;
            opacity: 0.8;
        }
        
        .date-line {
            flex: 1;
        }
        
        .date-info {
            color: white;
            font-weight: 600;
            font-size: 15px;
        }
        
        .events-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 20px;
            max-height: 350px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .events-list::-webkit-scrollbar {
            width: 5px;
        }
        
        .events-list::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 5px;
        }
        
        .events-list::-webkit-scrollbar-thumb {
            background: rgba(255, 255, 255, 0.3);
            border-radius: 5px;
        }
        
        .event-item {
            display: flex;
            border-radius: 12px;
            transition: all 0.3s ease;
            overflow: hidden;
            border-left: none;
            padding: 0;
            margin-bottom: 0;
        }
        
        .event-item:hover {
            transform: translateX(5px);
            background: rgba(255, 255, 255, 0.2);
        }
        
        .event-item.today {
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.15);
            background: rgba(255, 255, 255, 0.15);
            position: relative;
            overflow: hidden;
        }
        
        .event-item.today::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 5px;
            height: 100%;
            background: white;
            opacity: 0.8;
        }
        
        .event-time-block {
            background: rgba(255, 255, 255, 0.15);
            padding: 15px 10px;
            width: 60px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }
        
        .event-time {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            font-weight: 600;
        }
        
        .event-day {
            font-size: 20px;
            font-weight: 700;
            color: white;
        }
        
        .event-status {
            font-size: 11px;
            padding: 3px 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            margin-top: 5px;
            color: white;
        }
        
        .event-details {
            flex: 1;
            padding: 15px;
        }
        
        .event-title {
            margin: 0 0 5px 0;
            font-size: 16px;
        }
        
        .event-location {
            display: flex;
            align-items: center;
            margin: 5px 0 10px 0;
        }
        
        .event-actions {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-top: 10px;
        }
        
        .event-participants {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
        }
        
        .event-participants i {
            margin-right: 5px;
        }
        
        .event-time-remaining {
            font-size: 12px;
            color: rgba(255, 255, 255, 0.8);
        }
        
        .event-action-btn {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s ease;
        }
        
        .event-action-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }
        
        .events-footer {
            text-align: center;
            margin-top: 15px;
        }
        
        .view-all-events-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 12px 20px;
            border-radius: 30px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        
        .view-all-events-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .view-all-events-btn i {
            transition: transform 0.3s ease;
        }
        
        .view-all-events-btn:hover i {
            transform: translateX(4px);
        }
        .dashboard-split-section.upcoming-events-full {
    background: #fff;
    box-shadow: 0 8px 30px rgba(255, 127, 66, 0.10);
    border-radius: 24px;
    padding: 40px 32px;
    margin-bottom: 0;
    min-height: 350px;
    display: flex;
    flex-direction: column;
    justify-content: flex-start;
}
.dashboard-split-section.upcoming-events-full .upcoming-events-title {
    color: #7c3aed;
}
.dashboard-split-section.upcoming-events-full .event-item {
    background: #f3f0fa;
    color: #333;
}
.dashboard-split-section.upcoming-events-full .event-item.today {
    background: #ede9fe;
}
.dashboard-split-section.upcoming-events-full .event-title {
    color: #7c3aed;
}
.dashboard-split-section.upcoming-events-full .event-date-indicator {
    background: #ede9fe;
}
        /* Modern Bottom Section Design - FIXED DISPLAY */
        .dashboard-bottom-section {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 32px;
            margin-top: 48px;
            min-height: 500px;
            width: 100%;
        }

        .dashboard-bottom-card {
            background: rgba(255, 255, 255, 0.12);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 32px;
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 
                0 20px 40px rgba(0, 0, 0, 0.1),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            display: flex;
            flex-direction: column;
            height: 500px;
            min-height: 500px;
            overflow: hidden;
            position: relative;
            transition: all 0.4s cubic-bezier(0.25, 0.8, 0.25, 1);
            opacity: 1;
            visibility: visible;
        }

        .dashboard-bottom-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 2px;
            background: linear-gradient(90deg, 
                transparent, 
                rgba(255, 255, 255, 0.4), 
                transparent);
        }

        .dashboard-bottom-card:hover {
            transform: translateY(-8px);
            box-shadow: 
                0 32px 64px rgba(0, 0, 0, 0.15),
                inset 0 1px 0 rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.12);
        }

        /* Modern Card Header */
        .modern-card-header {
            padding: 32px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .card-header-content {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .card-icon {
            width: 64px;
            height: 64px;
            border-radius: 20px;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: white;
            box-shadow: 
                0 8px 25px rgba(255, 127, 66, 0.25),
                inset 0 1px 0 rgba(255, 255, 255, 0.2);
            transition: all 0.3s ease;
        }

        .card-title-group h3 {
            color: rgba(255, 255, 255, 0.95);
            font-size: 24px;
            font-weight: 700;
            margin: 0 0 4px 0;
            letter-spacing: -0.5px;
        }

        .card-title-group p {
            color: rgba(255, 255, 255, 0.6);
            font-size: 14px;
            margin: 0;
            font-weight: 500;
        }

        .header-actions {
            display: flex;
            gap: 8px;
        }

        .header-action-btn {
            width: 48px;
            height: 48px;
            border-radius: 16px;
            background: var(--main-color);
            border: none;
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
        }

        .header-action-btn:hover {
            background: var(--gradient-start);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
        }

        .header-action-btn:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }

        .header-action-btn .fa-spinner {
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            from { transform: rotate(0deg); }
            to { transform: rotate(360deg); }
        }

        /* Enhanced Team Chat Preview Styles */
        .chat-messages-container {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .chat-preview-empty {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            height: 180px;
            text-align: center;
            color: rgba(255, 255, 255, 0.7);
        }

        .empty-chat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.1);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: rgba(255, 255, 255, 0.6);
            margin-bottom: 16px;
        }

        .chat-preview-empty p {
            margin: 0 0 4px 0;
            font-size: 16px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.9);
        }

        .chat-preview-empty span {
            font-size: 14px;
            color: rgba(255, 255, 255, 0.6);
        }

        .chat-preview-message {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            animation: fadeInUp 0.3s ease-out;
        }

        .chat-preview-message.sent {
            flex-direction: row-reverse;
            align-self: flex-end;
        }

        .preview-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 12px;
            font-weight: 600;
            flex-shrink: 0;
            box-shadow: 0 4px 12px rgba(255, 127, 66, 0.2);
        }

        .preview-message-content {
            max-width: 80%;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 16px;
            padding: 12px 16px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
        }

        .chat-preview-message.sent .preview-message-content {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            box-shadow: 0 4px 12px rgba(255, 127, 66, 0.2);
        }

        .preview-message-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 6px;
        }

        .preview-sender {
            font-weight: 600;
            font-size: 13px;
            color: rgba(255, 255, 255, 0.9);
        }

        .preview-time {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
        }

        .preview-message-text {
            color: rgba(255, 255, 255, 0.95);
            font-size: 14px;
            line-height: 1.4;
            word-break: break-word;
        }

        .chat-preview-message.sent .preview-message-text {
            color: white;
        }

        .chat-input-container {
            padding: 24px 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .input-wrapper {
            display: flex;
            gap: 12px;
            align-items: center;
        }

        .chat-input {
            flex: 1;
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.15);
            border-radius: 20px;
            padding: 16px 20px;
            color: rgba(255, 255, 255, 0.95);
            font-size: 15px;
            outline: none;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .chat-input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .chat-input:focus,
        .chat-input:hover {
            border-color: var(--gradient-start);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.2);
            background: rgba(255, 255, 255, 0.15);
        }

        .chat-input[readonly] {
            cursor: pointer;
        }

        .chat-input[readonly]:hover {
            background: rgba(255, 255, 255, 0.12);
            border-color: rgba(255, 149, 98, 0.5);
        }

        .send-button {
            width: 52px;
            height: 52px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            color: white;
            font-size: 18px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 20px rgba(255, 127, 66, 0.3);
        }

        .send-button:hover {
            transform: scale(1.05);
            box-shadow: 0 12px 25px rgba(255, 127, 66, 0.4);
        }

        .send-button:active {
            transform: scale(0.95);
        }

        /* Enhanced Upcoming Appointments Styles */
        .events-list-container {
            flex: 1;
            padding: 24px 32px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0;
            max-height: 400px;
            scrollbar-width: thin;
            scrollbar-color: rgba(255, 149, 98, 0.3) transparent;
        }

        .events-list-container::-webkit-scrollbar {
            width: 6px;
        }

        .events-list-container::-webkit-scrollbar-track {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 3px;
        }

        .events-list-container::-webkit-scrollbar-thumb {
            background: rgba(255, 149, 98, 0.3);
            border-radius: 3px;
        }

        .events-list-container::-webkit-scrollbar-thumb:hover {
            background: rgba(255, 149, 98, 0.5);
        }

        .upcoming-appointment-item {
            display: flex;
            align-items: center;
            padding: 24px;
            background: rgba(255, 255, 255, 0.06);
            border-radius: 20px;
            border: 1px solid rgba(255, 255, 255, 0.08);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            position: relative;
            overflow: hidden;
            min-height: 100px;
            margin-bottom: 16px;
        }

        .upcoming-appointment-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(to bottom, var(--gradient-start), var(--gradient-end));
            border-radius: 0 2px 2px 0;
        }

        .upcoming-appointment-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
        }

        .upcoming-appointment-item.today {
            background: rgba(255, 149, 98, 0.12);
            border-color: rgba(255, 149, 98, 0.25);
            box-shadow: 0 4px 20px rgba(255, 149, 98, 0.1);
        }

        .upcoming-appointment-item.today::before {
            background: linear-gradient(to bottom, #ff9562, #ff7f42);
            width: 4px;
        }

        .appointment-date-section {
            display: flex;
            flex-direction: column;
            align-items: center;
            min-width: 80px;
            margin-right: 24px;
            flex-shrink: 0;
        }

        .appointment-date-number {
            font-size: 28px;
            font-weight: 800;
            color: rgba(255, 255, 255, 0.95);
            line-height: 1;
            margin-bottom: 2px;
        }

        .appointment-date-month {
            font-size: 11px;
            color: rgba(255, 255, 255, 0.6);
            font-weight: 600;
            letter-spacing: 1px;
        }

        .appointment-right-section {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 130px;
            margin-left: auto;
            flex-shrink: 0;
            padding-left: 16px;
        }

        .appointment-badge-container {
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            gap: 8px;
        }

        .appointment-today-badge,
        .appointment-tomorrow-badge,
        .appointment-week-badge,
        .appointment-past-badge {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            font-size: 11px;
            padding: 6px 10px;
            border-radius: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(255, 149, 98, 0.3);
            white-space: nowrap;
            min-width: fit-content;
        }

        .appointment-tomorrow-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .appointment-week-badge {
            background: linear-gradient(135deg, #a855f7, #9333ea);
            box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3);
        }

        .appointment-past-badge {
            background: linear-gradient(135deg, #6b7280, #4b5563);
            box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3);
        }

        .appointment-info-section {
            flex: 1;
            min-width: 0;
            padding: 0 16px;
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .appointment-client-name {
            font-size: 17px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.95);
            margin-bottom: 8px;
            line-height: 1.3;
            word-wrap: break-word;
        }

        .appointment-type-time {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 10px;
            flex-wrap: wrap;
        }

        .appointment-type {
            background: rgba(255, 255, 255, 0.12);
            color: rgba(255, 255, 255, 0.9);
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            border: 1px solid rgba(255, 255, 255, 0.15);
            white-space: nowrap;
        }

        .appointment-time {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 6px 12px;
            border-radius: 12px;
            font-size: 13px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(255, 149, 98, 0.2);
            white-space: nowrap;
        }

        .appointment-status-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 8px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .appointment-status-badge.status-confirmed {
            background: rgba(34, 197, 94, 0.2);
            color: #22c55e;
            border: 1px solid rgba(34, 197, 94, 0.3);
        }

        .appointment-status-badge.status-rescheduled {
            background: rgba(255, 193, 7, 0.2);
            color: #ffc107;
            border: 1px solid rgba(255, 193, 7, 0.3);
        }

        .appointment-status-badge.status-pending {
            background: rgba(168, 85, 247, 0.2);
            color: #a855f7;
            border: 1px solid rgba(168, 85, 247, 0.3);
        }

        /* Enhanced appointment status container for right side display */
        .appointment-status-container {
            display: flex;
            flex-direction: column;
            align-items: flex-end;
            gap: 8px;
            min-width: 120px;
        }

        .appointment-status-badge {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 14px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            transition: all 0.3s ease;
            border: 1px solid;
            white-space: nowrap;
            min-width: fit-content;
        }

        .appointment-status-badge.status-scheduled {
            background: rgba(59, 130, 246, 0.15);
            color: #3b82f6;
            border-color: rgba(59, 130, 246, 0.3);
        }

        .appointment-status-badge.status-confirmed {
            background: rgba(34, 197, 94, 0.15);
            color: #22c55e;
            border-color: rgba(34, 197, 94, 0.3);
        }

        .appointment-status-badge.status-completed {
            background: rgba(16, 185, 129, 0.15);
            color: #10b981;
            border-color: rgba(16, 185, 129, 0.3);
        }

        .appointment-status-badge.status-cancelled {
            background: rgba(239, 68, 68, 0.15);
            color: #ef4444;
            border-color: rgba(239, 68, 68, 0.3);
        }

        .appointment-status-badge.status-rescheduled {
            background: rgba(245, 158, 11, 0.15);
            color: #f59e0b;
            border-color: rgba(245, 158, 11, 0.3);
        }

        .appointment-status-badge.status-pending {
            background: rgba(168, 85, 247, 0.15);
            color: #a855f7;
            border-color: rgba(168, 85, 247, 0.3);
        }

        .appointment-status-badge.status-no-show {
            background: rgba(107, 114, 128, 0.15);
            color: #6b7280;
            border-color: rgba(107, 114, 128, 0.3);
        }

        .appointment-date-badge {
            display: flex;
            align-items: center;
            justify-content: flex-end;
        }

        .appointment-date-badge span {
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 700;
            letter-spacing: 0.5px;
            text-transform: uppercase;
        }

        .today-badge {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
            box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3);
        }

        .tomorrow-badge {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
            box-shadow: 0 2px 8px rgba(34, 197, 94, 0.3);
        }

        .upcoming-badge {
            background: linear-gradient(135deg, #3b82f6, #2563eb);
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }

        /* Enhanced empty state */
        .empty-appointments-icon {
            width: 70px;
            height: 70px;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
            color: rgba(255, 255, 255, 0.5);
            margin-bottom: 20px;
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        .events-footer {
            padding: 24px 32px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
            flex-shrink: 0;
        }

        .view-all-events-btn {
            width: 100%;
            background: var(--main-color);
            border: none;
            color: white;
            padding: 16px 24px;
            border-radius: 16px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            box-shadow: 0 4px 15px rgba(255, 149, 98, 0.3);
        }

        .view-all-events-btn:hover {
            background: var(--gradient-start);
            color: white;
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 149, 98, 0.4);
        }

        .view-all-events-btn i {
            transition: transform 0.3s ease;
        }

        .view-all-events-btn:hover i {
            transform: translateX(4px);
        }

        /* Responsive Design for Bottom Section */
        @media screen and (max-width: 1200px) {
            .dashboard-bottom-section {
                grid-template-columns: 1fr;
                gap: 24px;
                margin-top: 40px;
            }
            
            .dashboard-bottom-card {
                height: 500px;
            }
            
            .upcoming-appointment-item {
                padding: 20px;
                min-height: 90px;
            }
            
            .appointment-info-section {
                padding: 0 12px;
            }
            
            .appointment-right-section {
                min-width: 110px;
                padding-left: 12px;
            }
        }

        @media screen and (max-width: 768px) {
            .dashboard-bottom-section {
                margin-top: 32px;
            }
            
            .dashboard-bottom-card {
                height: 450px;
                border-radius: 24px;
            }
            
            .modern-card-header {
                padding: 24px;
            }
            
            .card-header-content {
                gap: 16px;
            }
            
            .card-icon {
                width: 56px;
                height: 56px;
                font-size: 24px;
            }
            
            .card-title-group h3 {
                font-size: 20px;
            }
            
            .chat-messages-container,
            .events-list-container {
                padding: 20px 24px;
            }
            
            .chat-input-container,
            .events-footer {
                padding: 20px 24px;
            }
            
            .upcoming-appointment-item {
                padding: 16px;
                min-height: 85px;
                flex-direction: column;
                align-items: flex-start;
                gap: 12px;
            }
            
            .appointment-date-section {
                margin-right: 0;
                margin-bottom: 8px;
                flex-direction: row;
                gap: 8px;
                align-self: flex-start;
            }
            
            .appointment-info-section {
                padding: 0;
                width: 100%;
            }
            
            .appointment-right-section {
                margin-left: 0;
                align-self: flex-end;
                min-width: auto;
                padding-left: 0;
            }
            
            .appointment-type-time {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }

        @media screen and (max-width: 576px) {
            .dashboard-bottom-card {
                height: 400px;
            }
            
            .modern-card-header {
                padding: 20px;
                flex-direction: column;
                gap: 16px;
                align-items: flex-start;
            }
            
            .header-actions {
                align-self: flex-end;
            }
            
            .sample-message {
                gap: 8px;
            }
            
            .message-content {
                padding: 12px 16px;
            }
            
            .event-item {
                padding: 16px;
            }
            
            .event-date {
                margin-right: 16px;
                min-width: 50px;
            }
            
            .date-number {
                font-size: 20px;
            }
        }
        .welcome-title {
            background: none;
            color: #6a1b9a;
            font-size: 3.5rem;
            font-weight: 900;
            padding: 18px 0 8px 0;
            border-radius: 18px;
            text-align: center;
            margin-bottom: 0.5rem;
            box-shadow: none;
            letter-spacing: 1px;
        }
        .welcome-subtitle {
            color: white !important;
            font-size: 1.7rem !important;
            font-weight: 600 !important;
            text-align: center;
            margin-bottom: 2.2rem;
            text-shadow: none;
        }
        
        .welcome-subtitle .highlight {
            color: white !important;
        }

        /* Time Conflict Animation Styles */
        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        /* Event Popup Modal */
        .event-modal-nice {
  display: none;
  position: fixed;
  z-index: 2000;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: transparent;
  backdrop-filter: none;
  -webkit-backdrop-filter: none;
  align-items: center;
  justify-content: center;
}
.event-modal-nice-content {
  background: rgba(255,255,255,0.95);
  border-radius: 28px;
  box-shadow: 0 16px 48px rgba(106,27,154,0.18), 0 0 0 1px #ede9fe;
  max-width: 370px;
  width: 95vw;
  margin: 60px auto 0 auto;
  padding: 0 0 28px 0;
  overflow: hidden;
  position: relative;
  animation: modalSlideUp 0.4s cubic-bezier(0.19, 1, 0.22, 1);
}
@keyframes modalSlideUp {
  from { opacity: 0; transform: translateY(40px) scale(0.97); }
  to { opacity: 1; transform: translateY(0) scale(1); }
}
.event-modal-nice-close {
  position: absolute;
  top: 18px; right: 24px;
  background: rgba(106,27,154,0.08);
  border: none;
  color: #6a1b9a;
  font-size: 2rem;
  width: 38px;
  height: 38px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  opacity: 0.7;
  transition: all 0.2s;
  z-index: 2;
}
.event-modal-nice-close:hover {
  opacity: 1;
  background: #ede9fe;
  color: #ab47bc;
  transform: rotate(90deg);
}
.event-modal-nice-header {
  background: linear-gradient(135deg, #ab47bc 0%, #6a1b9a 100%);
  padding: 38px 32px 18px 32px;
  text-align: center;
  border-top-left-radius: 28px;
  border-top-right-radius: 28px;
  position: relative;
}
.event-modal-nice-icon {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  font-size: 2.7rem;
  color: #fff;
  background: rgba(255,255,255,0.13);
  border-radius: 50%;
  width: 70px;
  height: 70px;
  margin-bottom: 10px;
  box-shadow: 0 4px 18px rgba(171,71,188,0.18);
  animation: pulse 3s infinite;
}
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.08); }
}
.event-modal-nice-header h2 {
  color: #fff;
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0 0 0.5rem 0;
  letter-spacing: 0.5px;
}
.event-modal-nice-tagline {
  color: #ede9fe;
  font-size: 1rem;
  font-weight: 400;
  margin: 0;
  opacity: 0.9;
}
.event-modal-nice-body {
  padding: 24px 32px 0 32px;
  display: flex;
  flex-direction: column;
  gap: 18px;
}
.event-modal-nice-body label {
  font-size: 1rem;
  color: #6a1b9a;
  font-weight: 600;
  margin-bottom: 4px;
}
.event-modal-nice-input-wrap {
  position: relative;
  margin-bottom: 10px;
}
.event-modal-nice-input-icon {
  position: absolute;
  left: 14px;
  top: 50%;
  transform: translateY(-50%);
  color: #ab47bc;
  opacity: 0.7;
  font-size: 1.1rem;
  pointer-events: none;
}
.event-modal-nice-input {
  width: 100%;
  padding: 12px 16px 12px 40px;
  border-radius: 12px;
  border: 1.5px solid #ede9fe;
  background: rgba(255,255,255,0.7);
  font-size: 1rem;
  color: #6a1b9a;
  outline: none;
  transition: border 0.2s, box-shadow 0.2s;
  box-shadow: 0 2px 8px rgba(106,27,154,0.04) inset;
}
.event-modal-nice-input:focus {
  border: 1.5px solid #ab47bc;
  box-shadow: 0 0 0 2px #ab47bc33;
  background: #fff;
}
.event-modal-nice-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 24px 32px 0 32px;
}
        .event-modal-nice-btn {
            padding: 12px 28px;
            border-radius: 18px;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
            min-height: 44px;
        }
        .event-modal-nice-btn.cancel {
            background: var(--main-color);
            color: white;
        }
        .event-modal-nice-btn.cancel:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
        }
        .event-modal-nice-btn.save {
            background: var(--main-color);
            color: white;
            box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);
        }
        .event-modal-nice-btn.save:hover {
            background: var(--gradient-start);
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.4);
        }
.event-modal-nice-overlay {
  display: none;
  position: fixed;
  left: 0; top: 0; width: 100vw; height: 100vh;
  background: rgba(0,0,0,0.28); /* More black, more visible */
  z-index: 1999;
  backdrop-filter: blur(10px); /* More blur */
  -webkit-backdrop-filter: blur(10px);
        }

        /* Enhanced Loading Animations */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes slideInFromRight {
            0% {
                transform: translateX(100%);
                opacity: 0;
            }
            100% {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        @keyframes slideOutToRight {
            0% {
                transform: translateX(0);
                opacity: 1;
            }
            100% {
                transform: translateX(100%);
                opacity: 0;
            }
        }
    </style>
</head>
<body>
    <script>
        // Secondary authentication check (when DOM is loaded)
        // Define missing functions to prevent errors
        function setupEventListeners() {
            console.log('Event listeners setup');
        }
        
        function loadDashboardData() {
            console.log('Dashboard data loaded');
        }
        
        function createParticles() {
            console.log('Particles created');
        }
        
        function checkMorningNotes() {
            console.log('Morning notes checked');
        }
        
        // **REMOVED: Old placeholder functions that were doing nothing**
        // These were replaced with working functions below

        // Initialize location-specific dashboard content
        function initializeLocationDashboard() {
            const urlParams = new URLSearchParams(window.location.search);
            const locationParam = urlParams.get('location');
            const isAdmin = localStorage.getItem("isAdmin") === "true";
            const username = localStorage.getItem("username");
            const role = localStorage.getItem("role");
            const locationCode = localStorage.getItem("locationCode") || localStorage.getItem("location_username") || localStorage.getItem("location_name");
            
            const welcomeTitle = document.getElementById('welcome-title');
            const welcomeSubtitle = document.getElementById('welcome-subtitle');
            
            if (locationParam && !isAdmin) {
                // Location-specific dashboard
                const monumeLocations = JSON.parse(localStorage.getItem('monumeLocations') || '[]');
                const currentLocation = monumeLocations.find(loc => loc.code === locationParam);
                
                if (currentLocation) {
                    welcomeTitle.textContent = `Welcome to ${currentLocation.name}`;
                    welcomeSubtitle.innerHTML = `<span class="highlight">${currentLocation.name}</span> Dashboard - Manage your location efficiently`;
                    
                    console.log(`🏢 Location Dashboard initialized for: ${currentLocation.name}`);
                    
                    // Update page title
                    document.title = `${currentLocation.name} - MonuMe Dashboard`;
                } else {
                    console.error("❌ Location not found:", locationParam);
                }
            } else if (isAdmin) {
                // Admin dashboard
                welcomeTitle.textContent = "Admin Dashboard - MonuMe Performance";
                welcomeSubtitle.innerHTML = 'Manage all locations and <span class="highlight">oversee</span> the entire <span class="highlight">network</span>';
                
                console.log("👑 Admin Dashboard initialized");
                
                // Update page title
                document.title = "Admin Dashboard - MonuMe Performance";
            } else {
                // Default dashboard
                console.log("📊 Default Dashboard initialized");
            }
            
            // Add location indicator badge if viewing location-specific dashboard
            if (locationParam) {
                addLocationBadge(locationParam);
            }
        }

        // Add location indicator badge
        function addLocationBadge(locationCode) {
            const welcomeContainer = document.getElementById('welcome-container');
            
            // Check if badge already exists
            if (document.getElementById('location-badge')) {
                return;
            }
            
            const badge = document.createElement('div');
            badge.id = 'location-badge';
            badge.style.cssText = `
                position: absolute;
                top: 20px;
                right: 20px;
                background: rgba(255, 255, 255, 0.2);
                backdrop-filter: blur(10px);
                border: 1px solid rgba(255, 255, 255, 0.3);
                border-radius: 20px;
                padding: 8px 16px;
                color: white;
                font-size: 14px;
                font-weight: 600;
                text-transform: uppercase;
                letter-spacing: 1px;
                box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            `;
            const locationName = localStorage.getItem("location_name") || locationCode;
        badge.innerHTML = `<i class="fas fa-map-marker-alt"></i> ${locationName}`;
            
            welcomeContainer.style.position = 'relative';
            welcomeContainer.appendChild(badge);
        }

        // Helper: get current location context for appointment association
        function getCurrentLocationContext() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const locationParam = urlParams.get('location');
                const locationIdRaw = localStorage.getItem('location_id') || localStorage.getItem('currentTrackingLocationId') || '';
                const locationUsername = localStorage.getItem('location_username') || localStorage.getItem('locationCode') || '';
                const locationName = localStorage.getItem('location_name') || '';
                const code = locationParam || locationUsername || locationName || '';
                const id = locationIdRaw ? (isNaN(Number(locationIdRaw)) ? locationIdRaw : Number(locationIdRaw)) : null;
                return { id, code, name: locationName || code };
            } catch (e) {
                console.warn('Could not determine current location context', e);
                return { id: null, code: '', name: '' };
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('DOM Content Loaded - Starting setup...');
            
            // Initialize location-specific dashboard
            initializeLocationDashboard();
            
            // Set up event listeners for the links and buttons
            setupEventListeners();
            // Load dashboard data
            loadDashboardData();
            // Create particles
            createParticles();
            // Check for incomplete morning notes
            checkMorningNotes();
            
            // Check for a custom logo in local storage
            const customLogo = localStorage.getItem('customLogo');
            const sidebarLogo = document.getElementById('sidebar-logo');
            if (customLogo && sidebarLogo) {
                sidebarLogo.src = customLogo;
            }
            
            // **DISABLED: Old Team MonuMe functions (replaced with working versions)**
            // setupActiveUsersButtons();
            // initializeUsersDatabase();
            // updateActiveUsersCount();
            // **NEW SYSTEM: These are now handled by the new script section**
            
            // IMPORTANT: Set up appointment functionality
            console.log('Setting up appointment functionality...');
            setupAppointmentButtons();
            
            // Additional backup event listeners for appointment buttons
            setTimeout(() => {
                const addBtn = document.getElementById('appointment-add-btn');
                const viewBtn = document.getElementById('appointment-view-btn');
                
                if (addBtn) {
                    console.log('✅ Adding backup event listener to ADD button');
                    addBtn.addEventListener('click', function(e) {
                        console.log('🎯 Backup ADD button clicked!');
                        e.preventDefault();
                        e.stopPropagation();
                        openAppointmentModal();
                    });
                }
                
                if (viewBtn) {
                    console.log('✅ Adding backup event listener to VIEW button');
                    viewBtn.addEventListener('click', function(e) {
                        console.log('🎯 Backup VIEW button clicked!');
                        e.preventDefault();
                        e.stopPropagation();
                        window.location.href = 'appointment.html';
                    });
                }
            }, 500);
            
            console.log('DOM setup completed successfully!');
        });

        function setupEventListeners() {
            console.log('Event listeners setup.');
        }
    </script>

    <!-- Particles background -->
    <div class="particles" id="particles"></div>

    <!-- Enhanced Sidebar -->
    <div class="sidebar">
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <a href="/dashboard" title="Go to Dashboard">
                    <div class="logo-container">
                        <img src="/static/logo11.png" alt="MonuMe Logo" class="sidebar-logo" onerror="this.onerror=null;this.src='/static/favicon.ico'">
                    </div>
                </a>
            </div>
            <div class="sidebar-divider"></div>
        </div>
        
        <nav class="sidebar-navigation">
            <ul class="sidebar-menu">
                <li class="menu-item active">
                    <a href="/dashboard" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-chart-pie"></i>
                        </div>
                        <span class="menu-text">Dashboard</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/management" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-cogs"></i>
                        </div>
                        <span class="menu-text">Management</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/tracking" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <span class="menu-text">Performance</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
                
                <li class="menu-item">
                    <a href="/appointment" class="menu-link">
                        <div class="menu-icon">
                            <i class="fas fa-calendar-check"></i>
                        </div>
                        <span class="menu-text">Appointments</span>
                        <div class="menu-arrow">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </a>
                </li>
            </ul>
        </nav>
        
        <div class="sidebar-footer">
            <div class="user-profile" id="user-profile" onclick="toggleUserMenu()">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-info">
                    <div class="user-name" id="user-name">Loading...</div>
                    <div class="user-status" id="user-status">Online</div>
                </div>
                <div class="user-menu-toggle">
                    <i class="fas fa-chevron-down"></i>
                </div>
            </div>
            
            <!-- User Menu Dropdown -->
            <div class="user-menu" id="user-menu">
                <div class="user-menu-item" onclick="signOut()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Sign Out</span>
                </div>
            </div>
        </div>
    </div>

    <!-- Mobile Menu Button -->
    <button class="mobile-menu-btn" id="mobile-menu-btn">
        <i class="fas fa-bars"></i>
    </button>

    <!-- Main content area -->
    <div class="main-content">
        <div class="welcome-container" id="welcome-container">
            <h1 class="welcome-title" id="welcome-title">Welcome to MonuMe Performance</h1>
            <p class="welcome-subtitle" id="welcome-subtitle">See The <span class="highlight">Result</span>, Shape The <span class="highlight">Future</span>.</p>
        </div>

        <!-- Modern Dashboard Statistics Cards -->
        <div class="dashboard-stats">
            <div class="stat-card" id="team-monume-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-users"></i>
                    </div>
                </div>
                <div class="stat-card-content">
                    <h3 class="team-monume-title">Team MonuMe</h3>
                    <div class="stat-card-value" id="activeUsers">0</div>
                    <p class="stat-card-description">Active Users Currently Online</p>
                    <div class="stat-card-actions">
                        <button id="start-session-btn" class="action-button" style="cursor: pointer;">
                            <i class="fas fa-play"></i>
                            Start Session
                        </button>
                        <button id="view-active-users-btn" class="action-button" style="cursor: pointer;">
                            <i class="fas fa-eye"></i>
                            View Active
                        </button>
                    </div>
                </div>
            </div>

            <div class="stat-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-calendar-alt"></i>
                    </div>
                </div>
                <div class="stat-card-content">
                    <h3 class="team-monume-title">Appointments</h3>
                    <div class="stat-card-value appointments-card-value">0</div>
                    <p class="stat-card-description">Scheduled Appointments</p>
                    <div class="stat-card-actions">
                        <button class="action-button primary" id="appointment-add-btn" onclick="console.log('Direct onclick fired!'); openAppointmentModal();">
                            <i class="fas fa-plus"></i>
                            Add New
                        </button>
                        <button class="action-button" id="appointment-view-btn" onclick="console.log('VIEW onclick fired!'); window.location.href='appointment.html';">
                            <i class="fas fa-calendar"></i>
                            View All
                        </button>
                    </div>
                </div>
            </div>

            <div class="stat-card coming-soon" id="gift-cards-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-gift"></i>
                    </div>
                </div>
                <div class="stat-card-content">
                    <h3 class="team-monume-title">Gift Cards</h3>
                    <div class="stat-card-value">0</div>
                    <p class="stat-card-description">Manage Gift Card Inventory</p>
                    <div class="stat-card-actions">
                        <button class="action-button primary" disabled>
                            <i class="fas fa-plus"></i>
                            Add Card
                        </button>
                        <button class="action-button" disabled>
                            <i class="fas fa-list"></i>
                            View Cards
                        </button>
                    </div>
                </div>
                <div class="coming-soon-overlay" onclick="event.preventDefault(); event.stopPropagation();">
                    <span><i class="fas fa-hourglass-half"></i> Coming Soon</span>
                </div>
            </div>

            <div class="stat-card coming-soon" id="opening-tasks-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-clipboard-check"></i>
                    </div>
                </div>
                <div class="stat-card-content">
                    <h3 class="team-monume-title">Opening Tasks</h3>
                    <div class="stat-card-value">0</div>
                    <p class="stat-card-description">Daily Opening Checklist</p>
                    <div class="stat-card-actions">
                        <button class="action-button primary" disabled>
                            <i class="fas fa-external-link-alt"></i>
                            Start Checklist
                        </button>
                    </div>
                </div>
                <div class="coming-soon-overlay" onclick="event.preventDefault(); event.stopPropagation();">
                    <span><i class="fas fa-hourglass-half"></i> Coming Soon</span>
                </div>
            </div>

            <div class="stat-card coming-soon" id="closing-tasks-card">
                <div class="stat-card-header">
                    <div class="stat-card-icon">
                        <i class="fas fa-clipboard-list"></i>
                    </div>
                </div>
                <div class="stat-card-content">
                    <h3 class="team-monume-title">Closing Tasks</h3>
                    <div class="stat-card-value">0</div>
                    <p class="stat-card-description">Daily Closing Checklist</p>
                    <div class="stat-card-actions">
                        <button class="action-button primary" disabled>
                            <i class="fas fa-external-link-alt"></i>
                            Start Checklist
                        </button>
                    </div>
                </div>
                <div class="coming-soon-overlay" onclick="event.preventDefault(); event.stopPropagation();">
                    <span><i class="fas fa-hourglass-half"></i> Coming Soon</span>
                </div>
            </div>
        </div>

        <!-- Modern Bottom Section -->
        <div class="dashboard-bottom-section">
            <div class="dashboard-bottom-card team-chat-container coming-soon" id="team-chat-card">
                <div class="modern-card-header">
                    <div class="card-header-content">
                        <div class="card-icon">
                            <i class="fas fa-comments"></i>
                        </div>
                        <div class="card-title-group">
                            <h3>Team Chat</h3>
                            <p>Stay connected with your team</p>
                        </div>
                    </div>
                    <button class="header-action-btn" title="Open Team Chat" style="cursor: not-allowed;">
                        <i class="fas fa-users"></i>
                    </button>
                </div>
                
                <div class="chat-messages-container" id="chatMessages">
                    <div class="chat-loading-state">
                        <div class="loading-spinner"></div>
                        <p>Coming Soon</p>
                    </div>
                </div>
                
                <div class="chat-input-container">
                    <div class="input-wrapper">
                        <input type="text" class="chat-input" id="messageInput" placeholder="Type your message..." readonly style="cursor: not-allowed;">
                        <button class="send-button" id="sendButton" disabled>
                            <i class="fas fa-paper-plane"></i>
                        </button>
                    </div>
                </div>

                <div class="coming-soon-overlay" onclick="event.preventDefault(); event.stopPropagation();">
                    <span><i class="fas fa-hourglass-half"></i> Coming Soon</span>
                </div>
            </div>

            <div class="dashboard-bottom-card events-container">
                <div class="modern-card-header">
                    <div class="card-header-content">
                        <div class="card-icon">
                            <i class="fas fa-calendar-week"></i>
                        </div>
                        <div class="card-title-group">
                            <h3>Upcoming Appointments</h3>
                            <p>Next 7 days scheduled appointments</p>
                        </div>
                    </div>
                    <div class="header-actions">
                        <button class="header-action-btn" title="View All Appointments" onclick="window.location.href='appointment.html';">
                            <i class="fas fa-calendar-alt"></i>
                        </button>
                    </div>
                </div>
                
                <div class="events-list-container" id="weeklyAppointments">
                    <div class="appointments-loading-state">
                        <div class="loading-spinner"></div>
                        <p>Loading this week's appointments...</p>
                    </div>
                </div>
                
                <div class="events-footer">
                    <button class="view-all-events-btn" onclick="window.location.href='appointment.html';">
                        <span>Manage Appointments</span>
                        <i class="fas fa-arrow-right"></i>
                    </button>
                </div>
            </div>
        </div>
    <!-- Logo Upload Modal -->
    <div id="logoModal" class="logo-modal">
        <h2>Change Logo</h2>
        <div id="logo-upload-area" class="logo-upload-area">
            <i class="fas fa-cloud-upload-alt"></i>
            <p>Click or drag image to upload</p>
            <input type="file" id="file-input" accept="image/*" />
        </div>
        <img id="logo-preview" class="logo-preview" alt="Logo preview" />
        <div class="logo-buttons">
            <button class="logo-btn cancel-btn" onclick="closeLogoModal()">Cancel</button>
            <button class="logo-btn save-btn" onclick="saveLogo()">Save Logo</button>
        </div>
    </div>


    
    <!-- Simple User Selection Modal -->
    <div id="user-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content">
            <div class="simple-modal-header">
                <h3>Select User to Start Session</h3>
                <button class="simple-modal-close" onclick="closeUserModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <div id="users-grid" class="users-grid">
                    <!-- Users will be populated here -->
                </div>
            </div>
        </div>
            </div>
            
    <!-- Password Confirmation Modal -->
    <div id="password-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content" style="width: 400px;">
            <div class="simple-modal-header">
                <h3>Confirm Password</h3>
                <button class="simple-modal-close" onclick="closePasswordModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <div class="password-user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="password-user-name"></div>
                        <div class="user-role" id="password-user-role"></div>
                    </div>
                </div>
                <div class="password-input-section">
                    <label for="password-input">Enter Password:</label>
                    <input type="password" id="password-input" class="password-field" placeholder="Password">
                </div>
                <div class="password-actions">
                    <button onclick="closePasswordModal()" class="cancel-btn">Cancel</button>
                    <button onclick="confirmPassword()" class="confirm-btn">Confirm</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Active Users Management Modal -->
    <div id="active-users-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content" style="width: 600px;">
            <div class="simple-modal-header">
                <h3>Active Users Management</h3>
                <button class="simple-modal-close" onclick="closeActiveUsersModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <div id="active-users-list" class="active-users-list">
                    <!-- Active users will be populated here -->
                </div>
            </div>
        </div>
    </div>
    
    <!-- Inactive User Confirmation Modal -->
    <div id="inactive-confirm-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content" style="width: 400px;">
            <div class="simple-modal-header">
                <h3>Make User Inactive</h3>
                <button class="simple-modal-close" onclick="closeInactiveModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <div class="inactive-user-info">
                    <div class="user-avatar">
                        <i class="fas fa-user-clock"></i>
                    </div>
                    <div class="user-details">
                        <div class="user-name" id="inactive-user-name"></div>
                        <div class="user-role" id="inactive-user-role"></div>
                    </div>
                </div>
                <div class="password-input-section">
                    <label for="inactive-password-input">Enter Your Password:</label>
                    <input type="password" id="inactive-password-input" class="password-field" placeholder="Password">
                </div>
                <div class="password-actions">
                    <button onclick="closeInactiveModal()" class="cancel-btn">Cancel</button>
                    <button onclick="confirmInactive()" class="confirm-btn">Make Inactive</button>
                </div>
            </div>
        </div>
            </div>
            
    <!-- Force Out Modal -->
    <div id="forceout-confirm-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content" style="width: 450px;">
            <div class="simple-modal-header">
                <h3>Force Out User</h3>
                <button class="simple-modal-close" onclick="closeForceOutModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <div class="forceout-user-info">
                    <div class="warning-icon">
                        <i class="fas fa-exclamation-triangle"></i>
                    </div>
                    <div class="forceout-details">
                        <p>You are about to force out:</p>
                        <div class="target-user" id="forceout-target-user"></div>
                    </div>
                </div>
                <div class="admin-selection-section">
                    <label for="admin-select">Select Admin/Manager:</label>
                    <select id="admin-select" class="admin-dropdown">
                        <option value="">Choose admin/manager...</option>
                    </select>
                </div>
                <div class="admin-password-section">
                    <label for="admin-password">Admin Password:</label>
                    <input type="password" id="admin-password" class="password-field" placeholder="Enter admin password">
                </div>
                <div class="forceout-actions">
                    <button onclick="closeForceOutModal()" class="cancel-btn">Cancel</button>
                    <button onclick="executeForceOut()" class="forceout-btn">Force Out</button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Force Out Modal - updated to only confirm role and password for the user you clicked -->
    <div id="forceout-modal" class="forceout-modal">
        <div class="forceout-content">
            <button class="forceout-close" id="forceout-close">&times;</button>
            <h3>Force Out User</h3>
            <p>Are you sure you want to force out <span id="forceout-user-display" style="color:#f44336;font-weight:600;"></span>?</p>
            <div class="forceout-user-dropdown">
                <label for="forceout-admin-select">Select Manager/Admin to Authorize:</label>
                <select id="forceout-admin-select" class="forceout-user-select"></select>
            </div>
            <p>Enter password to confirm:</p>
            <input type="password" id="forceout-password" class="forceout-password-field" placeholder="Manager/Admin password">
            <p id="forceout-error" class="forceout-error">Invalid password. Please try again.</p>
            <div class="forceout-buttons">
                <button class="forceout-cancel" id="forceout-cancel-btn">Cancel</button>
                <button class="forceout-confirm" id="forceout-confirm-btn">Force Out</button>
            </div>
        </div>
    </div>

    <!-- Gift Card Add Modal -->
    <div id="gift-card-add-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content" style="width: 500px;">
            <div class="simple-modal-header">
                <h3 style="color: var(--main-color);">
                    <i class="fas fa-gift"></i>
                    Create New Gift Card
                </h3>
                <button class="simple-modal-close" onclick="closeAddGiftCardModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <form id="gift-card-form">
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                            <i class="fas fa-barcode"></i> Gift Card Code
                        </label>
                        <input type="text" id="gift-card-code" placeholder="Enter gift card code" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;" required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                            <i class="fas fa-receipt"></i> Invoice Number
                        </label>
                        <input type="text" id="gift-card-invoice" placeholder="Enter invoice number" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;" required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                            <i class="fas fa-box"></i> Product
                        </label>
                        <select id="gift-card-product" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;" required>
                            <option value="">Select product</option>
                            <option value="MonuMe">MonuMe</option>
                            <option value="FameMe">FameMe</option>
                            <option value="CrystalMe">CrystalMe</option>
                        </select>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                            <i class="fas fa-envelope"></i> Recipient Email
                        </label>
                        <input type="email" id="gift-card-email" placeholder="Enter recipient email" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;" required>
                    </div>
                    
                    <div class="form-group" style="margin-bottom: 20px;">
                        <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                            <i class="fas fa-dollar-sign"></i> Amount (Optional)
                        </label>
                        <input type="number" id="gift-card-amount" placeholder="Enter amount" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;" step="0.01" min="0">
                    </div>
                    
                    <div style="display: flex; gap: 12px; justify-content: flex-end; margin-top: 30px;">
                        <button type="button" onclick="closeAddGiftCardModal()" style="padding: 12px 20px; border: none; border-radius: 8px; background: var(--main-color); color: white; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3); transition: all 0.3s ease;" onmouseover="this.style.background='var(--gradient-start)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(255, 149, 98, 0.4)';" onmouseout="this.style.background='var(--main-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 149, 98, 0.3)';">
                            <i class="fas fa-times"></i> Cancel
                        </button>
                        <button type="submit" style="padding: 12px 20px; border: none; border-radius: 8px; background: var(--main-color); color: white; font-weight: 600; cursor: pointer; box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3); transition: all 0.3s ease;" onmouseover="this.style.background='var(--gradient-start)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(255, 149, 98, 0.4)';" onmouseout="this.style.background='var(--main-color)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 149, 98, 0.3)';">
                            <i class="fas fa-magic"></i> Generate Gift Card
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Gift Card View Modal -->
    <div id="gift-cards-view-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content" style="width: 800px; max-width: 95vw;">
            <div class="simple-modal-header">
                <h3 style="color: var(--main-color);">
                    <i class="fas fa-list"></i>
                    Gift Cards Management
                </h3>
                <button class="simple-modal-close" onclick="closeViewGiftCardsModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <div id="gift-cards-list" style="max-height: 500px; overflow-y: auto;">
                    <!-- Gift cards will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Gift Card Details Modal -->
    <div id="gift-card-details-modal" class="simple-modal" style="display: none;">
        <div class="simple-modal-content" style="width: 600px;">
            <div class="simple-modal-header">
                <h3 style="color: var(--main-color);">
                    <i class="fas fa-info-circle"></i>
                    Gift Card Details
                </h3>
                <button class="simple-modal-close" onclick="closeGiftCardDetailsModal()">&times;</button>
            </div>
            <div class="simple-modal-body">
                <div id="gift-card-details-content">
                    <!-- Details will be populated here -->
                </div>
            </div>
        </div>
    </div>

    <!-- Event Popup Modal -->
    <div id="eventPopup" class="event-modal-nice">
  <div class="event-modal-nice-content">
    <button class="event-modal-nice-close" id="closeEventPopup" title="Close">&times;</button>
    <div class="event-modal-nice-header">
      <span class="event-modal-nice-icon"><i class="fas fa-calendar-plus"></i></span>
      <h2>Add New Event</h2>
      <p class="event-modal-nice-tagline">Plan ahead and keep your team in sync</p>
    </div>
    <div class="event-modal-nice-body">
      <label for="eventTitle">Event Title</label>
      <div class="event-modal-nice-input-wrap">
        <i class="fas fa-heading event-modal-nice-input-icon"></i>
        <input type="text" id="eventTitle" class="event-modal-nice-input" placeholder="Enter event title">
      </div>
      <label for="eventDate">Event Date</label>
      <div class="event-modal-nice-input-wrap">
        <i class="fas fa-calendar event-modal-nice-input-icon"></i>
        <input type="date" id="eventDate" class="event-modal-nice-input">
      </div>
    </div>
    <div class="event-modal-nice-footer">
      <button class="event-modal-nice-btn cancel" id="cancelEvent">Cancel</button>
      <button class="event-modal-nice-btn save" id="saveEvent">Save Event</button>
    </div>
  </div>
</div>
<div id="eventOverlay" class="event-modal-nice-overlay" style="display:none;"></div>

    <!-- Appointment Form Modal - Exact copy from appointment.html -->
    <div class="modal-overlay" id="appointment-modal" style="display: none;">
        <div class="modal-container">
            <div class="modal-header">
                <div>
                    <h2 class="modal-title">Schedule New Appointment</h2>
                    <p class="modal-subtitle">Fill out the details below to create a new appointment</p>
                </div>
                <button class="modal-close" id="close-modal">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="appointment-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-user" style="color: var(--primary-color);"></i>
                                Client Name
                            </label>
                            <input type="text" class="form-input" id="client-name" placeholder="Enter client name" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-envelope" style="color: var(--primary-color);"></i>
                                Client Email
                            </label>
                            <input type="email" class="form-input" id="client-email" placeholder="Enter client email" required>
                        </div>
                        <div class="form-group" style="grid-column: span 2;">
                            <label class="form-label">
                                <i class="fas fa-phone" style="color: var(--primary-color);"></i>
                                Client Phone
                            </label>
                            <input type="tel" class="form-input" id="client-phone" placeholder="Enter client phone number (e.g., +1 (555) 123-4567)" required>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-calendar" style="color: var(--primary-color);"></i>
                                Date
                            </label>
                            <input type="date" class="form-input" id="appointment-date" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-clock" style="color: var(--primary-color);"></i>
                                Time
                            </label>
                            <div class="time-selection-grid">
                                <select class="form-select time-select" id="appointment-hour" required>
                                    <option value="">Hour</option>
                                    <option value="1">1</option>
                                    <option value="2">2</option>
                                    <option value="3">3</option>
                                    <option value="4">4</option>
                                    <option value="5">5</option>
                                    <option value="6">6</option>
                                    <option value="7">7</option>
                                    <option value="8">8</option>
                                    <option value="9">9</option>
                                    <option value="10">10</option>
                                    <option value="11">11</option>
                                    <option value="12">12</option>
                                </select>
                                <select class="form-select time-select" id="appointment-minute" required>
                                    <option value="">Min</option>
                                    <option value="00">00</option>
                                    <option value="15">15</option>
                                    <option value="30">30</option>
                                    <option value="45">45</option>
                                </select>
                                <select class="form-select time-select" id="appointment-ampm" required>
                                    <option value="">AM/PM</option>
                                    <option value="AM">AM</option>
                                    <option value="PM">PM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <div class="form-grid">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-tag" style="color: var(--primary-color);"></i>
                                Appointment Type
                            </label>
                            <select class="form-select" id="appointment-type" required>
                                <option value="">Select appointment type</option>
                                <option value="MonuMe">MonuMe</option>
                                <option value="FameMe">FameMe</option>
                                <option value="CrystalMe">CrystalMe</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-user-tie" style="color: var(--primary-color);"></i>
                                Appointment Host
                            </label>
                            <select class="form-select" id="appointment-host">
                                <option value="">Select host</option>
                                <!-- Hosts will be loaded dynamically -->
                            </select>
                        </div>
                    </div>

                    <div class="form-group">
                        <label class="form-label">
                            <i class="fas fa-sticky-note" style="color: var(--primary-color);"></i>
                            Notes
                        </label>
                        <textarea class="form-textarea" id="appointment-notes" placeholder="Additional information about this appointment"></textarea>
                    </div>

                    <div class="form-actions">
                        <button type="button" class="btn btn-secondary" id="cancel-form-btn">
                            Cancel
                        </button>
                        <button type="submit" class="btn btn-primary">
                            <i class="fas fa-save"></i>
                            Schedule Appointment
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Completion Verification Modal -->
    <div class="completion-modal" id="completion-modal">
        <div class="completion-modal-content">
            <div class="completion-modal-header">
                <h3>Complete Appointment</h3>
                <p>Verify your identity to mark this appointment as completed</p>
            </div>
            <div class="completion-modal-body">
                <div class="completion-form-group">
                    <label class="completion-form-label">Select User</label>
                    <select class="completion-form-select" id="completion-username">
                        <option value="">Choose your username</option>
                        <option value="admin">Admin User</option>
                        <option value="manager">Manager User</option>
                        <option value="staff1">Staff Member 1</option>
                        <option value="staff2">Staff Member 2</option>
                    </select>
                </div>
                <div class="completion-form-group">
                    <label class="completion-form-label">Password</label>
                    <input type="password" class="completion-form-input" id="completion-password" placeholder="Enter your password">
                </div>
            </div>
            <div class="completion-modal-actions">
                <button class="completion-btn completion-btn-cancel" onclick="closeCompletionModal()">Cancel</button>
                <button class="completion-btn completion-btn-confirm" id="confirm-completion-btn" onclick="confirmCompletion()">
                    <i class="fas fa-check"></i>
                    Mark Completed
                </button>
            </div>
        </div>
    </div>

    <!-- Team Modal for User Selection -->
    <div id="team-modal" class="team-modal">
        <div class="team-modal-content">
            <div class="team-modal-header">
                <h3>Select User to Start Session</h3>
                <p>Choose a team member to activate</p>
                <button class="team-modal-close">&times;</button>
            </div>
            <div class="team-modal-body">
                <!-- User Grid -->
                <div id="teamUserGrid" class="team-user-grid">
                    <!-- User items will be populated here -->
                </div>
                
                <!-- No Users Available Message -->
                <div id="teamNoUsersMessage" class="no-users-message" style="display: none;">
                    <div class="no-users-icon">
                        <i class="fas fa-users-slash"></i>
                    </div>
                    <h4>All Users Active</h4>
                    <p>All team members are currently active. No additional users available to start.</p>
                </div>
            </div>
            <div class="team-modal-buttons">
                <button id="cancelTeamModalBtn" class="team-modal-button cancel">Cancel</button>
            </div>
        </div>
    </div>

    <script>
        // **OPTIMIZED: Fast sidebar loading with error handling**
        fetch('sidebar.html')
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.text();
            })
            .then(data => {
                const sidebarContainer = document.getElementById('sidebar-container');
                if (sidebarContainer) {
                    sidebarContainer.innerHTML = data;
                    console.log('✅ Sidebar loaded successfully');
                } else {
                    console.error('❌ Sidebar container not found');
                }
                
                // After loading sidebar, highlight active page
                setTimeout(() => {
                    const currentPage = window.location.pathname.split('/').pop();
                                // If it's the root, consider it as dashboard
            const activePage = currentPage === '' || currentPage === 'index.html' ? 'dashboard' : currentPage;
                    
                    // Find the corresponding link and make it active
                    const menuItems = document.querySelectorAll('.sidebar-menu li');
                    menuItems.forEach(item => {
                        const link = item.querySelector('a');
                        // Check both href and data-page attributes to find the active link
                        if (link && (link.getAttribute('href') === activePage || link.getAttribute('data-page') === activePage)) {
                            item.classList.add('active');
                        } else {
                            item.classList.remove('active');
                        }
                    });

                    // Update morning_notes.html links to team_chat.html
                    const morningNotesLinks = document.querySelectorAll('a[href="morning_notes.html"]');
                    morningNotesLinks.forEach(link => {
                        link.setAttribute('href', 'team_chat.html');
                    });
                    
                    // Set up smart links event handlers - FIX FOR SIDEBAR NAVIGATION
                    document.querySelectorAll('.smart-link').forEach(link => {
                        link.addEventListener('click', function(e) {
                            e.preventDefault();
                            const page = this.getAttribute('data-page');
                            if (page) {
                                // Handle both domain root and /static/ directory paths
                                const currentPath = window.location.pathname;
                                if (currentPath.includes('/static/')) {
                                    // If we're in the static directory
                                    window.location.href = page;
                                } else {
                                    // If we're at the root or elsewhere
                                    window.location.href = "/static/" + page;
                                }
                            }
                        });
                    });
                }, 100);
            })
            .catch(error => {
                console.error('❌ Error loading sidebar:', error);
                // Fallback: Show a basic sidebar structure
                const sidebarContainer = document.getElementById('sidebar-container');
                if (sidebarContainer) {
                    sidebarContainer.innerHTML = `
                        <div class="sidebar">
                            <div class="sidebar-header">
                                <h2 style="color: var(--main-color); text-align: center;">MonuMe</h2>
                            </div>
                            <div style="padding: 20px; color: white; text-align: center;">
                                <p>Sidebar loading failed</p>
                                <button onclick="location.reload()" style="background: var(--main-color); color: white; border: none; padding: 10px 20px; border-radius: 8px; cursor: pointer; margin-top: 10px;">
                                    Refresh Page
                                </button>
                            </div>
                        </div>
                    `;
                }
            });

        // Mobile menu functionality
        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobile-menu-btn');
            const sidebar = document.querySelector('.sidebar');
            
            if (mobileMenuBtn && sidebar) {
                mobileMenuBtn.addEventListener('click', function() {
                    sidebar.classList.toggle('mobile-open');
                    
                    // Update icon
                    const icon = this.querySelector('i');
                    if (sidebar.classList.contains('mobile-open')) {
                        icon.className = 'fas fa-times';
                    } else {
                        icon.className = 'fas fa-bars';
                    }
                });
                
                // Close sidebar when clicking outside on mobile
                document.addEventListener('click', function(e) {
                    if (window.innerWidth <= 576 && !sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                        sidebar.classList.remove('mobile-open');
                        mobileMenuBtn.querySelector('i').className = 'fas fa-bars';
                    }
                });
            }
        }

        // **ENHANCED: Team chat preview with notifications**
        function loadTeamChatPreview() {
            const chatContainer = document.getElementById('chatMessages');
            
            // Load chat notifications
            updateChatNotifications();
            
            // Reduced timeout for faster loading (200ms instead of 800ms)
            setTimeout(() => {
                // Use the EXACT same localStorage key as team_chat.html
                const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
                
                chatContainer.innerHTML = '';
                
                if (messages.length === 0) {
                    // Show welcome message if no real messages exist
                    chatContainer.innerHTML = `
                        <div class="chat-preview-empty">
                            <div class="empty-chat-icon">
                                <i class="fas fa-comments"></i>
                            </div>
                            <p>No messages yet</p>
                            <span>Click to start chatting</span>
                        </div>
                    `;
                } else {
                    // Show last 2-3 messages for preview
                    const recentMessages = messages.slice(-2);
                    recentMessages.forEach(message => {
                        const messageEl = document.createElement('div');
                        const currentUser = localStorage.getItem('currentUser') || 'You';
                        
                        // Handle both old format (user) and new format (sender)
                        const senderName = message.sender || message.user || 'Unknown';
                        const isSent = senderName === currentUser;
                        
                        messageEl.className = `chat-preview-message ${isSent ? 'sent' : 'received'}`;
                        
                        // Get sender initials for avatar
                        const initials = senderName.split(' ').map(n => n[0]).join('').toUpperCase().substring(0, 2);
                        
                        // Professional time formatting
                        const timeFormatted = formatChatTimePreview(message.timestamp);
                        
                        messageEl.innerHTML = `
                            ${!isSent ? `
                            <div class="preview-avatar">
                                ${initials}
                            </div>
                            ` : ''}
                            <div class="preview-message-content ${!message.read ? 'unread-message' : ''}">
                                <div class="preview-message-header">
                                    <span class="preview-sender">${isSent ? 'You' : senderName}</span>
                                    <span class="preview-time">${timeFormatted}</span>
                                    ${!message.read ? '<span class="new-message-badge">NEW</span>' : ''}
                                </div>
                                <div class="preview-message-text">${escapeHtml(message.message)}</div>
                            </div>
                        `;
                        
                        chatContainer.appendChild(messageEl);
                    });
                }
                
                // Scroll to bottom
                chatContainer.scrollTop = chatContainer.scrollHeight;
            }, 200); // Reduced from 800ms for faster loading
        }

        // **NEW: Chat notification management**
        function updateChatNotifications() {
            const notifications = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
            const unreadNotifications = notifications.filter(n => !n.read);
            
            // Update team chat header with notification badge
            const chatHeader = document.querySelector('.card-title-group h3');
            if (chatHeader && chatHeader.textContent.includes('Team Chat')) {
                const existingBadge = chatHeader.querySelector('.notification-badge');
                if (existingBadge) {
                    existingBadge.remove();
                }
                
                if (unreadNotifications.length > 0) {
                    const badge = document.createElement('span');
                    badge.className = 'notification-badge';
                    badge.textContent = unreadNotifications.length;
                    badge.style.cssText = `
                        background: linear-gradient(135deg, #ff6b35, #f7931e);
                        color: white;
                        font-size: 0.7rem;
                        padding: 3px 7px;
                        border-radius: 10px;
                        margin-left: 8px;
                        font-weight: 600;
                        animation: pulse 2s infinite;
                        box-shadow: 0 2px 6px rgba(255, 107, 53, 0.4);
                    `;
                    chatHeader.appendChild(badge);
                }
            }
            
            // Show persistent notification banner if there are unread messages
            showChatNotificationBanner(unreadNotifications);
        }

        // **NEW: Show notification banner for unread messages**
        function showChatNotificationBanner(unreadNotifications) {
            const existingBanner = document.getElementById('chat-notification-banner');
            if (existingBanner) {
                existingBanner.remove();
            }
            
            if (unreadNotifications.length === 0) return;
            
            const banner = document.createElement('div');
            banner.id = 'chat-notification-banner';
            banner.style.cssText = `
                position: fixed;
                top: 80px;
                right: 20px;
                background: linear-gradient(135deg, #ff6b35, #f7931e);
                color: white;
                padding: 12px 20px;
                border-radius: 12px;
                box-shadow: 0 8px 25px rgba(255, 107, 53, 0.3);
                z-index: 1000;
                max-width: 350px;
                animation: slideInFromRight 0.4s ease;
                cursor: pointer;
                border: 1px solid rgba(255, 255, 255, 0.2);
            `;
            
            const latestMessage = unreadNotifications[unreadNotifications.length - 1];
            banner.innerHTML = `
                <div style="display: flex; align-items: center; gap: 10px;">
                    <div style="flex: 1;">
                        <div style="font-weight: 600; margin-bottom: 4px;">
                            ${unreadNotifications.length} New Message${unreadNotifications.length > 1 ? 's' : ''}
                        </div>
                        <div style="font-size: 0.85rem; opacity: 0.9;">
                            ${latestMessage.sender}: ${latestMessage.message.substring(0, 40)}${latestMessage.message.length > 40 ? '...' : ''}
                        </div>
                        <div style="font-size: 0.7rem; opacity: 0.8; margin-top: 4px;">
                            Click to view • Mark as read
                        </div>
                    </div>
                    <button id="banner-mark-read-btn" style="
                        background: rgba(255, 255, 255, 0.2);
                        border: none;
                        color: white;
                        padding: 8px 16px;
                        border-radius: 10px;
                        font-size: 0.75rem;
                        cursor: pointer;
                        font-weight: 600;
                        transition: all 0.2s ease;
                        display: flex;
                        align-items: center;
                        gap: 6px;
                        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
                    " onmouseover="this.style.background='rgba(255,255,255,0.3)'; this.style.transform='translateY(-2px)'; this.style.boxShadow='0 4px 12px rgba(0,0,0,0.2)';" onmouseout="this.style.background='rgba(255,255,255,0.2)'; this.style.transform='translateY(0)'; this.style.boxShadow='0 2px 8px rgba(0,0,0,0.15)';">
                        <i class="fas fa-check-double"></i>
                        Mark Read
                    </button>
                </div>
            `;
            
            // Click to go to team chat
            banner.addEventListener('click', function(e) {
                if (!e.target.closest('button')) {
                    window.location.href = 'team_chat.html';
                }
            });
            
            document.body.appendChild(banner);
            
            // **CRITICAL: Add event listener for mark read button**
            const markReadBtn = banner.querySelector('#banner-mark-read-btn');
            if (markReadBtn) {
                markReadBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🔔 Banner mark read button clicked!');
                    markAllMessagesAsRead();
                });
                console.log('✅ Banner mark read button event listener attached');
            }
        }

        // **ENHANCED: Mark all messages as read with verification modal**
        function markAllMessagesAsRead() {
            console.log('🔔 Opening mark all as read modal...');
            
            // Remove any existing modal first
            const existingModal = document.getElementById('mark-read-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal with proper ID and enhanced functionality
            const modal = document.createElement('div');
            modal.id = 'mark-read-modal';
            modal.className = 'modal-overlay active';
            modal.style.cssText = `
                display: flex !important;
                position: fixed;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: rgba(0, 0, 0, 0.6);
                backdrop-filter: blur(8px);
                z-index: 10000;
                align-items: center;
                justify-content: center;
                opacity: 1;
                visibility: visible;
                animation: fadeIn 0.3s ease;
            `;
            
            modal.innerHTML = `
                <div class="modal-container" style="max-width: 450px; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2);">
                    <div class="modal-header" style="padding: 32px 32px 16px; border-bottom: 1px solid #e5e7eb;">
                        <div>
                            <h2 class="modal-title" style="color: var(--main-color); font-size: 24px; font-weight: 700; margin: 0 0 8px 0;">
                                <i class="fas fa-check-double" style="margin-right: 12px; color: #10b981;"></i>
                                Mark All Messages as Read
                            </h2>
                            <p class="modal-subtitle" style="color: #666; margin: 0; font-size: 14px;">Verify your identity to mark all messages as read</p>
                        </div>
                        <button class="modal-close" id="mark-read-close-btn" style="
                            position: absolute;
                            top: 20px;
                            right: 20px;
                            width: 36px;
                            height: 36px;
                            border-radius: 50%;
                            background: #f3f4f6;
                            border: none;
                            cursor: pointer;
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            color: #666;
                            font-size: 18px;
                            transition: all 0.2s ease;
                        " onmouseover="this.style.background='#e5e7eb'; this.style.color='#374151';" onmouseout="this.style.background='#f3f4f6'; this.style.color='#666';">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="modal-body" style="padding: 24px 32px;">
                        <div class="form-group" style="margin-bottom: 20px;">
                            <label class="form-label" style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px; font-size: 14px;">
                                <i class="fas fa-user" style="margin-right: 8px;"></i>
                                Select User
                            </label>
                            <select class="form-select" id="readAllUser" style="
                                width: 100%;
                                padding: 12px 16px;
                                border: 2px solid #e5e7eb;
                                border-radius: 12px;
                                font-size: 16px;
                                background: white;
                                transition: all 0.3s ease;
                            " onfocus="this.style.borderColor='var(--main-color)'; this.style.boxShadow='0 0 0 3px rgba(255,149,98,0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                                <option value="">Choose your username</option>
                            </select>
                        </div>
                        <div class="form-group" style="margin-bottom: 24px;">
                            <label class="form-label" style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px; font-size: 14px;">
                                <i class="fas fa-lock" style="margin-right: 8px;"></i>
                                Password
                            </label>
                            <input type="password" class="form-input" id="readAllPassword" placeholder="Enter your password" style="
                                width: 100%;
                                padding: 12px 16px;
                                border: 2px solid #e5e7eb;
                                border-radius: 12px;
                                font-size: 16px;
                                transition: all 0.3s ease;
                                box-sizing: border-box;
                            " onfocus="this.style.borderColor='var(--main-color)'; this.style.boxShadow='0 0 0 3px rgba(255,149,98,0.1)';" onblur="this.style.borderColor='#e5e7eb'; this.style.boxShadow='none';">
                        </div>
                        <div class="form-actions" style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button class="btn btn-secondary" id="mark-read-cancel-btn" style="
                                padding: 12px 24px;
                                border: none;
                                border-radius: 10px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                background: #f3f4f6;
                                color: #374151;
                                font-size: 14px;
                            " onmouseover="this.style.background='#e5e7eb'; this.style.transform='translateY(-2px)';" onmouseout="this.style.background='#f3f4f6'; this.style.transform='translateY(0)';">
                                <i class="fas fa-times" style="margin-right: 8px;"></i>
                                Cancel
                            </button>
                            <button class="btn btn-primary" id="mark-read-confirm-btn" style="
                                padding: 12px 24px;
                                border: none;
                                border-radius: 10px;
                                font-weight: 600;
                                cursor: pointer;
                                transition: all 0.3s ease;
                                background: linear-gradient(135deg, #10b981, #059669);
                                color: white;
                                font-size: 14px;
                                box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                            " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)';" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)';">
                                <i class="fas fa-check-double" style="margin-right: 8px;"></i>
                                Mark All as Read
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            console.log('✅ Modal created and added to DOM');
            
            // **ENHANCED: Set up event listeners with proper cleanup**
            const closeBtn = modal.querySelector('#mark-read-close-btn');
            const cancelBtn = modal.querySelector('#mark-read-cancel-btn');
            const confirmBtn = modal.querySelector('#mark-read-confirm-btn');
            const userSelect = modal.querySelector('#readAllUser');
            const passwordInput = modal.querySelector('#readAllPassword');
            
            // Close modal function
            function closeMarkReadModal() {
                console.log('🚫 Closing mark read modal...');
                modal.style.opacity = '0';
                modal.style.visibility = 'hidden';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                        console.log('✅ Modal removed from DOM');
                    }
                }, 300);
                document.body.style.overflow = ''; // Restore scrolling
            }
            
            // **CRITICAL: Attach close event listeners**
            if (closeBtn) {
                closeBtn.addEventListener('click', closeMarkReadModal);
                console.log('✅ Close button listener attached');
            }
            
            if (cancelBtn) {
                cancelBtn.addEventListener('click', closeMarkReadModal);
                console.log('✅ Cancel button listener attached');
            }
            
            // Confirm button listener
            if (confirmBtn) {
                confirmBtn.addEventListener('click', confirmMarkAllAsRead);
                console.log('✅ Confirm button listener attached');
            }
            
            // Click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeMarkReadModal();
                }
            });
            
            // ESC key to close
            const escapeListener = function(e) {
                if (e.key === 'Escape') {
                    closeMarkReadModal();
                    document.removeEventListener('keydown', escapeListener);
                }
            };
            document.addEventListener('keydown', escapeListener);
            
            // Prevent body scrolling
            document.body.style.overflow = 'hidden';
            
            // **ENHANCED: Populate users from localStorage**
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                if (users.length === 0) {
                    // Add default users if none exist
                    const defaultUsers = [
                        { username: 'admin', password: 'admin123', role: 'admin' },
                        { username: 'manager', password: 'manager123', role: 'manager' },
                        { username: 'staff1', password: 'staff123', role: 'staff' },
                        { username: 'staff2', password: 'staff123', role: 'staff' }
                    ];
                    users.push(...defaultUsers);
                    localStorage.setItem('users', JSON.stringify(users));
                }
                
                users.forEach(user => {
                    const option = document.createElement('option');
                    option.value = user.username;
                    option.textContent = user.username;
                    userSelect.appendChild(option);
                });
                console.log('✅ Users populated in dropdown:', users.length);
            } catch (error) {
                console.error('❌ Error loading users:', error);
            }
            
            // Focus password field when user is selected
            userSelect.addEventListener('change', function() {
                if (this.value && passwordInput) {
                    passwordInput.focus();
                }
            });
            
            // Enter key to submit when password field is focused
            passwordInput.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && userSelect.value && this.value) {
                    confirmMarkAllAsRead();
                }
            });
            
            // Focus first field after modal is fully visible
            setTimeout(() => {
                userSelect.focus();
            }, 100);
            
            console.log('🎉 Mark read modal setup complete!');
        }

        // **ENHANCED: Confirm mark all as read with proper modal handling**
        function confirmMarkAllAsRead() {
            console.log('✅ Confirming mark all as read...');
            
            const modal = document.getElementById('mark-read-modal');
            if (!modal) {
                console.error('❌ Modal not found');
                return;
            }
            
            const username = modal.querySelector('#readAllUser')?.value;
            const password = modal.querySelector('#readAllPassword')?.value;
            const confirmBtn = modal.querySelector('#mark-read-confirm-btn');
            
            if (!username || !password) {
                showModalError('Please select a user and enter password');
                return;
            }
            
            // Disable button and show loading
            if (confirmBtn) {
                confirmBtn.disabled = true;
                confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 8px;"></i>Processing...';
                confirmBtn.style.opacity = '0.7';
            }
            
            // Validate credentials
            try {
                const users = JSON.parse(localStorage.getItem('users') || '[]');
                const user = users.find(u => u.username === username);
                
                if (!user || user.password !== password) {
                    showModalError('Invalid username or password');
                    // Reset button
                    if (confirmBtn) {
                        confirmBtn.disabled = false;
                        confirmBtn.innerHTML = '<i class="fas fa-check-double" style="margin-right: 8px;"></i>Mark All as Read';
                        confirmBtn.style.opacity = '1';
                    }
                    return;
                }
                
                // Mark all messages and notifications as read
                const messages = JSON.parse(localStorage.getItem('chatMessages') || '[]');
                const notifications = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
                const now = new Date().toISOString();
                
                let markedCount = 0;
                
                messages.forEach(msg => {
                    if (!msg.read) {
                        msg.read = true;
                        msg.readBy = msg.readBy || [];
                        if (!msg.readBy.includes(username)) {
                            msg.readBy.push(username);
                        }
                        msg.readAt = now;
                        markedCount++;
                    }
                });
                
                notifications.forEach(notif => {
                    if (!notif.read) {
                        notif.read = true;
                        notif.readBy = username;
                        notif.readAt = now;
                    }
                });
                
                localStorage.setItem('chatMessages', JSON.stringify(messages));
                localStorage.setItem('chatNotifications', JSON.stringify(notifications));
                
                console.log(`✅ Marked ${markedCount} messages as read by ${user.username}`);
                
                // Update UI immediately
                updateChatNotifications();
                loadTeamChatPreview();
                
                // Remove notification banner
                const notificationBanner = document.getElementById('chat-notification-banner');
                if (notificationBanner) {
                    notificationBanner.remove();
                }
                
                // Show success state in button briefly
                if (confirmBtn) {
                    confirmBtn.innerHTML = '<i class="fas fa-check" style="margin-right: 8px;"></i>Success!';
                    confirmBtn.style.background = '#10b981';
                }
                
                // Close modal after short delay
                setTimeout(() => {
                    closeMarkReadModalDirectly();
                    
                    // Show success notification
                    showDashboardNotification(
                        `✅ All messages marked as read by ${user.username}${markedCount > 0 ? ` (${markedCount} messages)` : ''}`, 
                        'success'
                    );
                    
                }, 800);
                
            } catch (error) {
                console.error('❌ Error marking messages as read:', error);
                showModalError('Error processing request. Please try again.');
                
                // Reset button
                if (confirmBtn) {
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check-double" style="margin-right: 8px;"></i>Mark All as Read';
                    confirmBtn.style.opacity = '1';
                }
            }
        }
        
        // **NEW: Helper function to show modal errors**
        function showModalError(message) {
            // Remove existing error if any
            const existingError = document.querySelector('#mark-read-error');
            if (existingError) {
                existingError.remove();
            }
            
            const modal = document.getElementById('mark-read-modal');
            const modalBody = modal?.querySelector('.modal-body');
            if (!modalBody) return;
            
            const errorDiv = document.createElement('div');
            errorDiv.id = 'mark-read-error';
            errorDiv.style.cssText = `
                background: rgba(239, 68, 68, 0.1);
                border: 1px solid rgba(239, 68, 68, 0.3);
                color: #dc2626;
                padding: 12px 16px;
                border-radius: 8px;
                margin-top: 16px;
                font-size: 14px;
                display: flex;
                align-items: center;
                gap: 8px;
                animation: shake 0.5s ease-in-out;
            `;
            errorDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle"></i>
                ${message}
            `;
            
            modalBody.appendChild(errorDiv);
            
            // Remove error after 4 seconds
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.remove();
                }
            }, 4000);
        }
        
        // **NEW: Direct close function for modal**
        function closeMarkReadModalDirectly() {
            const modal = document.getElementById('mark-read-modal');
            if (modal) {
                modal.style.opacity = '0';
                modal.style.visibility = 'hidden';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                        console.log('✅ Mark read modal closed and removed');
                    }
                }, 300);
                document.body.style.overflow = ''; // Restore scrolling
            }
        }

        // **NEW: Professional time formatting for chat preview**
        function formatChatTimePreview(timestamp) {
            const date = new Date(timestamp);
            const now = new Date();
            const diffInMinutes = Math.floor((now - date) / (1000 * 60));
            const diffInHours = Math.floor(diffInMinutes / 60);
            
            if (diffInMinutes < 1) {
                return 'now';
            } else if (diffInMinutes < 60) {
                return `${diffInMinutes}m`;
            } else if (diffInHours < 24) {
                return `${diffInHours}h`;
            } else {
                return date.toLocaleDateString('en-US', {
                    month: 'short',
                    day: 'numeric'
                });
            }
        }

        // **NEW: Test functions for mark read functionality**
        window.testMarkReadModal = function() {
            console.log('🧪 === TESTING MARK READ MODAL FUNCTIONALITY ===');
            
            // First, create some test notifications if none exist
            const notifications = JSON.parse(localStorage.getItem('chatNotifications') || '[]');
            if (notifications.length === 0) {
                console.log('📝 Creating test notifications...');
                const testNotifications = [
                    {
                        id: 'test-notif-1',
                        message: 'Test notification message 1',
                        sender: 'TestUser1',
                        timestamp: new Date().toISOString(),
                        read: false
                    },
                    {
                        id: 'test-notif-2',
                        message: 'Test notification message 2',
                        sender: 'TestUser2',
                        timestamp: new Date().toISOString(),
                        read: false
                    }
                ];
                localStorage.setItem('chatNotifications', JSON.stringify(testNotifications));
                console.log('✅ Test notifications created');
            }
            
            // Update the dashboard to show notifications
            updateChatNotifications();
            
            // Test opening the modal directly
            setTimeout(() => {
                console.log('🚀 Opening mark read modal...');
                markAllMessagesAsRead();
            }, 1000);
            
            console.log('✅ Test complete! Check if:');
            console.log('   1. Notification banner appears');
            console.log('   2. Mark Read button opens modal');
            console.log('   3. Cancel button closes modal');
            console.log('   4. Form validation works');
            console.log('💡 Use credentials: admin/admin123 or manager/manager123');
        };

        window.testCancelButton = function() {
            console.log('🧪 Testing cancel button functionality...');
            markAllMessagesAsRead();
            
            setTimeout(() => {
                const modal = document.getElementById('mark-read-modal');
                const cancelBtn = modal?.querySelector('#mark-read-cancel-btn');
                if (cancelBtn) {
                    console.log('✅ Modal found, testing cancel button...');
                    console.log('🖱️ Clicking cancel button in 2 seconds...');
                    setTimeout(() => {
                        cancelBtn.click();
                        console.log('✅ Cancel button clicked - modal should close');
                    }, 2000);
                } else {
                    console.error('❌ Modal or cancel button not found');
                }
            }, 500);
        };

        window.testMarkReadComplete = function() {
            console.log('🧪 Testing complete mark read flow...');
            
            // Create test data
            const testMessages = [
                {
                    id: 'test-msg-1',
                    message: 'Test message 1',
                    sender: 'TestUser1',
                    timestamp: new Date().toISOString(),
                    read: false
                },
                {
                    id: 'test-msg-2',
                    message: 'Test message 2',
                    sender: 'TestUser2',
                    timestamp: new Date().toISOString(),
                    read: false
                }
            ];
            
            localStorage.setItem('chatMessages', JSON.stringify(testMessages));
            localStorage.setItem('chatNotifications', JSON.stringify(testMessages));
            
            // Update UI
            updateChatNotifications();
            loadTeamChatPreview();
            
            console.log('✅ Test data created');
            console.log('💡 Now click the Mark Read button and use admin/admin123 to test');
            console.log('🎯 Expected: Modal opens, form works, messages marked as read');
        };

        // **NEW: Dashboard notification helper**
        function showDashboardNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                border-radius: 8px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
                z-index: 10000;
                animation: slideInFromRight 0.3s ease;
                max-width: 300px;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 4000);
        }

        // **FIXED: Update active users count with real data**
        function updateActiveUsersCountReal() {
            console.log('📊 Updating active users count with real data...');
            
            try {
                // Get active users from localStorage
                const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
                const currentTime = Date.now();
                
                // Get current user's location and role for filtering
                const currentUserRole = localStorage.getItem('role');
                const currentUserLocation = localStorage.getItem('monume_location') || localStorage.getItem('location');
                const isAdmin = currentUserRole === 'admin' || localStorage.getItem('monume_is_admin') === 'true';
                
                console.log('🔍 User context - Role:', currentUserRole, 'Location:', currentUserLocation, 'Is Admin:', isAdmin);
                
                // Filter users who are currently active (last activity within 5 minutes)
                let currentlyActiveUsers = activeUsers.filter(user => {
                    const timeSinceLastActivity = currentTime - user.lastActivity;
                    const fiveMinutesInMs = 5 * 60 * 1000; // 5 minutes
                    return timeSinceLastActivity < fiveMinutesInMs;
                });
                
                // Apply location-based filtering for non-admin users
                if (!isAdmin && currentUserLocation) {
                    // Get all users to match active users with their locations
                    const allUsers = JSON.parse(localStorage.getItem('monumeUsers') || '[]');
                    
                    currentlyActiveUsers = currentlyActiveUsers.filter(activeUser => {
                        // Find the user's location from the users database
                        const userRecord = allUsers.find(u => u.username === activeUser.username);
                        if (userRecord) {
                            const userLocationCode = userRecord.locationCode || userRecord.location;
                            const matchesLocation = userLocationCode === currentUserLocation;
                            console.log(`👤 Active user ${activeUser.username}: location=${userLocationCode}, matches=${matchesLocation}`);
                            return matchesLocation;
                        }
                        // If user record not found, exclude from count for safety
                        console.log(`⚠️ User record not found for active user: ${activeUser.username}`);
                        return false;
                    });
                    
                    console.log(`🎯 Location filtering: ${activeUsers.length} total → ${currentlyActiveUsers.length} for location ${currentUserLocation}`);
                } else {
                    console.log('👑 Admin user - showing all active users:', currentlyActiveUsers.length);
                }
                
                // **FIXED: Find the correct element**
                let activeUsersElement = document.getElementById('activeUsers');
                
                // If not found, try alternative selectors
                if (!activeUsersElement) {
                    console.log('⚠️ #activeUsers not found, trying alternative selectors...');
                    // Try to find the Team MonuMe card value element
                    const teamCard = document.getElementById('team-monume-card');
                    if (teamCard) {
                        activeUsersElement = teamCard.querySelector('.stat-card-value');
                        console.log('✅ Found Team MonuMe card value element');
                    }
                }
                
                if (activeUsersElement) {
                    const oldCount = activeUsersElement.textContent;
                    activeUsersElement.textContent = currentlyActiveUsers.length;
                    
                    // Add animation if count changed
                    if (oldCount !== currentlyActiveUsers.length.toString()) {
                        activeUsersElement.style.animation = 'none';
                        setTimeout(() => {
                            activeUsersElement.style.animation = 'pulse 0.5s ease-in-out';
                        }, 10);
                    }
                    
                    console.log(`✅ Active users count updated: ${oldCount} → ${currentlyActiveUsers.length}`);
                    
                    // Update description based on count
                    const teamCard = document.getElementById('team-monume-card');
                    const descriptionElement = teamCard?.querySelector('.stat-card-description');
                    if (descriptionElement) {
                        const count = currentlyActiveUsers.length;
                        if (count === 0) {
                            descriptionElement.textContent = 'No users currently active';
                        } else if (count === 1) {
                            descriptionElement.textContent = '1 user currently active';
                        } else {
                            descriptionElement.textContent = `${count} users currently active`;
                        }
                    }
                } else {
                    console.error('❌ Active users element not found even with alternative selectors');
                    console.log('🔍 Available elements with .stat-card-value:');
                    document.querySelectorAll('.stat-card-value').forEach((el, index) => {
                        console.log(`   ${index}: ${el.textContent} (ID: ${el.id || 'no-id'})`);
                    });
                }
                
                // Clean up old inactive users from localStorage
                if (currentlyActiveUsers.length !== activeUsers.length) {
                    localStorage.setItem('activeUsers', JSON.stringify(currentlyActiveUsers));
                    console.log(`🧹 Cleaned up ${activeUsers.length - currentlyActiveUsers.length} inactive users`);
                }
                
                return currentlyActiveUsers.length;
                
            } catch (error) {
                console.error('❌ Error updating active users count:', error);
                return 0;
            }
        }

        // **NEW: Add user to active users list**
        function addActiveUser(username, userId = null) {
            console.log(`➕ Adding active user: ${username}`);
            
            try {
                const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
                const currentTime = Date.now();
                
                // Check if user is already in the list
                const existingUserIndex = activeUsers.findIndex(user => user.username === username);
                
                if (existingUserIndex !== -1) {
                    // Update existing user's last activity
                    activeUsers[existingUserIndex].lastActivity = currentTime;
                    console.log(`🔄 Updated last activity for ${username}`);
                } else {
                    // Add new active user
                    activeUsers.push({
                        username: username,
                        userId: userId || username,
                        sessionStart: currentTime,
                        lastActivity: currentTime
                    });
                    console.log(`✅ Added new active user: ${username}`);
                }
                
                localStorage.setItem('activeUsers', JSON.stringify(activeUsers));
                updateActiveUsersCountReal();
                
            } catch (error) {
                console.error('❌ Error adding active user:', error);
            }
        }

        // **NEW: Remove user from active users list**
        function removeActiveUser(username) {
            console.log(`➖ Removing active user: ${username}`);
            
            try {
                const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
                const filteredUsers = activeUsers.filter(user => user.username !== username);
                
                localStorage.setItem('activeUsers', JSON.stringify(filteredUsers));
                updateActiveUsersCountReal();
                
                console.log(`✅ Removed active user: ${username}`);
                
            } catch (error) {
                console.error('❌ Error removing active user:', error);
            }
        }

        // **NEW: Update user activity (keep them active)**
        function updateUserActivity(username) {
            try {
                const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
                const userIndex = activeUsers.findIndex(user => user.username === username);
                
                if (userIndex !== -1) {
                    activeUsers[userIndex].lastActivity = Date.now();
                    localStorage.setItem('activeUsers', JSON.stringify(activeUsers));
                }
                
            } catch (error) {
                console.error('❌ Error updating user activity:', error);
            }
        }

        // **NEW: Listen for chat updates**
        window.addEventListener('storage', function(e) {
            if (e.key === 'chatMessages' || e.key === 'chatNotifications') {
                console.log('🔔 Chat update detected, refreshing preview...');
                loadTeamChatPreview();
            }
        });

        // **NEW: HTML escape function**
        function escapeHtml(unsafe) {
            return unsafe
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }

                // **SIMPLIFIED: Use EXACT same method as appointment.js**
        function loadWeeklyAppointments(forceRefresh = false) {
            const appointmentsContainer = document.getElementById('weeklyAppointments');
            console.log('⚡ Dashboard: Loading appointments using IDENTICAL method to appointment.js...');
            
            // **CRITICAL: Use IDENTICAL localStorage access as appointment.js**
            let allAppointments = [];
            
            try {
                const savedAppointments = localStorage.getItem('monumeAppointments');
                if (savedAppointments) {
                    allAppointments = JSON.parse(savedAppointments);
                    console.log('✅ Dashboard: Loaded appointments from localStorage:', allAppointments.length);
                } else {
                    console.log('ℹ️ Dashboard: No appointments found in localStorage');
                    allAppointments = [];
                }
            } catch (error) {
                console.error('❌ Error loading appointments:', error);
                allAppointments = [];
            }
                
            // Calculate date range for next 7 days
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            
            const startDate = new Date(today);
            const endDate = new Date(today);
            endDate.setDate(today.getDate() + 7);
            endDate.setHours(23, 59, 59, 999);
            
            console.log('📅 Date range:', startDate.toDateString(), 'to', endDate.toDateString());
            
            // **CRITICAL: Use EXACT same date parsing as appointment.js**
            const upcomingAppointments = allAppointments.filter(apt => {
                if (!apt.date) return false;
                
                // **IDENTICAL TO APPOINTMENT.JS: Parse date components manually**
                const [year, month, day] = apt.date.split('-').map(num => parseInt(num, 10));
                const aptDate = new Date(year, month - 1, day); // Month is 0-indexed
                aptDate.setHours(0, 0, 0, 0);
                
                const isUpcoming = aptDate >= startDate && aptDate <= endDate;
                
                if (isUpcoming) {
                    console.log(`✅ Upcoming: ${apt.clientName} on ${apt.date} at ${apt.time}`);
                }
                
                return isUpcoming;
            }).sort((a, b) => {
                // **IDENTICAL TO APPOINTMENT.JS: Same sorting method**
                const [yearA, monthA, dayA] = a.date.split('-').map(num => parseInt(num, 10));
                const [hoursA, minutesA] = a.time.split(':').map(num => parseInt(num, 10));
                const dateTimeA = new Date(yearA, monthA - 1, dayA, hoursA, minutesA);
                
                const [yearB, monthB, dayB] = b.date.split('-').map(num => parseInt(num, 10));
                const [hoursB, minutesB] = b.time.split(':').map(num => parseInt(num, 10));
                const dateTimeB = new Date(yearB, monthB - 1, dayB, hoursB, minutesB);
                
                return dateTimeA - dateTimeB;
            });
            
            console.log('📋 Upcoming appointments (next 7 days):', upcomingAppointments.length);
            
            // Show up to 6 appointments
            const displayAppointments = upcomingAppointments.slice(0, 6);
            const extraCount = Math.max(0, upcomingAppointments.length - 6);
            
            appointmentsContainer.innerHTML = '';
            
            if (displayAppointments.length === 0) {
                appointmentsContainer.innerHTML = `
                    <div class="no-appointments-week">
                        <div class="empty-appointments-icon">
                            <i class="fas fa-calendar-plus"></i>
                        </div>
                        <h4>No upcoming appointments</h4>
                        <p>No appointments scheduled for the next 7 days</p>
                    </div>
                `;
            } else {
                displayAppointments.forEach(appointment => {
                    // **IDENTICAL TO APPOINTMENT.JS: Same date parsing**
                    const [year, month, day] = appointment.date.split('-').map(num => parseInt(num, 10));
                    const aptDate = new Date(year, month - 1, day);
                    
                    const isToday = aptDate.toDateString() === today.toDateString();
                    const isTomorrow = aptDate.toDateString() === new Date(today.getTime() + 24 * 60 * 60 * 1000).toDateString();
                    
                    // Format time using same method as appointment.js
                    const timeFormatted = formatTime12Hour(appointment.time);
                    
                    const daysUntil = Math.ceil((aptDate - today) / (1000 * 60 * 60 * 24));
                    
                    const appointmentEl = document.createElement('div');
                    appointmentEl.className = `upcoming-appointment-item ${isToday ? 'today' : ''} ${appointment.status === 'completed' ? 'completed' : ''}`;
                    
                    appointmentEl.innerHTML = `
                        <div class="appointment-date-section">
                            <div class="appointment-date-main">
                                <div class="appointment-date-number">${aptDate.getDate()}</div>
                                <div class="appointment-date-month">${aptDate.toLocaleDateString('en', { month: 'short' }).toUpperCase()}</div>
                            </div>
                        </div>
                        <div class="appointment-info-section">
                            <div class="appointment-client-name">${appointment.clientName}</div>
                            <div class="appointment-type-time">
                                <span class="appointment-type">${appointment.type}</span>
                                <span class="appointment-time">${timeFormatted}</span>
                            </div>
                        </div>
                        <div class="appointment-right-section">
                            <div class="appointment-status-container">
                                <div class="appointment-status-badge status-${appointment.status || 'scheduled'}">
                                    <i class="fas ${getStatusIcon(appointment.status || 'scheduled')}"></i>
                                    ${formatStatus(appointment.status || 'scheduled')}
                                </div>
                                <div class="appointment-date-badge">
                                    ${isToday ? '<span class="today-badge">TODAY</span>' : 
                                      isTomorrow ? '<span class="tomorrow-badge">TOMORROW</span>' : 
                                      daysUntil >= 2 && daysUntil <= 7 ? `<span class="upcoming-badge">IN ${daysUntil} DAYS</span>` : ''}
                                </div>
                            </div>
                        </div>
                    `;
                    
                    appointmentsContainer.appendChild(appointmentEl);
                });
                
                // Show extra appointments indicator if there are more than 6
                if (extraCount > 0) {
                    const extraIndicator = document.createElement('div');
                    extraIndicator.className = 'extra-appointments-indicator';
                    extraIndicator.innerHTML = `
                        <div class="extra-indicator-content">
                            <i class="fas fa-plus-circle"></i>
                            <span>${extraCount}+ more upcoming</span>
                            <small>View all in Appointments page</small>
                        </div>
                    `;
                    appointmentsContainer.appendChild(extraIndicator);
                }
            }
            
            // Update dashboard appointment count
            updateDashboardAppointmentCount();
        }

        // **ENHANCED: Helper function to format time to 12-hour format with error handling**
        function formatTime12Hour(time24) {
            try {
                if (!time24 || typeof time24 !== 'string') {
                    return '12:00 PM'; // Default fallback
                }
                
                const [hours, minutes] = time24.split(':');
                const hour = parseInt(hours) || 0;
                const min = minutes || '00';
                const ampm = hour >= 12 ? 'PM' : 'AM';
                const hour12 = hour % 12 || 12;
                return `${hour12}:${min} ${ampm}`;
            } catch (error) {
                console.warn('Error formatting time:', time24, error);
                return '12:00 PM'; // Fallback
            }
        }

        // **NEW: Helper functions for appointment status display**
        function getStatusIcon(status) {
            const statusIcons = {
                'scheduled': 'fa-clock',
                'confirmed': 'fa-check-circle',
                'completed': 'fa-check-double',
                'cancelled': 'fa-times-circle',
                'rescheduled': 'fa-calendar-alt',
                'pending': 'fa-hourglass-half',
                'no-show': 'fa-user-times'
            };
            return statusIcons[status] || 'fa-clock';
        }

        function formatStatus(status) {
            const statusLabels = {
                'scheduled': 'Scheduled',
                'confirmed': 'Confirmed',
                'completed': 'Completed',
                'cancelled': 'Cancelled',
                'rescheduled': 'Rescheduled',
                'pending': 'Pending',
                'no-show': 'No Show'
            };
            return statusLabels[status] || 'Scheduled';
        }

        // **SIMPLIFIED: Real-time sync with appointment.html**
        function setupRealtimeSync() {
            console.log('🔄 Setting up simplified real-time sync...');
            
            // Simple sync function
            function syncAppointments() {
                console.log('🔄 Syncing appointments from localStorage...');
                loadWeeklyAppointments(true);
                updateDashboardAppointmentCount();
            }
            
            // Listen for storage changes (cross-tab sync)
            window.addEventListener('storage', function(e) {
                if (e.key === 'monumeAppointments') {
                    console.log('📡 Storage event: monumeAppointments changed');
                    syncAppointments();
                }
            });
            
            // Listen for focus changes (refresh when returning to tab)
            window.addEventListener('focus', function() {
                console.log('👁️ Window focused - refreshing appointments');
                syncAppointments();
            });
            
            // Periodic sync every 3 seconds
            setInterval(() => {
                syncAppointments();
            }, 3000);
            
            console.log('✅ Simplified sync setup complete');
        }

        // **FIXED: Sync appointment count with total appointments**
        function updateDashboardAppointmentCount() {
            try {
                const allAppointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                
                // Try multiple selectors to find the appointments count element
                let appointmentCountElement = document.querySelector('.appointments-card-value');
                
                if (!appointmentCountElement) {
                    console.log('⚠️ .appointments-card-value not found, trying alternative selectors...');
                    // Try to find the second stat card (appointments card)
                    const statCards = document.querySelectorAll('.stat-card');
                    if (statCards.length >= 2) {
                        appointmentCountElement = statCards[1].querySelector('.stat-card-value');
                        console.log('✅ Found appointments card via alternative selector');
                    }
                }
                
                if (appointmentCountElement) {
                    const oldValue = appointmentCountElement.textContent;
                    appointmentCountElement.textContent = allAppointments.length;
                    console.log(`📊 Updated appointment count: ${oldValue} → ${allAppointments.length}`);
                } else {
                    console.error('❌ Appointment count element not found with any selector');
                    console.log('🔍 Available .stat-card-value elements:');
                    document.querySelectorAll('.stat-card-value').forEach((el, index) => {
                        console.log(`   ${index}: ${el.textContent} (classes: ${el.className})`);
                    });
                }
            } catch (error) {
                console.error('❌ Error updating appointment count:', error);
            }
        }

        // **SIMPLIFIED: Trigger sync notification using same method as appointment.js**
        function triggerAppointmentSyncNotification() {
            console.log('📡 Dashboard: Triggering sync notification...');
            
            try {
                // Use same method as appointment.js notifyOtherTabsOfChanges
                const storageEvent = new StorageEvent('storage', {
                    key: 'monumeAppointments',
                    newValue: JSON.stringify(JSON.parse(localStorage.getItem('monumeAppointments') || '[]')),
                    url: window.location.href
                });
                
                window.dispatchEvent(storageEvent);
                console.log('✅ Sync notification sent');
                
                // Refresh dashboard
                loadWeeklyAppointments(true);
                
            } catch (error) {
                console.error('❌ Error triggering sync notification:', error);
            }
        }



        // **NEW: Check for sync conflicts and resolve them**
        function checkAndResolveSyncConflicts() {
            try {
                const lastDashboardSync = parseInt(localStorage.getItem('dashboardLastSync') || '0');
                const lastAppointmentPageSync = parseInt(localStorage.getItem('appointmentPageLastSync') || '0');
                const currentTime = Date.now();
                
                // If there's a significant time difference, refresh
                if (currentTime - lastDashboardSync > 30000) { // 30 seconds
                    console.log('⚠️ Dashboard data might be stale, refreshing...');
                    loadWeeklyAppointments(true);
                }
                
                // If appointment page was updated more recently, sync
                if (lastAppointmentPageSync > lastDashboardSync) {
                    console.log('🔄 Appointment page has newer data, syncing...');
                    loadWeeklyAppointments(true);
                }
                
            } catch (error) {
                console.error('Error checking sync conflicts:', error);
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Dashboard starting up...');
            
            // Set up event listeners for the links and buttons
            setupEventListeners();
            // Load dashboard data
            loadDashboardData();
            // Create particles
            createParticles();
            // Check for incomplete morning notes
            checkMorningNotes();
            // Set up mobile menu
            setupMobileMenu();
            
            // Check for a custom logo in local storage
            const customLogo = localStorage.getItem('customLogo');
            const sidebarLogo = document.getElementById('sidebar-logo');
            if (customLogo && sidebarLogo) {
                sidebarLogo.src = customLogo;
            }
            
            // **DISABLED: Old Team MonuMe functions (replaced with working versions)**
            // setupActiveUsersButtons();
            // initializeUsersDatabase();
            // updateActiveUsersCount();
            // **NEW SYSTEM: These are now handled by the new script section**
            
            // **CRITICAL: Load appointments and team chat**
            loadTeamChatPreview();
            loadWeeklyAppointments();
            
            // **CRITICAL: Setup simplified real-time synchronization**
            setupRealtimeSync();
            
            // **CRITICAL: Setup appointment functionality**
            setupAppointmentButtons();
            
            console.log('✅ Dashboard initialized successfully!');
        });

        // Upcoming Events logic for dashboard
(function() {
  const addEventBtn = document.getElementById('add-event-btn');
  const eventPopup = document.getElementById('eventPopup');
  const eventOverlay = document.getElementById('eventOverlay');
  const saveEventBtn = document.getElementById('saveEvent');
  const cancelEventBtn = document.getElementById('cancelEvent');
  const closeEventBtn = document.getElementById('closeEventPopup');
  const eventsList = document.querySelector('.events-list-scroll');

  // --- Holiday API Integration ---
  // Uses Nager.Date public API for holidays (country: US, can be changed)
  async function fetchUpcomingHolidays() {
    const today = new Date();
    const year = today.getFullYear();
    const country = 'US'; // Change to your country code if needed
    try {
      const res = await fetch(`https://date.nager.at/api/v3/PublicHolidays/${year}/${country}`);
      if (!res.ok) return [];
      const holidays = await res.json();
      // Filter for holidays in the next 7 days
      const weekAhead = new Date(today);
      weekAhead.setDate(today.getDate() + 7);
      return holidays.filter(h => {
        const hDate = new Date(h.date);
        return hDate >= today && hDate <= weekAhead;
      }).map(h => ({
        title: h.localName,
        date: h.date,
        type: 'holiday',
        description: h.name
      }));
    } catch (e) {
      return [];
    }
  }

  // Show modal
  if (addEventBtn) {
    addEventBtn.addEventListener('click', function() {
      eventPopup.style.display = 'block';
      eventOverlay.style.display = 'block';
      document.body.style.overflow = 'hidden'; // Prevent scroll
      document.getElementById('eventTitle').value = '';
      document.getElementById('eventDate').value = '';
    });
  }
  // Hide modal
  function closeEventModal() {
    eventPopup.style.display = 'none';
    eventOverlay.style.display = 'none';
    document.body.style.overflow = '';
  }
  if (cancelEventBtn) {
    cancelEventBtn.addEventListener('click', closeEventModal);
  }
  if (closeEventBtn) {
    closeEventBtn.addEventListener('click', closeEventModal);
  }
  if (eventOverlay) {
    eventOverlay.addEventListener('click', closeEventModal);
  }
  // Save event
  if (saveEventBtn) {
    saveEventBtn.addEventListener('click', function() {
      const title = document.getElementById('eventTitle').value.trim();
      const date = document.getElementById('eventDate').value;
      if (!title || !date) {
        alert('Please enter both title and date.');
        return;
      }
      // Save to localStorage
      const events = JSON.parse(localStorage.getItem('monume_events') || '[]');
      events.push({ title, date });
      localStorage.setItem('monume_events', JSON.stringify(events));
      renderEvents();
      closeEventModal();
    });
  }
  // Add modal for editing events
  const editModal = document.createElement('div');
  editModal.id = 'editEventModal';
  editModal.style.display = 'none';
  editModal.innerHTML = `
    <div class="event-modal-nice-content" style="max-width:340px;">
      <button class="event-modal-nice-close" id="closeEditEventModal" title="Close">&times;</button>
      <div class="event-modal-nice-header">
        <span class="event-modal-nice-icon"><i class="fas fa-pen"></i></span>
        <h2>Edit Event</h2>
                            </div>
      <div class="event-modal-nice-body">
        <label for="editEventTitle">Event Title</label>
        <div class="event-modal-nice-input-wrap">
          <i class="fas fa-heading event-modal-nice-input-icon"></i>
          <input type="text" id="editEventTitle" class="event-modal-nice-input" placeholder="Enter event title">
                        </div>
        <label for="editEventDate">Event Date</label>
        <div class="event-modal-nice-input-wrap">
          <i class="fas fa-calendar event-modal-nice-input-icon"></i>
          <input type="date" id="editEventDate" class="event-modal-nice-input">
                            </div>
                        </div>
      <div class="event-modal-nice-footer">
        <button class="event-modal-nice-btn cancel" id="deleteEventBtn" style="background:#f44336;color:#fff;">Delete</button>
        <button class="event-modal-nice-btn save" id="saveEditEventBtn">Save</button>
                                </div>
                                </div>
  `;
  document.body.appendChild(editModal);
  const editOverlay = document.createElement('div');
  editOverlay.id = 'editEventOverlay';
  editOverlay.className = 'event-modal-nice-overlay';
  editOverlay.style.display = 'none';
  document.body.appendChild(editOverlay);

  let editingEventIndex = null;

  // Show edit modal
  function showEditModal(eventIdx, eventObj) {
    editingEventIndex = eventIdx;
    document.getElementById('editEventTitle').value = eventObj.title;
    document.getElementById('editEventDate').value = eventObj.date;
    editModal.style.display = 'block';
    editOverlay.style.display = 'block';
    document.body.style.overflow = 'hidden';
  }
  // Hide edit modal
  function closeEditModal() {
    editModal.style.display = 'none';
    editOverlay.style.display = 'none';
    document.body.style.overflow = '';
    editingEventIndex = null;
  }
  document.getElementById('closeEditEventModal').onclick = closeEditModal;
  editOverlay.onclick = closeEditModal;
  document.getElementById('deleteEventBtn').onclick = function() {
    if (editingEventIndex !== null) {
      const events = JSON.parse(localStorage.getItem('monume_events') || '[]');
      events.splice(editingEventIndex, 1);
      localStorage.setItem('monume_events', JSON.stringify(events));
      closeEditModal();
      renderEvents();
    }
  };
  document.getElementById('saveEditEventBtn').onclick = function() {
    if (editingEventIndex !== null) {
      const title = document.getElementById('editEventTitle').value.trim();
      const date = document.getElementById('editEventDate').value;
      if (!title || !date) {
        alert('Please enter both title and date.');
        return;
      }
      const events = JSON.parse(localStorage.getItem('monume_events') || '[]');
      events[editingEventIndex] = { title, date };
      localStorage.setItem('monume_events', JSON.stringify(events));
      closeEditModal();
      renderEvents();
    }
  };

  // Render events (now merges local and holiday events)
  async function renderEvents() {
    if (!eventsList) return;
    const localEvents = JSON.parse(localStorage.getItem('monume_events') || '[]');
    const holidays = await fetchUpcomingHolidays();
    let allEvents = [
      ...localEvents.map((ev, idx) => ({ ...ev, type: 'local', _idx: idx })),
      ...holidays.map(ev => ({ ...ev, type: 'holiday' }))
    ];
    // Remove duplicates (same date and title)
    allEvents = allEvents.filter((ev, idx, arr) =>
      arr.findIndex(e => e.date === ev.date && e.title === ev.title) === idx
    );
    // Only show next 7 days
    const today = new Date();
    const weekAhead = new Date(today);
    weekAhead.setDate(today.getDate() + 7);
    allEvents = allEvents.filter(ev => {
      const d = new Date(ev.date);
      return d >= today && d <= weekAhead;
    });
    // Sort by date ascending
    allEvents.sort((a, b) => a.date.localeCompare(b.date));
    eventsList.innerHTML = '';
    if (allEvents.length === 0) {
      eventsList.innerHTML = '<div class="no-events">No upcoming events.</div>';
      return;
    }
    allEvents.forEach(ev => {
      const dateObj = new Date(ev.date);
      const day = String(dateObj.getDate()).padStart(2, '0');
      const month = dateObj.toLocaleString('default', { month: 'short' }).toUpperCase();
      const today = new Date();
      const isToday = dateObj.toDateString() === today.toDateString();
      const eventRow = document.createElement('div');
      eventRow.className = 'event-row' + (isToday ? ' today' : '');
      eventRow.innerHTML = `
        <div class="event-date-block">
            <span class="event-date-main">${day}</span>
            <span class="event-date-month">${month}</span>
                            </div>
        <div class="event-info">
            <div class="event-title">${ev.title}${ev.type === 'holiday' ? ' <span style=\'color:#ab47bc;font-weight:600;font-size:13px\'>(Holiday)</span>' : ''}</div>
            ${ev.type === 'holiday' && ev.description ? `<div style='color:#888;font-size:12px;'>${ev.description}</div>` : ''}
                        </div>
                    `;
      eventsList.appendChild(eventRow);
    });
  }
  // Initial render
  renderEvents();
})();

        // Completion Modal Functions
        let currentCompletionAppointmentId = null;

        function openCompletionModal(appointmentId) {
            console.log('Opening completion modal for appointment:', appointmentId);
            currentCompletionAppointmentId = appointmentId;
            
            // Reset form
            document.getElementById('completion-username').value = '';
            document.getElementById('completion-password').value = '';
            
            // Show modal
            const modal = document.getElementById('completion-modal');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
        }

        function closeCompletionModal() {
            const modal = document.getElementById('completion-modal');
            modal.classList.remove('active');
            document.body.style.overflow = 'auto';
            currentCompletionAppointmentId = null;
        }

        function confirmCompletion() {
            const username = document.getElementById('completion-username').value;
            const password = document.getElementById('completion-password').value;
            const confirmBtn = document.getElementById('confirm-completion-btn');
            
            if (!username || !password) {
                alert('Please select a username and enter your password');
                return;
            }

            // Disable button during verification
            confirmBtn.disabled = true;
            confirmBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Verifying...';

            // Mock authentication (same as other auth systems in the project)
            const users = [
                { username: 'admin', password: 'admin123', role: 'admin', name: 'Admin User' },
                { username: 'manager', password: 'manager123', role: 'manager', name: 'Manager User' },
                { username: 'staff1', password: 'staff123', role: 'employee', name: 'Staff Member 1' },
                { username: 'staff2', password: 'staff123', role: 'employee', name: 'Staff Member 2' }
            ];

            setTimeout(() => {
                const user = users.find(u => u.username === username);
                
                if (!user || user.password !== password) {
                    alert('Invalid username or password');
                    confirmBtn.disabled = false;
                    confirmBtn.innerHTML = '<i class="fas fa-check"></i> Mark Completed';
                    return;
                }

                // Mark appointment as completed
                markAppointmentCompleted(currentCompletionAppointmentId, user);
                
                // Show success and close modal
                showCompletionSuccess(user.name);
                closeCompletionModal();
                
                // Reload appointments display
                loadWeeklyAppointments();
                
                // Reset button
                confirmBtn.disabled = false;
                confirmBtn.innerHTML = '<i class="fas fa-check"></i> Mark Completed';
            }, 1500); // Add delay for authentication feel
        }

        function markAppointmentCompleted(appointmentId, completedBy) {
            try {
                // Get appointments from localStorage
                const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                
                // Find and update the appointment
                const appointmentIndex = appointments.findIndex(apt => apt.id === appointmentId);
                
                if (appointmentIndex !== -1) {
                    appointments[appointmentIndex].status = 'completed';
                    appointments[appointmentIndex].completedBy = completedBy.name;
                    appointments[appointmentIndex].completedAt = new Date().toISOString();
                    
                    // Save back to localStorage
                    localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
                    
                    console.log('✅ Appointment marked as completed:', appointmentId);
                } else {
                    console.error('❌ Appointment not found:', appointmentId);
                }
            } catch (error) {
                console.error('Error marking appointment as completed:', error);
                alert('Error updating appointment status');
            }
        }

        function showCompletionSuccess(completedByName) {
            // Create success notification
            const notification = document.createElement('div');
            notification.className = 'appointment-message success show';
            notification.innerHTML = `
                <i class="fas fa-check-circle"></i>
                Appointment marked as completed by ${completedByName}
            `;
            
            // Add styles
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 1rem 1.5rem;
                border-radius: 10px;
                color: white;
                font-weight: 600;
                z-index: 1001;
                transform: translateX(100%);
                transition: transform 0.3s ease;
                background: linear-gradient(135deg, #10b981, #059669);
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                display: flex;
                align-items: center;
                gap: 8px;
            `;
            
            document.body.appendChild(notification);
            
            // Animate in
            setTimeout(() => {
                notification.style.transform = 'translateX(0)';
            }, 100);
            
            // Auto remove after 4 seconds
            setTimeout(() => {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }, 4000);
        }

        // Close completion modal when clicking outside
        document.addEventListener('click', function(e) {
            const modal = document.getElementById('completion-modal');
            if (e.target === modal) {
                closeCompletionModal();
            }
        });

        // Close completion modal with ESC key
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('completion-modal');
                if (modal && modal.classList.contains('active')) {
                    closeCompletionModal();
                }
            }
        });

        // Appointment Management Functions
        function setupAppointmentButtons() {
            console.log('Setting up appointment buttons...');
            const addBtn = document.getElementById('appointment-add-btn');
            const viewBtn = document.getElementById('appointment-view-btn');
            const modal = document.getElementById('appointment-modal');
            const closeBtn = document.getElementById('close-modal');
            const cancelBtn = document.getElementById('cancel-form-btn');
            const form = document.getElementById('appointment-form');

            console.log('Elements found:', {
                addBtn: !!addBtn,
                viewBtn: !!viewBtn,
                modal: !!modal,
                closeBtn: !!closeBtn,
                cancelBtn: !!cancelBtn,
                form: !!form
            });

            // Add button - Open modal
            if (addBtn) {
                console.log('Adding click listener to ADD button');
                addBtn.addEventListener('click', function(e) {
                    console.log('ADD button clicked!');
                    e.preventDefault();
                    openAppointmentModal();
                });
            } else {
                console.error('ADD button not found!');
            }

            // View button - Navigate to appointment.html
            if (viewBtn) {
                viewBtn.addEventListener('click', function(e) {
                    console.log('VIEW button clicked!');
                    window.location.href = 'appointment.html';
                });
            } else {
                console.error('VIEW button not found!');
            }

            // Close button
            if (closeBtn) {
                closeBtn.addEventListener('click', function() {
                    closeAppointmentModal();
                });
            }

            // Cancel button
            if (cancelBtn) {
                cancelBtn.addEventListener('click', function() {
                    closeAppointmentModal();
                });
            }

            // Form submission - Enhanced handler for both create and edit
            if (form) {
                form.addEventListener('submit', handleAppointmentFormSubmit);
                console.log('✅ Enhanced form submission handler attached');
            }

            // Close modal when clicking outside
            if (modal) {
                modal.addEventListener('click', function(e) {
                    if (e.target === modal) {
                        closeAppointmentModal();
                    }
                });
            }

            // ESC key to close modal
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape' && modal.style.display !== 'none') {
                    closeAppointmentModal();
                }
            });
        }

        function openAppointmentModal() {
            console.log('🚀 openAppointmentModal called!');
            const modal = document.getElementById('appointment-modal');
            const form = document.getElementById('appointment-form');
            
            if (!modal) {
                console.error('❌ Modal element not found!');
                alert('Modal not found! Please refresh the page.');
                return;
            }
            
            if (!form) {
                console.error('❌ Form element not found!');
                alert('Form not found! Please refresh the page.');
                return;
            }
            
            console.log('✅ Modal and form elements found');
            
            // Reset form
            form.reset();
            console.log('✅ Form reset');
            
            // Set minimum date to today
            const dateInput = document.getElementById('appointment-date');
            if (dateInput) {
                const today = new Date().toISOString().split('T')[0];
                dateInput.min = today;
                dateInput.value = today;
                console.log('✅ Date set to:', today);
            }
            
            // Set default time values
            const hourSelect = document.getElementById('appointment-hour');
            const minuteSelect = document.getElementById('appointment-minute');
            const ampmSelect = document.getElementById('appointment-ampm');
            
            if (hourSelect && minuteSelect && ampmSelect) {
                hourSelect.value = '9';
                minuteSelect.value = '00';
                ampmSelect.value = 'AM';
                console.log('✅ Default time set to 9:00 AM');
            }
            
            // Load hosts dynamically
            loadHostOptions();
            
            // Show modal using CSS class (most reliable method)
            console.log('✅ Showing modal...');
            modal.classList.add('active');
            document.body.style.overflow = 'hidden';
            console.log('✅ Modal class added, should be visible now');
            
            // Focus first input after a short delay
            setTimeout(() => {
                const firstInput = document.getElementById('client-name');
                if (firstInput) {
                    firstInput.focus();
                    console.log('✅ Focus set to client name input');
                }
                
                // **NEW: Setup time conflict listeners after modal is fully open**
                setupDashboardTimeConflictListeners();
                console.log('✅ Time conflict listeners set up');
            }, 100);
            
            console.log('🎉 MODAL OPENING COMPLETE!');
        }

        function closeAppointmentModal() {
            const modal = document.getElementById('appointment-modal');
            const form = document.getElementById('appointment-form');
            
            if (modal) {
                console.log('✅ Closing modal...');
                modal.classList.remove('active');
                
                // Reset form state if it was in edit mode
                if (form && form.dataset.editingId) {
                    delete form.dataset.editingId;
                    
                    // Reset form title and button text
                    const titleElement = document.querySelector('.modal-title');
                    const submitButton = document.querySelector('#appointment-form button[type="submit"]');
                    
                    if (titleElement) {
                        titleElement.textContent = 'Schedule New Appointment';
                    }
                    
                    if (submitButton) {
                        submitButton.innerHTML = '<i class="fas fa-save"></i> Schedule Appointment';
                    }
                    
                    console.log('✅ Form reset from edit mode to create mode');
                }
                
                // Reset form fields
                if (form) {
                    form.reset();
                    console.log('✅ Form fields cleared');
                }
                
                // Force close with multiple methods
                setTimeout(() => {
                    modal.style.display = 'none';
                    modal.style.visibility = 'hidden';
                    modal.style.opacity = '0';
                }, 300); // Wait for transition
                
                document.body.style.overflow = '';
                console.log('✅ Modal closed and reset');
            }
        }

        function loadHostOptions() {
            const hostSelect = document.getElementById('appointment-host');
            if (hostSelect) {
                // Clear existing options except the first one
                hostSelect.innerHTML = '<option value="">Select host</option>';
                
                // Add host options (you can modify these as needed)
                const hosts = [
                    { id: 'admin', name: 'Administrator' },
                    { id: 'manager', name: 'Manager' },
                    { id: 'staff1', name: 'David Johnson' },
                    { id: 'staff2', name: 'Sarah Miller' },
                    { id: 'staff3', name: 'Michael Brown' },
                    { id: 'staff4', name: 'Emily Davis' }
                ];
                
                hosts.forEach(host => {
                    const option = document.createElement('option');
                    option.value = host.id;
                    option.textContent = host.name;
                    hostSelect.appendChild(option);
                });
            }
        }

        function convertTo24HourFormat(hour, minute, ampm) {
            let hour24 = parseInt(hour);
            
            if (ampm === 'AM') {
                if (hour24 === 12) {
                    hour24 = 0; // 12 AM = 00:xx
                }
            } else { // PM
                if (hour24 !== 12) {
                    hour24 += 12; // Add 12 for PM, except for 12 PM
                }
            }
            
            // Format as HH:MM
            const formattedHour = hour24.toString().padStart(2, '0');
            const formattedMinute = minute.padStart(2, '0');
            
            return `${formattedHour}:${formattedMinute}`;
        }

        function saveAppointmentFromDashboard() {
            console.log('💾 Starting appointment save process...');
            
            try {
                // Get form data using the new time selection format
                const clientName = document.getElementById('client-name').value.trim();
                const clientEmail = document.getElementById('client-email').value.trim();
                const clientPhone = document.getElementById('client-phone').value.trim();
                const appointmentDate = document.getElementById('appointment-date').value;
                
                // Get time components
                const appointmentHour = document.getElementById('appointment-hour').value;
                const appointmentMinute = document.getElementById('appointment-minute').value;
                const appointmentAmPm = document.getElementById('appointment-ampm').value;
                
                const appointmentType = document.getElementById('appointment-type').value;
                const appointmentHost = document.getElementById('appointment-host').value;
                const appointmentNotes = document.getElementById('appointment-notes').value.trim();

                console.log('📋 Form data collected:', {
                    clientName, clientEmail, appointmentDate, appointmentHour, appointmentMinute, appointmentAmPm, appointmentType
                });

                // Validate required fields including time components
                if (!clientName || !clientEmail || !clientPhone || !appointmentDate || 
                    !appointmentHour || !appointmentMinute || !appointmentAmPm || !appointmentType) {
                    showErrorNotification('Please fill in all required fields');
                    console.log('❌ Validation failed: Missing required fields');
                    return false;
                }

                // Convert time to 24-hour format
                const appointmentTime = convertTo24HourFormat(appointmentHour, appointmentMinute, appointmentAmPm);
                console.log('🕐 Converted time:', appointmentTime);

                // Validate email format
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(clientEmail)) {
                    showErrorNotification('Please enter a valid email address');
                    console.log('❌ Validation failed: Invalid email format');
                    return false;
                }

                // Validate date is not in the past
                const selectedDate = new Date(appointmentDate);
                const today = new Date();
                today.setHours(0, 0, 0, 0);
                
                if (selectedDate < today) {
                    showErrorNotification('Cannot schedule appointments in the past');
                    console.log('❌ Validation failed: Past date selected');
                    return false;
                }

                // Create appointment object (same format as appointment.js) and bind to current location
                const locationCtx = getCurrentLocationContext();
                const appointment = {
                    id: `apt-${Date.now()}-${Math.random().toString(36).substr(2, 9)}`,
                    clientName: clientName,
                    clientEmail: clientEmail,
                    clientPhone: clientPhone,
                    date: appointmentDate,
                    time: appointmentTime,
                    type: appointmentType,
                    hostId: appointmentHost || 'admin',
                    notes: appointmentNotes,
                    status: 'scheduled',
                    createdAt: new Date().toISOString(),
                    updatedAt: new Date().toISOString(),
                    url: `https://www.monumevip.com/appointment/${Date.now()}`,
                    source: 'dashboard',
                    locationId: locationCtx.id,
                    locationName: locationCtx.name,
                    locationCode: locationCtx.code
                };

                console.log('📝 Created appointment object:', appointment);

                // Save to localStorage with error handling
                try {
                    // Get existing appointments
                    const existingData = localStorage.getItem('monumeAppointments');
                    let appointments = [];
                    
                    if (existingData) {
                        appointments = JSON.parse(existingData);
                        if (!Array.isArray(appointments)) {
                            console.warn('⚠️ Invalid appointments data, resetting to empty array');
                            appointments = [];
                        }
                    }
                    
                    console.log('📊 Current appointments count:', appointments.length);
                    
                    // Add new appointment
                    appointments.push(appointment);
                    
                    // Save back to localStorage
                    const dataToSave = JSON.stringify(appointments);
                    localStorage.setItem('monumeAppointments', dataToSave);
                    
                    // Verify save was successful
                    const savedData = localStorage.getItem('monumeAppointments');
                    const savedAppointments = JSON.parse(savedData);
                    
                    if (savedAppointments.length === appointments.length) {
                        console.log('✅ Successfully saved appointment to localStorage');
                        console.log('📊 New total appointments:', savedAppointments.length);
                    } else {
                        throw new Error('Save verification failed');
                    }
                    
                } catch (storageError) {
                    console.error('❌ localStorage save error:', storageError);
                    showErrorNotification('Failed to save appointment. Storage might be full.');
                    return false;
                }

                // **REMOVED: Time conflict check that was preventing saves**
                // We'll allow overlapping appointments for now to ensure saving works

        // **CRITICAL: Trigger sync notification for other tabs/windows**
        console.log('🔄 Triggering sync notification...');
        triggerAppointmentSyncNotification();
        
        // Update appointment count on dashboard
        updateAppointmentCount();
        
        // Close modal FIRST
        closeAppointmentModal();
        console.log('✅ Modal closed after save');
        
        // Reload weekly appointments to show the new appointment
        setTimeout(() => {
            console.log('🔄 Reloading weekly appointments...');
            loadWeeklyAppointments(true); // Force refresh
        }, 100);
        
        // Show success message AFTER modal closes
        setTimeout(() => {
            showSuccessNotification('Appointment scheduled successfully! 🎉');
            console.log('🎉 Success notification shown');
        }, 300);
        
        // Send to server (optional - now just logs)
        sendAppointmentToServer(appointment);
        
                console.log('🎉 Appointment save process completed successfully!');
        
    } catch (error) {
        console.error('❌ Critical error in saveAppointmentFromDashboard:', error);
        showErrorNotification('Critical error saving appointment. Please refresh and try again.');
    }
}

    // **NEW: Dashboard time conflict checking functions**
    function checkDashboardTimeConflict(date, time) {
        console.log('🔍 Checking time conflict for dashboard appointment:', date, time);
        
        try {
            const existingAppointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            
            // Check if this time slot is already taken
            const conflictingAppointment = existingAppointments.find(apt => 
                apt.date === date && apt.time === time
            );
            
            if (conflictingAppointment) {
                const errorMessage = `⚠️ Time slot unavailable!\n\n${formatDateForDisplay(date)} at ${formatTimeForDisplay(time)}\nis already booked by ${conflictingAppointment.clientName}.\n\nPlease select a different time.`;
                
                showErrorNotification(errorMessage);
                
                // Highlight conflicting time fields
                highlightConflictingTimeFields();
                
                console.log('❌ Time conflict detected:', {
                    requestedDate: date,
                    requestedTime: time,
                    conflictingWith: conflictingAppointment.clientName
                });
                
                return true; // Conflict found
            }
            
            return false; // No conflict
            
        } catch (error) {
            console.error('Error checking time conflict:', error);
            return false; // Allow save if error checking
        }
    }

    function highlightConflictingTimeFields() {
        const timeFields = [
            document.getElementById('appointment-hour'),
            document.getElementById('appointment-minute'),
            document.getElementById('appointment-ampm')
        ];
        
        timeFields.forEach(field => {
            if (field) {
                field.style.borderColor = '#ef4444';
                field.style.backgroundColor = 'rgba(239, 68, 68, 0.05)';
                field.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                
                // Add shake animation
                field.style.animation = 'shake 0.5s ease-in-out';
                
                // Remove error styling after 4 seconds
                setTimeout(() => {
                    field.style.borderColor = '';
                    field.style.backgroundColor = '';
                    field.style.boxShadow = '';
                    field.style.animation = '';
                }, 4000);
            }
        });
    }

    function formatDateForDisplay(dateString) {
        try {
            const date = new Date(dateString + 'T00:00:00');
            return date.toLocaleDateString('en-US', { 
                weekday: 'long',
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            });
        } catch (error) {
            return dateString;
        }
    }

    function formatTimeForDisplay(timeString) {
        try {
            const [hours, minutes] = timeString.split(':');
            const hour = parseInt(hours);
            const ampm = hour >= 12 ? 'PM' : 'AM';
            const hour12 = hour % 12 || 12;
            return `${hour12}:${minutes} ${ampm}`;
        } catch (error) {
            return timeString;
        }
    }

    // **NEW: Real-time conflict checking for dashboard**
    function setupDashboardTimeConflictListeners() {
        const dateField = document.getElementById('appointment-date');
        const hourField = document.getElementById('appointment-hour');
        const minuteField = document.getElementById('appointment-minute');
        const ampmField = document.getElementById('appointment-ampm');
        
        // Date change listener
        if (dateField) {
            dateField.addEventListener('change', () => {
                console.log('📅 Dashboard: Date changed, checking availability...');
                updateDashboardTimeAvailability();
                clearDashboardTimeErrors();
            });
        }
        
        // Time field listeners
        [hourField, minuteField, ampmField].forEach(field => {
            if (field) {
                field.addEventListener('change', () => {
                    console.log('⏰ Dashboard: Time field changed...');
                    setTimeout(() => {
                        checkDashboardTimeConflictRealTime();
                    }, 100);
                });
            }
        });
    }

    function updateDashboardTimeAvailability() {
        const selectedDate = document.getElementById('appointment-date')?.value;
        if (!selectedDate) return;
        
        try {
            const existingAppointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            const bookedTimes = existingAppointments
                .filter(apt => apt.date === selectedDate)
                .map(apt => apt.time)
                .sort();
            
            if (bookedTimes.length > 0) {
                showDashboardAvailabilityInfo(selectedDate, bookedTimes);
            } else {
                clearDashboardAvailabilityInfo();
            }
        } catch (error) {
            console.error('Error updating time availability:', error);
        }
    }

    function showDashboardAvailabilityInfo(date, bookedTimes) {
        clearDashboardAvailabilityInfo();
        
        const timeContainer = document.querySelector('.time-selection-grid')?.parentElement;
        if (!timeContainer) return;
        
        const infoDiv = document.createElement('div');
        infoDiv.id = 'dashboard-time-availability-info';
        infoDiv.style.cssText = `
            margin-top: 12px;
            padding: 12px;
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 8px;
            font-size: 13px;
            color: #f59e0b;
            animation: slideDown 0.3s ease-out;
        `;
        
        const formattedTimes = bookedTimes.map(time => formatTimeForDisplay(time)).join(', ');
        infoDiv.innerHTML = `
            <div style="display: flex; align-items: center; gap: 8px;">
                <i class="fas fa-info-circle"></i>
                <div>
                    <strong>Unavailable times for ${formatDateForDisplay(date)}:</strong><br>
                    ${formattedTimes}
                </div>
            </div>
        `;
        
        timeContainer.appendChild(infoDiv);
    }

    function clearDashboardAvailabilityInfo() {
        const existingInfo = document.getElementById('dashboard-time-availability-info');
        if (existingInfo) {
            existingInfo.remove();
        }
    }

    function checkDashboardTimeConflictRealTime() {
        const date = document.getElementById('appointment-date')?.value;
        const hour = document.getElementById('appointment-hour')?.value;
        const minute = document.getElementById('appointment-minute')?.value;
        const ampm = document.getElementById('appointment-ampm')?.value;
        
        if (!date || !hour || !minute || !ampm) {
            clearDashboardTimeConflictWarning();
            return false;
        }
        
        // Convert to 24-hour format
        const time = convertTo24HourFormat(hour, minute, ampm);
        
        try {
            const existingAppointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            const conflictingAppointment = existingAppointments.find(apt => 
                apt.date === date && apt.time === time
            );
            
            if (conflictingAppointment) {
                showDashboardTimeConflictWarning(conflictingAppointment, date, time);
                return true;
            } else {
                clearDashboardTimeConflictWarning();
                clearDashboardTimeErrors();
                return false;
            }
        } catch (error) {
            console.error('Error checking real-time conflict:', error);
            return false;
        }
    }

    function showDashboardTimeConflictWarning(conflictingAppointment, date, time) {
        clearDashboardTimeConflictWarning();
        
        const timeContainer = document.querySelector('.time-selection-grid')?.parentElement;
        if (!timeContainer) return;
        
        const warningDiv = document.createElement('div');
        warningDiv.id = 'dashboard-time-conflict-warning';
        warningDiv.style.cssText = `
            margin-top: 8px;
            padding: 10px 12px;
            background: rgba(239, 68, 68, 0.08);
            border: 1px solid rgba(239, 68, 68, 0.2);
            border-radius: 8px;
            font-size: 13px;
            color: #dc2626;
            display: flex;
            align-items: center;
            gap: 8px;
            animation: slideDown 0.3s ease-out;
        `;
        
        warningDiv.innerHTML = `
            <i class="fas fa-exclamation-triangle" style="color: #f59e0b;"></i>
            <div>
                <strong>Time slot unavailable!</strong><br>
                ${formatTimeForDisplay(time)} on ${formatDateForDisplay(date)} is already booked by <strong>${conflictingAppointment.clientName}</strong>
            </div>
        `;
        
        timeContainer.appendChild(warningDiv);
        
        // Add subtle styling to time fields
        const timeFields = [
            document.getElementById('appointment-hour'),
            document.getElementById('appointment-minute'),
            document.getElementById('appointment-ampm')
        ];
        
        timeFields.forEach(field => {
            if (field) {
                field.style.borderColor = '#fca5a5';
                field.style.backgroundColor = 'rgba(239, 68, 68, 0.02)';
            }
        });
    }

    function clearDashboardTimeConflictWarning() {
        const existingWarning = document.getElementById('dashboard-time-conflict-warning');
        if (existingWarning) {
            existingWarning.remove();
        }
    }

    function clearDashboardTimeErrors() {
        const timeFields = [
            document.getElementById('appointment-hour'),
            document.getElementById('appointment-minute'),
            document.getElementById('appointment-ampm')
        ];
        
        timeFields.forEach(field => {
            if (field) {
                field.style.borderColor = '';
                field.style.backgroundColor = '';
                field.style.boxShadow = '';
                field.style.animation = '';
            }
        });
    }

    function sendAppointmentToServer(appointment) {
        // Server functionality disabled - using localStorage only
        console.log('📱 Using localStorage only (no server communication)');
        console.log('✅ Appointment saved locally:', appointment.id);
        
        // Show success notification instead of server communication
        setTimeout(() => {
            showSyncStatus('synced', 'Appointment saved locally');
        }, 200);
    }

    function updateAppointmentCount() {
        try {
            // Read from the same key that appointment.html uses
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            const appointmentCountElement = document.querySelector('.appointments-card-value');
            if (appointmentCountElement) {
                appointmentCountElement.textContent = appointments.length;
                console.log('✅ Updated appointment count to:', appointments.length);
            }
        } catch (error) {
            console.error('Error updating appointment count:', error);
        }
    }

    function showSuccessNotification(message) {
        console.log('📢 Showing success notification:', message);
        createNotification(message, 'success');
    }

    function showErrorNotification(message) {
        console.log('📢 Showing error notification:', message);
        createNotification(message, 'error');
    }

    function createNotification(message, type) {
        // Remove existing notifications
        const existingNotifications = document.querySelectorAll('.notification-toast');
        existingNotifications.forEach(notification => notification.remove());

        // Create notification element
        const notification = document.createElement('div');
        notification.className = `notification-toast notification-${type}`;
        
        const icon = type === 'success' ? 'check-circle' : 'exclamation-circle';
        const bgColor = type === 'success' ? '#10b981' : '#ef4444';
        
        notification.innerHTML = `
            <div class="notification-content">
                <i class="fas fa-${icon}"></i>
                <span class="notification-message">${message}</span>
                <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                    <i class="fas fa-times"></i>
                </button>
                        </div>
                    `;

        // Add styles
        notification.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            background: ${bgColor};
            color: white;
            padding: 1rem 1.5rem;
            border-radius: 10px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
            z-index: 10000;
            transform: translateX(100%);
            transition: transform 0.3s ease;
            max-width: 400px;
            font-weight: 500;
        `;

        notification.querySelector('.notification-content').style.cssText = `
            display: flex;
            align-items: center;
            gap: 10px;
        `;

        notification.querySelector('.notification-close').style.cssText = `
            background: none;
            border: none;
            color: white;
            cursor: pointer;
            padding: 0;
            margin-left: 10px;
            opacity: 0.8;
            transition: opacity 0.2s ease;
        `;

        // Add to body
        document.body.appendChild(notification);

        // Animate in
        setTimeout(() => {
            notification.style.transform = 'translateX(0)';
        }, 100);

        // Auto remove after 4 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.remove();
                    }
                }, 300);
            }
        }, 4000);

        console.log('✅ Notification created and displayed');
    }

    // Migrate appointments from old storage keys to new unified key
    function migrateAppointments() {
        try {
            const newAppointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            
            // Migrate from old 'appointments' key
            const oldAppointments = JSON.parse(localStorage.getItem('appointments') || '[]');
            if (oldAppointments.length > 0) {
                console.log('📦 Migrating', oldAppointments.length, 'appointments from old storage');
                
                // Merge appointments, avoiding duplicates
                oldAppointments.forEach(oldApt => {
                    const exists = newAppointments.find(newApt => newApt.id === oldApt.id);
                    if (!exists) {
                        newAppointments.push(oldApt);
                    }
                });
                
                // Save merged appointments
                localStorage.setItem('monumeAppointments', JSON.stringify(newAppointments));
                localStorage.removeItem('appointments'); // Clean up old key
                console.log('✅ Migration complete. Total appointments:', newAppointments.length);
            }
            
            // Migrate from old dashboard key
            const dashboardAppointments = JSON.parse(localStorage.getItem('monume_appointments') || '[]');
            if (dashboardAppointments.length > 0) {
                console.log('📦 Migrating', dashboardAppointments.length, 'appointments from dashboard storage');
                
                // Merge appointments, avoiding duplicates
                dashboardAppointments.forEach(dashApt => {
                    const exists = newAppointments.find(newApt => newApt.id === dashApt.id);
                    if (!exists) {
                        newAppointments.push(dashApt);
                    }
                });
                
                // Save merged appointments
                localStorage.setItem('monumeAppointments', JSON.stringify(newAppointments));
                console.log('✅ Dashboard migration complete. Total appointments:', newAppointments.length);
            }
            
        } catch (error) {
            console.error('Error during appointment migration:', error);
        }
    }

    // **ENHANCED: Debug function to check appointment data synchronization**
    window.debugAppointmentSync = function() {
        console.log('🔍 === APPOINTMENT SYNC DEBUG ===');
        
        // Check all possible localStorage keys
        const keys = ['monumeAppointments', 'appointments', 'dashboardAppointments', 'weeklyAppointments'];
        keys.forEach(key => {
            const data = localStorage.getItem(key);
            if (data) {
                const parsed = JSON.parse(data);
                console.log(`📊 ${key}: ${parsed.length} appointments`);
                console.log(`📋 Data:`, parsed);
            } else {
                console.log(`❌ ${key}: No data found`);
            }
        });
        
        console.log('🔄 Forcing dashboard reload...');
        loadWeeklyAppointments();
        updateDashboardAppointmentCount();
        
        console.log('✅ Debug complete - check appointment.html to verify sync');
    };

    // Test function to verify appointment integration
    window.testAppointmentIntegration = function() {
        console.log('🧪 Testing appointment integration...');
        const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
        console.log('📊 Current appointments in storage:', appointments.length);
        console.log('📋 Appointments data:', appointments);
        
        if (appointments.length > 0) {
            console.log('✅ Appointments found! They should appear in appointment.html');
            console.log('💡 Go to appointment.html to verify they show up in calendar and list view');
            
            // Show the latest appointment
            const latest = appointments[appointments.length - 1];
            console.log('📅 Latest appointment:', {
                client: latest.clientName,
                date: latest.date,
                time: latest.time,
                type: latest.type
            });
        } else {
            console.log('ℹ️ No appointments found. Create one from the dashboard to test.');
        }
    };

    // **NEW: Edit appointment functionality**
    function editAppointment(appointmentId) {
        console.log('📝 Editing appointment:', appointmentId);
        
        try {
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            const appointment = appointments.find(apt => apt.id === appointmentId);
            
            if (!appointment) {
                showErrorNotification('Appointment not found');
                return;
            }
            
            // Fill the form with existing data
            document.getElementById('client-name').value = appointment.clientName || '';
            document.getElementById('client-email').value = appointment.clientEmail || '';
            document.getElementById('client-phone').value = appointment.clientPhone || '';
            document.getElementById('appointment-date').value = appointment.date || '';
            document.getElementById('appointment-type').value = appointment.type || '';
            document.getElementById('appointment-host').value = appointment.hostId || '';
            document.getElementById('appointment-notes').value = appointment.notes || '';
            
            // Convert 24h time back to 12h format for the form
            if (appointment.time) {
                const [hours, minutes] = appointment.time.split(':');
                const hour24 = parseInt(hours);
                const hour12 = hour24 === 0 ? 12 : (hour24 > 12 ? hour24 - 12 : hour24);
                const ampm = hour24 >= 12 ? 'PM' : 'AM';
                
                document.getElementById('appointment-hour').value = hour12.toString();
                document.getElementById('appointment-minute').value = minutes;
                document.getElementById('appointment-ampm').value = ampm;
            }
            
            // Store the ID for update operation
            document.getElementById('appointment-form').dataset.editingId = appointmentId;
            
            // Change form title and button text
            document.querySelector('.modal-title').textContent = 'Edit Appointment';
            document.querySelector('#appointment-form button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Update Appointment';
            
            // Open modal
            openAppointmentModal();
            
            console.log('✅ Form populated for editing appointment:', appointmentId);
            
        } catch (error) {
            console.error('❌ Error loading appointment for edit:', error);
            showErrorNotification('Error loading appointment data');
        }
    }

    // **NEW: Update existing appointment**
    function updateAppointment(appointmentId) {
        console.log('💾 Updating appointment:', appointmentId);
        
        try {
            // Get form data (same validation as save)
            const clientName = document.getElementById('client-name').value.trim();
            const clientEmail = document.getElementById('client-email').value.trim();
            const clientPhone = document.getElementById('client-phone').value.trim();
            const appointmentDate = document.getElementById('appointment-date').value;
            
            const appointmentHour = document.getElementById('appointment-hour').value;
            const appointmentMinute = document.getElementById('appointment-minute').value;
            const appointmentAmPm = document.getElementById('appointment-ampm').value;
            
            const appointmentType = document.getElementById('appointment-type').value;
            const appointmentHost = document.getElementById('appointment-host').value;
            const appointmentNotes = document.getElementById('appointment-notes').value.trim();

            // Validate required fields
            if (!clientName || !clientEmail || !clientPhone || !appointmentDate || 
                !appointmentHour || !appointmentMinute || !appointmentAmPm || !appointmentType) {
                showErrorNotification('Please fill in all required fields');
                return false;
            }

            // Convert time to 24-hour format
            const appointmentTime = convertTo24HourFormat(appointmentHour, appointmentMinute, appointmentAmPm);

            // Validate email
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(clientEmail)) {
                showErrorNotification('Please enter a valid email address');
                return false;
            }

            // Get and update appointments
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            const appointmentIndex = appointments.findIndex(apt => apt.id === appointmentId);
            
            if (appointmentIndex === -1) {
                showErrorNotification('Appointment not found');
                return false;
            }
            
            // Update the appointment while preserving original metadata
            const originalAppointment = appointments[appointmentIndex];
            appointments[appointmentIndex] = {
                ...originalAppointment,
                clientName: clientName,
                clientEmail: clientEmail,
                clientPhone: clientPhone,
                date: appointmentDate,
                time: appointmentTime,
                type: appointmentType,
                hostId: appointmentHost || 'admin',
                notes: appointmentNotes,
                updatedAt: new Date().toISOString(),
                source: 'dashboard-edit'
            };

            // Save back to localStorage
            localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
            console.log('✅ Appointment updated successfully');

            // Trigger sync
            triggerAppointmentSyncNotification();
            
            // Update UI
            updateAppointmentCount();
            setTimeout(() => loadWeeklyAppointments(true), 100);
            
            // Close modal and show success
            closeAppointmentModal();
            setTimeout(() => {
                showSuccessNotification('Appointment updated successfully! 📝');
            }, 300);
            
            return true;
            
        } catch (error) {
            console.error('❌ Error updating appointment:', error);
            showErrorNotification('Error updating appointment. Please try again.');
                return false;
            }
        }

        // **NEW: Delete appointment functionality**
        function deleteAppointment(appointmentId) {
            if (!confirm('🗑️ Are you sure you want to delete this appointment?')) {
                return;
            }
            
            console.log('🗑️ Deleting appointment:', appointmentId);
            
            try {
                const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                const appointmentIndex = appointments.findIndex(apt => apt.id === appointmentId);
                
                if (appointmentIndex === -1) {
                    showErrorNotification('Appointment not found');
                    return;
                }
                
                // Get appointment details for confirmation
                const appointment = appointments[appointmentIndex];
                
                // Remove from array
                appointments.splice(appointmentIndex, 1);
                
                // Save back to localStorage
                localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
                console.log('✅ Appointment deleted successfully');

                // Trigger sync
                triggerAppointmentSyncNotification();
                
                // Update UI
                updateAppointmentCount();
                setTimeout(() => loadWeeklyAppointments(true), 100);
                
                // Show success
                showSuccessNotification(`Appointment for ${appointment.clientName} deleted! 🗑️`);
                
            } catch (error) {
                console.error('❌ Error deleting appointment:', error);
                showErrorNotification('Error deleting appointment. Please try again.');
            }
        }

        // **NEW: Enhanced form submission handler**
        function handleAppointmentFormSubmit(event) {
            event.preventDefault();
            
            const form = document.getElementById('appointment-form');
            const editingId = form.dataset.editingId;
            
            if (editingId) {
                console.log('🔄 Updating existing appointment:', editingId);
                updateAppointment(editingId);
                
                // Reset form state
                delete form.dataset.editingId;
                document.querySelector('.modal-title').textContent = 'Schedule New Appointment';
                document.querySelector('#appointment-form button[type="submit"]').innerHTML = '<i class="fas fa-save"></i> Schedule Appointment';
            } else {
                console.log('➕ Creating new appointment');
                saveAppointmentFromDashboard();
            }
        }

        // **FRESH START: Clear all appointment data**
        function clearAllAppointmentData() {
            console.log('🧹 Clearing all appointment data for fresh start...');
            
            // Remove all possible appointment storage keys
            const keysToRemove = [
                'monumeAppointments',
                'appointments', 
                'monume_appointments',
                'dashboardAppointments',
                'weeklyAppointments',
                'appointmentUpdateTrigger',
                'dashboardUpdateTrigger',
                'dashboardLastSync',
                'appointmentPageLastSync'
            ];
            
            keysToRemove.forEach(key => {
                localStorage.removeItem(key);
                console.log(`✅ Removed ${key}`);
            });
            
            // Update UI immediately
            updateDashboardAppointmentCount();
            loadWeeklyAppointments(true);
            
            console.log('🎉 Fresh start complete - all appointment data cleared!');
        }

        // Helper function to clear all appointments (for testing)
        window.clearAllAppointments = function() {
            if (confirm('🗑️ Clear all appointments? This cannot be undone!')) {
                clearAllAppointmentData();
                showSuccessNotification('All appointments cleared! Fresh start ready! 🎉');
            }
        };

        // **NEW: Test functions for appointment operations**
        window.testEditAppointment = function() {
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            if (appointments.length > 0) {
                console.log('🧪 Testing edit functionality with first appointment');
                editAppointment(appointments[0].id);
            } else {
                console.log('ℹ️ No appointments to edit. Creating test appointment first...');
                window.createTestAppointment();
                setTimeout(() => {
                    const newAppointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                    if (newAppointments.length > 0) {
                        editAppointment(newAppointments[newAppointments.length - 1].id);
                    }
                }, 500);
            }
        };

                 window.testDeleteAppointment = function() {
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             if (appointments.length > 0) {
                 console.log('🧪 Testing delete functionality with last appointment');
                 deleteAppointment(appointments[appointments.length - 1].id);
             } else {
                 console.log('ℹ️ No appointments to delete');
             }
         };

         // **COMPREHENSIVE: Test all appointment operations**
         window.runFullAppointmentTest = function() {
             console.log('🚀 === RUNNING FULL APPOINTMENT SYSTEM TEST ===');
             
             // Step 1: Clear existing data for clean test
             localStorage.removeItem('monumeAppointments');
             console.log('✅ Step 1: Cleared existing data');
             
             // Step 2: Create a test appointment
             console.log('📝 Step 2: Creating test appointment...');
             const testApt = window.createTestAppointment();
             
             setTimeout(() => {
                 // Step 3: Verify it was saved
                 const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                 console.log('✅ Step 3: Verified save - appointments count:', appointments.length);
                 
                 if (appointments.length > 0) {
                     // Step 4: Test edit functionality
                     console.log('📝 Step 4: Testing edit functionality...');
                     setTimeout(() => {
                         window.testEditAppointment();
                     }, 1000);
                     
                     // Step 5: Test sync
                     setTimeout(() => {
                         console.log('🔄 Step 5: Testing sync...');
                         window.forceSyncNow();
                     }, 2000);
                     
                     console.log('✅ Full test sequence initiated - check dashboard for results');
                     console.log('💡 You can also test delete by calling: testDeleteAppointment()');
                 } else {
                     console.error('❌ Test failed: No appointment was created');
                 }
             }, 500);
         };

         // **NEW: Quick appointment operations for testing**
         window.quickAddAppointment = function(name = 'Quick Test', type = 'MonuMe') {
             const quickApt = {
                 id: `quick-${Date.now()}`,
                 clientName: name,
                 clientEmail: `${name.toLowerCase().replace(' ', '')}@test.com`,
                 clientPhone: '555-QUICK',
                 date: new Date().toISOString().split('T')[0],
                 time: '10:00',
                 type: type,
                 hostId: 'admin',
                 notes: 'Quick test appointment',
                 status: 'scheduled',
                 createdAt: new Date().toISOString(),
                 url: `https://www.monumevip.com/appointment/quick-${Date.now()}`
             };
             
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             appointments.push(quickApt);
             localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
             
             triggerAppointmentSyncNotification();
             console.log('✅ Quick appointment added:', quickApt);
             return quickApt;
         };

         // **NEW: Status check function**
         window.checkAppointmentSystemStatus = function() {
             console.log('🔍 === APPOINTMENT SYSTEM STATUS ===');
             
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             console.log('📊 Total appointments:', appointments.length);
             
             const lastSync = localStorage.getItem('dashboardLastSync');
             console.log('🕐 Last sync:', lastSync ? new Date(parseInt(lastSync)).toLocaleString() : 'Never');
             
             // Check dashboard elements
             const addBtn = document.getElementById('appointment-add-btn');
             const viewBtn = document.getElementById('appointment-view-btn');
             const modal = document.getElementById('appointment-modal');
             const form = document.getElementById('appointment-form');
             
             console.log('🔧 Dashboard elements status:');
             console.log('   - Add button:', addBtn ? '✅ Found' : '❌ Missing');
             console.log('   - View button:', viewBtn ? '✅ Found' : '❌ Missing');
             console.log('   - Modal:', modal ? '✅ Found' : '❌ Missing');
             console.log('   - Form:', form ? '✅ Found' : '❌ Missing');
             
             // Check if form is in edit mode
             if (form && form.dataset.editingId) {
                 console.log('📝 Form is in EDIT mode for appointment:', form.dataset.editingId);
             } else {
                 console.log('➕ Form is in CREATE mode');
             }
             
             console.log('✅ Status check complete');
         };

        // Load appointment count on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Migrate any existing appointments first
            migrateAppointments();
            // Then update count
            updateAppointmentCount();
        });

        // Test functions for debugging - can be called from browser console
        window.testAppointmentModal = function() {
            console.log('🧪 Testing appointment modal from console...');
            openAppointmentModal();
        };

        window.checkElements = function() {
            console.log('🔍 Checking elements...');
            console.log('ADD button:', document.getElementById('appointment-add-btn'));
            console.log('VIEW button:', document.getElementById('appointment-view-btn'));
            console.log('Modal:', document.getElementById('appointment-modal'));
            console.log('Form:', document.getElementById('appointment-form'));
            console.log('Client name input:', document.getElementById('client-name'));
            console.log('Hour select:', document.getElementById('appointment-hour'));
        };

        window.forceOpenModal = function() {
            console.log('🔧 Force opening modal...');
            const modal = document.getElementById('appointment-modal');
            if (modal) {
                modal.style.display = 'flex';
                modal.style.visibility = 'visible';
                modal.style.opacity = '1';
                modal.style.zIndex = '9999';
                modal.classList.add('active');
                console.log('✅ Modal force opened');
            }
        };

        // **SYNC TEST: Create a test appointment to verify dashboard-appointment.html sync**
        window.createTestAppointment = function() {
            console.log('🧪 Creating test appointment for sync verification...');
            
            const testAppointment = {
                id: `test-${Date.now()}`,
                clientName: 'Test Client',
                clientEmail: 'test@email.com',
                clientPhone: '555-TEST',
                date: new Date().toISOString().split('T')[0], // Today
                time: '14:30', // 2:30 PM
                type: 'MonuMe',
                hostId: 'admin',
                notes: 'Test appointment for sync verification',
                status: 'scheduled',
                url: `https://www.monuevip.com/appointment/test-${Date.now()}`
            };
            
            // Save to localStorage
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            appointments.push(testAppointment);
            localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
            
            // Trigger sync
            triggerAppointmentSyncNotification();
            
            // Update dashboard
            loadWeeklyAppointments();
            updateDashboardAppointmentCount();
            
            console.log('✅ Test appointment created:', testAppointment);
            console.log('💡 Go to appointment.html to verify it appears in both calendar and list view');
            
            return testAppointment;
        };

        // **NEW: Enhanced debugging functions for sync issues**
        window.debugAppointmentSyncDetailed = function() {
            console.log('🔍 === DETAILED APPOINTMENT SYNC DEBUG ===');
            
            // Check localStorage data
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            console.log('📊 Total appointments in storage:', appointments.length);
            
            // Check timestamps
            const lastDashboardSync = localStorage.getItem('dashboardLastSync');
            const lastAppointmentPageSync = localStorage.getItem('appointmentPageLastSync');
            console.log('🕐 Dashboard last sync:', lastDashboardSync ? new Date(parseInt(lastDashboardSync)).toLocaleString() : 'Never');
            console.log('🕐 Appointment page last sync:', lastAppointmentPageSync ? new Date(parseInt(lastAppointmentPageSync)).toLocaleString() : 'Never');
            
            // Check this week's appointments
            const now = new Date();
            const startOfWeek = new Date(now);
            startOfWeek.setDate(now.getDate() - now.getDay());
            startOfWeek.setHours(0, 0, 0, 0);
            
            const thisWeekAppointments = appointments.filter(apt => {
                const aptDate = new Date(apt.date);
                return aptDate >= startOfWeek && aptDate <= new Date(startOfWeek.getTime() + 7 * 24 * 60 * 60 * 1000);
            });
            
            console.log('📅 This week appointments:', thisWeekAppointments.length);
            thisWeekAppointments.forEach(apt => {
                console.log(`   - ${apt.clientName} on ${apt.date} at ${apt.time} (${apt.status})`);
            });
            
            // Force refresh
            console.log('🔄 Forcing dashboard refresh...');
            loadWeeklyAppointments(true);
        };

        window.forceSyncNow = function() {
            console.log('🚀 FORCING IMMEDIATE SYNC...');
            
            // Clear any cached timestamps
            localStorage.removeItem('dashboardLastSync');
            
            // Force refresh everything
            loadWeeklyAppointments(true);
            updateDashboardAppointmentCount();
            triggerAppointmentSyncNotification();
            
            console.log('✅ Forced sync complete');
            
            setTimeout(() => {
                console.log('📊 Updated appointment count displayed');
                const count = document.querySelector('.appointments-card-value')?.textContent;
                console.log('Current dashboard count:', count);
            }, 1000);
        };

        window.simulateAppointmentChange = function() {
            console.log('🎭 Simulating appointment change...');
            
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            if (appointments.length > 0) {
                // Modify the first appointment
                appointments[0].clientName = `Modified Client ${Date.now()}`;
                appointments[0].status = appointments[0].status === 'completed' ? 'scheduled' : 'completed';
                
                localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
                console.log('✅ Modified appointment:', appointments[0]);
                
                // Trigger sync
                triggerAppointmentSyncNotification();
            } else {
                console.log('ℹ️ No appointments to modify, creating one...');
                window.createTestAppointment();
            }
        };

        // **NEW: Real-time sync status indicator**
        function showSyncStatus(status, message) {
            const existingStatus = document.getElementById('sync-status-indicator');
            if (existingStatus) {
                existingStatus.remove();
            }
            
            const statusIndicator = document.createElement('div');
            statusIndicator.id = 'sync-status-indicator';
            statusIndicator.style.cssText = `
                position: fixed;
                bottom: 20px;
                right: 20px;
                padding: 8px 12px;
                border-radius: 20px;
                font-size: 12px;
                font-weight: 600;
                z-index: 1000;
                transition: all 0.3s ease;
                display: flex;
                align-items: center;
                gap: 6px;
                box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            `;
            
            const colors = {
                syncing: 'background: #3b82f6; color: white;',
                synced: 'background: #10b981; color: white;',
                error: 'background: #ef4444; color: white;',
                warning: 'background: #f59e0b; color: white;'
            };
            
            const icons = {
                syncing: 'fa-sync-alt fa-spin',
                synced: 'fa-check-circle',
                error: 'fa-exclamation-circle',
                warning: 'fa-exclamation-triangle'
            };
            
            statusIndicator.style.cssText += colors[status] || colors.synced;
            statusIndicator.innerHTML = `
                <i class="fas ${icons[status] || icons.synced}"></i>
                ${message}
            `;
            
            document.body.appendChild(statusIndicator);
            
            // Auto remove after 3 seconds for success states
            if (status === 'synced') {
                setTimeout(() => {
                    if (statusIndicator.parentNode) {
                        statusIndicator.style.opacity = '0';
                        setTimeout(() => statusIndicator.remove(), 300);
                    }
                }, 3000);
            }
        }

        // Show sync status when appointments are updated
        const originalTriggerSync = triggerAppointmentSyncNotification;
        triggerAppointmentSyncNotification = function() {
            showSyncStatus('syncing', 'Syncing appointments...');
            originalTriggerSync();
            setTimeout(() => {
                showSyncStatus('synced', 'Appointments synced');
            }, 500);
        };

        // **FRESH START: Simple test function to verify everything is working**
        window.testFreshSetup = function() {
            console.log('🧪 === TESTING FRESH SETUP ===');
            
            // Check if appointment data is clean
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            console.log('📊 Current appointments count:', appointments.length);
            
            if (appointments.length === 0) {
                console.log('✅ Fresh start successful - no old appointment data found');
            } else {
                console.log('⚠️ Some appointment data still exists:', appointments);
            }
            
            // Check dashboard count
            const dashboardCount = document.querySelector('.appointments-card-value')?.textContent;
            console.log('📊 Dashboard shows:', dashboardCount, 'appointments');
            
            // Check if badges will appear on right side
            console.log('🎯 Badge positioning: RIGHT SIDE (as requested)');
            
            console.log('✅ Test complete - ready for fresh appointments!');
        };

        // **NEW: Test upcoming appointments filtering**
        window.testUpcomingAppointments = function() {
            console.log('🧪 === TESTING UPCOMING APPOINTMENTS FILTERING ===');
            
            // Create test appointments for different days
            const today = new Date();
            const tomorrow = new Date(today);
            tomorrow.setDate(today.getDate() + 1);
            const nextWeek = new Date(today);
            nextWeek.setDate(today.getDate() + 8); // 8 days from now (should NOT appear)
            
            const testAppointments = [
                {
                    id: 'test-today',
                    clientName: 'Today Client',
                    clientEmail: 'today@test.com',
                    clientPhone: '555-TODAY',
                    date: today.toISOString().split('T')[0],
                    time: '14:00',
                    type: 'MonuMe',
                    status: 'confirmed',
                    hostId: 'admin',
                    notes: 'Today appointment test'
                },
                {
                    id: 'test-tomorrow',
                    clientName: 'Tomorrow Client',
                    clientEmail: 'tomorrow@test.com',
                    clientPhone: '555-TOMORROW',
                    date: tomorrow.toISOString().split('T')[0],
                    time: '10:00',
                    type: 'FameMe',
                    status: 'scheduled',
                    hostId: 'admin',
                    notes: 'Tomorrow appointment test'
                },
                {
                    id: 'test-nextweek',
                    clientName: 'Next Week Client',
                    clientEmail: 'nextweek@test.com',
                    clientPhone: '555-NEXTWEEK',
                    date: nextWeek.toISOString().split('T')[0],
                    time: '16:00',
                    type: 'CrystalMe',
                    status: 'pending',
                    hostId: 'admin',
                    notes: 'Next week appointment test (should NOT appear)'
                }
            ];
            
            // Save test appointments
            localStorage.setItem('monumeAppointments', JSON.stringify(testAppointments));
            
            // Trigger refresh
            loadWeeklyAppointments(true);
            
            console.log('✅ Test appointments created:');
            console.log('   - Today appointment (should appear with TODAY badge)');
            console.log('   - Tomorrow appointment (should appear with TOMORROW badge)');
            console.log('   - Next week appointment (should NOT appear - beyond 7 days)');
            console.log('');
                         console.log('📊 Check dashboard to see filtering in action!');
             console.log('🎯 Status badges should appear on the RIGHT SIDE');
         };

         // **NEW: Debug function to check appointment sync issues**
         window.debugAppointmentDisplay = function() {
             console.log('🔍 === DEBUGGING APPOINTMENT DISPLAY ===');
             
             // Check localStorage data
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             console.log('📊 Total appointments in storage:', appointments.length);
             
             if (appointments.length > 0) {
                 console.log('📋 All appointments:');
                 appointments.forEach((apt, index) => {
                     console.log(`   ${index + 1}. ${apt.clientName} - ${apt.date} at ${apt.time} (${apt.status || 'scheduled'})`);
                 });
             }
             
             // Check what should be displayed (next 7 days)
             const today = new Date();
             const startDate = new Date(today);
             startDate.setHours(0, 0, 0, 0);
             const endDate = new Date(today);
             endDate.setDate(today.getDate() + 7);
             endDate.setHours(23, 59, 59, 999);
             
             console.log('📅 Date range for upcoming appointments:');
             console.log('   From:', startDate.toDateString());
             console.log('   To:', endDate.toDateString());
             
             const shouldShow = appointments.filter(apt => {
                 const aptDate = new Date(apt.date + 'T00:00:00');
                 return aptDate >= startDate && aptDate <= endDate;
             });
             
             console.log('✅ Appointments that SHOULD be displayed:');
             if (shouldShow.length > 0) {
                 shouldShow.forEach((apt, index) => {
                     const aptDate = new Date(apt.date);
                     const isToday = aptDate.toDateString() === today.toDateString();
                     const isTomorrow = aptDate.toDateString() === new Date(today.getTime() + 24 * 60 * 60 * 1000).toDateString();
                     const daysUntil = Math.ceil((aptDate - today) / (1000 * 60 * 60 * 24));
                     
                     console.log(`   ${index + 1}. ${apt.clientName} - ${apt.date} at ${apt.time}`);
                     console.log(`      Status: ${apt.status || 'scheduled'}`);
                     console.log(`      Badge: ${isToday ? 'TODAY' : isTomorrow ? 'TOMORROW' : `IN ${daysUntil} DAYS`}`);
                 });
             } else {
                 console.log('   ❌ No appointments found for the next 7 days');
             }
             
             // Force refresh
             console.log('🔄 Forcing dashboard refresh...');
             loadWeeklyAppointments(true);
         };

         // **NEW: Quick function to sync with appointment.html data**
         window.syncWithAppointmentPage = function() {
             console.log('🔄 === SYNCING WITH APPOINTMENT PAGE ===');
             
             // Trigger all possible sync mechanisms
             triggerAppointmentSyncNotification();
             
             // Force reload from storage
             setTimeout(() => {
                 loadWeeklyAppointments(true);
                 updateDashboardAppointmentCount();
                 console.log('✅ Sync complete - check dashboard display');
             }, 200);
         };

         // **NEW: Perfect sync tester - ensures EXACT same data**
         window.perfectSyncTest = function() {
             console.log('🎯 === PERFECT SYNC TEST WITH APPOINTMENT.HTML ===');
             
             // Check if appointment manager exists (from appointment.html)
             if (window.appointmentManager) {
                 console.log('✅ Appointment manager found - we can compare data');
                 
                 const managerData = window.appointmentManager.appointments;
                 const localStorageData = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                 
                 console.log('📊 Appointment Manager data:', managerData.length, 'appointments');
                 console.log('📊 localStorage data:', localStorageData.length, 'appointments');
                 
                 if (managerData.length === localStorageData.length) {
                     console.log('✅ PERFECT SYNC: Both sources have same count');
                 } else {
                     console.log('❌ SYNC ISSUE: Data count mismatch!');
                     console.log('🔄 Forcing appointment manager to save...');
                     window.appointmentManager.saveAppointmentsToStorage();
                     
                     setTimeout(() => {
                         console.log('🔄 Reloading dashboard...');
                         loadWeeklyAppointments(true);
                     }, 100);
                 }
                 
                 // Show each appointment comparison
                 console.log('📋 Detailed comparison:');
                 managerData.forEach((apt, index) => {
                     const localApt = localStorageData.find(la => la.id === apt.id);
                     console.log(`${index + 1}. ${apt.clientName} - ${localApt ? 'FOUND' : 'MISSING'} in localStorage`);
                 });
                 
             } else {
                 console.log('⚠️ Appointment manager not found - we are not on appointment.html');
                 console.log('💡 Run this test from appointment.html for perfect comparison');
                 
                 // Just sync from localStorage
                 console.log('📋 Using localStorage data only...');
                 const data = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                 console.log('📊 Found', data.length, 'appointments in localStorage');
                 
                 if (data.length > 0) {
                     console.log('📝 Appointments:');
                     data.forEach((apt, index) => {
                         console.log(`   ${index + 1}. ${apt.clientName} - ${apt.date} at ${apt.time}`);
                     });
                 }
                 
                 loadWeeklyAppointments(true);
             }
         };

         // **NEW: Force dashboard to show ALL localStorage appointments**
         window.showAllAppointmentsFromStorage = function() {
             console.log('📋 === SHOWING ALL APPOINTMENTS FROM LOCALSTORAGE ===');
             
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             console.log('📊 Total appointments in localStorage:', appointments.length);
             
             if (appointments.length === 0) {
                 console.log('❌ No appointments found in localStorage');
                 console.log('💡 Go to appointment.html and create some appointments first');
                 return;
             }
             
             // Show all appointments regardless of date
             console.log('📝 All appointments:');
             appointments.forEach((apt, index) => {
                 const aptDate = new Date(apt.date);
                 const today = new Date();
                 const daysDiff = Math.ceil((aptDate - today) / (1000 * 60 * 60 * 24));
                 
                 console.log(`${index + 1}. ${apt.clientName}`);
                 console.log(`   📅 Date: ${apt.date} (${daysDiff > 0 ? `${daysDiff} days ahead` : daysDiff < 0 ? `${Math.abs(daysDiff)} days ago` : 'TODAY'})`);
                 console.log(`   ⏰ Time: ${apt.time}`);
                 console.log(`   🏷️ Type: ${apt.type}`);
                 console.log(`   📝 Status: ${apt.status || 'scheduled'}`);
                 console.log(`   ${daysDiff >= 0 && daysDiff <= 7 ? '✅ SHOULD APPEAR on dashboard' : '❌ Will NOT appear (outside 7-day range)'}`);
                 console.log('');
             });
             
             // Force immediate refresh
             console.log('🔄 Forcing dashboard refresh...');
             loadWeeklyAppointments(true);
             
             // Count what should appear
             const upcomingCount = appointments.filter(apt => {
                 const aptDate = new Date(apt.date + 'T00:00:00');
                 const today = new Date();
                 today.setHours(0, 0, 0, 0);
                 const endDate = new Date(today);
                 endDate.setDate(today.getDate() + 7);
                 return aptDate >= today && aptDate <= endDate;
             }).length;
             
             console.log(`🎯 ${upcomingCount} appointments should appear on dashboard (next 7 days)`);
         };

         // **NEW: Create test appointment in same format as appointment.html**
         window.createTestAppointmentForDashboard = function() {
             console.log('🧪 === CREATING TEST APPOINTMENT FOR DASHBOARD ===');
             
             const today = new Date();
             const testApt = {
                 id: 'dashboard-test-' + Date.now(),
                 clientName: 'Dashboard Test Client',
                 clientEmail: 'dashboard@test.com',
                 clientPhone: '(555) 123-DASH',
                 date: today.toISOString().split('T')[0], // Today
                 time: '15:30', // 3:30 PM
                 type: 'MonuMe',
                 status: 'confirmed',
                 notes: 'Test appointment created for dashboard sync testing',
                 hostId: 'admin',
                 createdAt: new Date().toISOString(),
                 url: `https://www.monuevip.com/appointment/dashboard-test-${Date.now()}`
             };
             
             // Get existing appointments and add the new one
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             appointments.push(testApt);
             
             // Save using the EXACT same method as appointment.html
             localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
             console.log('✅ Test appointment created and saved to localStorage');
             console.log('📋 Appointment details:', testApt);
             
             // Force immediate sync
             console.log('🔄 Triggering immediate dashboard sync...');
             setTimeout(() => {
                 loadWeeklyAppointments(true);
                 updateDashboardAppointmentCount();
                 console.log('✅ Dashboard should now show the new appointment!');
             }, 100);
             
             return testApt;
         };

         // **NEW: Create multiple test appointments to test layout with many appointments**
         window.createManyTestAppointments = function() {
             console.log('🧪 === CREATING MANY TEST APPOINTMENTS FOR LAYOUT TESTING ===');
             
             const clients = [
                 { name: 'John Smith', email: 'john@example.com', phone: '(555) 123-0001', type: 'MonuMe' },
                 { name: 'Sarah Johnson', email: 'sarah@example.com', phone: '(555) 123-0002', type: 'FameMe' },
                 { name: 'Michael Brown', email: 'michael@example.com', phone: '(555) 123-0003', type: 'CrystalMe' },
                 { name: 'Emily Davis', email: 'emily@example.com', phone: '(555) 123-0004', type: 'MonuMe' },
                 { name: 'David Wilson', email: 'david@example.com', phone: '(555) 123-0005', type: 'FameMe' },
                 { name: 'Lisa Anderson', email: 'lisa@example.com', phone: '(555) 123-0006', type: 'CrystalMe' },
                 { name: 'Robert Taylor', email: 'robert@example.com', phone: '(555) 123-0007', type: 'MonuMe' },
                 { name: 'Jennifer Martinez', email: 'jennifer@example.com', phone: '(555) 123-0008', type: 'FameMe' }
             ];
             
             const statuses = ['scheduled', 'confirmed', 'completed', 'rescheduled'];
             const times = ['09:00', '10:30', '11:00', '13:30', '14:00', '15:30', '16:00', '17:00'];
             
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             
             // Create appointments for today, tomorrow, and next few days
             for (let i = 0; i < clients.length; i++) {
                 const client = clients[i];
                 const dayOffset = Math.floor(i / 2); // 2 appointments per day
                 const appointmentDate = new Date();
                 appointmentDate.setDate(appointmentDate.getDate() + dayOffset);
                 
                 const testApt = {
                     id: `layout-test-${Date.now()}-${i}`,
                     clientName: client.name,
                     clientEmail: client.email,
                     clientPhone: client.phone,
                     date: appointmentDate.toISOString().split('T')[0],
                     time: times[i % times.length],
                     type: client.type,
                     status: statuses[i % statuses.length],
                     notes: `Test appointment ${i + 1} for layout testing`,
                     hostId: 'admin',
                     createdAt: new Date().toISOString(),
                     url: `https://www.monuevip.com/appointment/layout-test-${Date.now()}-${i}`
                 };
                 
                 appointments.push(testApt);
             }
             
             localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
             console.log('✅ Created', clients.length, 'test appointments');
             
             // Trigger refresh
             setTimeout(() => {
                 loadWeeklyAppointments(true);
                 updateDashboardAppointmentCount();
                 console.log('✅ Dashboard should now show many appointments with improved layout!');
                 console.log('💡 Check how the appointment rows handle multiple appointments');
             }, 100);
             
             return appointments;
         };

         // **NEW: Simple sync test function**
         window.testSyncWithAppointmentPage = function() {
             console.log('🧪 === TESTING SYNC WITH APPOINTMENT PAGE ===');
             
             const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
             console.log('📊 Total appointments in localStorage:', appointments.length);
             
             if (appointments.length > 0) {
                 console.log('📋 Appointments found:');
                 appointments.forEach((apt, index) => {
                     console.log(`   ${index + 1}. ${apt.clientName} - ${apt.date} at ${apt.time}`);
                 });
             } else {
                 console.log('❌ No appointments found in localStorage');
                 console.log('💡 Go to appointment.html and create some appointments first');
             }
             
             // Force refresh dashboard
             console.log('🔄 Refreshing dashboard...');
             loadWeeklyAppointments(true);
             
             console.log('✅ Test complete - check dashboard for appointments');
         };
    </script>

    <!-- Include Team MonuMe functionality -->
    <script src="js/team-monume-activeusers.js"></script>
    
    <!-- **FIXED: Complete Team MonuMe Card System** -->
    <script>
        // **TEAM MONUME CARD - SINGLE WORKING SYSTEM**
        
        function setupActiveUsersButtonsReal() {
            console.log('🔧 Setting up Team MonuMe card buttons...');
            
            // Get the buttons
            const startSessionBtn = document.getElementById('start-session-btn');
            const viewActiveBtn = document.getElementById('view-active-users-btn');
            
            // Start Session button
            if (startSessionBtn) {
                startSessionBtn.addEventListener('click', function() {
                    console.log('🚀 Start Session clicked');
                    openUserSelectionModal();
                });
                console.log('✅ Start Session button set up');
            } else {
                console.error('❌ Start Session button not found');
            }
            
            // View Active button
            if (viewActiveBtn) {
                viewActiveBtn.addEventListener('click', function() {
                    console.log('👥 View Active clicked');
                    openActiveUsersModal();
                });
                console.log('✅ View Active button set up');
            } else {
                console.error('❌ View Active button not found');
            }
        }
        
        function initializeUsersDatabase() {
            console.log('📊 Initializing users database...');
            
            // Create default users if none exist
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            if (existingUsers.length === 0) {
                const defaultUsers = [
                    { username: 'admin', password: 'admin123', role: 'admin', name: 'Administrator' },
                    { username: 'manager', password: 'manager123', role: 'manager', name: 'Manager' },
                    { username: 'staff1', password: 'staff123', role: 'staff', name: 'Staff Member 1' },
                    { username: 'staff2', password: 'staff123', role: 'staff', name: 'Staff Member 2' }
                ];
                localStorage.setItem('users', JSON.stringify(defaultUsers));
                console.log('✅ Default users created');
            } else {
                console.log('✅ Users database already exists with', existingUsers.length, 'users');
            }
            
            // Don't automatically add current user as active - let them manually start sessions
            console.log('✅ Dashboard initialized - users can manually start sessions');
        }
        
        // **ENHANCED: Location-based user filtering and duplicate session prevention (server-aware)**
        async function getFilteredUsers() {
            const currentUserRole = localStorage.getItem('role');
            const locationCtx = (typeof getCurrentLocationContext === 'function')
                ? getCurrentLocationContext()
                : { id: null, code: (localStorage.getItem('location') || ''), name: (localStorage.getItem('location_name') || '') };

            // Try to fetch fresh users from server
            const normalizeUsers = (list) => (Array.isArray(list) ? list : []).map(u => ({
                id: u.id || u.user_id || u.userId,
                username: u.username || u.user_name || u.name || '',
                name: u.name || u.full_name || u.username || '',
                role: u.role || u.user_role || 'employee',
                location: u.location || u.location_username || u.locationCode || '',
                location_name: u.location_name || u.locationName || '',
                location_id: u.location_id || u.locationId || null
            }));

            let serverUsers = [];
            try {
                const resp = await fetch('/api/users?all=true&per_page=1000', { credentials: 'include' }).catch(() => ({ ok: false }));
                if (resp && resp.ok) {
                    const json = await resp.json();
                    const list = Array.isArray(json) ? json : (json.users || []);
                    serverUsers = normalizeUsers(list);
                } else {
                    // Fallback endpoint
                    const r2 = await fetch('/get_users_for_tracking', { credentials: 'include' }).catch(() => ({ ok: false }));
                    if (r2 && r2.ok) {
                        const data = await r2.json();
                        const list2 = Array.isArray(data) ? data : (data.users || []);
                        serverUsers = normalizeUsers(list2);
                    }
                }
            } catch (_) {
                // ignore
            }

            // If no server users, fallback to localStorage datasets
            let users = serverUsers;
            if (!users || users.length === 0) {
                try {
                    users = normalizeUsers(JSON.parse(localStorage.getItem('users') || '[]'));
                } catch (_) {
                    users = [];
                }

                if (users.length === 0) {
                    try {
                        const locationUsersRaw = localStorage.getItem('locationUsers');
                        if (locationUsersRaw) {
                            const locationUsersMap = JSON.parse(locationUsersRaw);
                            const allUsersFromMap = Object.values(locationUsersMap || {}).reduce((acc, arr) => acc.concat(arr), []);
                            users = normalizeUsers(allUsersFromMap);
                        }
                    } catch (_) {
                        // ignore
                    }
                }
            }

            // Admin sees all
            if (currentUserRole === 'admin') {
                return users;
            }

            // Filter by current location
            return users.filter(u => {
                const code = String(u.location || '').toLowerCase();
                const name = String(u.location_name || '').toLowerCase();
                const idNum = (u.location_id !== null && u.location_id !== undefined) ? Number(u.location_id) : null;

                if (locationCtx.code && code && String(locationCtx.code).toLowerCase() === code) return true;
                if (locationCtx.name && name && String(locationCtx.name).toLowerCase() === name) return true;
                if (locationCtx.id !== null && idNum !== null && Number(locationCtx.id) === idNum) return true;
                return false;
            });
        }

        function isUserAlreadyActive(username) {
            const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
            const currentTime = Date.now();
            
            // Check if user is currently active (within 5 minutes)
            const activeUser = activeUsers.find(user => {
                const timeSinceActivity = currentTime - user.lastActivity;
                return user.username === username && timeSinceActivity < (5 * 60 * 1000);
            });
            
            return !!activeUser;
        }

        async function openUserSelectionModal() {
            console.log('👥 Opening user selection modal with location filtering...');
            
            const users = await getFilteredUsers();
            if (users.length === 0) {
                showTeamSuccessMessage('❌ No users found for your location. Please contact administrator.');
                return;
            }
            
            // Open the proper user selection modal
            const modal = document.getElementById('user-modal');
            const usersGrid = document.getElementById('users-grid');
            
            if (!modal || !usersGrid) {
                console.error('❌ User selection modal elements not found');
                return;
            }
            
            // Clear and populate users grid
            usersGrid.innerHTML = '';
            
            let availableUsers = 0;
            
            users.forEach(user => {
                const isAlreadyActive = isUserAlreadyActive(user.username);
                
                const userCard = document.createElement('div');
                userCard.className = `user-card ${isAlreadyActive ? 'user-already-active' : ''}`;
                userCard.innerHTML = `
                    <div class="user-name">${user.name || user.username}</div>
                    <div class="user-role">(${user.username})</div>
                    ${user.location ? `<div class="user-location">${user.location}</div>` : ''}
                    ${isAlreadyActive ? '<div class="user-status">Already Active</div>' : ''}
                `;
                
                if (!isAlreadyActive) {
                    userCard.addEventListener('click', function() {
                        selectUserForSession(user);
                    });
                    availableUsers++;
                } else {
                    userCard.style.opacity = '0.5';
                    userCard.style.cursor = 'not-allowed';
                    userCard.title = 'This user is already active';
                }
                
                usersGrid.appendChild(userCard);
            });
            
            // Show message if no available users
            if (availableUsers === 0) {
                const noUsersMsg = document.createElement('div');
                noUsersMsg.className = 'no-available-users';
                noUsersMsg.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                        <h4>All Users Active</h4>
                        <p>All users in your location are currently active</p>
                    </div>
                `;
                usersGrid.appendChild(noUsersMsg);
            }
            
            // Show modal with forced centering
            modal.removeAttribute('style');
            modal.classList.add('show');
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(8px) !important;
            `;
            
            console.log(`✅ User selection modal opened. Available users: ${availableUsers}/${users.length}`);
        }
        
        async function openActiveUsersModal() {
            console.log('👁️ Opening active users modal with location filtering...');
            
            const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
            const currentTime = Date.now();
            const currentUserRole = localStorage.getItem('role');
            const currentLocation = localStorage.getItem('location');
            
            // Filter only currently active users (within 5 minutes)
            let currentlyActive = activeUsers.filter(user => {
                const timeSinceActivity = currentTime - user.lastActivity;
                return timeSinceActivity < (5 * 60 * 1000);
            });
            
            // Apply location filtering for non-admin users
            if (currentUserRole !== 'admin' && currentLocation && currentLocation !== 'all') {
                const locationUsers = await getFilteredUsers();
                const locationUsernames = locationUsers.map(u => u.username);
                currentlyActive = currentlyActive.filter(user => 
                    locationUsernames.includes(user.username)
                );
            }
            
            // Open the proper active users modal
            const modal = document.getElementById('active-users-modal');
            const activeUsersList = document.getElementById('active-users-list');
            
            if (!modal || !activeUsersList) {
                console.error('❌ Active users modal elements not found');
                return;
            }
            
            // Clear and populate active users list
            activeUsersList.innerHTML = '';
            
            if (currentlyActive.length === 0) {
                activeUsersList.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-users-slash" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                        <h4>No Active Users</h4>
                        <p>No users are currently active${currentUserRole !== 'admin' ? ' in your location' : ''}</p>
                    </div>
                `;
            } else {
                currentlyActive.forEach((user, index) => {
                    const sessionDuration = Math.floor((currentTime - user.sessionStart) / (1000 * 60)); // minutes
                    const lastActivity = Math.floor((currentTime - user.lastActivity) / (1000 * 60)); // minutes ago
                    
                    const userItem = document.createElement('div');
                    userItem.className = 'active-user-item';
                    userItem.innerHTML = `
                        <div class="active-user-info">
                            <div class="user-avatar">
                                <i class="fas fa-user"></i>
                            </div>
                            <div>
                                <div class="user-name">${user.username}</div>
                                <div class="session-time">Session: ${sessionDuration} min • Last active: ${lastActivity === 0 ? 'Just now' : lastActivity + 'm ago'}</div>
                            </div>
                        </div>
                        <div class="user-actions">
                            <button class="inactive-btn" onclick="openInactiveModal('${user.username}')">
                                <i class="fas fa-pause"></i> Make Inactive
                            </button>
                            ${isAdminOrManager() ? `
                            <button class="forceout-btn" onclick="openForceOutModalForUser('${user.username}')">
                                <i class="fas fa-user-times"></i> Force Out
                            </button>
                            ` : ''}
                        </div>
                    `;
                    
                    activeUsersList.appendChild(userItem);
                });
            }
            
            // Show modal with forced centering
            modal.removeAttribute('style');
            modal.classList.add('show');
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(8px) !important;
            `;
            
            console.log(`✅ Active users modal opened. Active users: ${currentlyActive.length}`);
        }
        
        // **ENHANCED: Better user session validation**
        function selectUserForSession(user) {
            console.log('👤 User selected for session:', user.name || user.username);
            
            // Double-check if user is already active
            if (isUserAlreadyActive(user.username)) {
                showTeamSuccessMessage('❌ This user is already active. Cannot start duplicate session.');
                closeUserModal();
                return;
            }
            
            // Close user selection modal
            closeUserModal();
            
            // Open password confirmation modal
            const passwordModal = document.getElementById('password-modal');
            const passwordUserName = document.getElementById('password-user-name');
            const passwordUserRole = document.getElementById('password-user-role');
            
            if (passwordModal && passwordUserName && passwordUserRole) {
                passwordUserName.textContent = user.name || user.username;
                passwordUserRole.textContent = user.role || user.username;
                
                // Store selected user for password confirmation
                passwordModal.dataset.selectedUser = JSON.stringify(user);
                
                passwordModal.removeAttribute('style');
                passwordModal.classList.add('show');
                passwordModal.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    display: flex !important;
                    justify-content: center !important;
                    align-items: center !important;
                    z-index: 10000 !important;
                    background: rgba(0, 0, 0, 0.6) !important;
                    backdrop-filter: blur(8px) !important;
                `;
                
                // Focus password input
                const passwordInput = document.getElementById('password-input');
                if (passwordInput) {
                    setTimeout(() => passwordInput.focus(), 100);
                }
            }
        }
        
        function closeUserModal() {
            const modal = document.getElementById('user-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }
        
        function closePasswordModal() {
            const modal = document.getElementById('password-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                // Clear password input
                const passwordInput = document.getElementById('password-input');
                if (passwordInput) {
                    passwordInput.value = '';
                }
            }
        }
        
        // **ENHANCED: Better password confirmation with duplicate check**
        function confirmPassword() {
            const modal = document.getElementById('password-modal');
            const passwordInput = document.getElementById('password-input');
            
            if (!modal || !passwordInput) {
                return;
            }
            
            const selectedUser = JSON.parse(modal.dataset.selectedUser || '{}');
            const enteredPassword = passwordInput.value.trim();
            
            if (!enteredPassword) {
                showTeamSuccessMessage('❌ Please enter a password');
                return;
            }
            
            // Final check for duplicate session
            if (isUserAlreadyActive(selectedUser.username)) {
                showTeamSuccessMessage('❌ User became active while you were entering password. Cannot start duplicate session.');
                closePasswordModal();
                return;
            }
            
            if (enteredPassword === selectedUser.password) {
                // Success - start session
                addActiveUser(selectedUser.username, selectedUser.username);
                showTeamSuccessMessage(`✅ Session started for ${selectedUser.name || selectedUser.username}`);
                closePasswordModal();
            } else {
                // Wrong password
                showTeamSuccessMessage('❌ Invalid password');
                passwordInput.value = '';
                passwordInput.focus();
            }
        }
        
        function closeActiveUsersModal() {
            const modal = document.getElementById('active-users-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
            }
        }
        
        // **NEW: Enhanced inactive user modal with password verification**
        function openInactiveModal(username) {
            console.log('⏸️ Opening inactive modal for:', username);
            
            const modal = document.getElementById('inactive-confirm-modal');
            const inactiveUserName = document.getElementById('inactive-user-name');
            const inactiveUserRole = document.getElementById('inactive-user-role');
            const passwordInput = document.getElementById('inactive-password-input');
            
            if (!modal || !inactiveUserName || !passwordInput) {
                console.error('❌ Inactive modal elements not found');
                return;
            }
            
            // Get user details
            const users = getFilteredUsers();
            const user = users.find(u => u.username === username);
            
            if (!user) {
                showTeamSuccessMessage('❌ User not found');
                return;
            }
            
            // Populate modal
            inactiveUserName.textContent = user.name || username;
            if (inactiveUserRole) {
                inactiveUserRole.textContent = user.role || 'User';
            }
            
            // Store target username for later use
            modal.dataset.targetUsername = username;
            
            // Clear password field
            passwordInput.value = '';
            
            // Show modal
            modal.removeAttribute('style');
            modal.classList.add('show');
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(8px) !important;
            `;
            
            // Focus password input
            setTimeout(() => passwordInput.focus(), 100);
        }

        function closeInactiveModal() {
            const modal = document.getElementById('inactive-confirm-modal');
            if (modal) {
                modal.style.display = 'none';
                modal.classList.remove('show');
                const passwordInput = document.getElementById('inactive-password-input');
                if (passwordInput) {
                    passwordInput.value = '';
                }
            }
        }

        // **NEW: Confirm inactive with password verification**
        function confirmInactive() {
            const modal = document.getElementById('inactive-confirm-modal');
            const passwordInput = document.getElementById('inactive-password-input');
            
            if (!modal || !passwordInput) {
                return;
            }
            
            const targetUsername = modal.dataset.targetUsername;
            const enteredPassword = passwordInput.value.trim();
            const currentUsername = localStorage.getItem('username');
            
            if (!enteredPassword) {
                showTeamSuccessMessage('❌ Please enter your password');
                return;
            }
            
            // Verify password against current user
            const users = getFilteredUsers();
            const currentUser = users.find(u => u.username === currentUsername);
            
            if (!currentUser) {
                showTeamSuccessMessage('❌ Current user not found');
                return;
            }
            
            if (enteredPassword !== currentUser.password) {
                showTeamSuccessMessage('❌ Invalid password');
                passwordInput.value = '';
                passwordInput.focus();
                return;
            }
            
            // Password is correct - proceed with making user inactive
            removeActiveUser(targetUsername);
            showTeamSuccessMessage(`🔴 ${targetUsername} marked as inactive`);
            closeInactiveModal();
            
            // Refresh the active users modal
            setTimeout(() => {
                openActiveUsersModal();
            }, 500);
        }

        function makeUserInactive(username) {
            console.log('⏸️ Making user inactive:', username);
            removeActiveUser(username);
            showTeamSuccessMessage(`🔴 ${username} marked as inactive`);
            
            // Refresh the active users modal
            setTimeout(() => {
                openActiveUsersModal();
            }, 500);
        }
        
        // **NEW: Force Out functionality for admin/managers only**
        function isAdminOrManager() {
            const currentUser = localStorage.getItem('username');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === currentUser);
            
            if (user) {
                return user.role === 'admin' || user.role === 'manager';
            }
            
            // Default check for common admin usernames if role not found
            return currentUser === 'admin' || currentUser === 'manager';
        }
        
        function openForceOutModalForUser(targetUsername) {
            console.log('🚨 Opening force out modal for:', targetUsername);
            
            // Check permissions again
            if (!isAdminOrManager()) {
                showTeamSuccessMessage('❌ Only administrators and managers can force out users');
                return;
            }
            
            // Close the active users modal first
            closeActiveUsersModal();
            
            // Create and show force out authentication modal
            createForceOutAuthModal(targetUsername);
        }
        
        function createForceOutAuthModal(targetUsername) {
            // Remove any existing force out modal
            const existingModal = document.getElementById('dashboard-forceout-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            // Create modal
            const modal = document.createElement('div');
            modal.id = 'dashboard-forceout-modal';
            modal.className = 'simple-modal show';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(8px) !important;
            `;
            
            modal.innerHTML = `
                <div class="simple-modal-content" style="width: 450px; border: 2px solid #f44336;">
                    <div class="simple-modal-header">
                        <h3 style="color: #f44336;">
                            <i class="fas fa-exclamation-triangle"></i>
                            Force Out User
                        </h3>
                        <button class="simple-modal-close" onclick="closeDashboardForceOutModal()">&times;</button>
                    </div>
                    <div class="simple-modal-body">
                        <div style="background: rgba(244, 67, 54, 0.1); border: 1px solid rgba(244, 67, 54, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-exclamation-triangle" style="color: #f44336; font-size: 24px;"></i>
                                <div>
                                    <strong style="color: #f44336;">Warning!</strong><br>
                                    You are about to force out user: <strong style="color: #f44336;">${targetUsername}</strong>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                                <i class="fas fa-user-shield"></i> Select Admin/Manager
                            </label>
                            <select id="forceout-admin-select" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <option value="">Choose admin/manager...</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                                <i class="fas fa-lock"></i> Admin/Manager Password
                            </label>
                            <input type="password" id="forceout-password-input" placeholder="Enter admin/manager password" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        
                        <div id="forceout-error-message" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #dc2626; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeDashboardForceOutModal()" style="padding: 12px 20px; border: none; border-radius: 8px; background: #f3f4f6; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button onclick="executeForceOutFromDashboard('${targetUsername}')" style="padding: 12px 20px; border: none; border-radius: 8px; background: #f44336; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                <i class="fas fa-user-times"></i> Force Out
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate admin/manager dropdown
            console.log('🚀 Populating admin select dropdown...');
            populateAdminSelect();
            
            // Focus password input when admin is selected
            const adminSelect = document.getElementById('forceout-admin-select');
            const passwordInput = document.getElementById('forceout-password-input');
            
            if (adminSelect && passwordInput) {
                adminSelect.addEventListener('change', function() {
                    if (this.value) {
                        passwordInput.focus();
                    }
                });
                
                // Enter key support
                passwordInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter' && adminSelect.value && this.value) {
                        executeForceOutFromDashboard(targetUsername);
                    }
                });
            }
            
            // ESC key to close
            const escapeHandler = function(e) {
                if (e.key === 'Escape') {
                    closeDashboardForceOutModal();
                    document.removeEventListener('keydown', escapeHandler);
                }
            };
            document.addEventListener('keydown', escapeHandler);
            
            // Click outside to close
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeDashboardForceOutModal();
                }
            });
        }
        
        // **DYNAMIC: Admin dropdown population from actual users**
        function populateAdminSelect() {
            console.log('🔧 Populating admin select dropdown...');
            const adminSelect = document.getElementById('forceout-admin-select');
            if (!adminSelect) {
                console.error('❌ Admin select element not found!');
                return false;
            }
            
            // Clear existing options
            adminSelect.innerHTML = '<option value="">Choose admin/manager...</option>';
            
            // Get all users from storage
            const allUsers = JSON.parse(localStorage.getItem('users') || '[]');
            console.log('📋 Total users found:', allUsers.length);
            
            // Filter for admin and manager roles
            const adminUsers = allUsers.filter(user => 
                user.role === 'admin' || 
                user.role === 'manager' ||
                user.role === 'Administrator' ||
                user.role === 'Manager'
            );
            
            console.log('👥 Admin/Manager users found:', adminUsers.length);
            console.log('📋 Admin users:', adminUsers.map(u => `${u.username} (${u.role})`));
            
            if (adminUsers.length === 0) {
                console.log('⚠️ No admin/manager users found, creating defaults...');
                // Create default admin users if none exist
                const defaultAdmins = [
                    { username: 'admin', name: 'System Administrator', role: 'admin', password: 'ori3', location: 'all' },
                    { username: 'manager', name: 'Location Manager', role: 'manager', password: 'manager', location: 'Location1' },
                    { username: 'manager2', name: 'Emma Davis', role: 'manager', password: 'manager123', location: 'Location2' }
                ];
                
                // Add defaults to users array
                defaultAdmins.forEach(admin => {
                    if (!allUsers.find(u => u.username === admin.username)) {
                        allUsers.push(admin);
                        adminUsers.push(admin);
                    }
                });
                
                // Save updated users
                localStorage.setItem('users', JSON.stringify(allUsers));
                console.log('✅ Created default admin users');
            }
            
            // Populate dropdown with actual admin/manager users
            let addedCount = 0;
            adminUsers.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name || user.username} (${user.role})`;
                adminSelect.appendChild(option);
                addedCount++;
                console.log(`✅ Added option: ${option.textContent}`);
            });
            
            console.log(`✅ Admin dropdown populated with ${addedCount} admin/manager options`);
            return addedCount > 0;
        }
        
        function closeDashboardForceOutModal() {
            const modal = document.getElementById('dashboard-forceout-modal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        function executeForceOutFromDashboard(targetUsername) {
            const adminSelect = document.getElementById('forceout-admin-select');
            const passwordInput = document.getElementById('forceout-password-input');
            const errorDiv = document.getElementById('forceout-error-message');
            
            if (!adminSelect || !passwordInput || !errorDiv) {
                console.error('❌ Force out modal elements not found');
                return;
            }
            
            const selectedAdmin = adminSelect.value;
            const enteredPassword = passwordInput.value.trim();
            
            // Clear previous errors
            errorDiv.style.display = 'none';
            
            // Validation
            if (!selectedAdmin) {
                showForceOutError('Please select an admin or manager');
                return;
            }
            
            if (!enteredPassword) {
                showForceOutError('Please enter the admin/manager password');
                return;
            }
            
            // Verify credentials
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const adminUser = users.find(user => user.username === selectedAdmin);
            
            if (!adminUser) {
                showForceOutError('Selected admin/manager not found');
                return;
            }
            
            if (adminUser.password !== enteredPassword) {
                showForceOutError('Invalid password. Please try again.');
                passwordInput.value = '';
                passwordInput.focus();
                
                // Add shake animation
                const modalContent = document.querySelector('#dashboard-forceout-modal .simple-modal-content');
                if (modalContent) {
                    modalContent.style.animation = 'shake 0.5s ease-in-out';
                    setTimeout(() => {
                        modalContent.style.animation = '';
                    }, 500);
                }
                return;
            }
            
            // Check if user has permission
            if (adminUser.role !== 'admin' && adminUser.role !== 'manager') {
                showForceOutError('Only administrators and managers can force out users');
                return;
            }
            
            // Execute force out
            console.log(`🚨 Force out authorized: ${targetUsername} by ${adminUser.username} (${adminUser.role})`);
            
            // Remove user from active users
            const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
            const updatedActiveUsers = activeUsers.filter(user => user.username !== targetUsername);
            localStorage.setItem('activeUsers', JSON.stringify(updatedActiveUsers));
            
            // Update UI
            updateActiveUsersCountReal();
            
            // Close modal
            closeDashboardForceOutModal();
            
            // Show success message
            showTeamSuccessMessage(`🚨 ${targetUsername} has been forced out by ${adminUser.name || adminUser.username}`);
            
            // Log the action
            console.log(`✅ Force out completed: ${targetUsername} removed by ${adminUser.username}`);
            
            // Optionally refresh active users modal if it's still open
            setTimeout(() => {
                const activeUsersModal = document.getElementById('active-users-modal');
                if (activeUsersModal && activeUsersModal.classList.contains('show')) {
                    openActiveUsersModal();
                }
            }, 1500);
        }
        
        function showForceOutError(message) {
            const errorDiv = document.getElementById('forceout-error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Auto-hide after 4 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 4000);
            }
        }
        
        function showTeamSuccessMessage(message) {
            // Create a temporary success notification
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 15px 20px;
                border-radius: 10px;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                z-index: 10000;
                font-weight: 600;
                animation: slideInFromRight 0.3s ease;
            `;
            notification.textContent = message;
            
            document.body.appendChild(notification);
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 3000);
        }
        
        // **ENHANCED: Sidebar Functions for Dashboard**
        async function loadCurrentUser() {
            try {
                const response = await fetch('/get_current_user', {
                    method: 'GET',
                    credentials: 'same-origin',
                    headers: {
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    if (data.user) {
                        updateUserDisplay(data.user);
                    } else {
                        console.log('No user data found');
                        updateUserDisplay(null);
                    }
                } else {
                    console.log('Failed to get current user');
                    updateUserDisplay(null);
                }
            } catch (error) {
                console.error('Error loading current user:', error);
                updateUserDisplay(null);
            }
        }

        function updateUserDisplay(user) {
            const userNameElement = document.getElementById('user-name');
            const userStatusElement = document.getElementById('user-status');
            
            if (user) {
                const displayName = user.name || user.username || 'User';
                userNameElement.textContent = displayName;
                
                const role = user.role || 'user';
                const statusText = role === 'admin' ? 'Administrator' : 
                                 role === 'location' ? 'Location Manager' : 'User';
                userStatusElement.textContent = statusText;
                
                localStorage.setItem('username', user.username || user.name);
                localStorage.setItem('role', role);
                localStorage.setItem('isLoggedIn', 'true');
            } else {
                userNameElement.textContent = 'Not Logged In';
                userStatusElement.textContent = 'Offline';
            }
        }

        function toggleUserMenu() {
            const userMenu = document.getElementById('user-menu');
            userMenu.classList.toggle('show');
            
            document.addEventListener('click', function closeMenu(e) {
                if (!e.target.closest('#user-profile')) {
                    userMenu.classList.remove('show');
                    document.removeEventListener('click', closeMenu);
                }
            });
        }

        async function signOut() {
            try {
                const response = await fetch('/api/logout', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    credentials: 'same-origin'
                });
                
                if (response.ok) {
                    localStorage.clear();
                    showNotification('Successfully signed out!', 'success');
                    setTimeout(() => {
                        window.location.href = '/login';
                    }, 1000);
                } else {
                    console.error('Logout failed');
                    showNotification('Failed to sign out. Please try again.', 'error');
                }
            } catch (error) {
                console.error('Error during sign out:', error);
                showNotification('Error during sign out. Please try again.', 'error');
            }
        }

        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.textContent = message;
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? '#10b981' : type === 'error' ? '#ef4444' : '#3b82f6'};
                color: white;
                padding: 12px 20px;
                border-radius: 8px;
                z-index: 10000;
                font-weight: 500;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            document.body.appendChild(notification);
            setTimeout(() => notification.remove(), 3000);
        }

        // **ENHANCED: Comprehensive Button Fix for All Dashboard Cards**
        function ensureAllButtonsWork() {
            console.log('🔧 Ensuring all dashboard card buttons work...');
            
            // Fix Start Session button
            const startSessionBtn = document.getElementById('start-session-btn');
            if (startSessionBtn) {
                // Remove any existing listeners to prevent duplicates
                startSessionBtn.replaceWith(startSessionBtn.cloneNode(true));
                const newStartBtn = document.getElementById('start-session-btn');
                
                newStartBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('🚀 Start Session clicked - Enhanced handler');
                    openUserSelectionModal();
                });
                console.log('✅ Start Session button enhanced');
            }
            
            // Fix View Active Users button
            const viewActiveBtn = document.getElementById('view-active-users-btn');
            if (viewActiveBtn) {
                viewActiveBtn.replaceWith(viewActiveBtn.cloneNode(true));
                const newViewBtn = document.getElementById('view-active-users-btn');
                
                newViewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('👥 View Active clicked - Enhanced handler');
                    openActiveUsersModal();
                });
                console.log('✅ View Active button enhanced');
            }
            
            // Fix Appointment Add button
            const appointmentAddBtn = document.getElementById('appointment-add-btn');
            if (appointmentAddBtn) {
                appointmentAddBtn.replaceWith(appointmentAddBtn.cloneNode(true));
                const newAppointmentAddBtn = document.getElementById('appointment-add-btn');
                
                newAppointmentAddBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('📅 Add Appointment clicked - Enhanced handler');
                    
                    // Check if openAppointmentModal function exists
                    if (typeof openAppointmentModal === 'function') {
                        openAppointmentModal();
                    } else {
                        console.log('📅 Opening appointment page directly');
                        // Preserve ?location= for multi-location context
                        const urlParams = new URLSearchParams(window.location.search);
                        const locationParam = urlParams.get('location');
                        const baseUrl = '/appointment';
                        window.location.href = locationParam ? `${baseUrl}?location=${encodeURIComponent(locationParam)}` : baseUrl;
                    }
                });
                console.log('✅ Appointment Add button enhanced');
            }
            
            // Fix Appointment View button
            const appointmentViewBtn = document.getElementById('appointment-view-btn');
            if (appointmentViewBtn) {
                appointmentViewBtn.replaceWith(appointmentViewBtn.cloneNode(true));
                const newAppointmentViewBtn = document.getElementById('appointment-view-btn');
                
                newAppointmentViewBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('📅 View Appointments clicked - Enhanced handler');
                    const urlParams = new URLSearchParams(window.location.search);
                    const locationParam = urlParams.get('location');
                    const baseUrl = '/appointment';
                    window.location.href = locationParam ? `${baseUrl}?location=${encodeURIComponent(locationParam)}` : baseUrl;
                });
                console.log('✅ Appointment View button enhanced');
            }
            
            // Fix Gift Card buttons
            const giftCardButtons = document.querySelectorAll('button[onclick*="openAddGiftCardModal"], button[onclick*="openViewGiftCardsModal"]');
            giftCardButtons.forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                if (newBtn.textContent.includes('Add Card')) {
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🎁 Add Gift Card clicked - Enhanced handler');
                        
                        // Check if openAddGiftCardModal function exists
                        if (typeof openAddGiftCardModal === 'function') {
                            openAddGiftCardModal();
                        } else {
                            console.log('🎁 Gift card modal function not found, showing fallback');
                            alert('Gift card functionality is being set up. Please try again later.');
                        }
                    });
                } else if (newBtn.textContent.includes('View Cards')) {
                    newBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('🎁 View Gift Cards clicked - Enhanced handler');
                        
                        // Check if openViewGiftCardsModal function exists
                        if (typeof openViewGiftCardsModal === 'function') {
                            openViewGiftCardsModal();
                        } else {
                            console.log('🎁 Gift card view modal function not found, showing fallback');
                            alert('Gift card view functionality is being set up. Please try again later.');
                        }
                    });
                }
            });
            console.log('✅ Gift Card buttons enhanced');
            
            // Fix Checklist buttons
            const checklistButtons = document.querySelectorAll('button[onclick*="monumevip.com"]');
            checklistButtons.forEach(btn => {
                const newBtn = btn.cloneNode(true);
                btn.parentNode.replaceChild(newBtn, btn);
                
                newBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('📋 Checklist clicked - Enhanced handler');
                    window.open('https://monumevip.com/forms/1745893032923/monume-queens', '_blank');
                });
            });
            console.log('✅ Checklist buttons enhanced');
            
            // Add visual feedback for all buttons
            const allActionButtons = document.querySelectorAll('.action-button');
            allActionButtons.forEach(btn => {
                btn.addEventListener('mouseenter', function() {
                    this.style.transform = 'translateY(-2px)';
                    this.style.boxShadow = '0 8px 20px rgba(255, 149, 98, 0.3)';
                });
                
                btn.addEventListener('mouseleave', function() {
                    this.style.transform = 'translateY(0)';
                    this.style.boxShadow = '0 4px 12px rgba(255, 149, 98, 0.2)';
                });
                
                btn.addEventListener('click', function() {
                    // Add click animation
                    this.style.transform = 'scale(0.95)';
                    setTimeout(() => {
                        this.style.transform = 'scale(1)';
                    }, 150);
                });
            });
            
            console.log('✅ All dashboard card buttons enhanced and working!');
        }

        // **SINGLE INITIALIZATION - Replace all the duplicates**
        document.addEventListener('DOMContentLoaded', function() {
            console.log('🚀 Team MonuMe Card: Initializing (SINGLE SYSTEM)...');
            
            // Wait for DOM and other scripts to load
            setTimeout(() => {
                // Initialize with working functions only
                setupActiveUsersButtonsReal();
                initializeUsersDatabase();
                updateActiveUsersCountReal();
                
                // **NEW: Ensure all buttons work**
                ensureAllButtonsWork();
                
                // **NEW: Initialize sidebar functionality**
                loadCurrentUser();
                
                // Set up periodic updates every 30 seconds
                setInterval(() => {
                    updateActiveUsersCountReal();
                }, 30000);
                
                // **NEW: Set up modal event listeners**
                setupModalEventListeners();
                
                console.log('✅ Team MonuMe Card: Complete initialization finished!');
            }, 1500); // Wait 1.5 seconds for all scripts to load
        });
        
        function setupModalEventListeners() {
            console.log('🔧 Setting up modal event listeners...');
            
            // User selection modal close buttons
            const userModalCloseBtn = document.querySelector('#user-modal .simple-modal-close');
            if (userModalCloseBtn) {
                userModalCloseBtn.addEventListener('click', closeUserModal);
            }
            
            // Password modal close buttons  
            const passwordModalCloseBtn = document.querySelector('#password-modal .simple-modal-close');
            const passwordCancelBtn = document.querySelector('#password-modal .cancel-btn');
            if (passwordModalCloseBtn) {
                passwordModalCloseBtn.addEventListener('click', closePasswordModal);
            }
            if (passwordCancelBtn) {
                passwordCancelBtn.addEventListener('click', closePasswordModal);
            }
            
            // Active users modal close button
            const activeUsersModalCloseBtn = document.querySelector('#active-users-modal .simple-modal-close');
            if (activeUsersModalCloseBtn) {
                activeUsersModalCloseBtn.addEventListener('click', closeActiveUsersModal);
            }
            
            // Password input enter key
            const passwordInput = document.getElementById('password-input');
            if (passwordInput) {
                passwordInput.addEventListener('keydown', function(e) {
                    if (e.key === 'Enter') {
                        confirmPassword();
                    }
                });
            }
            
            // Click outside to close modals
            document.addEventListener('click', function(e) {
                const userModal = document.getElementById('user-modal');
                const passwordModal = document.getElementById('password-modal');
                const activeUsersModal = document.getElementById('active-users-modal');
                
                if (e.target === userModal) {
                    closeUserModal();
                } else if (e.target === passwordModal) {
                    closePasswordModal();
                } else if (e.target === activeUsersModal) {
                    closeActiveUsersModal();
                }
            });
            
            // ESC key to close modals
            document.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    const userModal = document.getElementById('user-modal');
                    const passwordModal = document.getElementById('password-modal');
                    const activeUsersModal = document.getElementById('active-users-modal');
                    
                    if (userModal && userModal.classList.contains('show')) {
                        closeUserModal();
                    } else if (passwordModal && passwordModal.classList.contains('show')) {
                        closePasswordModal();
                    } else if (activeUsersModal && activeUsersModal.classList.contains('show')) {
                        closeActiveUsersModal();
                    }
                }
            });
            
            console.log('✅ Modal event listeners set up');
        }
        
        // **TEST FUNCTIONS FOR TEAM MONUME CARD**
        window.testTeamMonuMe = function() {
            console.log('🧪 === TESTING TEAM MONUME CARD ===');
            
            // Test 1: Check if element exists
            const cardElement = document.getElementById('team-monume-card');
            const countElement = document.getElementById('activeUsers');
            console.log('Card element found:', !!cardElement);
            console.log('Count element found:', !!countElement);
            
            // Test 2: Add test users
            addActiveUser('testuser1');
            addActiveUser('testuser2');
            addActiveUser('testuser3');
            console.log('✅ Added 3 test users');
            
            // Test 3: Update count
            updateActiveUsersCountReal();
            
            // Test 4: Show current status
            const currentCount = countElement?.textContent;
            console.log('📊 Current displayed count:', currentCount);
            
            console.log('✅ Team MonuMe test complete!');
        };
        
        // **NEW: Initialize location-based demo users**
        function initializeLocationUsers() {
            console.log('🏢 Initializing location-based demo users...');
            
            const locationUsersMap = {
                'Location1': [
                    { username: 'manager', password: 'manager', name: 'Location Manager', role: 'manager', location: 'Location1' },
                    { username: 'employee', password: 'employee', name: 'Location Employee', role: 'employee', location: 'Location1' },
                    { username: 'staff1', password: 'staff123', name: 'Sarah Johnson', role: 'staff', location: 'Location1' },
                    { username: 'staff2', password: 'staff123', name: 'Mike Chen', role: 'staff', location: 'Location1' }
                ],
                'Location2': [
                    { username: 'manager2', password: 'manager123', name: 'Emma Davis', role: 'manager', location: 'Location2' },
                    { username: 'staff3', password: 'staff123', name: 'David Kim', role: 'staff', location: 'Location2' },
                    { username: 'staff4', password: 'staff123', name: 'Lisa Wong', role: 'staff', location: 'Location2' }
                ]
            };
            
            localStorage.setItem('locationUsers', JSON.stringify(locationUsersMap));
            
            // Also create main users array for backward compatibility
            const allUsers = [
                { username: 'admin', password: 'ori3', name: 'System Administrator', role: 'admin', location: 'all' },
                ...locationUsersMap.Location1,
                ...locationUsersMap.Location2
            ];
            
            localStorage.setItem('users', JSON.stringify(allUsers));
            console.log('✅ Location-based users initialized');
        }

        // **SIMPLE: Initialize basic users**
        function initializeBasicUsers() {
            console.log('🔧 Initializing basic users...');
            
            const basicUsers = [
                { username: 'admin', name: 'System Administrator', role: 'admin', password: 'ori3', location: 'all' },
                { username: 'manager', name: 'Location Manager', role: 'manager', password: 'manager', location: 'Location1' },
                { username: 'manager2', name: 'Emma Davis', role: 'manager', password: 'manager123', location: 'Location2' },
                { username: 'employee', name: 'Location Employee', role: 'employee', password: 'employee', location: 'Location1' },
                { username: 'staff1', name: 'Sarah Johnson', role: 'staff', password: 'staff123', location: 'Location1' }
            ];
            
            // Only initialize if no users exist
            const existingUsers = JSON.parse(localStorage.getItem('users') || '[]');
            if (existingUsers.length === 0) {
                localStorage.setItem('users', JSON.stringify(basicUsers));
                console.log('✅ Basic users initialized');
            } else {
                console.log('✅ Users already exist, skipping initialization');
            }
        }
        
        // Initialize users once
        initializeBasicUsers();

        window.testForceOutFunctionality = function() {
            console.log('🧪 === TESTING FORCE OUT FUNCTIONALITY ===');
            
            // Check if current user is admin/manager
            const isAdminManager = isAdminOrManager();
            console.log('🔐 Current user is admin/manager:', isAdminManager);
            
            if (!isAdminManager) {
                console.log('⚠️ Current user is not admin/manager - Force Out buttons will not appear');
                console.log('💡 Switch to admin or manager account to test Force Out functionality');
                return;
            }
            
            // Add some test users first
            addActiveUser('testuser1');
            addActiveUser('testuser2');
            addActiveUser('manager'); // This user should not be able to force out themselves
            console.log('✅ Added test users including manager');
            
            // Open active users modal to see Force Out buttons
            console.log('🚀 Opening Active Users modal to show Force Out buttons...');
            openActiveUsersModal();
            
            console.log('✅ Force Out test setup complete!');
            console.log('📋 You should see:');
            console.log('   - Force Out buttons next to each user (red button with user-times icon)');
            console.log('   - Clicking Force Out should open authentication modal');
            console.log('   - Only admin/manager credentials should work');
            console.log('💡 Test credentials: admin/admin123 or manager/manager123');
        };
        
        window.testStartSessionModal = function() {
            console.log('🧪 === TESTING START SESSION MODAL ===');
            console.log('Opening user selection modal...');
            openUserSelectionModal();
            console.log('✅ Modal should now be open with proper user selection interface');
        };

        window.testLocationFiltering = function() {
            console.log('🧪 === TESTING LOCATION FILTERING ===');
            console.log('Current user role:', localStorage.getItem('role'));
            console.log('Current user location:', localStorage.getItem('location'));
            
            const filteredUsers = getFilteredUsers();
            console.log('Filtered users for current location:', filteredUsers);
            
            console.log('Opening user selection modal to see location filtering...');
            openUserSelectionModal();
        };

        // **SIMPLIFIED: Debug users and test force-out**
        window.debugUsers = function() {
            console.log('🔍 === USER DEBUG ===');
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
            const adminUsers = users.filter(u => u.role === 'admin' || u.role === 'manager');
            
            console.log('👤 Current user:', localStorage.getItem('username'));
            console.log('📋 Total users:', users.length);
            console.log('👥 Admin/Manager users:', adminUsers.length);
            console.log('🟢 Active users:', activeUsers.length);
            console.log('');
            console.log('Admin details:', adminUsers.map(u => `${u.username} (${u.role}) - Password: ${u.password}`));
            
            return { users, activeUsers, adminUsers };
        };
        
        window.testForceOut = function() {
            console.log('🧪 === TESTING FORCE OUT ===');
            
            // Add a test user to force out
            addActiveUser('admin');
            console.log('✅ Added admin as active user');
            
            // Open active users modal
            setTimeout(() => {
                openActiveUsersModal();
                console.log('👥 Opening active users modal with Force Out buttons');
                console.log('💡 Click Force Out button to test dropdown');
            }, 500);
        };
        
        window.testViewActiveModal = function() {
            console.log('🧪 === TESTING VIEW ACTIVE MODAL ===');
            
            // Only add test users if explicitly requested
            console.log('Opening active users modal...');
            openActiveUsersModal();
            console.log('✅ Active users modal should now be open');
        };
        
        window.fixTeamMonuMe = function() {
            console.log('🔧 === FIXING TEAM MONUME CARD ===');
            
            // Force update everything
            setupActiveUsersButtonsReal();
            initializeUsersDatabase();
            updateActiveUsersCountReal();
            setupModalEventListeners();
            
            console.log('✅ Team MonuMe card fixed!');
        };
        
        // **NEW: Global function to fix all dashboard buttons**
        window.fixAllDashboardButtons = function() {
            console.log('🔧 === FIXING ALL DASHBOARD BUTTONS ===');
            
            // Ensure all buttons work
            ensureAllButtonsWork();
            
            // Fix Team MonuMe card
            setupActiveUsersButtonsReal();
            initializeUsersDatabase();
            updateActiveUsersCountReal();
            setupModalEventListeners();
            
            // Test all buttons
            testAllButtons();
            
            console.log('✅ All dashboard buttons fixed and tested!');
        };
        
        // **NEW: Test all buttons function**
        window.testAllButtons = function() {
            console.log('🧪 === TESTING ALL DASHBOARD BUTTONS ===');
            
            const buttons = [
                { id: 'start-session-btn', name: 'Start Session' },
                { id: 'view-active-users-btn', name: 'View Active' },
                { id: 'appointment-add-btn', name: 'Add Appointment' },
                { id: 'appointment-view-btn', name: 'View Appointments' }
            ];
            
            buttons.forEach(button => {
                const btn = document.getElementById(button.id);
                if (btn) {
                    console.log(`✅ ${button.name} button found and ready`);
                } else {
                    console.log(`❌ ${button.name} button not found`);
                }
            });
            
            // Test gift card buttons
            const giftCardButtons = document.querySelectorAll('button[onclick*="openAddGiftCardModal"], button[onclick*="openViewGiftCardsModal"]');
            console.log(`✅ Found ${giftCardButtons.length} gift card buttons`);
            
            // Test checklist buttons
            const checklistButtons = document.querySelectorAll('button[onclick*="monumevip.com"]');
            console.log(`✅ Found ${checklistButtons.length} checklist buttons`);
            
            console.log('✅ All button tests complete!');
        };
        
        window.testModalButtons = function() {
            console.log('🧪 === TESTING MODAL BUTTONS ===');
            
            const startBtn = document.getElementById('start-session-btn');
            const viewBtn = document.getElementById('view-active-users-btn');
            
            console.log('Start Session button found:', !!startBtn);
            console.log('View Active button found:', !!viewBtn);
            
            if (startBtn) {
                console.log('🚀 Testing Start Session button...');
                startBtn.click();
            }
            
            setTimeout(() => {
                if (viewBtn) {
                    console.log('👥 Testing View Active button...');
                    // Close any open modal first
                    closeUserModal();
                    setTimeout(() => {
                        viewBtn.click();
                    }, 500);
                }
            }, 2000);
            
            console.log('✅ Modal button test complete - check if proper modals opened');
        };
        
        // **NEW: Fix bottom section display**
        window.fixBottomSection = function() {
            console.log('🔧 === FIXING BOTTOM SECTION DISPLAY ===');
            
            const bottomSection = document.querySelector('.dashboard-bottom-section');
            const teamChatCard = document.querySelector('.team-chat-container');
            const eventsCard = document.querySelector('.events-container');
            
            console.log('Bottom section found:', !!bottomSection);
            console.log('Team chat card found:', !!teamChatCard);
            console.log('Events card found:', !!eventsCard);
            
            if (bottomSection) {
                bottomSection.style.display = 'grid';
                bottomSection.style.visibility = 'visible';
                bottomSection.style.opacity = '1';
                console.log('✅ Bottom section display fixed');
            }
            
            if (teamChatCard) {
                teamChatCard.style.display = 'flex';
                teamChatCard.style.visibility = 'visible';
                teamChatCard.style.opacity = '1';
                console.log('✅ Team chat card display fixed');
            }
            
            if (eventsCard) {
                eventsCard.style.display = 'flex';
                eventsCard.style.visibility = 'visible';
                eventsCard.style.opacity = '1';
                console.log('✅ Events card display fixed');
            }
            
            // Force reload the bottom content
            loadTeamChatPreview();
            loadWeeklyAppointments(true);
            
            console.log('🎉 Bottom section should now be visible!');
        };
        
        // **NEW: Force modal centering**
        window.forceModalCentering = function() {
            console.log('🎯 === FORCING MODAL CENTERING ===');
            
            const modals = document.querySelectorAll('.simple-modal');
            console.log('Found modals:', modals.length);
            
            modals.forEach((modal, index) => {
                console.log(`Fixing modal ${index + 1}:`, modal.id);
                
                // Apply forced centering styles
                modal.style.cssText = `
                    position: fixed !important;
                    top: 0 !important;
                    left: 0 !important;
                    width: 100vw !important;
                    height: 100vh !important;
                    display: none !important;
                    justify-content: center !important;
                    align-items: center !important;
                    z-index: 10000 !important;
                    background: rgba(0, 0, 0, 0.6) !important;
                    backdrop-filter: blur(8px) !important;
                    margin: 0 !important;
                    padding: 0 !important;
                `;
                
                // Fix modal content
                const content = modal.querySelector('.simple-modal-content');
                if (content) {
                    content.style.cssText = `
                        background: white !important;
                        border-radius: 20px !important;
                        padding: 30px !important;
                        width: 500px !important;
                        max-width: 90vw !important;
                        max-height: 80vh !important;
                        overflow-y: auto !important;
                        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3) !important;
                        border: 2px solid var(--main-color) !important;
                        position: relative !important;
                        margin: 0 !important;
                        transform: none !important;
                    `;
                }
            });
            
            console.log('✅ Modal centering force applied!');
            console.log('💡 Test with: testCenteredModal()');
        };
        
        // **NEW: Test centered modal**
        window.testCenteredModal = function() {
            console.log('🧪 === TESTING CENTERED MODAL ===');
            
            // First apply the centering fix
            forceModalCentering();
            
            // Wait a moment then open the modal
            setTimeout(() => {
                console.log('🚀 Opening test modal...');
                
                // Open the active users modal (without auto-adding users)
                openActiveUsersModal();
                
                console.log('✅ Modal should now be perfectly centered!');
                console.log('💡 The modal should appear in the center of your screen');
            }, 500);
        };
        
        // **NEW: Complete dashboard fix**
        window.fixDashboard = function() {
            console.log('🔧 === COMPLETE DASHBOARD FIX ===');
            
            // Force modal centering
            console.log('🎯 Forcing modal centering...');
            forceModalCentering();
            
            // Fix bottom section
            console.log('📱 Fixing bottom section...');
            fixBottomSection();
            
            // Fix Team MonuMe
            console.log('👥 Fixing Team MonuMe...');
            if (typeof fixTeamMonuMe === 'function') {
                fixTeamMonuMe();
            }
            
            console.log('🎉 Complete dashboard fix applied!');
            console.log('💡 Test with: testCenteredModal()');
        };
        
        // **NEW: Auto-fix on page load**
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('🔧 Auto-fixing dashboard display...');
                
                // Fix modal centering
                if (typeof forceModalCentering === 'function') {
                    forceModalCentering();
                }
                
                // Fix bottom section
                if (typeof fixBottomSection === 'function') {
                    fixBottomSection();
                }
                
                console.log('✅ Auto-fix complete - modals should now be centered!');
            }, 3000); // Wait 3 seconds after page load
        });

        // **GIFT CARD SYSTEM - COMPLETE FUNCTIONALITY**
        
        // Gift Card Storage Functions
        function getGiftCards() {
            return JSON.parse(localStorage.getItem('giftCards') || '[]');
        }
        
        function saveGiftCards(giftCards) {
            localStorage.setItem('giftCards', JSON.stringify(giftCards));
        }
        
        function updateGiftCardCount() {
            const giftCards = getGiftCards();
            const countElement = document.querySelector('.stat-card:nth-child(3) .stat-card-value');
            if (countElement) {
                countElement.textContent = giftCards.length;
            }
        }
        
        // Modal Functions
        function openAddGiftCardModal() {
            console.log('🎁 Opening Add Gift Card modal...');
            const modal = document.getElementById('gift-card-add-modal');
            
            // Reset form
            document.getElementById('gift-card-form').reset();
            
            // Generate automatic code
            const autoCode = 'GC-' + Date.now().toString().slice(-8);
            document.getElementById('gift-card-code').value = autoCode;
            
            // Show modal with proper centering
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(8px) !important;
            `;
        }
        
        function closeAddGiftCardModal() {
            const modal = document.getElementById('gift-card-add-modal');
            modal.style.display = 'none';
        }
        
        function openViewGiftCardsModal() {
            console.log('📋 Opening View Gift Cards modal...');
            const modal = document.getElementById('gift-cards-view-modal');
            
            loadGiftCardsList();
            
            // Show modal with proper centering
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(8px) !important;
            `;
        }
        
        function closeViewGiftCardsModal() {
            const modal = document.getElementById('gift-cards-view-modal');
            modal.style.display = 'none';
        }
        
        function closeGiftCardDetailsModal() {
            const modal = document.getElementById('gift-card-details-modal');
            modal.style.display = 'none';
        }
        
        // Gift Card Generation Functions
        function generateGiftCard(giftCardData) {
            return new Promise((resolve, reject) => {
                console.log('🎨 Generating gift card image...');
                
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.crossOrigin = 'anonymous';
                img.onload = function() {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    
                    // Draw the base template
                    ctx.drawImage(img, 0, 0);
                    
                    // Add gift card code in the white square - ORANGE color as requested
                    ctx.fillStyle = '#f8a168';
                    ctx.font = 'bold 28px Arial';
                    ctx.textAlign = 'center';
                    ctx.textBaseline = 'middle';
                    
                    // Position code centered in the white square - matching picture positioning
                    const codeX = canvas.width / 2; // Center horizontally in white square
                    const codeY = 515; // Centered vertically in white square
                    ctx.fillText(giftCardData.code, codeX, codeY);
                    
                    // Add invoice number in the red area - WHITE text for contrast against red
                    ctx.fillStyle = '#FFFFFF';
                    ctx.font = 'bold 20px Arial';
                    ctx.textAlign = 'left';
                    ctx.textBaseline = 'middle';
                    
                    // Position invoice number exactly aligned with "INVOICE:" text as in picture
                    const invoiceX = 290; // X position aligned after "INVOICE #" text
                    const invoiceY = 590; // Y position exactly on same line as "INVOICE #" text in red area
                    ctx.fillText(giftCardData.invoice, invoiceX, invoiceY);
                    
                    console.log(`✅ Gift card generated with code centered in white square at (${codeX}, ${codeY}) and invoice aligned with INVOICE: text at (${invoiceX}, ${invoiceY})`);
                    
                    // Convert canvas to data URL
                    const dataURL = canvas.toDataURL('image/png');
                    resolve(dataURL);
                };
                
                img.onerror = function() {
                    reject(new Error('Failed to load gift card template'));
                };
                
                img.src = 'GIFT CARD.png';
            });
        }
        
        // Email Functions
        function sendGiftCardEmail(giftCardData, imageData) {
            console.log('📧 Sending gift card email via MonuMe servers...');
            console.log('📋 Gift card data for email:', giftCardData);
            
            // Ensure amount is always properly defined with comprehensive fallback
            let safeAmount = '0.00';
            if (giftCardData.amount !== undefined && giftCardData.amount !== null && giftCardData.amount !== '') {
                safeAmount = giftCardData.amount.toString();
            }
            
            // Create a safe data object with guaranteed values
            const safeGiftCardData = {
                email: giftCardData.email || '',
                code: giftCardData.code || '',
                product: giftCardData.product || '',
                amount: safeAmount,
                invoice: giftCardData.invoice || 'N/A'
            };
            
            console.log('✅ Safe gift card data prepared:', safeGiftCardData);
            
            // Get email template
            const template = getGiftCardEmailTemplate();
            
            // Replace placeholders in template with error handling
            const currentDate = new Date().toISOString().split('T')[0].replace(/-/g, '');
            const emailContent = template
                .replace(/{{recipientEmail}}/g, safeGiftCardData.email)
                .replace(/{{giftCardCode}}/g, safeGiftCardData.code)
                .replace(/{{product}}/g, safeGiftCardData.product)
                .replace(/{{amount}}/g, safeGiftCardData.amount)
                .replace(/{{invoiceNumber}}/g, safeGiftCardData.invoice)
                .replace(/{{currentDate}}/g, currentDate);
            
            console.log('✅ Email template processed successfully');
            
            // Prepare comprehensive email data for MonuMe servers using safe data
            const emailData = {
                to: safeGiftCardData.email,
                from: 'info@monumevip.com',
                fromName: 'MonuMe Team',
                subject: `🎁 Your MonuMe Gift Card - Code: ${safeGiftCardData.code}`,
                html: emailContent,
                text: `Your MonuMe Gift Card\n\nCode: ${safeGiftCardData.code}\nProduct: ${safeGiftCardData.product}\nAmount: $${safeGiftCardData.amount}\nInvoice: ${safeGiftCardData.invoice}\n\nContact us at info@monumevip.com to redeem your gift card.\n\nVisit us at www.monumevip.com`,
                attachment: {
                    filename: `MonuMe_GiftCard_${safeGiftCardData.code}.png`,
                    content: imageData,
                    type: 'image/png'
                },
                giftCardData: {
                    code: safeGiftCardData.code,
                    product: safeGiftCardData.product,
                    amount: safeGiftCardData.amount,
                    invoice: safeGiftCardData.invoice,
                    createdAt: new Date().toISOString()
                }
            };
            
            console.log('📤 Sending email data:', {
                to: emailData.to,
                from: emailData.from,
                subject: emailData.subject,
                hasAttachment: !!emailData.attachment
            });
            
            // Try multiple endpoints for real email sending
            const endpoints = [
                '/send-gift-card-email',  // Local server endpoint
                '/api/email/gift-card',   // Alternative API endpoint
                'https://www.monumevip.com/api/email/gift-card'  // Domain endpoint
            ];
            
            return tryEmailEndpoints(emailData, endpoints);
        }
        
        // Improved email sending with better error handling
        function tryEmailEndpoints(emailData, endpoints) {
            console.log('📡 Starting email sending process...');
            
            // For development mode, simulate email sending
            if (window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1') {
                console.log('🔧 Development mode detected - simulating email sending');
                return new Promise((resolve) => {
                    setTimeout(() => {
                        console.log('✅ Email simulated successfully in development mode');
                        resolve({
                            success: true,
                            message: 'Email simulated in development mode',
                            isDevelopment: true,
                            timestamp: new Date().toISOString()
                        });
                    }, 1500); // Simulate delay
                });
            }
            
            // Try the main endpoint
            const endpoint = '/send-gift-card-email';
            console.log(`📡 Sending email via: ${endpoint}`);
            
            return fetch(endpoint, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Accept': 'application/json'
                },
                body: JSON.stringify(emailData)
            })
            .then(response => {
                console.log(`📊 Email response status: ${response.status} ${response.statusText}`);
                if (!response.ok) {
                    throw new Error(`Server error: ${response.status} ${response.statusText}`);
                }
                return response.json();
            })
            .then(data => {
                if (data.success) {
                    console.log('✅ Email sent successfully via server');
                    return data;
                } else {
                    throw new Error(data.error || 'Email sending failed');
                }
            })
            .catch(error => {
                console.error('❌ Email sending failed:', error.message);
                console.log('💡 Gift card will still be created, but email failed');
                throw new Error(`Email sending failed: ${error.message}`);
            });
        }
        
        function getGiftCardEmailTemplate() {
            const template = localStorage.getItem('giftCardEmailTemplate');
            if (template) {
                return template;
            }
            
            // Clean, simple email template without calendar integration
            return `
                <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #f9f9f9; padding: 20px;">
                    <div style="background: white; border-radius: 10px; padding: 30px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                        <div style="text-align: center; margin-bottom: 30px;">
                            <h1 style="color: #ff9562; margin: 0; font-size: 28px;">MonuMe Gift Card</h1>
                            <p style="color: #666; margin: 10px 0; font-size: 16px;">Your special gift awaits!</p>
                        </div>
                        
                        <div style="background: linear-gradient(135deg, #ff7f42, #ff9562); color: white; padding: 25px; border-radius: 12px; margin-bottom: 30px; box-shadow: 0 4px 15px rgba(255, 127, 66, 0.3);">
                            <h2 style="margin: 0 0 15px 0; font-size: 24px;">🎁 Gift Card Details</h2>
                            <div style="background: rgba(255, 255, 255, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 15px;">
                                <p style="margin: 8px 0; font-size: 16px;"><strong>📱 Code:</strong> {{giftCardCode}}</p>
                                <p style="margin: 8px 0; font-size: 16px;"><strong>🎯 Product:</strong> {{product}}</p>
                                <p style="margin: 8px 0; font-size: 16px;"><strong>💰 Amount:</strong> ${{amount}}</p>
                                <p style="margin: 8px 0; font-size: 16px;"><strong>📄 Invoice:</strong> {{invoiceNumber}}</p>
                            </div>
                            <p style="margin: 0; font-size: 14px; opacity: 0.9; text-align: center;">
                                ✨ Enjoy your MonuMe experience!
                            </p>
                        </div>
                        
                        <div style="text-align: center; margin-bottom: 30px;">
                            <p style="color: #333; font-size: 16px; line-height: 1.6;">
                                🎉 Congratulations! You've received a MonuMe gift card. 
                                Please find your personalized gift card attached to this email.
                            </p>
                            <p style="color: #666; font-size: 14px;">
                                To redeem this gift card, please contact us with your gift card code.
                            </p>
                        </div>
                        
                        <!-- Contact Information -->
                        <div style="background: linear-gradient(135deg, #28a745, #20c997); color: white; padding: 20px; border-radius: 10px; text-align: center; margin-bottom: 20px;">
                            <h4 style="margin: 0 0 10px 0; font-size: 18px;">📞 Ready to Schedule?</h4>
                            <p style="margin: 5px 0; font-size: 16px;"><strong>📧 Email:</strong> info@monumevip.com</p>
                            <p style="margin: 5px 0; font-size: 16px;"><strong>🌐 Website:</strong> www.monumevip.com</p>
                            <p style="margin: 10px 0 0 0; font-size: 14px; opacity: 0.9;">
                                Contact us today to book your MonuMe experience!
                            </p>
                        </div>
                        
                        <div style="text-align: center; padding: 20px; background: #f8f9fa; border-radius: 8px;">
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                Questions? Contact us at info@monumevip.com
                            </p>
                            <p style="margin: 5px 0 0 0; color: #999; font-size: 12px;">
                                This email was sent on {{currentDate}}
                            </p>
                        </div>
                    </div>
                </div>
            `;
        }
        
        // Gift Card Form Handler
        document.getElementById('gift-card-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Get form data with proper amount handling
            const amountValue = document.getElementById('gift-card-amount').value;
            const formData = {
                code: document.getElementById('gift-card-code').value.trim(),
                invoice: document.getElementById('gift-card-invoice').value.trim(),
                product: document.getElementById('gift-card-product').value,
                email: document.getElementById('gift-card-email').value.trim(),
                amount: (amountValue && amountValue.trim() !== '') ? amountValue.trim() : '0.00'
            };
            
            // Ensure amount is always defined
            if (!formData.amount || formData.amount === '') {
                formData.amount = '0.00';
            }
            
            console.log('📝 Gift card form data:', formData);
            
            if (!formData.code || !formData.invoice || !formData.product || !formData.email) {
                showGiftCardMessage('Please fill in all required fields', 'error');
                return;
            }
            
            try {
                // Show enhanced loading with progress indicator
                const submitBtn = e.target.querySelector('button[type="submit"]');
                const originalText = submitBtn.innerHTML;
                showGiftCardLoadingStep(submitBtn, 'Generating gift card image...', 'magic');
                submitBtn.disabled = true;
                
                console.log('🎯 Starting gift card generation with data:', formData);
                
                // Generate gift card image
                const imageData = await generateGiftCard(formData);
                console.log('✅ Gift card image generated successfully');
                
                // Create gift card record with proper data validation
                const giftCard = {
                    id: 'gc-' + Date.now(),
                    code: formData.code,
                    invoice: formData.invoice,
                    product: formData.product,
                    email: formData.email,
                    amount: formData.amount || '0.00',
                    createdAt: new Date().toISOString(),
                    status: 'active',
                    imageData: imageData,
                    history: [{
                        action: 'created',
                        timestamp: new Date().toISOString(),
                        details: 'Gift card created and generated'
                    }]
                };
                
                console.log('📝 Gift card record created:', giftCard);
                
                // Save to storage
                const giftCards = getGiftCards();
                giftCards.push(giftCard);
                saveGiftCards(giftCards);
                
                // Send email with enhanced loading
                showGiftCardLoadingStep(submitBtn, 'Sending email...', 'envelope', '#3b82f6');
                console.log('📧 Attempting to send email...');
                
                try {
                    await sendGiftCardEmail(giftCard, imageData);
                    console.log('✅ Email sent successfully');
                    
                    // Show success step
                    showGiftCardLoadingStep(submitBtn, 'Email sent successfully!', 'check-circle', '#10b981');
                    
                    // Update history with successful email
                    giftCard.history.push({
                        action: 'email_sent',
                        timestamp: new Date().toISOString(),
                        details: `Email sent successfully to ${giftCard.email}`
                    });
                } catch (emailError) {
                    console.error('❌ Email sending failed:', emailError);
                    
                    // Show warning step
                    showGiftCardLoadingStep(submitBtn, 'Email failed, but gift card created', 'exclamation-triangle', '#f59e0b');
                    
                    // Update history with email failure
                    giftCard.history.push({
                        action: 'email_failed',
                        timestamp: new Date().toISOString(),
                        details: `Email sending failed: ${emailError.message}`
                    });
                    
                    // Still save the gift card even if email fails
                    showGiftCardMessage('Gift card created successfully! Email sending failed but you can resend it later.', 'warning');
                }
                
                // Save the updated gift card with history
                saveGiftCards(giftCards);
                
                // Update count and close modal
                updateGiftCardCount();
                closeAddGiftCardModal();
                
                // Show success message with options
                showGiftCardSuccessMessage(giftCard);
                
                // Reset button
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
            } catch (error) {
                console.error('❌ Error creating gift card:', error);
                showGiftCardMessage('Error creating gift card: ' + error.message, 'error');
                
                // Reset button
                const submitBtn = e.target.querySelector('button[type="submit"]');
                submitBtn.innerHTML = '<i class="fas fa-magic"></i> Generate Gift Card';
                submitBtn.disabled = false;
            }
        });
        
        // Gift Card List Functions
        function loadGiftCardsList() {
            const giftCards = getGiftCards();
            const container = document.getElementById('gift-cards-list');
            
            // Add filter controls
            const showCompleted = localStorage.getItem('showCompletedGiftCards') === 'true';
            
            container.innerHTML = `
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding: 15px; background: #f8f9fa; border-radius: 8px;">
                    <h4 style="margin: 0; color: var(--main-color);">
                        <i class="fas fa-list"></i> Gift Cards Management
                    </h4>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" id="show-completed-toggle" ${showCompleted ? 'checked' : ''} onchange="toggleCompletedGiftCards()" style="transform: scale(1.2);">
                        <span style="font-weight: 500; color: #666;">Show Completed</span>
                    </label>
                </div>
                <div id="gift-cards-container"></div>
            `;
            
            const giftCardsContainer = document.getElementById('gift-cards-container');
            
            // Filter cards based on toggle
            const filteredCards = showCompleted ? giftCards : giftCards.filter(card => card.status !== 'redeemed');
            
            if (filteredCards.length === 0) {
                giftCardsContainer.innerHTML = `
                    <div style="text-align: center; padding: 40px; color: #666;">
                        <i class="fas fa-gift" style="font-size: 48px; margin-bottom: 16px; color: #ddd;"></i>
                        <h4>${showCompleted ? 'No Gift Cards' : 'No Active Gift Cards'}</h4>
                        <p>${showCompleted ? 'No gift cards have been created yet' : 'No active gift cards found. Toggle "Show Completed" to see all cards.'}</p>
                    </div>
                `;
                return;
            }
            
            giftCardsContainer.innerHTML = filteredCards.map(card => `
                <div style="border: 1px solid #e5e7eb; border-radius: 12px; padding: 20px; margin-bottom: 16px; background: white; ${card.status === 'redeemed' ? 'opacity: 0.8; background: #f9f9f9;' : ''}">
                    <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 15px;">
                        <div>
                            <h4 style="margin: 0 0 8px 0; color: var(--main-color); font-size: 18px;">
                                <i class="fas fa-gift"></i> ${card.code}
                            </h4>
                            <p style="margin: 0; color: #666; font-size: 14px;">
                                Created: ${new Date(card.createdAt).toLocaleDateString()}
                                ${card.completedBy ? `<br>Completed by: <strong>${card.completedBy}</strong> on ${new Date(card.completedAt).toLocaleDateString()}` : ''}
                            </p>
                        </div>
                        <span style="padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; 
                                   background: ${card.status === 'active' ? '#10b981' : card.status === 'redeemed' ? '#6b7280' : '#f59e0b'}; 
                                   color: white; text-transform: uppercase;">
                            ${card.status === 'redeemed' ? 'COMPLETED' : card.status}
                        </span>
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 15px; font-size: 14px;">
                        <div><strong>Invoice:</strong> ${card.invoice}</div>
                        <div><strong>Product:</strong> ${card.product}</div>
                        <div><strong>Email:</strong> ${card.email}</div>
                        <div><strong>Amount:</strong> ${card.amount ? '$' + card.amount : 'N/A'}</div>
                    </div>
                    
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button onclick="downloadGiftCard('${card.id}')" style="padding: 8px 16px; border: none; border-radius: 6px; background: #10b981; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-download"></i> Download
                        </button>
                        <button onclick="resendGiftCard('${card.id}')" style="padding: 8px 16px; border: none; border-radius: 6px; background: #3b82f6; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-envelope"></i> Send Again
                        </button>
                        <button onclick="viewGiftCardDetails('${card.id}')" style="padding: 8px 16px; border: none; border-radius: 6px; background: #f59e0b; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-info-circle"></i> Details
                        </button>
                        ${card.status !== 'redeemed' ? `
                        <button onclick="openMarkAsDoneModal('${card.id}')" style="padding: 8px 16px; border: none; border-radius: 6px; background: #6b7280; color: white; font-size: 12px; cursor: pointer; display: flex; align-items: center; gap: 4px;">
                            <i class="fas fa-check"></i> Mark Done
                        </button>
                        ` : `
                        <button style="padding: 8px 16px; border: none; border-radius: 6px; background: #10b981; color: white; font-size: 12px; cursor: not-allowed; display: flex; align-items: center; gap: 4px;" disabled>
                            <i class="fas fa-check-double"></i> Completed
                        </button>
                        `}
                    </div>
                </div>
            `).join('');
        }
        
        // Gift Card Action Functions
        function downloadGiftCard(cardId) {
            console.log('⬇️ Downloading gift card:', cardId);
            
            const giftCards = getGiftCards();
            const card = giftCards.find(gc => gc.id === cardId);
            
            if (!card) {
                showGiftCardMessage('Gift card not found', 'error');
                return;
            }
            
            // Create download link
            const link = document.createElement('a');
            link.href = card.imageData;
            link.download = `GiftCard_${card.code}.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            // Update history
            card.history.push({
                action: 'downloaded',
                timestamp: new Date().toISOString(),
                details: 'Gift card image downloaded'
            });
            saveGiftCards(giftCards);
            
            showGiftCardMessage('Gift card downloaded successfully', 'success');
        }
        
        async function resendGiftCard(cardId) {
            console.log('📧 Resending gift card:', cardId);
            
            const giftCards = getGiftCards();
            const card = giftCards.find(gc => gc.id === cardId);
            
            if (!card) {
                showGiftCardMessage('Gift card not found', 'error');
                return;
            }
            
            // Find the resend button and show loading
            const resendButtons = document.querySelectorAll('button[onclick*="resendGiftCard"]');
            let targetButton = null;
            
            resendButtons.forEach(btn => {
                if (btn.onclick.toString().includes(cardId)) {
                    targetButton = btn;
                }
            });
            
            if (targetButton) {
                const originalHTML = targetButton.innerHTML;
                showGiftCardLoadingStep(targetButton, 'Sending...', 'spinner', '#3b82f6');
                targetButton.disabled = true;
                
                try {
                    await sendGiftCardEmail(card, card.imageData);
                    
                    // Show success state
                    showGiftCardLoadingStep(targetButton, 'Sent!', 'check', '#10b981');
                    
                    // Update history
                    card.history.push({
                        action: 'email_resent',
                        timestamp: new Date().toISOString(),
                        details: `Email resent to ${card.email}`
                    });
                    saveGiftCards(giftCards);
                    
                    showGiftCardMessage('Gift card email sent successfully! 📧', 'success');
                    
                    // Reset button after delay
                    setTimeout(() => {
                        targetButton.innerHTML = originalHTML;
                        targetButton.disabled = false;
                        targetButton.style = '';
                    }, 2000);
                    
                } catch (error) {
                    console.error('❌ Error resending gift card:', error);
                    
                    // Show error state
                    showGiftCardLoadingStep(targetButton, 'Failed', 'times', '#ef4444');
                    
                    showGiftCardMessage('Error sending email: ' + error.message, 'error');
                    
                    // Reset button after delay
                    setTimeout(() => {
                        targetButton.innerHTML = originalHTML;
                        targetButton.disabled = false;
                        targetButton.style = '';
                    }, 3000);
                }
            } else {
                // Fallback for when button not found
                try {
                    await sendGiftCardEmail(card, card.imageData);
                    
                    card.history.push({
                        action: 'email_resent',
                        timestamp: new Date().toISOString(),
                        details: `Email resent to ${card.email}`
                    });
                    saveGiftCards(giftCards);
                    
                    showGiftCardMessage('Gift card email sent successfully! 📧', 'success');
                    
                } catch (error) {
                    console.error('❌ Error resending gift card:', error);
                    showGiftCardMessage('Error sending email: ' + error.message, 'error');
                }
            }
        }
        
        function viewGiftCardDetails(cardId) {
            console.log('👁️ Viewing gift card details:', cardId);
            
            const giftCards = getGiftCards();
            const card = giftCards.find(gc => gc.id === cardId);
            
            if (!card) {
                showGiftCardMessage('Gift card not found', 'error');
                return;
            }
            
            const modal = document.getElementById('gift-card-details-modal');
            const content = document.getElementById('gift-card-details-content');
            
            content.innerHTML = `
                <div style="margin-bottom: 25px;">
                    <h4 style="color: var(--main-color); margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-gift"></i> Gift Card Information
                    </h4>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; background: #f8f9fa; padding: 15px; border-radius: 8px;">
                        <div><strong>Code:</strong> ${card.code}</div>
                        <div><strong>Invoice:</strong> ${card.invoice}</div>
                        <div><strong>Product:</strong> ${card.product}</div>
                        <div><strong>Amount:</strong> ${card.amount ? '$' + card.amount : 'N/A'}</div>
                        <div><strong>Email:</strong> ${card.email}</div>
                        <div><strong>Status:</strong> 
                            <span style="padding: 2px 8px; border-radius: 12px; font-size: 12px; background: ${card.status === 'active' ? '#10b981' : '#6b7280'}; color: white;">
                                ${card.status === 'redeemed' ? 'COMPLETED' : card.status}
                            </span>
                        </div>
                        <div style="grid-column: span 2;"><strong>Created:</strong> ${new Date(card.createdAt).toLocaleString()}</div>
                        ${card.completedBy ? `
                        <div style="grid-column: span 2; background: rgba(16, 185, 129, 0.1); padding: 10px; border-radius: 6px; border-left: 3px solid #10b981;">
                            <strong>✅ Completed by:</strong> ${card.completedBy} (${card.completedByUsername || 'N/A'})<br>
                            <strong>Role:</strong> ${card.completedByRole || 'user'}<br>
                            <strong>Completed on:</strong> ${card.completedAtFormatted || new Date(card.completedAt).toLocaleString()}
                        </div>` : ''}
                    </div>
                </div>
                
                <div style="margin-bottom: 25px;">
                    <h4 style="color: var(--main-color); margin: 0 0 15px 0; display: flex; align-items: center; gap: 8px;">
                        <i class="fas fa-history"></i> History
                    </h4>
                    <div style="max-height: 200px; overflow-y: auto; border: 1px solid #e5e7eb; border-radius: 8px;">
                        ${card.history.map(entry => `
                            <div style="padding: 12px 15px; border-bottom: 1px solid #f3f4f6; ${entry.action === 'marked_done' ? 'background: rgba(16, 185, 129, 0.05); border-left: 3px solid #10b981;' : ''}">
                                <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: ${entry.completedBy ? '8px' : '0'};">
                                    <div style="flex: 1;">
                                        <strong style="color: ${entry.action === 'marked_done' ? '#10b981' : 'var(--main-color)'}; text-transform: capitalize; display: flex; align-items: center; gap: 6px;">
                                            ${entry.action === 'marked_done' ? '✅' : entry.action === 'created' ? '🎁' : entry.action === 'email_sent' ? '📧' : entry.action === 'email_resent' ? '🔄' : entry.action === 'downloaded' ? '⬇️' : '📝'} 
                                            ${entry.action.replace('_', ' ')}
                                        </strong>
                                        <div style="font-size: 13px; color: #666; margin-top: 2px;">${entry.details}</div>
                                        ${entry.completedBy ? `
                                        <div style="margin-top: 8px; padding: 8px; background: rgba(16, 185, 129, 0.1); border-radius: 4px; font-size: 12px;">
                                            <strong>📋 Completion Details:</strong><br>
                                            👤 <strong>User:</strong> ${entry.completedBy.name} (${entry.completedBy.username})<br>
                                            🔐 <strong>Role:</strong> ${entry.completedBy.role}<br>
                                            🕒 <strong>Time:</strong> ${entry.completedBy.formattedTime}
                                        </div>` : ''}
                                    </div>
                                    <div style="font-size: 12px; color: #999; margin-left: 15px; text-align: right;">
                                        ${new Date(entry.timestamp).toLocaleDateString()}<br>
                                        ${new Date(entry.timestamp).toLocaleTimeString()}
                                    </div>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
                
                <div style="display: flex; gap: 8px; justify-content: flex-end;">
                    <button onclick="downloadGiftCard('${card.id}')" style="padding: 10px 16px; border: none; border-radius: 8px; background: #10b981; color: white; cursor: pointer;">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button onclick="resendGiftCard('${card.id}')" style="padding: 10px 16px; border: none; border-radius: 8px; background: #3b82f6; color: white; cursor: pointer;">
                        <i class="fas fa-envelope"></i> Send Again
                    </button>
                    <button onclick="closeGiftCardDetailsModal()" style="padding: 10px 16px; border: none; border-radius: 8px; background: #6b7280; color: white; cursor: pointer;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            // Show modal
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10000 !important;
                background: rgba(0, 0, 0, 0.6) !important;
                backdrop-filter: blur(8px) !important;
            `;
        }
        
        // Filter toggle function
        function toggleCompletedGiftCards() {
            const checkbox = document.getElementById('show-completed-toggle');
            localStorage.setItem('showCompletedGiftCards', checkbox.checked);
            loadGiftCardsList(); // Refresh the list
        }
        
        // Mark as done with verification
        function openMarkAsDoneModal(cardId) {
            console.log('🔒 Opening mark as done verification for:', cardId);
            
            const giftCards = getGiftCards();
            const card = giftCards.find(gc => gc.id === cardId);
            
            if (!card) {
                showGiftCardMessage('Gift card not found', 'error');
                return;
            }
            
            // Create verification modal
            const modal = document.createElement('div');
            modal.id = 'mark-done-verification-modal';
            modal.className = 'simple-modal show';
            modal.style.cssText = `
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                display: flex !important;
                justify-content: center !important;
                align-items: center !important;
                z-index: 10001 !important;
                background: rgba(0, 0, 0, 0.7) !important;
                backdrop-filter: blur(8px) !important;
            `;
            
            modal.innerHTML = `
                <div class="simple-modal-content" style="width: 450px; border: 2px solid #10b981;">
                    <div class="simple-modal-header">
                        <h3 style="color: #10b981;">
                            <i class="fas fa-check-circle"></i>
                            Mark Gift Card as Completed
                        </h3>
                        <button class="simple-modal-close" onclick="closeMarkDoneModal()">&times;</button>
                    </div>
                    <div class="simple-modal-body">
                        <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 15px; margin-bottom: 20px;">
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <i class="fas fa-gift" style="color: #10b981; font-size: 24px;"></i>
                                <div>
                                    <strong style="color: #10b981;">Gift Card: ${card.code}</strong><br>
                                    <span style="color: #666; font-size: 14px;">Product: ${card.product} | Email: ${card.email}</span>
                                </div>
                            </div>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                                <i class="fas fa-user"></i> Select User
                            </label>
                            <select id="mark-done-user-select" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px;">
                                <option value="">Choose your username...</option>
                            </select>
                        </div>
                        
                        <div style="margin-bottom: 20px;">
                            <label style="display: block; font-weight: 600; color: var(--main-color); margin-bottom: 8px;">
                                <i class="fas fa-lock"></i> Password
                            </label>
                            <input type="password" id="mark-done-password-input" placeholder="Enter your password" style="width: 100%; padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 14px; box-sizing: border-box;">
                        </div>
                        
                        <div id="mark-done-error-message" style="display: none; background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.3); color: #dc2626; padding: 10px; border-radius: 6px; margin-bottom: 15px; font-size: 14px;">
                        </div>
                        
                        <div style="display: flex; gap: 12px; justify-content: flex-end;">
                            <button onclick="closeMarkDoneModal()" style="padding: 12px 20px; border: none; border-radius: 8px; background: #f3f4f6; color: #374151; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                <i class="fas fa-times"></i> Cancel
                            </button>
                            <button onclick="confirmMarkAsDone('${cardId}')" style="padding: 12px 20px; border: none; border-radius: 8px; background: #10b981; color: white; font-weight: 600; cursor: pointer; transition: all 0.3s ease;">
                                <i class="fas fa-check"></i> Mark as Done
                            </button>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Populate user dropdown
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const userSelect = document.getElementById('mark-done-user-select');
            
            users.forEach(user => {
                const option = document.createElement('option');
                option.value = user.username;
                option.textContent = `${user.name || user.username} (${user.role || 'user'})`;
                userSelect.appendChild(option);
            });
            
            // Focus password input when user is selected
            userSelect.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('mark-done-password-input').focus();
                }
            });
            
            // Enter key support
            document.getElementById('mark-done-password-input').addEventListener('keydown', function(e) {
                if (e.key === 'Enter' && userSelect.value && this.value) {
                    confirmMarkAsDone(cardId);
                }
            });
        }
        
        function closeMarkDoneModal() {
            const modal = document.getElementById('mark-done-verification-modal');
            if (modal) {
                modal.remove();
            }
        }
        
        function confirmMarkAsDone(cardId) {
            const userSelect = document.getElementById('mark-done-user-select');
            const passwordInput = document.getElementById('mark-done-password-input');
            const errorDiv = document.getElementById('mark-done-error-message');
            
            const selectedUser = userSelect.value;
            const enteredPassword = passwordInput.value.trim();
            
            // Clear previous errors
            errorDiv.style.display = 'none';
            
            if (!selectedUser) {
                showMarkDoneError('Please select a user');
                return;
            }
            
            if (!enteredPassword) {
                showMarkDoneError('Please enter your password');
                return;
            }
            
            // Verify credentials
            const users = JSON.parse(localStorage.getItem('users') || '[]');
            const user = users.find(u => u.username === selectedUser);
            
            if (!user || user.password !== enteredPassword) {
                showMarkDoneError('Invalid username or password');
                passwordInput.value = '';
                passwordInput.focus();
                return;
            }
            
            // Mark as done with detailed tracking
            const giftCards = getGiftCards();
            const card = giftCards.find(gc => gc.id === cardId);
            
            if (!card) {
                showMarkDoneError('Gift card not found');
                return;
            }
            
            const currentTime = new Date().toISOString();
            const completionDateTime = new Date().toLocaleString('en-US', {
                year: 'numeric',
                month: 'long',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                timeZoneName: 'short'
            });
            
            // Update card status and completion info
            card.status = 'redeemed';
            card.completedBy = user.name || user.username;
            card.completedByUsername = user.username;
            card.completedByRole = user.role || 'user';
            card.completedAt = currentTime;
            card.completedAtFormatted = completionDateTime;
            
            // Add detailed completion entry to history
            card.history.push({
                action: 'marked_done',
                timestamp: currentTime,
                details: `Gift card marked as completed/redeemed by ${user.name || user.username} (${user.username}) with ${user.role || 'user'} privileges on ${completionDateTime}`,
                completedBy: {
                    name: user.name || user.username,
                    username: user.username,
                    role: user.role || 'user',
                    timestamp: currentTime,
                    formattedTime: completionDateTime
                }
            });
            
            saveGiftCards(giftCards);
            closeMarkDoneModal();
            loadGiftCardsList(); // Refresh the list
            showGiftCardMessage(`✅ Gift card ${card.code} marked as completed by ${user.name || user.username} on ${new Date().toLocaleDateString()}`, 'success');
            
            console.log(`✅ Gift card ${card.code} marked as done by ${user.name || user.username} (${user.username}) at ${completionDateTime}`);
        }
        
        function showMarkDoneError(message) {
            const errorDiv = document.getElementById('mark-done-error-message');
            if (errorDiv) {
                errorDiv.textContent = message;
                errorDiv.style.display = 'block';
                
                // Auto-hide after 4 seconds
                setTimeout(() => {
                    errorDiv.style.display = 'none';
                }, 4000);
            }
        }
        
        // Enhanced Loading Functions
        function showGiftCardLoadingStep(button, message, icon = 'spinner', color = '#ff9562') {
            const isSpinning = icon === 'spinner';
            button.innerHTML = `
                <div style="display: flex; align-items: center; gap: 8px; justify-content: center;">
                    <div style="position: relative; display: flex; align-items: center;">
                        <i class="fas fa-${icon} ${isSpinning ? 'fa-spin' : ''}" style="color: ${color}; font-size: 16px;"></i>
                        ${isSpinning ? '<div style="position: absolute; width: 24px; height: 24px; border: 2px solid transparent; border-top: 2px solid ' + color + '; border-radius: 50%; animation: spin 1s linear infinite; margin-left: -4px; margin-top: -2px;"></div>' : ''}
                    </div>
                    <span style="font-weight: 600;">${message}</span>
                </div>
            `;
            button.style.background = 'rgba(255, 255, 255, 0.95)';
            button.style.border = `2px solid ${color}`;
            button.style.color = color;
            button.style.boxShadow = `0 4px 12px rgba(0,0,0,0.1)`;
            button.style.transform = 'translateY(-1px)';
        }

        // Message Functions
        function showGiftCardMessage(message, type = 'info') {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                padding: 15px 20px;
                border-radius: 8px;
                color: white;
                font-weight: 600;
                z-index: 10001;
                animation: slideInFromRight 0.3s ease;
                max-width: 300px;
                box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            `;
            
            if (type === 'success') {
                notification.style.background = '#10b981';
            } else if (type === 'error') {
                notification.style.background = '#ef4444';
            } else if (type === 'warning') {
                notification.style.background = '#f59e0b';
            } else {
                notification.style.background = '#3b82f6';
            }
            
            notification.textContent = message;
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 4000);
        }
        
        function showGiftCardSuccessMessage(giftCard) {
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: linear-gradient(135deg, #10b981, #059669);
                color: white;
                padding: 20px;
                border-radius: 12px;
                box-shadow: 0 10px 25px rgba(16, 185, 129, 0.3);
                z-index: 10001;
                animation: slideInFromRight 0.3s ease;
                max-width: 350px;
            `;
            
            notification.innerHTML = `
                <div style="margin-bottom: 12px;">
                    <h4 style="margin: 0 0 8px 0;">🎉 Gift Card Created Successfully!</h4>
                    <p style="margin: 0; font-size: 14px; opacity: 0.9;">Code: ${giftCard.code}</p>
                </div>
                <div style="display: flex; gap: 8px;">
                    <button onclick="downloadGiftCard('${giftCard.id}'); this.parentElement.parentElement.remove();" style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; background: rgba(255,255,255,0.2); color: white; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-download"></i> Download
                    </button>
                    <button onclick="this.parentElement.parentElement.remove();" style="flex: 1; padding: 8px 12px; border: none; border-radius: 6px; background: rgba(255,255,255,0.1); color: white; cursor: pointer; font-size: 12px;">
                        <i class="fas fa-times"></i> Close
                    </button>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.remove();
                }
            }, 10000);
        }
        
        // Initialize gift card count on page load
        document.addEventListener('DOMContentLoaded', function() {
            updateGiftCardCount();
        });
    </script>
    
    <script>
        // **TESTING AND DEBUGGING FUNCTIONS**
        
        // Test appointment saving functionality
        window.testAppointmentSave = function() {
            console.log('🧪 === TESTING APPOINTMENT SAVE FUNCTIONALITY ===');
            
            // First open the modal
            openAppointmentModal();
            
            setTimeout(() => {
                // Fill form with test data
                document.getElementById('client-name').value = 'Test Client Save';
                document.getElementById('client-email').value = 'testsave@test.com';
                document.getElementById('client-phone').value = '555-SAVE';
                document.getElementById('appointment-date').value = new Date().toISOString().split('T')[0];
                document.getElementById('appointment-hour').value = '10';
                document.getElementById('appointment-minute').value = '00';
                document.getElementById('appointment-ampm').value = 'AM';
                document.getElementById('appointment-type').value = 'MonuMe';
                
                console.log('✅ Form filled with test data');
                console.log('💡 Click "Schedule Appointment" button to test save functionality');
                console.log('💡 Or call: saveAppointmentFromDashboard() directly');
            }, 500);
        };

        // Test user count functionality
        window.testUserCount = function() {
            console.log('🧪 === TESTING USER COUNT FUNCTIONALITY ===');
            
            // Add some test users
            addActiveUser('testuser1');
            addActiveUser('testuser2');
            addActiveUser('testuser3');
            
            console.log('✅ Added 3 test users');
            
            // Update count
            updateActiveUsersCountReal();
            
            console.log('📊 Check Team MonuMe card for updated count');
            
            // Show current count
            const currentCount = document.getElementById('activeUsers')?.textContent;
            console.log('Current displayed count:', currentCount);
        };

        // Fix user count display
        window.fixUserCountDisplay = function() {
            console.log('🔧 === FIXING USER COUNT DISPLAY ===');
            
            const activeUsersElement = document.getElementById('activeUsers');
            console.log('activeUsers element found:', !!activeUsersElement);
            
            if (!activeUsersElement) {
                console.error('❌ #activeUsers element not found!');
                console.log('🔍 Searching for alternative elements...');
                
                const allStatValues = document.querySelectorAll('.stat-card-value');
                console.log('Found stat-card-value elements:', allStatValues.length);
                
                allStatValues.forEach((el, index) => {
                    console.log(`Element ${index}:`, el.textContent, el.id || el.className);
                });
            } else {
                console.log('✅ Element found, updating count...');
                updateActiveUsersCountReal();
            }
        };

        // Test immediate save
        window.testSaveNow = function() {
            console.log('🧪 Testing immediate save...');
            
            const testApt = {
                id: `test-${Date.now()}`,
                clientName: 'Immediate Test',
                clientEmail: 'immediate@test.com',
                clientPhone: '555-IMMEDIATE',
                date: new Date().toISOString().split('T')[0],
                time: '14:00',
                type: 'MonuMe',
                status: 'scheduled',
                hostId: 'admin',
                notes: 'Immediate test appointment',
                createdAt: new Date().toISOString()
            };
            
            const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
            appointments.push(testApt);
            localStorage.setItem('monumeAppointments', JSON.stringify(appointments));
            
            console.log('✅ Test appointment saved directly to localStorage');
            console.log('📊 Total appointments now:', appointments.length);
            
            // Update display
            updateDashboardAppointmentCount();
            loadWeeklyAppointments(true);
            
            return testApt;
        };

        // Check active users data
        window.checkActiveUsersData = function() {
            console.log('🔍 === CHECKING ACTIVE USERS DATA ===');
            
            const activeUsers = JSON.parse(localStorage.getItem('activeUsers') || '[]');
            console.log('📊 Active users in storage:', activeUsers.length);
            
            if (activeUsers.length > 0) {
                activeUsers.forEach((user, index) => {
                    console.log(`${index + 1}. ${user.username} - Last activity: ${new Date(user.lastActivity).toLocaleString()}`);
                });
            } else {
                console.log('ℹ️ No active users found');
                console.log('💡 Adding test user...');
                addActiveUser('testuser');
            }
            
            // Update display
            updateActiveUsersCountReal();
            
            const displayedCount = document.getElementById('activeUsers')?.textContent || 'NOT FOUND';
            console.log('📺 Displayed count:', displayedCount);
        };

        // Quick fix for both issues
        window.quickFix = function() {
            console.log('⚡ === QUICK FIX FOR DASHBOARD ISSUES ===');
            
            console.log('🔧 Step 1: Fixing user count...');
            updateActiveUsersCountReal();
            
            console.log('📊 Step 2: Updating appointment count...');
            updateDashboardAppointmentCount();
            
            console.log('🔄 Step 3: Refreshing appointments display...');
            loadWeeklyAppointments(true);
            
            console.log('✅ Quick fix complete!');
            
            // Show status
            setTimeout(() => {
                const userCount = document.getElementById('activeUsers')?.textContent || 'NOT FOUND';
                const appointments = JSON.parse(localStorage.getItem('monumeAppointments') || '[]');
                
                console.log('📈 Current status:');
                console.log(`   User count displayed: ${userCount}`);
                console.log(`   Appointments in storage: ${appointments.length}`);
                console.log('💡 Try testAppointmentSave() to test appointment saving');
                console.log('💡 Try testUserCount() to test user count functionality');
            }, 1000);
        };

        // Auto-run quick fix when page loads
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(() => {
                console.log('🚀 Auto-running quick fix...');
                if (typeof quickFix === 'function') {
                    quickFix();
                }
            }, 2000); // Run after 2 seconds to ensure everything is loaded
        });
 
    </script>
</body>
</html>
