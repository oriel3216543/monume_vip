<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Add New User - MonuMe Tracker</title>
    <link rel="icon" type="image/png" href="/icon.png">
    <!-- Authentication Check -->
    <script>
        // Authentication check - runs after page loads
        document.addEventListener('DOMContentLoaded', function() {
            const username = localStorage.getItem("username");
            const isLoggedIn = localStorage.getItem("isLoggedIn");
            const role = localStorage.getItem("role");
            
            console.log("Auth check - username:", username, "isLoggedIn:", isLoggedIn, "role:", role);
            
            if (!username || !isLoggedIn) {
                console.log("Authentication failed, redirecting to login page");
                window.location.href = "/login";
                return;
            }

            console.log("Authentication successful for:", username, "Role:", role);
        });
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }

        :root {
            --main-color: #ff9562;
            --primary-color: #ff9562;
            --primary-color-rgb: 255, 149, 98;
            --gradient-start: #ff7f42;
            --gradient-end: #ff9562;
            --sidebar-bg: #272430;
            --card-bg: rgba(255, 255, 255, 0.95);
            --card-hover-bg: rgba(255, 255, 255, 0.98);
            --text-primary: #ffffff;
            --text-secondary: rgba(255, 255, 255, 0.9);
            --text-muted: rgba(255, 255, 255, 0.7);
            --text-light: #f8f9fa;
            --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.15);
            --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.2);
            --shadow-lg: 0 8px 32px rgba(0, 0, 0, 0.25);
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            --border-radius: 12px;
            --border-color: rgba(255, 255, 255, 0.2);
            --font-weight-medium: 500;
            --font-weight-semibold: 600;
            --font-weight-bold: 700;
            --white: #ffffff;
            --gray-50: #f9fafb;
            --gray-100: #f3f4f6;
            --gray-200: #e5e7eb;
        }

        body {
            background: linear-gradient(135deg, #ff9562, #ff7f42);
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1500"><rect fill="%23ff9562" width="2000" height="1500"/><defs><radialGradient id="a" gradientUnits="objectBoundingBox"><stop offset="0" stop-color="%23ffffff"/><stop offset="1" stop-color="%23ff9562"/></radialGradient><linearGradient id="b" gradientUnits="userSpaceOnUse" x1="0" y1="750" x2="1550" y2="750"><stop offset="0" stop-color="%23ffcab1"/><stop offset="1" stop-color="%23ff9562"/></linearGradient></defs><path fill="url(%23a)" d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z"/><path d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 253.3-58 79.2-123.4 152.6-195.1 219-71.7 66.4-149.6 125.8-232.2 177.2-82.7 51.4-170.1 94.7-260.7 129.1-90.6 34.4-184.4 60-279.5 76.3C192.6 1495 96.1 1502 0 1500v-400.7c96.1-2.1 191.8-13.3 285.4-33.6 93.6-20.2 185-49.5 272.5-87.2 87.6-37.7 171.3-83.8 249.6-137.3 78.4-53.5 151.5-114.5 217.9-181.7 66.5-67.2 126.4-140.7 178.6-218.9 52.3-78.3 96.9-161.4 133-247.9 36.1-86.5 63.8-176.2 82.6-267.6 18.8-91.4 28.6-184.4 29.6-277.4H1500c0.9 92.9 10.7 185.8 29.2 277.2z" fill="url(%23b)"/></svg>') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
            margin: 0;
            padding: 0;
        }

        /* Main Container */
        .main-container {
            width: 100%;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 40px 20px;
        }

        /* Header */
        .page-header {
            text-align: center;
            margin-bottom: 40px;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 40px 60px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            position: relative;
            overflow: hidden;
            max-width: 600px;
            width: 100%;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: linear-gradient(45deg, transparent, rgba(255, 149, 98, 0.05), transparent);
            animation: shimmer 3s ease-in-out infinite;
        }

        @keyframes shimmer {
            0% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
            50% { transform: translateX(100%) translateY(100%) rotate(45deg); }
            100% { transform: translateX(-100%) translateY(-100%) rotate(45deg); }
        }

        .page-header h1 {
            font-size: 2.8rem;
            font-weight: 800;
            color: #1f2937;
            margin-bottom: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 16px;
            position: relative;
            z-index: 1;
        }

        .page-header h1 i {
            color: var(--main-color);
            text-shadow: 0 4px 8px rgba(255, 149, 98, 0.3);
        }

        .page-header p {
            font-size: 1.1rem;
            color: #6b7280;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        /* Form Container */
        .form-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border-radius: 28px;
            padding: 48px;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.3);
            max-width: 800px;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        .form-container::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 1px;
            background: linear-gradient(90deg, transparent, rgba(255, 149, 98, 0.3), transparent);
        }

        /* Form Grid */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 24px;
            margin-bottom: 32px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group.full-width {
            grid-column: span 2;
        }

        .form-group label {
            font-size: 14px;
            font-weight: 600;
            color: #374151;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .form-group label i {
            color: var(--main-color);
            font-size: 16px;
        }

        .form-group input,
        .form-group select {
            padding: 16px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 500;
            color: #1f2937;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
        }

        .form-group input:focus,
        .form-group select:focus {
            outline: none;
            border-color: var(--main-color);
            background: rgba(255, 255, 255, 0.95);
            box-shadow: 0 8px 25px rgba(255, 149, 98, 0.15);
            transform: translateY(-2px);
        }

        .form-group input::placeholder {
            color: #9ca3af;
            font-weight: 400;
        }

        /* Role Selection */
        .role-options {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 16px;
            margin-top: 12px;
        }

        .role-option {
            position: relative;
        }

        .role-option input[type="radio"] {
            display: none;
        }

        .role-option label {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 18px 20px;
            border: 2px solid #e5e7eb;
            border-radius: 16px;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            font-weight: 500;
            color: #374151;
        }

        .role-option input[type="radio"]:checked + label {
            border-color: var(--main-color);
            background: rgba(255, 149, 98, 0.1);
            color: var(--main-color);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 149, 98, 0.15);
        }

        .role-option label i {
            font-size: 20px;
        }

        /* Form Actions */
        .form-actions {
            display: flex;
            gap: 16px;
            justify-content: center;
            margin-top: 40px;
        }

        .btn {
            padding: 16px 32px;
            border: none;
            border-radius: 16px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            display: flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            min-width: 140px;
            justify-content: center;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            box-shadow: 0 8px 25px rgba(255, 149, 98, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 12px 35px rgba(255, 149, 98, 0.4);
        }

        .btn-secondary {
            background: rgba(255, 255, 255, 0.8);
            color: #374151;
            border: 2px solid rgba(255, 149, 98, 0.2);
        }

        .btn-secondary:hover {
            background: rgba(255, 149, 98, 0.1);
            border-color: var(--main-color);
            transform: translateY(-2px);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none !important;
        }

        /* Success/Error Messages */
        .message {
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .message.success {
            background: rgba(16, 185, 129, 0.1);
            color: #065f46;
            border: 1px solid rgba(16, 185, 129, 0.2);
        }

        .message.error {
            background: rgba(239, 68, 68, 0.1);
            color: #991b1b;
            border: 1px solid rgba(239, 68, 68, 0.2);
        }

        /* Loading Animation */
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Back Button */
        .back-btn {
            position: fixed;
            top: 30px;
            left: 30px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #374151;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            text-decoration: none;
        }

        .back-btn:hover {
            background: rgba(255, 255, 255, 1);
            transform: translateY(-2px);
            box-shadow: 0 12px 35px rgba(0, 0, 0, 0.15);
            color: var(--main-color);
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .main-container {
                padding: 20px 16px;
            }

            .page-header {
                padding: 30px 24px;
            }

            .page-header h1 {
                font-size: 2rem;
            }

            .form-container {
                padding: 30px 24px;
            }

            .form-grid {
                grid-template-columns: 1fr;
                gap: 20px;
            }

            .form-group.full-width {
                grid-column: span 1;
            }

            .form-actions {
                flex-direction: column;
            }

            .btn {
                width: 100%;
            }

            .role-options {
                grid-template-columns: 1fr;
            }
        }


    </style>
</head>
<body>
    <!-- Back Button -->
    <a href="/users" class="back-btn">
        <i class="fas fa-arrow-left"></i>
    </a>

    <div class="main-container">
        <!-- Loading Indicator -->
        <div id="loading-indicator" style="position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: white; padding: 20px; border-radius: 10px; box-shadow: 0 4px 20px rgba(0,0,0,0.1); z-index: 9999;">
            <p>Loading page...</p>
        </div>
        
        <!-- Page Header -->
        <div class="page-header">
            <h1 id="page-title">
                <i class="fas fa-user-plus"></i>
                Create New User
            </h1>
            <p id="page-description">Add a new team member to your MonuMe system</p>
        </div>

        <!-- Form Container -->
        <div class="form-container">
            <form id="user-form" class="user-form">
                <!-- Success/Error Messages -->
                <div id="message-container"></div>

                <div class="form-grid">
                    <div class="form-group">
                        <label for="name">
                            <i class="fas fa-user"></i>
                            Full Name *
                        </label>
                        <input type="text" id="name" name="name" required 
                               placeholder="Enter full name">
                    </div>
                    
                    <div class="form-group">
                        <label for="email">
                            <i class="fas fa-envelope"></i>
                            Email Address *
                        </label>
                        <input type="email" id="email" name="email" required 
                               placeholder="Enter email address">
                    </div>
                    
                    <div class="form-group">
                        <label for="username">
                            <i class="fas fa-at"></i>
                            Username *
                        </label>
                        <input type="text" id="username" name="username" required 
                               placeholder="Enter username">
                    </div>
                    
                    <div class="form-group">
                        <label for="password">
                            <i class="fas fa-lock"></i>
                            Password *
                        </label>
                        <input type="password" id="password" name="password" required 
                               placeholder="Enter password">
                    </div>
                    <div class="form-group">
                        <label for="base_hourly_rate">
                            <i class="fas fa-dollar-sign"></i>
                            Base Hourly Rate (before tiers)
                        </label>
                        <input type="number" id="base_hourly_rate" name="base_hourly_rate" step="0.01" min="0" placeholder="0.00">
                    </div>
                    
                    <div class="form-group full-width">
                        <label for="location_id">
                            <i class="fas fa-map-marker-alt"></i>
                            Assign to Location *
                        </label>
                        <select id="location_id" name="location_id" required>
                            <option value="">Select a location</option>
                        </select>
                    </div>
                    
                    <div class="form-group full-width">
                        <label>
                            <i class="fas fa-shield-alt"></i>
                            User Role *
                        </label>
                        <div class="role-options">
                            <div class="role-option">
                                <input type="radio" id="role-user" name="role" value="user" checked>
                                <label for="role-user">
                                    <i class="fas fa-user"></i>
                                    <span>User</span>
                                </label>
                            </div>
                            <div class="role-option">
                                <input type="radio" id="role-location" name="role" value="location_manager">
                                <label for="role-location">
                                    <i class="fas fa-map-marker-alt"></i>
                                    <span>Location Manager</span>
                                </label>
                            </div>
                            <div class="role-option">
                                <input type="radio" id="role-admin" name="role" value="admin">
                                <label for="role-admin">
                                    <i class="fas fa-shield-alt"></i>
                                    <span>Administrator</span>
                                </label>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="form-actions">
                    <button type="button" class="btn btn-secondary" onclick="window.location.href='/users'">
                        <i class="fas fa-times"></i>
                        Cancel
                    </button>
                    <button type="submit" class="btn btn-primary" id="submit-btn">
                        <i class="fas fa-save"></i>
                        Create User
                    </button>
                </div>
            </form>
        </div>
    </div>

    <script>
        // Global variables for edit mode
        let isEditMode = false;
        let editUserId = null;
        
        // Check if we're in edit mode
        function checkEditMode() {
            const urlParams = new URLSearchParams(window.location.search);
            editUserId = urlParams.get('edit');
            
            if (editUserId) {
                isEditMode = true;
                console.log('Edit mode detected for user ID:', editUserId);
                
                // Update page header for edit mode
                const pageTitle = document.getElementById('page-title');
                const pageDescription = document.getElementById('page-description');
                const submitBtn = document.getElementById('submit-btn');
                
                if (pageTitle) {
                    pageTitle.innerHTML = '<i class="fas fa-user-edit"></i> Edit User';
                }
                if (pageDescription) {
                    pageDescription.textContent = 'Update user information and settings';
                }
                if (submitBtn) {
                    submitBtn.innerHTML = '<i class="fas fa-save"></i> Update User';
                }
                
                // Pre-fill form with URL parameters
                const name = urlParams.get('name');
                const email = urlParams.get('email');
                const username = urlParams.get('username');
                const role = urlParams.get('role');
                const locationId = urlParams.get('location_id');
                const isActive = urlParams.get('is_active');
                const baseRate = urlParams.get('base_hourly_rate');
                
                // Fill form fields
                if (name) document.getElementById('name').value = decodeURIComponent(name);
                if (email) document.getElementById('email').value = decodeURIComponent(email);
                if (username) document.getElementById('username').value = decodeURIComponent(username);
                if (role) {
                    const roleRadio = document.querySelector(`input[name="role"][value="${role}"]`);
                    if (roleRadio) roleRadio.checked = true;
                }
                if (baseRate) {
                    const baseEl = document.getElementById('base_hourly_rate');
                    if (baseEl) baseEl.value = decodeURIComponent(baseRate);
                }
                
                // Set location after locations are loaded
                setTimeout(() => {
                    if (locationId) {
                        const locationSelect = document.getElementById('location_id');
                        if (locationSelect) {
                            locationSelect.value = locationId;
                        }
                    }
                }, 500);
                
                // Make password optional for editing
                const passwordField = document.getElementById('password');
                if (passwordField) {
                    passwordField.required = false;
                    passwordField.placeholder = 'Leave blank to keep current password';
                }
            }
        }

        // Load locations for dropdown
        async function loadLocations() {
            try {
                // First get current user info to check role
                const userResponse = await fetch('/get_current_user', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                let currentUser = null;
                if (userResponse.ok) {
                    const userData = await userResponse.json();
                    currentUser = userData.user;
                    console.log('Current user:', currentUser);
                }

                const response = await fetch('/api/locations', {
                    method: 'GET',
                    headers: {
                        'Content-Type': 'application/json',
                    }
                });

                if (response.ok) {
                    const data = await response.json();
                    console.log('Locations response:', data);
                    
                    // Handle different response formats
                    const locations = data.locations || data;
                    const locationSelect = document.getElementById('location_id');
                    
                    // Clear existing options except the first one
                    locationSelect.innerHTML = '<option value="">Select a location</option>';
                    
                    // Add location options
                    if (Array.isArray(locations)) {
                        locations.forEach(location => {
                            const option = document.createElement('option');
                            option.value = location.id;
                            option.textContent = `${location.name || location.location_name} ${location.mall ? '- ' + location.mall : ''}${location.address ? '- ' + location.address : ''}`;
                            locationSelect.appendChild(option);
                        });
                        console.log(`Loaded ${locations.length} locations`);

                        // If user is location manager, automatically select their location
                        if (currentUser && currentUser.role === 'location_manager' && currentUser.location_id) {
                            locationSelect.value = currentUser.location_id;
                            locationSelect.disabled = true;
                            console.log('Location manager detected, auto-selected location:', currentUser.location_id);
                        }
                    } else {
                        console.error('Locations data is not an array:', locations);
                        showMessage('No locations available. Please contact administrator.', 'error');
                    }
                } else {
                    const errorData = await response.json();
                    console.error('Failed to load locations:', errorData);
                    showMessage(errorData.error || 'Failed to load locations. Please refresh the page.', 'error');
                }
            } catch (error) {
                console.error('Error loading locations:', error);
                showMessage('Error loading locations. Please check your connection.', 'error');
            }
        }

        // Show success/error messages
        function showMessage(message, type) {
            const messageContainer = document.getElementById('message-container');
            
            const messageElement = document.createElement('div');
            messageElement.className = `message ${type}`;
            
            if (type === 'success') {
                messageElement.innerHTML = `<i class="fas fa-check-circle"></i> ${message}`;
            } else {
                messageElement.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${message}`;
            }
            
            messageContainer.innerHTML = '';
            messageContainer.appendChild(messageElement);
            
            // Scroll to message
            messageElement.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
        }

        // Go back function
        function goBack() {
            window.location.href = '/users';
        }

        // Handle form submission
        document.getElementById('user-form').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const submitBtn = e.target.querySelector('button[type="submit"]');
            const originalText = submitBtn.innerHTML;
            
            // Show loading state
            const loadingText = isEditMode ? 'Updating...' : 'Creating...';
            submitBtn.innerHTML = `<i class="fas fa-spinner spinner"></i> ${loadingText}`;
            submitBtn.disabled = true;
            
            try {
                const formData = new FormData(this);
                const userData = {
                    name: formData.get('name'),
                    email: formData.get('email'),
                    username: formData.get('username'),
                    role: formData.get('role'),
                    location_id: formData.get('location_id') ? parseInt(formData.get('location_id')) : null,
                    base_hourly_rate: formData.get('base_hourly_rate') ? parseFloat(formData.get('base_hourly_rate')) : 0
                };

                // Set is_active - for edit mode, get from URL params, otherwise default to true
                if (isEditMode) {
                    const urlParams = new URLSearchParams(window.location.search);
                    const isActiveParam = urlParams.get('is_active');
                    userData.is_active = isActiveParam === 'true';
                } else {
                    userData.is_active = true; // Default to active for new users
                }

                // Only include password if it's provided (for edit mode)
                const password = formData.get('password');
                if (password && password.trim() !== '') {
                    userData.password = password;
                }

                console.log('Submitting user data:', userData);

                let response;
                if (isEditMode) {
                    // Update existing user
                    response = await fetch(`/api/users/${editUserId}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(userData)
                    });
                } else {
                    // Create new user with pending tiers (if any)
                    const tiers = Array.isArray(window.__pendingTiers) ? window.__pendingTiers : [];
                    response = await fetch('/api/users', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ ...userData, tiers })
                    });
                }

                const result = await response.json();
                console.log('User operation response:', result);
                console.log('Response status:', response.status);

                if (response.ok && result.success) {
                    const successMessage = isEditMode ? 'User updated successfully! Redirecting to users page...' : 'User created successfully! Redirecting to users page...';
                    showMessage(successMessage, 'success');
                    
                    // Redirect to users page after 2 seconds
                    setTimeout(() => {
                        window.location.href = '/users';
                    }, 2000);
                } else {
                    const errorMessage = result.message || result.error || (isEditMode ? 'Failed to update user. Please try again.' : 'Failed to create user. Please try again.');
                    console.error('Server error details:', result);
                    showMessage(errorMessage, 'error');
                }
            } catch (error) {
                console.error('Error with user operation:', error);
                showMessage('An error occurred. Please check your connection and try again.', 'error');
            } finally {
                // Reset button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
            }
        });

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Page loaded, checking edit mode and loading locations...');
            console.log('Body element:', document.body);
            console.log('Main container:', document.querySelector('.main-container'));
            
            // Hide loading indicator
            const loadingIndicator = document.getElementById('loading-indicator');
            if (loadingIndicator) {
                loadingIndicator.style.display = 'none';
            }
            
            // Check if we're in edit mode first
            checkEditMode();
            
            // Then load locations
            loadLocations();

            // Initialize tiers UI (only in edit mode)
            initTiersUI();
        });

        // ===== Commission Tiers UI =====
        function initTiersUI() {
            const container = document.querySelector('.form-container');
            if (!container) return;

            const section = document.createElement('div');
            section.className = 'form-container';
            section.style.marginTop = '24px';
            section.innerHTML = `
                <h3 style="margin-bottom:16px;color:#374151;display:flex;align-items:center;gap:8px;">
                    <i class="fas fa-coins" style="color:#ff9562"></i>
                    Commission Tiers
                </h3>
                <p style="margin-bottom:12px;color:#6b7280">To unlock a tier for a day, both same-day Sales Goal and (optional) Min Demo must be met.</p>
                <div id="tiers-toolbar" style="display:flex;gap:12px;flex-wrap:wrap;margin-top:12px">
                    <button id="add-tier-btn" type="button" class="btn btn-secondary"><i class="fas fa-plus"></i> Add Tier</button>
                    <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
                        <select id="copy-tier-select" style="min-width:260px;padding:12px;border:1px solid #e5e7eb;border-radius:12px">
                            <option value="">Copy tiers from user…</option>
                        </select>
                        <button id="copy-tier-btn" type="button" class="btn btn-primary"><i class="fas fa-copy"></i> Copy Tiers</button>
                    </div>
                    <div style="flex:1"></div>
                    <button id="save-all-tiers-btn" type="button" class="btn btn-primary"><i class="fas fa-save"></i> Save All Tiers</button>
                </div>
                <div id="tiers-list" style="display:flex;flex-direction:column;gap:12px;margin-top:12px;"></div>
            `;
            container.parentNode.appendChild(section);

            document.getElementById('add-tier-btn').addEventListener('click', addTierRow);

            // Populate copy-tier user list and bind copy action
            setupCopyTierUI();
            const saveAllBtn = document.getElementById('save-all-tiers-btn');
            if (saveAllBtn) saveAllBtn.addEventListener('click', saveAllTiers);

            if (isEditMode && editUserId) {
                loadTiers(parseInt(editUserId, 10));
            } else {
                // Allow creating tiers before user exists
                window.__pendingTiers = [];
                const list = document.getElementById('tiers-list');
                list.innerHTML = '';
            }
        }

        function tierRowTemplate(tier) {
            const t = tier || {};
            return `
            <div class="tier-row" data-id="${t.id || ''}" style="display:block;background:#fff;border:1px solid #e5e7eb;border-radius:16px;padding:12px;box-shadow:0 2px 8px rgba(0,0,0,0.04)">
                <div style="display:flex;gap:12px;flex-wrap:wrap;align-items:flex-end">
                    <div style="min-width:160px;">
                        <label style="font-size:12px;color:#374151">Type</label>
                        <select class="tier-type" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;">
                            <option value="hourly" ${ (t.tier_type || 'hourly')==='hourly' ? 'selected' : '' }>Hourly</option>
                            <option value="commission" ${ (t.tier_type || '')==='commission' ? 'selected' : '' }>Commission</option>
                        </select>
                    </div>
                    <div style="min-width:160px;">
                        <label style="font-size:12px;color:#374151">Sales Goal (today)</label>
                        <input type="number" class="tier-sales" value="${t.sales_goal_in_day ?? ''}" min="0" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" />
                    </div>
                    <div style="min-width:160px;">
                        <label style="font-size:12px;color:#374151">Min Demo (optional)</label>
                        <input type="number" class="tier-demos" value="${t.daily_demo_min ?? ''}" min="0" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" />
                    </div>
                    <div style="min-width:160px;" data-hourly>
                        <label style="font-size:12px;color:#374151">Hourly $/hr</label>
                        <input type="number" class="tier-hourly" value="${t.hourly_rate ?? ''}" step="0.01" min="0" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" />
                    </div>
                    <div style="min-width:160px;" data-commission>
                        <label style="font-size:12px;color:#374151">Commission %</label>
                        <input type="number" class="tier-commission" value="${t.commission_rate_pct ?? ''}" step="0.01" min="0" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" />
                    </div>
                    <div style="min-width:160px;">
                        <label style="font-size:12px;color:#374151">Pay per Demo ($)</label>
                        <input type="number" class="tier-bonus" value="${t.demo_bonus ?? ''}" step="0.01" min="0" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" />
                    </div>
                    <div style="min-width:180px;">
                        <label style="font-size:12px;color:#374151">Effective From</label>
                        <input type="date" class="tier-effective" value="${t.effective_from || new Date().toISOString().slice(0,10)}" style="width:100%;padding:10px;border:1px solid #e5e7eb;border-radius:10px;" />
                    </div>
                <!-- Removed Active & Order per request -->
                </div>
                <div style="display:flex;gap:8px;justify-content:flex-end;margin-top:12px;">
                    <button type="button" class="btn btn-secondary tier-delete"><i class="fas fa-trash"></i> Delete</button>
                </div>
            </div>`;
        }

        async function loadTiers(userId) {
            try {
                const res = await fetch(`/api/users/${userId}/tiers`);
                const data = await res.json();
                const list = document.getElementById('tiers-list');
                list.innerHTML = '';
                const tiers = Array.isArray(data) ? data : (data.tiers || []);
                tiers.forEach(t => {
                    const wrapper = document.createElement('div');
                    wrapper.innerHTML = tierRowTemplate(t);
                    bindTierRow(wrapper.firstElementChild, userId);
                    list.appendChild(wrapper.firstElementChild);
                });
            } catch (e) {
                console.error('Failed to load tiers', e);
            }
        }

        function addTierRow() {
            const list = document.getElementById('tiers-list');
            const wrapper = document.createElement('div');
            wrapper.innerHTML = tierRowTemplate({});
            const row = wrapper.firstElementChild;
            if (isEditMode && editUserId) {
                bindTierRow(row, parseInt(editUserId, 10));
            } else {
                setupTypeToggle(row);
                const delBtn = row.querySelector('.tier-delete');
                delBtn.addEventListener('click', () => row.remove());
            }
            list.appendChild(row);
        }

        async function setupCopyTierUI() {
            const select = document.getElementById('copy-tier-select');
            const btn = document.getElementById('copy-tier-btn');
            if (!select || !btn) return;

            try {
                const res = await fetch('/api/users?all=true&per_page=1000');
                const json = await res.json();
                const users = Array.isArray(json) ? json : (json.users || []);

                // Fill dropdown
                select.innerHTML = '<option value="">Copy tiers from user…</option>';
                users
                  .filter(u => !String(u.username||'').toLowerCase().includes('test'))
                  .forEach(u => {
                    const opt = document.createElement('option');
                    opt.value = u.id;
                    opt.textContent = `${u.name || u.username || 'User'}${u.location_id ? ' • Loc ' + u.location_id : ''}`;
                    select.appendChild(opt);
                  });

                btn.addEventListener('click', async () => {
                    const sourceId = parseInt(select.value);
                    if (!sourceId) { showMessage('Please select a user to copy tiers from.', 'error'); return; }

                    try {
                        const tiersRes = await fetch(`/api/users/${sourceId}/tiers`);
                        const tiersResp = await tiersRes.json();
                        const tiers = Array.isArray(tiersResp) ? tiersResp : (tiersResp.tiers || []);
                        const list = document.getElementById('tiers-list');
                        if (!Array.isArray(tiers) || tiers.length === 0) { showMessage('Selected user has no tiers to copy.', 'error'); return; }

                        // Clear current list before copying
                        list.innerHTML = '';
                        const targetUserId = isEditMode ? parseInt(editUserId, 10) : null;
                        window.__pendingTiers = window.__pendingTiers || [];

                        tiers.forEach(t => {
                            const payload = {
                                tier_type: t.tier_type || 'hourly',
                                sales_goal_in_day: t.sales_goal_in_day ?? t.sales_goal ?? 0,
                                daily_demo_min: t.daily_demo_min ?? t.min_demo ?? 0,
                                hourly_rate: t.hourly_rate ?? 0,
                                commission_rate_pct: t.commission_rate_pct ?? t.commission_rate ?? 0,
                                demo_bonus: t.demo_bonus ?? 0,
                                effective_from: new Date().toISOString().slice(0,10)
                            };

                            if (targetUserId) {
                                // Immediately create tier for existing user
                                const rowWrapper = document.createElement('div');
                                rowWrapper.innerHTML = tierRowTemplate(payload);
                                 const row = rowWrapper.firstElementChild;
                                 bindTierRow(row, targetUserId);
                                 list.appendChild(row);
                            } else {
                                // For new user, queue as pending tiers
                                window.__pendingTiers.push(payload);
                                const rowWrapper = document.createElement('div');
                                rowWrapper.innerHTML = tierRowTemplate(payload);
                                const row = rowWrapper.firstElementChild;
                                setupTypeToggle(row);
                                list.appendChild(row);
                            }
                        });

                        showMessage('Tiers copied successfully.', 'success');
                    } catch (err) {
                        console.error(err);
                        showMessage('Failed to copy tiers. Please try again.', 'error');
                    }
                });
            } catch (e) {
                console.error('Failed to load users for copy-tier', e);
            }
        }

        function setupTypeToggle(row){
            const typeSelect = row.querySelector('.tier-type');
            const hourlyEl = row.querySelector('[data-hourly]');
            const commEl = row.querySelector('[data-commission]');
            const applyTypeVisibility = () => {
                const type = typeSelect.value;
                if (hourlyEl) hourlyEl.style.display = type === 'hourly' ? 'block' : 'none';
                if (commEl) commEl.style.display = type === 'commission' ? 'block' : 'none';
            };
            typeSelect.addEventListener('change', applyTypeVisibility);
            applyTypeVisibility();
        }

        function collectTierPayload(row){
            return {
                tier_type: row.querySelector('.tier-type').value || 'hourly',
                sales_goal_in_day: parseInt(row.querySelector('.tier-sales').value || '0'),
                daily_demo_min: parseInt(row.querySelector('.tier-demos').value || '0'),
                hourly_rate: parseFloat(row.querySelector('.tier-hourly').value || '0'),
                commission_rate_pct: parseFloat(row.querySelector('.tier-commission').value || '0'),
                demo_bonus: parseFloat(row.querySelector('.tier-bonus').value || '0'),
                effective_from: row.querySelector('.tier-effective').value || new Date().toISOString().slice(0,10),
                // keep placeholders to be compatible with server aliases
                sales_goal_in_period: parseInt(row.querySelector('.tier-sales').value || '0')
            };
        }

        async function saveAllTiers(){
            const rows = Array.from(document.querySelectorAll('.tier-row'));
            if (rows.length === 0) { showMessage('No tiers to save.', 'error'); return; }
            try {
                if (isEditMode && editUserId) {
                    // For existing user: upsert each tier (replace-by-type behavior server-side)
                    const userId = parseInt(editUserId, 10);
                    for (const row of rows) {
                        const payload = collectTierPayload(row);
                        const idAttr = row.getAttribute('data-id');
                        if (idAttr) {
                            const res = await fetch(`/api/users/${userId}/tiers/${idAttr}`, { method: 'PUT', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                            const data = await res.json();
                            if (!res.ok || !data.success) throw new Error(data.message || 'Failed to update tier');
                        } else {
                            const res = await fetch(`/api/users/${userId}/tiers`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify(payload) });
                            const data = await res.json();
                            if (!res.ok || !data.success) throw new Error(data.message || 'Failed to create tier');
                            const created = data.tier || data.data;
                            if (created && created.id) row.setAttribute('data-id', created.id);
                        }
                    }
                    showMessage('All tiers saved.', 'success');
                } else {
                    // New user: buffer tiers until user creation
                    window.__pendingTiers = rows.map(r => collectTierPayload(r));
                    showMessage('All tiers added for the new user. Click Create User to save.', 'success');
                }
            } catch (e) {
                showMessage(e.message || 'Failed to save all tiers', 'error');
            }
        }

        function bindTierRow(row, userId) {
            const saveBtn = row.querySelector('.tier-save');
            const delBtn = row.querySelector('.tier-delete');
            const id = row.getAttribute('data-id');

            const typeSelect = row.querySelector('.tier-type');
            const hourlyEl = row.querySelector('[data-hourly]');
            const commEl = row.querySelector('[data-commission]');
            const applyTypeVisibility = () => {
                const type = typeSelect.value;
                hourlyEl.style.display = type === 'hourly' ? 'block' : 'none';
                commEl.style.display = type === 'commission' ? 'block' : 'none';
            };
            typeSelect.addEventListener('change', applyTypeVisibility);
            applyTypeVisibility();

            // Per-row save disabled; handled by Save All

            delBtn.addEventListener('click', async () => {
                const tid = row.getAttribute('data-id');
                if (!tid) { row.remove(); return; }
                try {
                    const res = await fetch(`/api/users/${userId}/tiers/${tid}`, { method: 'DELETE' });
                    const data = await res.json();
                    if (!res.ok) throw new Error(data.message || 'Failed to delete tier');
                    row.remove();
                    showMessage('Tier removed', 'success');
                } catch (e) {
                    showMessage(e.message || 'Failed to delete tier', 'error');
                }
            });
        }
    </script>
</body>
</html> 