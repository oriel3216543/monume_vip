<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Email Management - MonuMe Tracker</title>
    <link rel="icon" type="image/png" href="/icon.png">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        :root {
            --main-color: #ff9562;
            --gradient-start: #ff7f42;
            --gradient-end: #ff9562;
            --sidebar-bg: #272430;
            --card-bg: rgba(255, 255, 255, 0.85);
            --card-hover-bg: rgba(255, 255, 255, 0.95);
            --text-primary: #333;
            --text-secondary: #666;
            --text-light: #f8f9fa;
            --shadow-sm: 0 4px 12px rgba(0, 0, 0, 0.08);
            --shadow-md: 0 10px 25px rgba(0, 0, 0, 0.12);
            --shadow-lg: 0 15px 35px rgba(0, 0, 0, 0.15);
            --transition: all 0.3s cubic-bezier(0.25, 0.8, 0.25, 1);
            --border-radius: 16px;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Poppins', sans-serif;
            background: url('data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 2000 1500"><rect fill="%23ff9562" width="2000" height="1500"/><defs><radialGradient id="a" gradientUnits="objectBoundingBox"><stop offset="0" stop-color="%23ffffff"/><stop offset="1" stop-color="%23ff9562"/></radialGradient><linearGradient id="b" gradientUnits="userSpaceOnUse" x1="0" y1="750" x2="1550" y2="750"><stop offset="0" stop-color="%23ffcab1"/><stop offset="1" stop-color="%23ff9562"/></linearGradient></defs><path fill="url(%23a)" d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6-24.1 96-57.4 189.4-99.3 278.6-41.9 89.2-92.4 174.1-150.3 255.3-58 81.2-123.4 158.2-195.1 231.4-71.7 73.2-149.6 141.9-232.2 205.7-82.7 63.8-169.9 122.6-260.9 176.3-91 53.7-184.9 102.1-283.2 144.3-98.3 42.1-198.1 77.8-300.2 106.4-101.1 28.6-203.9 50-307.9 64.6l-2.1 2.1c-28.2 91.7-55.8 183.6-84.9 275.1-29.6 94.2-60.7 188.2-93.1 282.1-32.9 94.7-67.2 189.3-105.2 283-39.1 95.2-80.5 190.3-127.7 284C377.7 1328 319 1421.3 253.5 1512.5L254 1576z"/><path fill="url(%23b)" d="M1549.2 51.6c-5.4 99.1-20.2 197.6-44.2 293.6s-57.4 189.4-99.3 278.6c-41.9 89.2-92.4 174.1-150.3 255.3-58 81.2-123.4 158.2-195.1 231.4-71.7 73.2-149.6 141.9-232.2 205.7-82.7 63.8-169.9 122.6-260.9 176.3-91 53.7-184.9 102.1-283.2 144.3-98.3 42.1-198.1 77.8-300.2 106.4-101.1 28.6-203.9 50-307.9 64.6l-2.1 2.1c-28.2 91.7-55.8 183.6-84.9 275.1-29.6 94.2-60.7 188.2-93.1 282.1-32.9 94.7-67.2 189.3-105.2 283-39.1 95.2-80.5 190.3-127.7 284C377.7 1328 319 1421.3 253.5 1512.5L254 1576z"/></svg>') no-repeat center center fixed;
            background-size: cover;
            color: var(--text-primary);
            display: flex;
            min-height: 100vh;
            overflow-x: hidden;
        }

        /* Main content styles */
        .main-content {
            margin-left: 280px;
            width: calc(100% - 280px);
            padding: 40px;
            transition: var(--transition);
        }

        /* Email settings container with glassmorphism */
        .email-settings-container {
            background: var(--card-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            padding: 35px;
            margin-bottom: 40px;
            box-shadow: var(--shadow-sm);
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        /* Page header with gradient */
        .page-header {
            background: linear-gradient(135deg, rgba(255, 149, 98, 0.95), rgba(255, 127, 66, 0.9));
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: var(--border-radius);
            padding: 35px;
            margin-bottom: 40px;
            color: white;
            text-align: center;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
        }

        .page-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(135deg, rgba(255, 127, 66, 0.7), rgba(255, 149, 98, 0.7));
            z-index: -1;
        }

        .page-header h1 {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .page-header p {
            opacity: 0.9;
            font-size: 18px;
            max-width: 700px;
            margin: 0 auto;
        }

        /* Section Header Styling */
        .section-header {
            border-bottom: 2px solid rgba(255, 149, 98, 0.2);
            color: var(--main-color);
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 25px;
            padding-bottom: 10px;
            position: relative;
        }

        .section-header::after {
            content: '';
            position: absolute;
            bottom: -2px;
            left: 0;
            width: 60px;
            height: 2px;
            background: linear-gradient(90deg, var(--gradient-start), var(--gradient-end));
        }

        /* Settings Group Styling */
        .settings-group {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            margin-bottom: 30px;
            padding: 20px;
            box-shadow: var(--shadow-sm);
        }

        .settings-row {
            align-items: center;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
        }

        .settings-row:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-weight: 600;
            font-size: 16px;
            margin-bottom: 5px;
            color: var(--text-primary);
        }

        .settings-description {
            color: var(--text-secondary);
            font-size: 14px;
            max-width: 70%;
        }

        .settings-control {
            display: flex;
            align-items: center;
            justify-content: flex-end;
            min-width: 60px;
        }

        /* Toggle Switch */
        .switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 34px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ccc;
            transition: .4s;
            border-radius: 34px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 26px;
            width: 26px;
            left: 4px;
            bottom: 4px;
            background-color: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .slider {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
        }

        input:focus + .slider {
            box-shadow: 0 0 1px var(--main-color);
        }

        input:checked + .slider:before {
            transform: translateX(26px);
        }

        /* Test Email Section */
        .email-test-section {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
            padding: 25px;
        }

        .test-email-input {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 15px;
            padding: 12px 15px;
            width: 100%;
            transition: all 0.2s ease;
        }

        .test-email-input:focus {
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.2);
            outline: none;
        }

        .test-email-button {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            border-radius: 8px;
            box-shadow: 0 4px 10px rgba(255, 149, 98, 0.2);
            color: white;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            padding: 12px 20px;
            transition: all 0.3s ease;
        }

        .test-email-button:hover {
            box-shadow: 0 6px 15px rgba(255, 149, 98, 0.3);
            transform: translateY(-2px);
        }

        .email-status {
            border-radius: 8px;
            display: none;
            font-weight: 600;
            margin-top: 15px;
            padding: 15px;
            text-align: center;
        }

        .email-status.success {
            background-color: rgba(76, 175, 80, 0.1);
            border: 1px solid rgba(76, 175, 80, 0.2);
            color: #2e7d32;
        }

        .email-status.error {
            background-color: rgba(244, 67, 54, 0.1);
            border: 1px solid rgba(244, 67, 54, 0.2);
            color: #c62828;
        }

        .email-status.pending {
            background-color: rgba(255, 152, 0, 0.1);
            border: 1px solid rgba(255, 152, 0, 0.2);
            color: #f57c00;
        }

        /* Email Logs Section */
        .email-log-section {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
            padding: 25px;
        }

        .email-log-table {
            background: white;
            border-collapse: collapse;
            border-radius: 8px;
            box-shadow: var(--shadow-sm);
            margin-top: 15px;
            overflow: hidden;
            width: 100%;
        }

        .email-log-table th, .email-log-table td {
            border-bottom: 1px solid #eee;
            padding: 12px 15px;
            text-align: left;
        }

        .email-log-table th {
            background: #f9f9f9;
            color: var(--text-primary);
            font-weight: 600;
        }

        .email-log-table tr:last-child td {
            border-bottom: none;
        }

        .email-log-table tr:hover {
            background: rgba(255, 149, 98, 0.05);
        }

        .log-status-success {
            color: #4caf50;
            font-weight: 600;
        }

        .log-status-failed {
            color: #f44336;
            font-weight: 600;
        }

        /* Particles background effect */
        .particles {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            z-index: -1;
            overflow: hidden;
            pointer-events: none;
        }
        
        .particle {
            position: absolute;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            animation: float 20s infinite linear;
        }

        @keyframes float {
            0% { transform: translateY(0) rotate(0deg); opacity: 0; }
            10% { opacity: 1; }
            90% { opacity: 1; }
            100% { transform: translateY(-100vh) rotate(360deg); opacity: 0; }
        }

        /* Tab navigation styles */
        .tab-navigation {
            display: flex;
            gap: 15px;
            align-items: center;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .tab-button {
            background: rgba(255, 255, 255, 0.8);
            border: 2px solid rgba(255, 149, 98, 0.3);
            border-radius: 12px;
            color: #4a5568;
            cursor: pointer;
            font-size: 16px;
            font-weight: 700;
            padding: 18px 30px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            text-shadow: 0 1px 2px rgba(0, 0, 0, 0.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
            min-width: 200px;
            justify-content: center;
        }
        
        .tab-button:hover {
            background: rgba(255, 149, 98, 0.15);
            border-color: rgba(255, 149, 98, 0.6);
            color: #ff7f42;
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(255, 149, 98, 0.2);
        }
        
        .tab-button.active {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border-color: var(--main-color);
            color: white;
            box-shadow: 0 8px 25px rgba(255, 149, 98, 0.4);
            transform: translateY(-1px);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }
        
        .tab-button.active:hover {
            transform: translateY(-2px);
            box-shadow: 0 12px 30px rgba(255, 149, 98, 0.5);
        }
        
        /* Responsive tab styling */
        @media (max-width: 768px) {
            .tab-button {
                min-width: 160px;
                padding: 14px 20px;
                font-size: 14px;
            }
            
            .tab-button span {
                font-size: 14px !important;
            }
            
            .tab-navigation {
                gap: 10px;
                padding: 12px;
            }
        }
        
        @media (max-width: 600px) {
            .tab-navigation {
                flex-direction: column;
                gap: 12px;
            }
            
            .tab-button {
                width: 100%;
                max-width: 280px;
            }
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }

        /* Gift Card Template Editor Styles */
        .template-editor {
            background: rgba(255, 255, 255, 0.5);
            border-radius: 12px;
            box-shadow: var(--shadow-sm);
            margin-bottom: 30px;
            padding: 25px;
        }

        .template-editor-textarea {
            width: 100%;
            min-height: 500px;
            padding: 20px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Courier New', monospace;
            font-size: 14px;
            line-height: 1.5;
            background: #f8f9fa;
            resize: vertical;
            margin-bottom: 20px;
        }

        .template-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid rgba(255, 149, 98, 0.2);
        }

        .template-editor-title {
            color: var(--main-color);
            font-size: 20px;
            font-weight: 600;
            margin: 0;
        }

        .template-editor-actions {
            display: flex;
            gap: 10px;
        }

        .template-action-btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 16px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .template-action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 98, 0.3);
        }

        .template-action-btn.secondary {
            background: #6c757d;
        }

        .template-action-btn.secondary:hover {
            background: #5a6268;
            box-shadow: 0 6px 15px rgba(108, 117, 125, 0.3);
        }

        /* Enhanced Preview Styles */
        .template-preview {
            margin-top: 30px;
            padding: 0;
            background: #f8f9fa;
            border-radius: 12px;
            border: 2px solid #e9ecef;
            overflow: hidden;
        }

        .template-preview h4 {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            margin: 0;
            padding: 20px;
            font-size: 18px;
            font-weight: 600;
        }

        #template-preview-content {
            padding: 0;
            background: white;
            max-height: 80vh;
            overflow-y: auto;
        }

        /* Rich Text Editor Styles */
        .toolbar-btn {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            color: #555;
            cursor: pointer;
            padding: 8px 10px;
            font-size: 14px;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
        }

        .toolbar-btn:hover {
            background: #f0f0f0;
            border-color: #bbb;
            color: #333;
        }

        .toolbar-btn:active,
        .toolbar-btn.active {
            background: var(--main-color);
            border-color: var(--main-color);
            color: white;
        }

        .toolbar-color-label {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            padding: 8px 10px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 32px;
            height: 32px;
            color: #555;
        }

        .toolbar-color-label:hover {
            background: #f0f0f0;
            border-color: #bbb;
        }

        .rich-text-editor {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
        }

        .rich-text-editor:focus {
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.1);
        }

        .rich-text-editor h1, .rich-text-editor h2, .rich-text-editor h3 {
            color: var(--main-color);
            margin-top: 20px;
            margin-bottom: 10px;
        }

        .rich-text-editor p {
            margin-bottom: 10px;
        }

        .rich-text-editor a {
            color: var(--main-color);
            text-decoration: none;
        }

        .rich-text-editor a:hover {
            text-decoration: underline;
        }

        .rich-text-editor table {
            border-collapse: collapse;
            width: 100%;
            margin: 15px 0;
        }

        .rich-text-editor table th,
        .rich-text-editor table td {
            border: 1px solid #ddd;
            padding: 8px 12px;
            text-align: left;
        }

        .rich-text-editor table th {
            background: #f8f9fa;
            font-weight: 600;
        }

        .rich-text-editor hr {
            border: none;
            border-top: 2px solid #e9ecef;
            margin: 20px 0;
        }

        /* Visual Template Editor Modal */
        .template-editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            z-index: 10000;
            display: none;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 20px;
            box-sizing: border-box;
        }

        .template-editor-content {
            background: white;
            border-radius: 16px;
            max-width: 1200px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.3);
            position: relative;
        }

        .template-editor-header {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            color: white;
            padding: 20px 30px;
            border-radius: 16px 16px 0 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .template-editor-header h2 {
            margin: 0;
            font-size: 24px;
            font-weight: 600;
        }

        .template-editor-close {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            color: white;
            cursor: pointer;
            font-size: 18px;
            padding: 8px 12px;
            transition: all 0.3s ease;
        }

        .template-editor-close:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .template-editor-body {
            padding: 30px;
            display: grid;
            grid-template-columns: 1fr 300px;
            gap: 30px;
        }

        .template-canvas-container {
            position: relative;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            background: #f8f9fa;
            padding: 20px;
            text-align: center;
        }

        .template-canvas {
            max-width: 100%;
            height: auto;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
            position: relative;
            display: inline-block;
        }

        .position-marker {
            position: absolute;
            border: 2px dashed;
            border-radius: 4px;
            padding: 8px;
            font-size: 12px;
            font-weight: bold;
            cursor: move;
            user-select: none;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 80px;
            min-height: 30px;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            transition: all 0.3s ease;
        }

        .position-marker:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }

        .position-marker.code-marker {
            border-color: #f8a168;
            color: #f8a168;
            background: rgba(248, 161, 104, 0.1);
        }

        .position-marker.invoice-marker {
            border-color: #dc3545;
            color: #dc3545;
            background: rgba(220, 53, 69, 0.1);
        }

        .template-tools {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
        }

        .tool-section {
            margin-bottom: 25px;
            padding-bottom: 20px;
            border-bottom: 1px solid #e5e7eb;
        }

        .tool-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
        }

        .tool-section h4 {
            color: var(--main-color);
            font-size: 16px;
            font-weight: 600;
            margin: 0 0 15px 0;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tool-button {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            padding: 10px 16px;
            transition: all 0.3s ease;
            width: 100%;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }

        .tool-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 15px rgba(255, 149, 98, 0.3);
        }

        .tool-button.secondary {
            background: #6b7280;
        }

        .tool-button.secondary:hover {
            box-shadow: 0 6px 15px rgba(107, 114, 128, 0.3);
        }

        .position-controls {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 10px;
        }

        .position-input {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 6px;
            font-size: 12px;
            padding: 6px 8px;
            text-align: center;
        }

        .position-input:focus {
            border-color: var(--main-color);
            outline: none;
            box-shadow: 0 0 0 2px rgba(255, 149, 98, 0.2);
        }

        .file-upload-area {
            border: 2px dashed #d1d5db;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-area:hover {
            border-color: var(--main-color);
            background: rgba(255, 149, 98, 0.05);
        }

        .file-upload-area.dragover {
            border-color: var(--main-color);
            background: rgba(255, 149, 98, 0.1);
        }

        .template-settings {
            background: white;
            border: 1px solid #e5e7eb;
            border-radius: 8px;
            padding: 15px;
            margin-top: 15px;
        }

        .setting-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }

        .setting-row:last-child {
            margin-bottom: 0;
        }

        .setting-label {
            font-size: 13px;
            font-weight: 500;
            color: #374151;
        }

        .setting-input {
            background: white;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-size: 12px;
            padding: 4px 8px;
            width: 60px;
            text-align: center;
        }

        .color-picker {
            width: 40px;
            height: 30px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            cursor: pointer;
        }
        
        .template-editor-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .template-editor-title {
            color: var(--main-color);
            font-size: 18px;
            font-weight: 600;
            margin: 0;
        }
        
        .template-editor-actions {
            display: flex;
            gap: 12px;
        }
        
        .template-action-btn {
            background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end));
            border: none;
            border-radius: 8px;
            color: white;
            cursor: pointer;
            font-size: 14px;
            font-weight: 600;
            padding: 10px 16px;
            transition: all 0.3s ease;
        }
        
        .template-action-btn:hover {
            box-shadow: 0 6px 15px rgba(255, 149, 98, 0.3);
            transform: translateY(-2px);
        }
        
        .template-action-btn.secondary {
            background: #6b7280;
        }
        
        .template-action-btn.secondary:hover {
            box-shadow: 0 6px 15px rgba(107, 114, 128, 0.3);
        }
        
        .template-editor-textarea {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 14px;
            height: 400px;
            line-height: 1.6;
            padding: 20px;
            resize: vertical;
            width: 100%;
            box-sizing: border-box;
        }
        
        .template-editor-textarea:focus {
            border-color: var(--main-color);
            box-shadow: 0 0 0 3px rgba(255, 149, 98, 0.2);
            outline: none;
        }
        
        .template-preview {
            background: white;
            border: 1px solid rgba(0, 0, 0, 0.1);
            border-radius: 8px;
            max-height: 400px;
            overflow-y: auto;
            padding: 20px;
            margin-top: 20px;
        }
        
        .template-variables {
            background: rgba(255, 249, 235, 0.8);
            border: 1px solid rgba(255, 149, 98, 0.3);
            border-radius: 8px;
            margin-bottom: 20px;
            padding: 15px;
        }
        
        .template-variables h4 {
            color: var(--main-color);
            margin: 0 0 10px 0;
            font-size: 16px;
        }

        /* Enhanced Rich Text Editor Modals */
        .editor-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(8px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            animation: fadeIn 0.3s ease;
        }

        .editor-modal-content {
            background: white;
            border-radius: 20px;
            box-shadow: 0 25px 80px rgba(0, 0, 0, 0.2);
            max-width: 90vw;
            max-height: 90vh;
            overflow: hidden;
            animation: slideUp 0.3s ease;
        }

        .editor-modal-header {
            background: linear-gradient(135deg, var(--main-color), #ff9562);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .editor-modal-header h3 {
            margin: 0;
            font-size: 20px;
            font-weight: 600;
        }

        .editor-modal-close {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
            padding: 5px 10px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .editor-modal-close:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: rotate(90deg);
        }

        .editor-modal-body {
            padding: 30px;
            max-height: 70vh;
            overflow-y: auto;
        }

        .editor-modal-footer {
            padding: 20px 30px;
            border-top: 1px solid #eee;
            display: flex;
            gap: 15px;
            justify-content: flex-end;
        }

        /* Color Picker Styles */
        .color-picker-grid {
            display: grid;
            gap: 25px;
        }

        .color-section h4 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .color-palette {
            display: grid;
            grid-template-columns: repeat(6, 1fr);
            gap: 10px;
        }

        .color-option {
            width: 40px;
            height: 40px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 2px solid transparent;
        }

        .color-option:hover {
            transform: scale(1.1);
            border-color: var(--main-color);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }

        .toolbar-color-btn {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 6px;
            padding: 8px 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .toolbar-color-btn:hover {
            background: #e9ecef;
            border-color: var(--main-color);
        }

        .color-preview {
            width: 14px;
            height: 14px;
            border-radius: 3px;
            border: 1px solid #ddd;
        }

        /* Image Modal Styles */
        .tab-container {
            margin-bottom: 20px;
        }

        .tab-buttons {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab-btn {
            padding: 10px 20px;
            border: none;
            background: #f8f9fa;
            border-radius: 8px 8px 0 0;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .tab-btn.active {
            background: var(--main-color);
            color: white;
        }

        .image-tab {
            display: none;
            padding: 20px;
            border: 2px dashed #e1e5e9;
            border-radius: 8px;
        }

        .image-tab.active {
            display: block;
        }

        .file-upload-zone {
            text-align: center;
            padding: 40px 20px;
            border: 2px dashed #ddd;
            border-radius: 12px;
            background: #f8fafc;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .file-upload-zone:hover {
            border-color: var(--main-color);
            background: rgba(255, 127, 66, 0.05);
        }

        .file-upload-zone i {
            font-size: 48px;
            color: var(--main-color);
            margin-bottom: 15px;
        }

        /* Text Style Modal */
        .style-grid {
            display: grid;
            gap: 25px;
        }

        .style-section h4 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .effect-grid, .transform-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .effect-btn, .transform-btn {
            padding: 12px 16px;
            border: 2px solid #e1e5e9;
            background: white;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .effect-btn:hover, .transform-btn:hover {
            border-color: var(--main-color);
            background: rgba(255, 127, 66, 0.05);
        }

        .spacing-labels {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: #666;
            margin-top: 5px;
        }

        /* Special Characters Modal */
        .char-categories {
            display: grid;
            gap: 25px;
        }

        .char-category h4 {
            color: #333;
            margin: 0 0 15px 0;
            font-size: 16px;
            font-weight: 600;
        }

        .char-grid {
            display: grid;
            grid-template-columns: repeat(8, 1fr);
            gap: 8px;
        }

        .char-option {
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            border: 2px solid #e1e5e9;
            border-radius: 8px;
            cursor: pointer;
            font-size: 18px;
            font-weight: 600;
            transition: all 0.3s ease;
            background: white;
        }

        .char-option:hover {
            border-color: var(--main-color);
            background: rgba(255, 127, 66, 0.1);
            transform: scale(1.1);
        }

        /* Button Styles */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--main-color), #ff9562);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255, 127, 66, 0.3);
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-secondary:hover {
            background: #5a6268;
            transform: translateY(-2px);
        }

                 /* Email Setup Help Modal Styles */
         .help-content {
             padding: 10px 0;
         }

         .help-section {
             margin-bottom: 30px;
         }

         .help-section h4 {
             color: var(--main-color);
             margin: 0 0 15px 0;
             font-size: 18px;
             font-weight: 600;
             display: flex;
             align-items: center;
             gap: 10px;
         }

         .help-section p, .help-section ol, .help-section ul {
             margin: 10px 0;
             line-height: 1.6;
         }

         .help-section ol li, .help-section ul li {
             margin: 8px 0;
             padding-left: 5px;
         }

         .help-tabs {
             margin-top: 15px;
         }

         .help-tab-buttons {
             display: flex;
             gap: 5px;
             margin-bottom: 20px;
         }

         .help-tab-btn {
             padding: 10px 20px;
             border: none;
             background: #f8f9fa;
             border-radius: 8px 8px 0 0;
             cursor: pointer;
             transition: all 0.3s ease;
             font-weight: 500;
             border-bottom: 2px solid transparent;
         }

         .help-tab-btn.active {
             background: var(--main-color);
             color: white;
             border-bottom-color: var(--main-color);
         }

         .help-tab-btn:hover:not(.active) {
             background: #e9ecef;
         }

         .help-tab-content {
             display: none;
             padding: 20px;
             background: #f8fafc;
             border-radius: 0 8px 8px 8px;
             border: 1px solid #e1e5e9;
         }

         .help-tab-content.active {
             display: block;
         }

         .help-tab-content h5 {
             color: var(--main-color);
             margin: 0 0 15px 0;
             font-size: 16px;
         }

         .help-note {
             background: rgba(59, 130, 246, 0.1);
             border: 1px solid rgba(59, 130, 246, 0.2);
             border-radius: 8px;
             padding: 12px 15px;
             margin-top: 15px;
             display: flex;
             align-items: flex-start;
             gap: 10px;
             font-size: 14px;
         }

         .help-note i {
             color: #3b82f6;
             margin-top: 2px;
         }

         .security-tips {
             display: grid;
             gap: 15px;
         }

         .security-tip {
             display: flex;
             align-items: flex-start;
             gap: 15px;
             padding: 15px;
             background: rgba(16, 185, 129, 0.05);
             border: 1px solid rgba(16, 185, 129, 0.2);
             border-radius: 8px;
         }

         .security-tip i {
             color: #10b981;
             font-size: 20px;
             margin-top: 2px;
         }

         .faq-list {
             display: grid;
             gap: 15px;
         }

         .faq-item {
             padding: 15px;
             background: white;
             border: 1px solid #e1e5e9;
             border-radius: 8px;
             border-left: 4px solid var(--main-color);
         }

         .faq-item strong {
             color: var(--main-color);
         }

         .config-status {
             padding: 12px 16px;
             border-radius: 8px;
             font-weight: 500;
             display: none;
         }

         .config-status.success {
             background: rgba(16, 185, 129, 0.1);
             color: #059669;
             border: 1px solid rgba(16, 185, 129, 0.2);
             display: block;
         }

         .config-status.error {
             background: rgba(239, 68, 68, 0.1);
             color: #dc2626;
             border: 1px solid rgba(239, 68, 68, 0.2);
             display: block;
         }

         .config-status.loading {
             background: rgba(59, 130, 246, 0.1);
             color: #2563eb;
             border: 1px solid rgba(59, 130, 246, 0.2);
             display: block;
         }

         /* Animations */
         @keyframes fadeIn {
             from { opacity: 0; }
             to { opacity: 1; }
         }

         @keyframes slideUp {
             from { 
                 opacity: 0;
                 transform: translateY(50px);
             }
             to { 
                 opacity: 1;
                 transform: translateY(0);
             }
         }
        
        .variable-list {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 8px;
            font-size: 14px;
        }
        
        .variable-item {
            background: rgba(255, 255, 255, 0.8);
            border-radius: 6px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px 12px;
            transition: all 0.2s ease;
        }
        
        .variable-item:hover {
            background: rgba(255, 149, 98, 0.1);
            color: var(--main-color);
        }
        
        .variable-code {
            color: var(--main-color);
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-weight: 600;
        }

        /* Toast notification */
        .toast {
            position: fixed;
            right: 20px;
            top: 20px;
            background: white;
            color: var(--text-primary);
            padding: 15px 25px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            transform: translateX(120%);
            transition: transform 0.3s cubic-bezier(0.68, -0.55, 0.265, 1.55);
            z-index: 1000;
            display: flex;
            align-items: center;
            font-weight: 600;
        }
        
        .toast.success {
            border-left: 4px solid #4caf50;
        }
        
        .toast.error {
            border-left: 4px solid #f44336;
        }
        
        .toast.show {
            transform: translateX(0);
        }
        
        .toast i {
            margin-right: 10px;
            font-size: 18px;
        }
        
        /* Responsive styles */
        @media screen and (max-width: 1200px) {
            .sidebar {
                width: 240px;
            }
            .main-content {
                margin-left: 240px;
                width: calc(100% - 240px);
            }
        }

        @media screen and (max-width: 992px) {
            .sidebar {
                width: 80px;
                overflow: hidden;
            }
            
            .sidebar-header h2,
            .sidebar-menu li a span {
                display: none;
            }
            
            .sidebar-menu li a {
                justify-content: center;
                padding: 15px 0;
            }
            
            .sidebar-menu li a i {
                margin-right: 0;
                font-size: 20px;
            }
            
            .main-content {
                margin-left: 80px;
                width: calc(100% - 80px);
                padding: 30px 20px;
            }
        }

        @media screen and (max-width: 768px) {
            .main-content {
                padding: 20px 15px;
            }
            
            .settings-row {
                flex-direction: column;
                align-items: flex-start;
            }
            
            .settings-description {
                max-width: 100%;
                margin-bottom: 15px;
            }
        }
    </style>
</head>
<body>
    <!-- Particles background -->
    <div class="particles" id="particles"></div>
    
    <!-- Include sidebar -->
    <div id="sidebar-container"></div>
    
    <!-- Main content area -->
    <div class="main-content">
        <!-- Page header with gradient overlay -->
        <div class="page-header">
            <h1>Email Management</h1>
            <p>Configure automatic email settings, test your email configuration, and monitor email logs</p>
        </div>

        <!-- Tab Navigation -->
        <div class="tab-navigation" style="background: linear-gradient(135deg, rgba(255, 255, 255, 0.95), rgba(248, 250, 252, 0.9)); border-radius: 20px; padding: 15px; margin-bottom: 40px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.12); border: 2px solid rgba(255, 149, 98, 0.1); display: flex; gap: 15px; justify-content: center; align-items: center;">
            <button class="tab-button active" onclick="event.preventDefault(); switchTab('email-settings'); return false;">
                <i class="fas fa-cog" style="font-size: 18px;"></i> 
                <span style="font-size: 16px; letter-spacing: 0.5px;">Email Settings</span>
            </button>
            <button class="tab-button" onclick="event.preventDefault(); switchTab('gift-card-templates'); return false;">
                <i class="fas fa-gift" style="font-size: 18px;"></i> 
                <span style="font-size: 16px; letter-spacing: 0.5px;">Gift Card Templates</span>
            </button>
            <button class="tab-button" onclick="event.preventDefault(); switchTab('appointment-templates'); return false;">
                <i class="fas fa-calendar-check" style="font-size: 18px;"></i> 
                <span style="font-size: 16px; letter-spacing: 0.5px;">Appointment Templates</span>
            </button>
        </div>
        
        <!-- Email Settings Tab -->
        <div id="email-settings" class="tab-content active">
            <div class="email-settings-container">
                <h2 class="section-header">Email Configuration</h2>
            
            <!-- Environment indicator banner -->
            <div id="environment-banner" style="margin-bottom: 20px; padding: 10px 15px; border-radius: 8px; display: flex; align-items: center; justify-content: space-between;">
                <div>
                    <i class="fas fa-info-circle" style="margin-right: 8px;"></i>
                    <span id="environment-message"></span>
                </div>
                <div id="domain-display" style="font-weight: 600;"></div>
            </div>

            <!-- Email Account Setup Section -->
            <div class="settings-group" style="margin-bottom: 30px; background: linear-gradient(135deg, rgba(255, 149, 98, 0.05), rgba(255, 127, 66, 0.02)); border: 2px solid rgba(255, 149, 98, 0.2); border-radius: 12px; padding: 25px;">
                <div class="setting-group-header" style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h3 style="margin: 0; color: var(--main-color); font-size: 20px; font-weight: 600;">
                        <i class="fas fa-envelope-open-text"></i> Email Account Setup
                    </h3>
                    <button type="button" class="help-btn" onclick="showEmailSetupHelp()" style="
                        background: linear-gradient(135deg, #10b981, #059669);
                        border: none;
                        border-radius: 8px;
                        color: white;
                        padding: 10px 16px;
                        font-size: 14px;
                        cursor: pointer;
                        transition: all 0.3s ease;
                        display: flex;
                        align-items: center;
                        gap: 8px;
                        font-weight: 600;
                        box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                    " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                        <i class="fas fa-question-circle"></i>
                        How to Setup
                    </button>
                </div>
                
                <!-- MonuMe VIP Information Banner -->
                <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.1)); border: 1px solid rgba(59, 130, 246, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 25px;">
                    <div style="display: flex; align-items: start; gap: 15px;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px; flex-shrink: 0;">
                            <i class="fas fa-globe"></i>
                        </div>
                        <div style="flex: 1;">
                            <h4 style="margin: 0 0 10px 0; color: #1e40af; font-size: 18px; font-weight: 600;">
                                MonuMe VIP Email Setup (www.monumevip.com)
                            </h4>
                            <p style="margin: 0 0 15px 0; color: #374151; font-size: 14px; line-height: 1.5;">
                                                        <strong>Important:</strong> Use professional email providers for reliable delivery. 
                        <strong style="color: #22c55e;"> MonuMe domains (@monume.com, @monumevip.com) are now fully supported!</strong>
                        They use Gmail's infrastructure for reliable email delivery.
                            </p>
                            <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 10px;">
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                        <i class="fab fa-google" style="color: #ea4335; font-size: 16px;"></i>
                                        <strong style="color: #059669; font-size: 14px;">Recommended: Gmail</strong>
                                    </div>
                                    <div style="font-size: 13px; color: #374151;">monumevip@gmail.com</div>
                                </div>
                                <div style="background: rgba(16, 185, 129, 0.1); padding: 12px; border-radius: 8px; border: 1px solid rgba(16, 185, 129, 0.2);">
                                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 5px;">
                                        <i class="fab fa-microsoft" style="color: #0078d4; font-size: 16px;"></i>
                                        <strong style="color: #059669; font-size: 14px;">Alternative: Outlook</strong>
                                    </div>
                                    <div style="font-size: 13px; color: #374151;">support@outlook.com</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="email-config-form">
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="width: 100%;">
                            <label for="sender-email" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 14px;">
                                <i class="fas fa-at" style="color: var(--main-color); margin-right: 8px;"></i>
                                Sender Email Address
                            </label>
                            <input type="email" id="sender-email" class="form-input" placeholder="your-email@gmail.com" required onchange="validateEmailDomain(this.value)" style="
                                width: 100%;
                                padding: 12px 16px;
                                border: 2px solid #e1e5e9;
                                border-radius: 8px;
                                font-size: 14px;
                                transition: border-color 0.3s ease;
                                background: white;
                                box-sizing: border-box;
                            " onfocus="this.style.borderColor='var(--main-color)'; this.style.boxShadow='0 0 0 3px rgba(255, 127, 66, 0.1)'" onblur="this.style.borderColor='#e1e5e9'; this.style.boxShadow='none'">
                            <small class="form-hint" style="display: block; margin-top: 5px; color: #6b7280; font-size: 12px;">
                                Use Gmail, Outlook, or Yahoo for best compatibility
                            </small>
                            <div style="margin-top: 8px; display: flex; gap: 8px; flex-wrap: wrap;">
                                <span style="background: rgba(16, 185, 129, 0.1); color: #059669; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                     Gmail
                                </span>
                                <span style="background: rgba(16, 185, 129, 0.1); color: #059669; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                     Outlook
                                </span>
                                <span style="background: rgba(16, 185, 129, 0.1); color: #059669; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: 600;">
                                     Yahoo
                                </span>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom: 20px;">
                        <div class="form-group" style="width: 100%;">
                            <label for="sender-password" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 14px;">
                                <i class="fas fa-key" style="color: var(--main-color); margin-right: 8px;"></i>
                                App Password
                            </label>
                            <div class="password-input-container" style="position: relative;">
                                <input type="password" id="sender-password" class="form-input" placeholder="Enter 16-character app password" required style="
                                    width: 100%;
                                    padding: 12px 50px 12px 16px;
                                    border: 2px solid #e1e5e9;
                                    border-radius: 8px;
                                    font-size: 14px;
                                    transition: border-color 0.3s ease;
                                    background: white;
                                    box-sizing: border-box;
                                " onfocus="this.style.borderColor='var(--main-color)'; this.style.boxShadow='0 0 0 3px rgba(255, 127, 66, 0.1)'" onblur="this.style.borderColor='#e1e5e9'; this.style.boxShadow='none'">
                                <button type="button" class="password-toggle" onclick="togglePasswordVisibility('sender-password')" style="
                                    position: absolute;
                                    right: 12px;
                                    top: 50%;
                                    transform: translateY(-50%);
                                    background: none;
                                    border: none;
                                    color: #6b7280;
                                    cursor: pointer;
                                    padding: 5px;
                                    transition: color 0.3s ease;
                                " onmouseover="this.style.color='var(--main-color)'" onmouseout="this.style.color='#6b7280'">
                                    <i class="fas fa-eye"></i>
                                </button>
                            </div>
                            <small class="form-hint" style="display: block; margin-top: 5px; color: #dc2626; font-size: 12px;">
                                <i class="fas fa-shield-alt"></i>
                                Use an App Password, not your regular email password
                            </small>
                        </div>
                    </div>
                    
                    <div class="form-row" style="margin-bottom: 25px;">
                        <div class="form-group" style="width: 100%;">
                            <label for="sender-name" style="display: block; margin-bottom: 8px; color: #374151; font-weight: 600; font-size: 14px;">
                                <i class="fas fa-user" style="color: var(--main-color); margin-right: 8px;"></i>
                                Sender Name (Optional)
                            </label>
                            <input type="text" id="sender-name" class="form-input" placeholder="MonuMe VIP" value="MonuMe VIP" style="
                                width: 100%;
                                padding: 12px 16px;
                                border: 2px solid #e1e5e9;
                                border-radius: 8px;
                                font-size: 14px;
                                transition: border-color 0.3s ease;
                                background: white;
                                box-sizing: border-box;
                            " onfocus="this.style.borderColor='var(--main-color)'; this.style.boxShadow='0 0 0 3px rgba(255, 127, 66, 0.1)'" onblur="this.style.borderColor='#e1e5e9'; this.style.boxShadow='none'">
                            <small class="form-hint" style="display: block; margin-top: 5px; color: #6b7280; font-size: 12px;">
                                The name that will appear as the sender
                            </small>
                        </div>
                    </div>
                    
                    <div class="email-config-actions" style="display: flex; gap: 12px; justify-content: center; flex-wrap: wrap;">
                        <button type="button" class="btn btn-info" onclick="testNetworkOnly()" style="
                            background: linear-gradient(135deg, #3b82f6, #2563eb);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            padding: 12px 18px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-weight: 600;
                            box-shadow: 0 4px 12px rgba(59, 130, 246, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(59, 130, 246, 0.3)'">
                            <i class="fas fa-wifi"></i>
                            Test Network
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="testEmailConfiguration()" style="
                            background: #6c757d;
                            border: none;
                            border-radius: 8px;
                            color: white;
                            padding: 12px 20px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-weight: 600;
                        " onmouseover="this.style.background='#5a6268'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='#6c757d'; this.style.transform='translateY(0)'">
                            <i class="fas fa-paper-plane"></i>
                            Test Email
                        </button>
                        <button type="button" class="btn btn-primary" onclick="saveEmailConfiguration()" style="
                            background: linear-gradient(135deg, var(--main-color), #ff9562);
                            border: none;
                            border-radius: 8px;
                            color: white;
                            padding: 12px 20px;
                            font-size: 14px;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-weight: 600;
                            box-shadow: 0 4px 12px rgba(255, 127, 66, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(255, 127, 66, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 127, 66, 0.3)'">
                            <i class="fas fa-save"></i>
                            Save Configuration
                        </button>
                    </div>
                    
                    <div id="email-config-status" class="config-status" style="margin-top: 15px; text-align: center;"></div>
                </div>
            </div>
            
            <!-- Email Triggers Section -->
            <div class="settings-group">
                <div class="domain-info-container" style="display: none; margin-bottom: 15px; background-color: rgba(255, 149, 98, 0.1); border-radius: 8px; padding: 12px; border: 1px solid rgba(255, 149, 98, 0.3);">
                    <p style="margin: 0; font-weight: 500;">
                        <i class="fas fa-globe" style="color: var(--main-color); margin-right: 8px;"></i>
                        Using domain: <span id="domain-info" style="font-weight: 600; color: var(--main-color);"></span>
                    </p>
                </div>
                
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Performance Summary Emails</div>
                        <div class="settings-description">
                            Send automatic performance summary emails when users submit tracking data.
                        </div>
                    </div>
                    <div class="settings-control">
                        <label class="switch">
                            <input type="checkbox" id="autoEmailEnabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Daily Performance Reports</div>
                        <div class="settings-description">
                            Send daily summary reports to all users at the end of the day.
                        </div>
                    </div>
                    <div class="settings-control">
                        <label class="switch">
                            <input type="checkbox" id="dailyEmailEnabled">
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
                
                <div class="settings-row">
                    <div>
                        <div class="settings-label">Weekly Performance Digest</div>
                        <div class="settings-description">
                            Send weekly performance summary emails every Sunday night.
                        </div>
                    </div>
                    <div class="settings-control">
                        <label class="switch">
                            <input type="checkbox" id="weeklyEmailEnabled" checked>
                            <span class="slider"></span>
                        </label>
                    </div>
                </div>
            </div>
            
            <!-- Test Email Section -->
            <h2 class="section-header">Send Test Email</h2>
            <div class="email-test-section">
                <p>Send a test email to verify your email configuration is working correctly.</p>
                <input type="email" class="test-email-input" id="test-email" placeholder="Enter email address to test" value="Monumequeens@gmail.com">
                <button class="test-email-button" onclick="sendTestEmail()">
                    <i class="fas fa-envelope"></i> Send Test Email
                </button>
                <div id="email-status" class="email-status"></div>
            </div>
            
            <!-- Email Logs Section -->
            <h2 class="section-header">Recent Email Logs</h2>
            <div class="email-log-section">
                <table class="email-log-table">
                    <thead>
                        <tr>
                            <th>Date & Time</th>
                            <th>Recipient</th>
                            <th>Type</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="email-logs">
                        <tr>
                            <td colspan="4" style="text-align: center;">Loading logs...</td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
        </div>
        
        <!-- Gift Card Templates Tab -->
        <div id="gift-card-templates" class="tab-content">
            <div class="email-settings-container">
                <h2 class="section-header">Gift Card Email Templates</h2>
                
                <!-- Enhanced Gift Card Template Preview -->
                <div style="display: grid; grid-template-columns: 400px 1fr; gap: 30px; margin-bottom: 40px;">
                    <!-- Gift Card Image Preview -->
                    <div style="border: 2px solid #e5e7eb; border-radius: 16px; padding: 25px; background: linear-gradient(135deg, #f8f9fa, #ffffff); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);">
                        <h4 style="margin: 0 0 20px 0; color: var(--main-color); display: flex; align-items: center; gap: 10px; justify-content: space-between; font-size: 18px;">
                            <span><i class="fas fa-gift"></i> Gift Card Template</span>
                            <button onclick="openTemplateEditor()" style="background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); border: none; border-radius: 8px; color: white; padding: 10px 16px; font-size: 14px; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3);" onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(255, 149, 98, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(255, 149, 98, 0.3)'">
                                <i class="fas fa-edit"></i> Visual Editor
                            </button>
                        </h4>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img id="gift-card-preview-image" 
                                 src="GIFT CARD.png" 
                                 alt="Gift Card Template" 
                                 style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);"
                                 onerror="this.style.display='none'; document.getElementById('gift-card-preview-fallback').style.display='block';">
                            <div id="gift-card-preview-fallback" style="display: none; padding: 80px 20px; background: linear-gradient(135deg, #ff7f42, #ff9562); color: white; border-radius: 12px; font-weight: bold; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                                <i class="fas fa-gift" style="font-size: 48px; margin-bottom: 15px; opacity: 0.8;"></i><br>
                                Gift Card Template<br>
                                <small style="font-weight: normal; opacity: 0.9; font-size: 14px; margin-top: 10px; display: block;">Template image not found</small>
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #666; line-height: 1.6; background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 18px; border-radius: 10px; border: 1px solid #e9ecef;">
                            <strong style="color: var(--main-color); font-size: 16px;"> Text Positioning:</strong><br><br>
                            <div style="margin: 12px 0; display: flex; align-items: center; gap: 12px;">
                                <span style="color: #f8a168; font-weight: bold; font-size: 18px;"></span> 
                                <span><strong>Gift card code</strong> (orange in white area)</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="color: #ffffff; background: #dc3545; padding: 3px 8px; border-radius: 4px; font-weight: bold;"></span> 
                                <span><strong>Invoice number</strong> (white in red area)</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Template Variables Reference -->
                    <div class="template-variables" style="background: rgba(255, 255, 255, 0.8); border-radius: 16px; padding: 25px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 149, 98, 0.2);">
                        <h4 style="color: var(--main-color); font-size: 20px; margin-bottom: 15px;"><i class="fas fa-code"></i> Template Variables</h4>
                        <p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 16px; line-height: 1.5;">
                            Click on any variable to insert it into your email template:
                        </p>
                        <div class="variable-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="variable-item" onclick="insertVariable('{{recipientEmail}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{recipientEmail}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Recipient's email address</small>
                            </div>
                            <div class="variable-item" onclick="insertVariable('{{giftCardCode}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{giftCardCode}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Unique gift card code</small>
                            </div>
                            <div class="variable-item" onclick="insertVariable('{{product}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{product}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Product/service name</small>
                            </div>
                            <div class="variable-item" onclick="insertVariable('{{amount}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{amount}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Gift card dollar amount</small>
                            </div>
                            <div class="variable-item" onclick="insertVariable('{{invoiceNumber}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{invoiceNumber}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Invoice/order number</small>
                            </div>
                            <div class="variable-item" onclick="insertVariable('{{currentDate}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{currentDate}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Current date/time</small>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <h5 style="color: #10b981; margin: 0 0 8px 0; font-size: 16px;"><i class="fas fa-lightbulb"></i> Pro Tip</h5>
                            <p style="margin: 0; color: #059669; font-size: 14px; line-height: 1.5;">
                                You can create professional million-dollar emails with rich formatting, logos, bold text, and advanced layouts using the template builder below.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Professional Rich Text Template Editor -->
                <div class="template-editor">
                    <div class="template-editor-header">
                        <h3 class="template-editor-title">
                            <i class="fas fa-magic"></i> Professional Email Builder
                        </h3>
                        <div class="template-editor-actions">
                            <button class="template-action-btn secondary" onclick="resetTemplate()">
                                <i class="fas fa-undo"></i> Reset to Default
                            </button>
                            <button class="template-action-btn" onclick="previewTemplate()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button class="template-action-btn" onclick="saveTemplate()">
                                <i class="fas fa-save"></i> Save Template
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rich Text Formatting Toolbar -->
                    <div class="rich-text-toolbar" style="background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 8px 8px 0 0; padding: 12px; display: flex; flex-wrap: wrap; gap: 8px; align-items: center;">
                        <!-- Text Formatting Group -->
                        <div class="toolbar-group" style="display: flex; gap: 4px; padding-right: 12px; border-right: 1px solid #dee2e6;">
                            <button type="button" class="toolbar-btn" onclick="formatText('bold')" title="Bold">
                                <i class="fas fa-bold"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('italic')" title="Italic">
                                <i class="fas fa-italic"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('underline')" title="Underline">
                                <i class="fas fa-underline"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('strikethrough')" title="Strikethrough">
                                <i class="fas fa-strikethrough"></i>
                            </button>
                        </div>
                        
                        <!-- Text Color Group -->
                        <div class="toolbar-group" style="display: flex; gap: 4px; padding-right: 12px; border-right: 1px solid #dee2e6; align-items: center;">
                            <button type="button" class="toolbar-color-btn" onclick="openColorPicker('text')" title="Text Color">
                                <i class="fas fa-palette"></i>
                                <span class="color-preview" id="text-color-preview" style="background: #333333;"></span>
                            </button>
                            <button type="button" class="toolbar-color-btn" onclick="openColorPicker('background')" title="Background Color">
                                <i class="fas fa-fill-drip"></i>
                                <span class="color-preview" id="bg-color-preview" style="background: #ffffff;"></span>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="openTextStyleModal()" title="Text Styles">
                                <i class="fas fa-font"></i>
                            </button>
                        </div>
                        
                        <!-- Font Size Group -->
                        <div class="toolbar-group" style="display: flex; gap: 4px; padding-right: 12px; border-right: 1px solid #dee2e6; align-items: center;">
                            <select id="font-size-select" onchange="applyFontSize(this.value)" style="padding: 4px 8px; border: 1px solid #ddd; border-radius: 4px; font-size: 12px;">
                                <option value="10px">10px</option>
                                <option value="12px">12px</option>
                                <option value="14px" selected>14px</option>
                                <option value="16px">16px</option>
                                <option value="18px">18px</option>
                                <option value="20px">20px</option>
                                <option value="24px">24px</option>
                                <option value="28px">28px</option>
                                <option value="32px">32px</option>
                                <option value="36px">36px</option>
                            </select>
                        </div>
                        
                        <!-- Alignment Group -->
                        <div class="toolbar-group" style="display: flex; gap: 4px; padding-right: 12px; border-right: 1px solid #dee2e6;">
                            <button type="button" class="toolbar-btn" onclick="formatText('justifyLeft')" title="Align Left">
                                <i class="fas fa-align-left"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('justifyCenter')" title="Align Center">
                                <i class="fas fa-align-center"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('justifyRight')" title="Align Right">
                                <i class="fas fa-align-right"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('justifyFull')" title="Justify">
                                <i class="fas fa-align-justify"></i>
                            </button>
                        </div>
                        
                        <!-- Lists Group -->
                        <div class="toolbar-group" style="display: flex; gap: 4px; padding-right: 12px; border-right: 1px solid #dee2e6;">
                            <button type="button" class="toolbar-btn" onclick="formatText('insertUnorderedList')" title="Bullet List">
                                <i class="fas fa-list-ul"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="formatText('insertOrderedList')" title="Numbered List">
                                <i class="fas fa-list-ol"></i>
                            </button>
                        </div>
                        
                        <!-- Special Elements Group -->
                        <div class="toolbar-group" style="display: flex; gap: 4px;">
                            <button type="button" class="toolbar-btn" onclick="openLinkModal()" title="Insert Link">
                                <i class="fas fa-link"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="openImageModal()" title="Insert Image">
                                <i class="fas fa-image"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertTable()" title="Insert Table">
                                <i class="fas fa-table"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertHorizontalRule()" title="Insert Line">
                                <i class="fas fa-minus"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="openSpecialCharModal()" title="Special Characters">
                                <i class="fas fa-at"></i>
                            </button>
                            <button type="button" class="toolbar-btn" onclick="insertButton()" title="Insert Button">
                                <i class="fas fa-square"></i>
                            </button>
                        </div>
                    </div>
                    
                    <!-- Rich Text Editor Area -->
                    <div id="rich-text-editor" class="rich-text-editor" contenteditable="true" style="
                        min-height: 500px;
                        max-height: 800px;
                        overflow-y: auto;
                        padding: 20px;
                        border: 1px solid #e9ecef;
                        border-top: none;
                        border-radius: 0 0 8px 8px;
                        background: white;
                        font-family: 'Inter', Arial, sans-serif;
                        font-size: 14px;
                        line-height: 1.6;
                        outline: none;
                    " placeholder="Start building your professional email template here...">
                        <!-- Rich text content will be loaded here -->
                    </div>
                    
                    <!-- Hidden textarea for form submission -->
                    <textarea id="gift-card-template" style="display: none;"></textarea>
                    
                    <div id="template-preview" class="template-preview" style="display: none;">
                        <h4 style="background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color: white; margin: 0; padding: 20px; font-size: 18px; font-weight: 600;">
                            <i class="fas fa-eye"></i> Email Preview
                        </h4>
                        <div id="template-preview-content">
                            <!-- Preview content will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Test Gift Card Email -->
                <div class="email-test-section">
                    <h3 class="section-header">Test Gift Card Email</h3>
                    <p>Send a test gift card email using the current template:</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <input type="email" class="test-email-input" id="test-gift-card-email" placeholder="Recipient email address" value="test@example.com">
                        <input type="text" class="test-email-input" id="test-gift-card-code" placeholder="Test gift card code" value="TEST-GC-123">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <select class="test-email-input" id="test-gift-card-product">
                            <option value="MonuMe">MonuMe</option>
                            <option value="FameMe">FameMe</option>
                            <option value="CrystalMe">CrystalMe</option>
                        </select>
                        <input type="number" class="test-email-input" id="test-gift-card-amount" placeholder="Amount" value="100" step="0.01" min="0">
                    </div>
                    
                    <button class="test-email-button" onclick="sendTestGiftCardEmail()">
                        <i class="fas fa-gift"></i> Send Test Gift Card Email
                    </button>
                    
                    <div id="gift-card-email-status" class="email-status"></div>
                </div>
            </div>
        </div>
        
        <!-- Appointment Templates Tab -->
        <div id="appointment-templates" class="tab-content">
            <div class="email-settings-container">
                <h2 class="section-header">Appointment Email Templates</h2>
                
                <!-- Enhanced Appointment Template Preview -->
                <div style="display: grid; grid-template-columns: 400px 1fr; gap: 30px; margin-bottom: 40px;">
                    <!-- Appointment Template Preview -->
                    <div style="border: 2px solid #e5e7eb; border-radius: 16px; padding: 25px; background: linear-gradient(135deg, #f8f9fa, #ffffff); box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1);">
                        <h4 style="margin: 0 0 20px 0; color: var(--main-color); display: flex; align-items: center; gap: 10px; justify-content: space-between; font-size: 18px;">
                            <span><i class="fas fa-calendar-check"></i> Appointment Template</span>
                        </h4>
                        <div style="text-align: center; margin-bottom: 20px;">
                            <img id="appointment-logo-preview" 
                                 src="logo2.png" 
                                 alt="MonuMe Logo" 
                                 style="max-width: 100%; height: auto; border-radius: 12px; box-shadow: 0 8px 20px rgba(0,0,0,0.15);"
                                 onerror="this.style.display='none'; document.getElementById('appointment-logo-fallback').style.display='block';">
                            <div id="appointment-logo-fallback" style="display: none; padding: 80px 20px; background: linear-gradient(135deg, #ff7f42, #ff9562); color: white; border-radius: 12px; font-weight: bold; text-align: center; box-shadow: 0 8px 20px rgba(0,0,0,0.15);">
                                <i class="fas fa-calendar-check" style="font-size: 48px; margin-bottom: 15px; opacity: 0.8;"></i><br>
                                Appointment Email<br>
                                <small style="font-weight: normal; opacity: 0.9; font-size: 14px; margin-top: 10px; display: block;">Logo not found</small>
                            </div>
                        </div>
                        <div style="font-size: 14px; color: #666; line-height: 1.6; background: linear-gradient(135deg, #f8f9fa, #ffffff); padding: 18px; border-radius: 10px; border: 1px solid #e9ecef;">
                            <strong style="color: var(--main-color); font-size: 16px;"> Calendar Integration:</strong><br><br>
                            <div style="margin: 12px 0; display: flex; align-items: center; gap: 12px;">
                                <span style="color: #4285f4; font-weight: bold; font-size: 18px;"></span> 
                                <span><strong>Google Calendar</strong> - One-click add</span>
                            </div>
                            <div style="display: flex; align-items: center; gap: 12px;">
                                <span style="color: #007acc; font-weight: bold; font-size: 18px;"></span> 
                                <span><strong>Apple Calendar</strong> - ICS file download</span>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Enhanced Template Variables Reference -->
                    <div class="template-variables" style="background: rgba(255, 255, 255, 0.8); border-radius: 16px; padding: 25px; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); border: 1px solid rgba(255, 149, 98, 0.2);">
                        <h4 style="color: var(--main-color); font-size: 20px; margin-bottom: 15px;"><i class="fas fa-code"></i> Appointment Variables</h4>
                        <p style="margin: 0 0 20px 0; color: var(--text-secondary); font-size: 16px; line-height: 1.5;">
                            Click on any variable to insert it into your appointment template:
                        </p>
                        <div class="variable-list" style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px;">
                            <div class="variable-item" onclick="insertAppointmentVariable('{{customerName}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{customerName}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Customer's name</small>
                            </div>
                            <div class="variable-item" onclick="insertAppointmentVariable('{{appointmentDate}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{appointmentDate}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Appointment date</small>
                            </div>
                            <div class="variable-item" onclick="insertAppointmentVariable('{{appointmentTime}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{appointmentTime}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Appointment time</small>
                            </div>
                            <div class="variable-item" onclick="insertAppointmentVariable('{{serviceType}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{serviceType}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Type of service</small>
                            </div>
                            <div class="variable-item" onclick="insertAppointmentVariable('{{location}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{location}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Appointment location</small>
                            </div>
                            <div class="variable-item" onclick="insertAppointmentVariable('{{staffMember}}')" style="background: linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05)); border: 1px solid rgba(255, 149, 98, 0.2); border-radius: 8px; padding: 12px; cursor: pointer; transition: all 0.3s ease; font-size: 14px;" onmouseover="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.2), rgba(255, 127, 66, 0.1))'; this.style.transform='translateY(-2px)'" onmouseout="this.style.background='linear-gradient(135deg, rgba(255, 149, 98, 0.1), rgba(255, 127, 66, 0.05))'; this.style.transform='translateY(0)'">
                                <span class="variable-code" style="background: var(--main-color); color: white; padding: 2px 6px; border-radius: 4px; font-family: monospace; font-size: 12px; font-weight: 600;">{{staffMember}}</span><br>
                                <small style="color: #666; margin-top: 4px; display: block;">Staff member name</small>
                            </div>
                        </div>
                        
                        <div style="margin-top: 20px; padding: 15px; background: rgba(16, 185, 129, 0.1); border-radius: 10px; border: 1px solid rgba(16, 185, 129, 0.2);">
                            <h5 style="color: #10b981; margin: 0 0 8px 0; font-size: 16px;"><i class="fas fa-lightbulb"></i> Pro Tip</h5>
                            <p style="margin: 0; color: #059669; font-size: 14px; line-height: 1.5;">
                                Create professional appointment emails with calendar integration, logo branding, and multiple template styles for different appointment types.
                            </p>
                        </div>
                    </div>
                </div>
                
                <!-- Template Style Selector -->
                <div style="background: rgba(255, 255, 255, 0.5); border-radius: 12px; box-shadow: var(--shadow-sm); margin-bottom: 30px; padding: 25px;">
                    <h3 style="color: var(--main-color); font-size: 20px; margin-bottom: 20px;"><i class="fas fa-palette"></i> Choose Template Style</h3>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                        <button class="template-style-btn" onclick="selectAppointmentTemplate('Professional')" style="background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px;" onmouseover="this.style.borderColor='var(--main-color)'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(255, 149, 98, 0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-briefcase" style="font-size: 24px; color: var(--main-color);"></i>
                            <span style="font-weight: 600; color: #333;">Professional</span>
                            <small style="color: #666; font-size: 12px;">Clean corporate style</small>
                        </button>
                        <button class="template-style-btn" onclick="selectAppointmentTemplate('Modern')" style="background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px;" onmouseover="this.style.borderColor='var(--main-color)'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(255, 149, 98, 0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-rocket" style="font-size: 24px; color: var(--main-color);"></i>
                            <span style="font-weight: 600; color: #333;">Modern</span>
                            <small style="color: #666; font-size: 12px;">Vibrant contemporary</small>
                        </button>
                        <button class="template-style-btn" onclick="selectAppointmentTemplate('Elegant')" style="background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px;" onmouseover="this.style.borderColor='var(--main-color)'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(255, 149, 98, 0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-gem" style="font-size: 24px; color: var(--main-color);"></i>
                            <span style="font-weight: 600; color: #333;">Elegant</span>
                            <small style="color: #666; font-size: 12px;">Sophisticated luxury</small>
                        </button>
                        <button class="template-style-btn" onclick="selectAppointmentTemplate('Friendly')" style="background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px;" onmouseover="this.style.borderColor='var(--main-color)'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(255, 149, 98, 0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-smile" style="font-size: 24px; color: var(--main-color);"></i>
                            <span style="font-weight: 600; color: #333;">Friendly</span>
                            <small style="color: #666; font-size: 12px;">Warm and welcoming</small>
                        </button>
                        <button class="template-style-btn" onclick="selectAppointmentTemplate('Clean')" style="background: linear-gradient(135deg, #f8f9fa, #ffffff); border: 2px solid #e9ecef; border-radius: 12px; padding: 20px; text-align: center; cursor: pointer; transition: all 0.3s ease; display: flex; flex-direction: column; align-items: center; gap: 10px;" onmouseover="this.style.borderColor='var(--main-color)'; this.style.transform='translateY(-3px)'; this.style.boxShadow='0 8px 25px rgba(255, 149, 98, 0.2)'" onmouseout="this.style.borderColor='#e9ecef'; this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-sparkles" style="font-size: 24px; color: var(--main-color);"></i>
                            <span style="font-weight: 600; color: #333;">Clean</span>
                            <small style="color: #666; font-size: 12px;">Simple and minimal</small>
                        </button>
                    </div>
                </div>
                
                <!-- Professional Rich Text Template Editor -->
                <div class="template-editor">
                    <div class="template-editor-header">
                        <h3 class="template-editor-title">
                            <i class="fas fa-magic"></i> Appointment Email Builder
                        </h3>
                        <div class="template-editor-actions">
                            <button class="template-action-btn secondary" onclick="resetAppointmentTemplate()">
                                <i class="fas fa-undo"></i> Reset to Default
                            </button>
                            <button class="template-action-btn" onclick="previewAppointmentTemplate()">
                                <i class="fas fa-eye"></i> Preview
                            </button>
                            <button class="template-action-btn" onclick="saveAppointmentTemplate()">
                                <i class="fas fa-save"></i> Save Template
                            </button>
                        </div>
                    </div>
                    
                    <!-- Appointment Rich Text Editor Area -->
                    <div id="appointment-rich-text-editor" class="rich-text-editor" contenteditable="true" style="
                        min-height: 500px;
                        max-height: 800px;
                        overflow-y: auto;
                        padding: 20px;
                        border: 1px solid #e9ecef;
                        border-radius: 8px;
                        background: white;
                        font-family: 'Inter', Arial, sans-serif;
                        font-size: 14px;
                        line-height: 1.6;
                        outline: none;
                    " placeholder="Start building your professional appointment email template here...">
                        <!-- Rich text content will be loaded here -->
                    </div>
                    
                    <!-- Hidden textarea for form submission -->
                    <textarea id="appointment-template" style="display: none;"></textarea>
                    
                    <div id="appointment-template-preview" class="template-preview" style="display: none;">
                        <h4 style="background: linear-gradient(135deg, var(--gradient-start), var(--gradient-end)); color: white; margin: 0; padding: 20px; font-size: 18px; font-weight: 600;">
                            <i class="fas fa-eye"></i> Appointment Email Preview
                        </h4>
                        <div id="appointment-template-preview-content">
                            <!-- Preview content will be displayed here -->
                        </div>
                    </div>
                </div>
                
                <!-- Test Appointment Email -->
                <div class="email-test-section">
                    <h3 class="section-header">Test Appointment Email</h3>
                    <p>Send a test appointment email using the current template:</p>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <input type="email" class="test-email-input" id="test-appointment-email" placeholder="Recipient email address" value="test@example.com">
                        <input type="text" class="test-email-input" id="test-customer-name" placeholder="Customer name" value="John Doe">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <input type="date" class="test-email-input" id="test-appointment-date" value="">
                        <input type="time" class="test-email-input" id="test-appointment-time" value="10:00">
                    </div>
                    
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                        <select class="test-email-input" id="test-service-type">
                            <option value="Consultation">Consultation</option>
                            <option value="Treatment">Treatment</option>
                            <option value="Follow-up">Follow-up</option>
                            <option value="Assessment">Assessment</option>
                        </select>
                        <input type="text" class="test-email-input" id="test-location" placeholder="Location" value="Main Office">
                    </div>
                    
                    <div style="margin-bottom: 15px;">
                        <input type="text" class="test-email-input" id="test-staff-member" placeholder="Staff member name" value="Dr. Smith">
                    </div>
                    
                    <button class="test-email-button" onclick="sendTestAppointmentEmail()">
                        <i class="fas fa-calendar-check"></i> Send Test Appointment Email
                    </button>
                    
                    <div id="appointment-email-status" class="email-status"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Visual Template Editor Modal -->
    <div id="template-editor-modal" class="template-editor-modal">
        <div class="template-editor-content">
            <div class="template-editor-header">
                <h2><i class="fas fa-magic"></i> Visual Template Builder</h2>
                <button class="template-editor-close" onclick="closeTemplateEditor()">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            
            <div class="template-editor-body">
                <!-- Canvas Area -->
                <div class="template-canvas-container">
                    <h4 style="margin: 0 0 20px 0; color: var(--main-color);">
                        <i class="fas fa-image"></i> Template Design Canvas
                    </h4>
                    
                    <div id="canvas-wrapper" style="position: relative; display: inline-block;">
                        <img id="template-canvas" class="template-canvas" src="GIFT CARD.png" alt="Gift Card Template">
                        
                        <!-- Draggable Position Markers -->
                        <div id="code-marker" class="position-marker code-marker" style="top: 50%; left: 50%; transform: translate(-50%, -50%);">
                            <i class="fas fa-barcode"></i> CODE
                        </div>
                        
                        <div id="invoice-marker" class="position-marker invoice-marker" style="top: 70%; left: 60%; transform: translate(-50%, -50%);">
                            <i class="fas fa-receipt"></i> INVOICE
                        </div>
                    </div>
                    
                    <div style="margin-top: 15px; font-size: 13px; color: #666; text-align: center;">
                         Drag the orange CODE and red INVOICE boxes to position them where you want the text to appear
                    </div>
                </div>
                
                <!-- Tools Panel -->
                <div class="template-tools">
                    <!-- Image Tools -->
                    <div class="tool-section">
                        <h4><i class="fas fa-image"></i> Image Tools</h4>
                        
                        <div class="file-upload-area" onclick="document.getElementById('image-upload').click()">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 24px; color: var(--main-color); margin-bottom: 8px;"></i>
                            <div style="font-weight: 600; margin-bottom: 4px;">Upload New Template</div>
                            <div style="font-size: 12px; color: #666;">Click or drag image here</div>
                        </div>
                        
                        <input type="file" id="image-upload" accept="image/*" style="display: none;" onchange="loadNewImage(event)">
                        
                        <button class="tool-button secondary" onclick="resetTemplate()">
                            <i class="fas fa-undo"></i> Reset to Original
                        </button>
                    </div>
                    
                    <!-- Position Tools -->
                    <div class="tool-section">
                        <h4><i class="fas fa-crosshairs"></i> Position Controls</h4>
                        
                        <div style="margin-bottom: 15px;">
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: #f8a168;">
                                <i class="fas fa-barcode"></i> Code Position
                            </div>
                            <div class="position-controls">
                                <input type="number" class="position-input" id="code-x" placeholder="X" min="0" max="100" onchange="updateCodePosition()">
                                <input type="number" class="position-input" id="code-y" placeholder="Y" min="0" max="100" onchange="updateCodePosition()">
                            </div>
                        </div>
                        
                        <div>
                            <div style="font-weight: 600; font-size: 13px; margin-bottom: 8px; color: #dc3545;">
                                <i class="fas fa-receipt"></i> Invoice Position
                            </div>
                            <div class="position-controls">
                                <input type="number" class="position-input" id="invoice-x" placeholder="X" min="0" max="100" onchange="updateInvoicePosition()">
                                <input type="number" class="position-input" id="invoice-y" placeholder="Y" min="0" max="100" onchange="updateInvoicePosition()">
                            </div>
                        </div>
                        
                        <button class="tool-button" onclick="centerPositions()">
                            <i class="fas fa-align-center"></i> Center Elements
                        </button>
                    </div>
                    
                    <!-- Text Settings -->
                    <div class="tool-section">
                        <h4><i class="fas fa-font"></i> Text Settings</h4>
                        
                        <div class="template-settings">
                            <div class="setting-row">
                                <span class="setting-label">Code Color:</span>
                                <input type="color" class="color-picker" id="code-color" value="#f8a168" onchange="updateTextSettings()">
                            </div>
                            
                            <div class="setting-row">
                                <span class="setting-label">Code Size:</span>
                                <input type="number" class="setting-input" id="code-size" value="28" min="10" max="50" onchange="updateTextSettings()">
                            </div>
                            
                            <div class="setting-row">
                                <span class="setting-label">Invoice Color:</span>
                                <input type="color" class="color-picker" id="invoice-color" value="#ffffff" onchange="updateTextSettings()">
                            </div>
                            
                            <div class="setting-row">
                                <span class="setting-label">Invoice Size:</span>
                                <input type="number" class="setting-input" id="invoice-size" value="20" min="10" max="50" onchange="updateTextSettings()">
                            </div>
                        </div>
                    </div>
                    
                    <!-- Actions -->
                    <div class="tool-section">
                        <h4><i class="fas fa-tools"></i> Actions</h4>
                        
                        <button class="tool-button" onclick="previewGiftCard()">
                            <i class="fas fa-eye"></i> Preview Card
                        </button>
                        
                        <button class="tool-button" onclick="saveTemplateSettings()">
                            <i class="fas fa-save"></i> Save Settings
                        </button>
                        
                        <button class="tool-button secondary" onclick="closeTemplateEditor()">
                            <i class="fas fa-times"></i> Close Editor
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Toast Notification -->
    <div id="toast" class="toast"></div>

    <!-- Email Setup Help Modal -->
    <div id="email-setup-help-modal" class="editor-modal" style="display: none;">
        <div class="editor-modal-content" style="max-width: 700px;">
            <div class="editor-modal-header">
                <h3><i class="fas fa-question-circle"></i> Email Setup Guide</h3>
                <button class="editor-modal-close" onclick="closeEmailSetupHelp()">&times;</button>
            </div>
            <div class="editor-modal-body">
                <div class="help-content">
                    <div class="help-section">
                        <h4><i class="fas fa-envelope"></i> Step 1: Choose Your Email Provider</h4>
                        <p>MonuMe supports most email providers. We recommend:</p>
                        <ul>
                            <li><strong>Gmail</strong> - Easiest to setup with App Passwords</li>
                            <li><strong>Outlook/Hotmail</strong> - Good Microsoft integration</li>
                            <li><strong>Yahoo Mail</strong> - Reliable option</li>
                            <li><strong>Custom Domain</strong> - Professional business email</li>
                        </ul>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-key"></i> Step 2: Generate App Password</h4>
                        <div class="help-tabs">
                            <div class="help-tab-buttons">
                                <button class="help-tab-btn active" onclick="showHelpTab('gmail')">Gmail</button>
                                <button class="help-tab-btn" onclick="showHelpTab('outlook')">Outlook</button>
                                <button class="help-tab-btn" onclick="showHelpTab('yahoo')">Yahoo</button>
                            </div>
                            
                            <div id="gmail-help" class="help-tab-content active">
                                <h5> Gmail Setup:</h5>
                                <ol>
                                    <li>Go to <a href="https://myaccount.google.com/security" target="_blank">Google Account Security</a></li>
                                    <li>Enable <strong>2-Step Verification</strong> if not already enabled</li>
                                    <li>Click on <strong>"App passwords"</strong></li>
                                    <li>Select <strong>"Mail"</strong> as the app</li>
                                    <li>Select <strong>"Other (custom name)"</strong> and enter "MonuMe"</li>
                                    <li>Copy the 16-character password generated</li>
                                    <li>Paste it in the App Password field above</li>
                                </ol>
                                <div class="help-note">
                                    <i class="fas fa-info-circle"></i>
                                    <strong>Note:</strong> The app password will look like: abcd efgh ijkl mnop
                                </div>
                            </div>
                            
                            <div id="outlook-help" class="help-tab-content">
                                <h5> Outlook Setup:</h5>
                                <ol>
                                    <li>Go to <a href="https://account.microsoft.com/security" target="_blank">Microsoft Account Security</a></li>
                                    <li>Sign in to your Microsoft account</li>
                                    <li>Go to <strong>Security basics</strong></li>
                                    <li>Under <strong>App passwords</strong>, click <strong>Create a new app password</strong></li>
                                    <li>Enter "MonuMe" as the app name</li>
                                    <li>Copy the generated password</li>
                                    <li>Paste it in the App Password field above</li>
                                </ol>
                                <div class="help-note">
                                    <i class="fas fa-shield-alt"></i>
                                    <strong>Security:</strong> App passwords are safer than using your main password
                                </div>
                            </div>
                            
                            <div id="yahoo-help" class="help-tab-content">
                                <h5> Yahoo Setup:</h5>
                                <ol>
                                    <li>Go to <a href="https://login.yahoo.com/account/security" target="_blank">Yahoo Account Security</a></li>
                                    <li>Click on <strong>"Generate app password"</strong></li>
                                    <li>Enter "MonuMe" as the app name</li>
                                    <li>Click <strong>"Generate password"</strong></li>
                                    <li>Copy the 16-character password</li>
                                    <li>Paste it in the App Password field above</li>
                                </ol>
                                <div class="help-note">
                                    <i class="fas fa-clock"></i>
                                    <strong>Tip:</strong> App passwords don't expire but can be revoked anytime
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-cog"></i> Step 3: Configure MonuMe</h4>
                        <ol>
                            <li>Enter your <strong>email address</strong> in the "Sender Email" field</li>
                            <li>Paste the <strong>App Password</strong> you generated</li>
                            <li>Optionally customize the <strong>Sender Name</strong></li>
                            <li>Click <strong>"Test Connection"</strong> to verify setup</li>
                            <li>If successful, click <strong>"Save Configuration"</strong></li>
                        </ol>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-shield-alt"></i> Security & Troubleshooting</h4>
                        <div class="security-tips">
                            <div class="security-tip">
                                <i class="fas fa-lock"></i>
                                <div>
                                    <strong>Never use your regular password</strong><br>
                                    Always use App Passwords for better security
                                </div>
                            </div>
                            <div class="security-tip">
                                <i class="fas fa-eye-slash"></i>
                                <div>
                                    <strong>Keep passwords private</strong><br>
                                    Don't share your app passwords with anyone
                                </div>
                            </div>
                            <div class="security-tip">
                                <i class="fas fa-sync-alt"></i>
                                <div>
                                    <strong>If emails fail</strong><br>
                                    Try regenerating a new app password
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="help-section">
                        <h4><i class="fas fa-question-circle"></i> Common Issues</h4>
                        <div class="faq-list">
                            <div class="faq-item">
                                <strong>Q: Authentication failed error?</strong><br>
                                A: Double-check your app password and make sure 2FA is enabled.
                            </div>
                            <div class="faq-item">
                                <strong>Q: Emails not sending?</strong><br>
                                A: Verify your internet connection and email provider settings.
                            </div>
                            <div class="faq-item">
                                <strong>Q: Recipients not receiving emails?</strong><br>
                                A: Check spam folders and verify email addresses are correct.
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            <div class="editor-modal-footer">
                <button class="btn btn-primary" onclick="closeEmailSetupHelp()">
                    <i class="fas fa-check"></i> Got it!
                </button>
            </div>
        </div>
    </div>

    <!-- Color Picker Modal -->
    <div id="color-picker-modal" class="editor-modal" style="display: none;">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <h3><i class="fas fa-palette"></i> Choose Color</h3>
                <button class="editor-modal-close" onclick="closeColorPicker()">&times;</button>
            </div>
            <div class="editor-modal-body">
                <div class="color-picker-grid">
                    <!-- Popular Colors -->
                    <div class="color-section">
                        <h4>Popular Colors</h4>
                        <div class="color-palette">
                            <div class="color-option" style="background: #000000" onclick="selectColor('#000000')"></div>
                            <div class="color-option" style="background: #333333" onclick="selectColor('#333333')"></div>
                            <div class="color-option" style="background: #666666" onclick="selectColor('#666666')"></div>
                            <div class="color-option" style="background: #999999" onclick="selectColor('#999999')"></div>
                            <div class="color-option" style="background: #ffffff; border: 1px solid #ddd" onclick="selectColor('#ffffff')"></div>
                            <div class="color-option" style="background: #ff0000" onclick="selectColor('#ff0000')"></div>
                            <div class="color-option" style="background: #00ff00" onclick="selectColor('#00ff00')"></div>
                            <div class="color-option" style="background: #0000ff" onclick="selectColor('#0000ff')"></div>
                            <div class="color-option" style="background: #ffff00" onclick="selectColor('#ffff00')"></div>
                            <div class="color-option" style="background: #ff00ff" onclick="selectColor('#ff00ff')"></div>
                            <div class="color-option" style="background: #00ffff" onclick="selectColor('#00ffff')"></div>
                            <div class="color-option" style="background: #ff7f42" onclick="selectColor('#ff7f42')"></div>
                        </div>
                    </div>
                    
                    <!-- Brand Colors -->
                    <div class="color-section">
                        <h4>Brand Colors</h4>
                        <div class="color-palette">
                            <div class="color-option" style="background: #ff7f42" onclick="selectColor('#ff7f42')" title="MonuMe Orange"></div>
                            <div class="color-option" style="background: #ff9562" onclick="selectColor('#ff9562')" title="MonuMe Light Orange"></div>
                            <div class="color-option" style="background: #667eea" onclick="selectColor('#667eea')" title="MonuMe Blue"></div>
                            <div class="color-option" style="background: #764ba2" onclick="selectColor('#764ba2')" title="MonuMe Purple"></div>
                            <div class="color-option" style="background: #10b981" onclick="selectColor('#10b981')" title="Success Green"></div>
                            <div class="color-option" style="background: #dc2626" onclick="selectColor('#dc2626')" title="Error Red"></div>
                        </div>
                    </div>
                    
                    <!-- Custom Color -->
                    <div class="color-section">
                        <h4>Custom Color</h4>
                        <input type="color" id="custom-color-picker" style="width: 60px; height: 40px; border: none; border-radius: 8px; cursor: pointer;" onchange="selectColor(this.value)">
                        <input type="text" id="color-hex-input" placeholder="#ffffff" style="margin-left: 10px; padding: 8px 12px; border: 1px solid #ddd; border-radius: 6px; font-family: monospace;" onchange="selectColor(this.value)">
                    </div>
                </div>
            </div>
            <div class="editor-modal-footer">
                <button class="btn btn-secondary" onclick="closeColorPicker()">Cancel</button>
                <button class="btn btn-primary" onclick="applySelectedColor()">Apply Color</button>
            </div>
        </div>
    </div>

    <!-- Link Modal -->
    <div id="link-modal" class="editor-modal" style="display: none;">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <h3><i class="fas fa-link"></i> Insert Link</h3>
                <button class="editor-modal-close" onclick="closeLinkModal()">&times;</button>
            </div>
            <div class="editor-modal-body">
                <div class="form-group">
                    <label for="link-text">Link Text:</label>
                    <input type="text" id="link-text" class="form-control" placeholder="Click here">
                </div>
                <div class="form-group">
                    <label for="link-url">URL:</label>
                    <input type="url" id="link-url" class="form-control" placeholder="https://example.com">
                </div>
                <div class="form-group">
                    <label for="link-title">Title (tooltip):</label>
                    <input type="text" id="link-title" class="form-control" placeholder="Optional tooltip text">
                </div>
                <div class="form-group">
                    <label>
                        <input type="checkbox" id="link-new-tab"> Open in new tab
                    </label>
                </div>
                <div class="form-group">
                    <label for="link-style">Link Style:</label>
                    <select id="link-style" class="form-control">
                        <option value="default">Default Link</option>
                        <option value="button">Button Style</option>
                        <option value="underline">Underlined</option>
                        <option value="no-decoration">No Decoration</option>
                    </select>
                </div>
            </div>
            <div class="editor-modal-footer">
                <button class="btn btn-secondary" onclick="closeLinkModal()">Cancel</button>
                <button class="btn btn-primary" onclick="insertLinkFromModal()">Insert Link</button>
            </div>
        </div>
    </div>

    <!-- Image Modal -->
    <div id="image-modal" class="editor-modal" style="display: none;">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <h3><i class="fas fa-image"></i> Insert Image</h3>
                <button class="editor-modal-close" onclick="closeImageModal()">&times;</button>
            </div>
            <div class="editor-modal-body">
                <!-- Upload Tab -->
                <div class="tab-container">
                    <div class="tab-buttons">
                        <button class="tab-btn active" onclick="switchImageTab('upload')">Upload File</button>
                        <button class="tab-btn" onclick="switchImageTab('url')">From URL</button>
                    </div>
                    
                    <div id="upload-tab" class="image-tab active">
                        <div class="file-upload-zone" id="image-upload-zone">
                            <i class="fas fa-cloud-upload-alt"></i>
                            <p>Drag & drop an image here or click to browse</p>
                            <input type="file" id="image-file-input" accept="image/*" style="display: none;">
                            <button class="btn btn-primary" onclick="document.getElementById('image-file-input').click()">
                                <i class="fas fa-folder-open"></i> Choose File
                            </button>
                        </div>
                        <div id="image-preview" style="display: none; text-align: center; margin-top: 15px;">
                            <img id="preview-img" style="max-width: 100%; max-height: 200px; border-radius: 8px;">
                        </div>
                    </div>
                    
                    <div id="url-tab" class="image-tab">
                        <div class="form-group">
                            <label for="image-url">Image URL:</label>
                            <input type="url" id="image-url" class="form-control" placeholder="https://example.com/image.jpg">
                        </div>
                        <button class="btn btn-secondary" onclick="previewImageFromUrl()">
                            <i class="fas fa-eye"></i> Preview
                        </button>
                    </div>
                </div>
                
                <!-- Image Settings -->
                <div class="image-settings" style="margin-top: 20px; border-top: 1px solid #eee; padding-top: 20px;">
                    <h4>Image Settings</h4>
                    <div class="form-group">
                        <label for="image-alt">Alt Text:</label>
                        <input type="text" id="image-alt" class="form-control" placeholder="Describe the image">
                    </div>
                    <div class="form-group">
                        <label for="image-width">Width:</label>
                        <select id="image-width" class="form-control">
                            <option value="auto">Auto</option>
                            <option value="25%">25%</option>
                            <option value="50%">50%</option>
                            <option value="75%">75%</option>
                            <option value="100%">100%</option>
                            <option value="200px">200px</option>
                            <option value="400px">400px</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="image-align">Alignment:</label>
                        <select id="image-align" class="form-control">
                            <option value="left">Left</option>
                            <option value="center">Center</option>
                            <option value="right">Right</option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="editor-modal-footer">
                <button class="btn btn-secondary" onclick="closeImageModal()">Cancel</button>
                <button class="btn btn-primary" onclick="insertImageFromModal()">Insert Image</button>
            </div>
        </div>
    </div>

    <!-- Text Style Modal -->
    <div id="text-style-modal" class="editor-modal" style="display: none;">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <h3><i class="fas fa-font"></i> Text Styles</h3>
                <button class="editor-modal-close" onclick="closeTextStyleModal()">&times;</button>
            </div>
            <div class="editor-modal-body">
                <div class="style-grid">
                    <!-- Font Family -->
                    <div class="style-section">
                        <h4>Font Family</h4>
                        <select id="font-family-select" class="form-control" onchange="applyFontFamily(this.value)">
                            <option value="Arial, sans-serif">Arial</option>
                            <option value="'Times New Roman', serif">Times New Roman</option>
                            <option value="'Courier New', monospace">Courier New</option>
                            <option value="'Helvetica Neue', Arial, sans-serif">Helvetica</option>
                            <option value="Georgia, serif">Georgia</option>
                            <option value="'Comic Sans MS', cursive">Comic Sans</option>
                            <option value="'Inter', Arial, sans-serif" selected>Inter (Premium)</option>
                            <option value="'Roboto', sans-serif">Roboto</option>
                        </select>
                    </div>
                    
                    <!-- Text Decoration -->
                    <div class="style-section">
                        <h4>Text Effects</h4>
                        <div class="effect-grid">
                            <button class="effect-btn" onclick="applyTextEffect('shadow')">
                                <i class="fas fa-font"></i> Text Shadow
                            </button>
                            <button class="effect-btn" onclick="applyTextEffect('glow')">
                                <i class="fas fa-sun"></i> Glow Effect
                            </button>
                            <button class="effect-btn" onclick="applyTextEffect('gradient')">
                                <i class="fas fa-fill-drip"></i> Gradient Text
                            </button>
                            <button class="effect-btn" onclick="applyTextEffect('outline')">
                                <i class="fas fa-border-style"></i> Text Outline
                            </button>
                        </div>
                    </div>
                    
                    <!-- Text Transform -->
                    <div class="style-section">
                        <h4>Text Transform</h4>
                        <div class="transform-grid">
                            <button class="transform-btn" onclick="applyTextTransform('uppercase')">UPPERCASE</button>
                            <button class="transform-btn" onclick="applyTextTransform('lowercase')">lowercase</button>
                            <button class="transform-btn" onclick="applyTextTransform('capitalize')">Capitalize</button>
                            <button class="transform-btn" onclick="applyTextTransform('none')">Normal</button>
                        </div>
                    </div>
                    
                    <!-- Letter Spacing -->
                    <div class="style-section">
                        <h4>Letter Spacing</h4>
                        <input type="range" id="letter-spacing" min="-2" max="10" value="0" step="0.5" onchange="applyLetterSpacing(this.value)">
                        <div class="spacing-labels">
                            <span>Tight</span>
                            <span>Normal</span>
                            <span>Wide</span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="editor-modal-footer">
                <button class="btn btn-secondary" onclick="closeTextStyleModal()">Close</button>
            </div>
        </div>
    </div>

    <!-- Special Characters Modal -->
    <div id="special-char-modal" class="editor-modal" style="display: none;">
        <div class="editor-modal-content">
            <div class="editor-modal-header">
                <h3><i class="fas fa-at"></i> Special Characters</h3>
                <button class="editor-modal-close" onclick="closeSpecialCharModal()">&times;</button>
            </div>
            <div class="editor-modal-body">
                <div class="char-categories">
                    <div class="char-category">
                        <h4>Symbols</h4>
                        <div class="char-grid">
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('$')">$</span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                        </div>
                    </div>
                    
                    <div class="char-category">
                        <h4>Arrows</h4>
                        <div class="char-grid">
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                        </div>
                    </div>
                    
                    <div class="char-category">
                        <h4>Math</h4>
                        <div class="char-grid">
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                        </div>
                    </div>
                    
                    <div class="char-category">
                        <h4>Punctuation</h4>
                        <div class="char-grid">
                            <span class="char-option" onclick="insertSpecialChar('&ldquo;')">"</span>
                            <span class="char-option" onclick="insertSpecialChar('&rdquo;')">"</span>
                            <span class="char-option" onclick="insertSpecialChar('&lsquo;')">'</span>
                            <span class="char-option" onclick="insertSpecialChar('&rsquo;')">'</span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                            <span class="char-option" onclick="insertSpecialChar('')"></span>
                        </div>
                    </div>
                </div>
            </div>
            <div class="editor-modal-footer">
                <button class="btn btn-secondary" onclick="closeSpecialCharModal()">Close</button>
            </div>
        </div>
    </div>

    <script src="js/emails-location.js"></script>
    <script>
        // Determine environment: production or development
        const hostname = window.location.hostname;
        const port = window.location.port;
        const isProduction = hostname.includes('monumevip.com');
        const isDevelopment = (
            hostname === 'localhost' ||
            hostname === '127.0.0.1'
        );

        let apiBasePath;

        if (isProduction) {
            apiBasePath = 'https://www.monumevip.com';
            console.log(`Running in PRODUCTION mode. Using API: ${apiBasePath}`);
        } else if (isDevelopment) {
            apiBasePath = 'http://127.0.0.1:5000';
            console.log(`Running in DEVELOPMENT mode. Using API: ${apiBasePath}`);
        } else {
            apiBasePath = window.location.origin;
            console.log(`Running in UNKNOWN environment. Using API: ${apiBasePath}`);
        }
            
        // Make sure to include credentials for authentication
        const fetchOptions = {
            credentials: 'include',
            headers: {
                'Content-Type': 'application/json'
            }
        };

        // Improved error handling for API calls
        async function fetchWithErrorHandling(url, options = {}) {
            try {
                const mergedOptions = { ...fetchOptions, ...options };
                
                // For development with Live Server, we might need to handle CORS issues
                if (isDevelopment) {
                    console.log(`Debug - Fetching: ${url}`);
                }
                
                const response = await fetch(url, mergedOptions);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }
                return await response.json();
            } catch (error) {
                console.error(`Error fetching ${url}:`, error);
                throw error;
            }
        }
        
        // Send test email - Making this a window function so it's globally accessible
        window.sendTestEmail = async function() {
            const emailInput = document.getElementById('test-email');
            const emailStatus = document.getElementById('email-status');
            const email = emailInput.value.trim();
            
            if (!email) {
                emailStatus.textContent = 'Please enter an email address';
                emailStatus.className = 'email-status error';
                emailStatus.style.display = 'block';
                return;
            }
            
            // Email validation regex
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            if (!emailRegex.test(email)) {
                emailStatus.textContent = 'Please enter a valid email address';
                emailStatus.className = 'email-status error';
                emailStatus.style.display = 'block';
                return;
            }
            
            try {
                // Update status to pending
                emailStatus.textContent = 'Sending test email...';
                emailStatus.className = 'email-status pending';
                emailStatus.style.display = 'block';
                
                // Use relative URL - will work on both development and production
                const apiUrl = '/send_test_email';
                console.log(`Sending test email via: ${apiUrl}`);
                
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email })
                });

                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const result = await response.json();
                emailStatus.textContent = result.message || 'Test email sent successfully!';
                emailStatus.className = 'email-status success';
                
                // Refresh email logs
                setTimeout(loadEmailLogs, 1000);
                
            } catch (error) {
                console.error('Failed to send test email:', error);
                emailStatus.textContent = `Failed to send test email: ${error.message}`;
                emailStatus.className = 'email-status error';
            }
        }
        
        // Display environment-specific banner
        function setupEnvironmentBanner() {
            const banner = document.getElementById('environment-banner');
            const message = document.getElementById('environment-message');
            const domainDisplay = document.getElementById('domain-display');
            
            if (isProduction) {
                banner.style.backgroundColor = 'rgba(76, 175, 80, 0.15)';
                banner.style.border = '1px solid rgba(76, 175, 80, 0.3)';
                message.textContent = 'Production Mode - Real emails will be sent';
                domainDisplay.textContent = hostname;
            } else {
                banner.style.backgroundColor = 'rgba(255, 152, 0, 0.15)';
                banner.style.border = '1px solid rgba(255, 152, 0, 0.3)';
                message.textContent = 'Development Mode - Emails will be simulated';
                domainDisplay.textContent = `${hostname}:${port}`;
            }
        }
        
        // Generate particles for background effect
        document.addEventListener('DOMContentLoaded', function() {
            // Setup environment banner
            setupEnvironmentBanner();
            
            const particles = document.getElementById('particles');
            const particleCount = 20;
            
            for (let i = 0; i < particleCount; i++) {
                const particle = document.createElement('div');
                particle.className = 'particle';
                particle.style.width = `${Math.random() * 20 + 5}px`;
                particle.style.height = particle.style.width;
                particle.style.left = `${Math.random() * 100}%`;
                particle.style.top = `${Math.random() * 100}%`;
                particle.style.opacity = Math.random() * 0.6;
                particle.style.animationDuration = `${Math.random() * 20 + 10}s`;
                particle.style.animationDelay = `${Math.random() * 5}s`;
                particles.appendChild(particle);
            }
            
            // Load sidebar
            fetch('sidebar-template.html')
                .then(response => response.text())
                .then(data => {
                    document.getElementById('sidebar-container').innerHTML = data;
                    
                    // Highlight active menu item
                    setTimeout(() => {
                        const menuItems = document.querySelectorAll('.sidebar-menu li');
                        menuItems.forEach(item => {
                            const link = item.querySelector('a');
                            if (link && link.getAttribute('href') === 'emails.html') {
                                item.classList.add('active');
                            }
                        });
                    }, 100);
                })
                .catch(error => {
                    console.error('Error loading sidebar:', error);
                    // Fallback for sidebar if it fails to load
                    document.getElementById('sidebar-container').innerHTML = `
                        <div class="sidebar">
                            <div class="sidebar-header">
                                <h2>MonuMe Tracker</h2>
                            </div>
                            <ul class="sidebar-menu">
                                <li><a href="dashboard.html"><i class="fas fa-chart-line"></i><span>Dashboard</span></a></li>
                                <li class="active"><a href="emails.html"><i class="fas fa-envelope"></i><span>Emails</span></a></li>
                                <li><a href="users.html"><i class="fas fa-users"></i><span>Users</span></a></li>
                            </ul>
                        </div>
                    `;
                });
            
            // Check user permissions
            checkUserPermissions();
        });
        
        // Check if user has permissions to access this page
        async function checkUserPermissions() {
            // Always load the email functionality in development mode
            if (isDevelopment || window.location.hostname === '127.0.0.1' || window.location.hostname === 'localhost') {
                console.log('Development mode or local environment: Bypassing authentication checks');
                loadEmailSettings();
                loadEmailLogs();
                setupToggleListeners();
                return;
            }
            
            // Get authentication from localStorage
            const username = localStorage.getItem('username');
            const isLoggedIn = localStorage.getItem('isLoggedIn') === 'true';
            
            if (!isLoggedIn || !username) {
                console.log('User not logged in via localStorage');
                
                // Try to find credentials in URL (for demo purposes)
                const urlParams = new URLSearchParams(window.location.search);
                const autoLogin = urlParams.get('autologin');
                
                if (autoLogin === 'true') {
                    console.log('Auto-login enabled, bypassing authentication');
                    localStorage.setItem('username', 'demo_user');
                    localStorage.setItem('role', 'employee');
                    localStorage.setItem('isLoggedIn', 'true');
                    
                    // Load email functionality
                    loadEmailSettings();
                    loadEmailLogs();
                    setupToggleListeners();
                    return;
                }
                
                // Try server authentication as fallback
                try {
                    const response = await fetch(`${apiBasePath}/get_current_user`, { credentials: 'include' });
                    
                    if (response.ok) {
                        // User is authenticated with server
                        const userData = await response.json();
                        console.log('User is authenticated with server:', userData.username);
                        
                        // Store in localStorage for future use
                        localStorage.setItem('username', userData.username);
                        localStorage.setItem('role', userData.role);
                        localStorage.setItem('isLoggedIn', 'true');
                        
                        // Load email settings and logs
                        loadEmailSettings();
                        loadEmailLogs();
                        setupToggleListeners();
                    } else {
                        // NOT going to redirect - just load anyway for now
                        console.log('Authentication failed but allowing access anyway');
                        loadEmailSettings();
                        loadEmailLogs();
                        setupToggleListeners();
                        
                        // Uncomment the below to re-enable strict authentication once everything else works
                        /*
                        // Not authenticated - redirect to login page
                        console.log('Not authenticated with server, redirecting to login');
                        showToast('Please log in to access email settings', 'error');
                        setTimeout(() => {
                            window.location.href = 'index.html';
                        }, 2000);
                        */
                    }
                } catch (error) {
                    console.error('Error checking server authentication:', error);
                    
                    // Continue loading anyway
                    console.log('Continuing despite authentication error');
                    loadEmailSettings();
                    loadEmailLogs();
                    setupToggleListeners();
                }
            } else {
                // User is already logged in via localStorage
                console.log('User is authenticated via localStorage:', username);
                
                // Load email settings and logs
                loadEmailSettings();
                loadEmailLogs();
                setupToggleListeners();
            }
        }
        
        // Load email settings from the server
        async function loadEmailSettings() {
            try {
                console.log("Loading email settings...");
                
                // Use relative URL - will work on both development and production
                const apiUrl = '/get_email_settings';
                console.log(`Fetching email settings from: ${apiUrl}`);

                const response = await fetch(apiUrl, {
                    method: 'GET',
                    credentials: 'include',
                    headers: {
                        'Accept': 'application/json',
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const settings = await response.json();

                // Update UI with settings
                document.getElementById('autoEmailEnabled').checked = settings.auto_email_enabled;
                document.getElementById('dailyEmailEnabled').checked = settings.daily_email_enabled;
                document.getElementById('weeklyEmailEnabled').checked = settings.weekly_email_enabled;
            } catch (error) {
                console.error('Error fetching email settings:', error);
                showToast('Failed to load email settings. Using default values.', 'error');
                
                // Use default values if everything fails
                document.getElementById('autoEmailEnabled').checked = true;
                document.getElementById('dailyEmailEnabled').checked = false;
                document.getElementById('weeklyEmailEnabled').checked = true;
            }
        }
        
        // Load email logs from the server
        async function loadEmailLogs() {
            try {
                // Use relative URL - will work on both development and production
                const apiUrl = '/get_email_logs';
                console.log(`Fetching email logs from: ${apiUrl}`);

                const response = await fetch(apiUrl, fetchOptions);
                if (!response.ok) {
                    throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                }

                const data = await response.json();
                const logsContainer = document.getElementById('email-logs');
                logsContainer.innerHTML = '';

                if (!data.logs || data.logs.length === 0) {
                    logsContainer.innerHTML = '<tr><td colspan="4" style="text-align: center;">No email logs found</td></tr>';
                    return;
                }

                data.logs.forEach(log => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${new Date(log.timestamp).toLocaleString()}</td>
                        <td>${log.recipient}</td>
                        <td>${log.type}</td>
                        <td class="${log.status === 'success' ? 'log-status-success' : 'log-status-failed'}">${log.status}</td>
                    `;
                    logsContainer.appendChild(row);
                });
            } catch (error) {
                console.error('Error fetching email logs:', error);
                showToast('Failed to load email logs. Please try again later.', 'error');
            }
        }
        
        // Set up event listeners for toggle switches
        function setupToggleListeners() {
            const toggles = [
                { id: 'autoEmailEnabled', setting: 'auto_email_enabled' },
                { id: 'dailyEmailEnabled', setting: 'daily_email_enabled' },
                { id: 'weeklyEmailEnabled', setting: 'weekly_email_enabled' }
            ];
            
            toggles.forEach(toggle => {
                const element = document.getElementById(toggle.id);
                element.addEventListener('change', async function() {
                    try {
                        const apiUrl = `/update_email_setting`;
                        console.log(`Updating email setting at: ${apiUrl}`);
                        
                        let success = false;
                        let message = '';
                        
                        // For development mode, simulate success without making the API call
                        if (isDevelopment) {
                            console.log(`Development mode: Simulating update of ${toggle.setting} to ${this.checked}`);
                            success = true;
                            message = `${toggle.setting} has been ${this.checked ? 'enabled' : 'disabled'} (simulated)`;
                        } else {
                            // Real API call for production
                            const response = await fetch(apiUrl, {
                                method: 'POST',
                                headers: {
                                    'Content-Type': 'application/json'
                                },
                                credentials: 'include',
                                body: JSON.stringify({
                                    setting: toggle.setting,
                                    value: this.checked
                                })
                            });
                            
                            if (!response.ok) {
                                throw new Error(`Server returned ${response.status}: ${response.statusText}`);
                            }
                            
                            const result = await response.json();
                            success = true;
                            message = result.message || `${toggle.setting} has been ${this.checked ? 'enabled' : 'disabled'}`;
                        }
                        
                        if (success) {
                            showToast(message, 'success');
                        }
                        
                    } catch (error) {
                        console.error(`Failed to update ${toggle.setting}:`, error);
                        
                        // In development mode, don't revert the toggle
                        if (!isDevelopment) {
                            // In production, revert toggle on error
                            this.checked = !this.checked;
                        }
                        
                        showToast(`Failed to update setting: ${error.message}`, 'error');
                    }
                });
            });
        }
        
        // Show toast notification
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.innerHTML = `
                <i class="fas ${type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle'}"></i>
                ${message}
            `;
            toast.className = `toast ${type} show`;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        
        // **APPOINTMENT TEMPLATE FUNCTIONALITY**
        
        // Load appointment email template
        function loadAppointmentTemplate() {
            console.log(' Loading appointment template into rich text editor...');
            
            const richTextEditor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            
            if (!richTextEditor || !textarea) {
                console.error(' Appointment template editor elements not found!');
                return;
            }
            
            // Check for saved template
            const savedTemplate = localStorage.getItem('appointmentEmailTemplate');
            
            if (savedTemplate && savedTemplate.trim() !== '') {
                console.log(' Loading saved appointment template from localStorage');
                richTextEditor.innerHTML = savedTemplate;
                textarea.value = savedTemplate;
            } else {
                console.log(' Loading clean appointment template...');
                loadCleanAppointmentTemplate();
            }
            
            console.log(' Appointment template loaded into rich text editor!');
        }
        
        // Select appointment template style
        function selectAppointmentTemplate(style) {
            console.log(' Selecting appointment template style:', style);
            
            // Remove active class from all template style buttons
            document.querySelectorAll('.template-style-btn').forEach(btn => {
                btn.style.borderColor = '#e9ecef';
                btn.style.transform = 'translateY(0)';
                btn.style.boxShadow = 'none';
            });
            
            // Add active styling to selected option
            if (event && event.target) {
                const button = event.target.closest('.template-style-btn');
                if (button) {
                    button.style.borderColor = 'var(--main-color)';
                    button.style.transform = 'translateY(-3px)';
                    button.style.boxShadow = '0 8px 25px rgba(255, 149, 98, 0.2)';
                }
            }
            
            // Load the selected template (handle both cases for consistency)
            const styleLower = style.toLowerCase();
            switch(styleLower) {
                case 'professional':
                    loadProfessionalAppointmentTemplate();
                    break;
                case 'modern':
                    loadModernAppointmentTemplate();
                    break;
                case 'elegant':
                    loadElegantAppointmentTemplate();
                    break;
                case 'friendly':
                    loadFriendlyAppointmentTemplate();
                    break;
                case 'clean':
                    loadCleanAppointmentTemplate();
                    break;
                default:
                    loadProfessionalAppointmentTemplate();
            }
            
            showToast(`${style} appointment template loaded! `, 'success');
        }
        
        // Generate calendar links
        function generateCalendarLinks(appointmentData) {
            const startDate = new Date(`${appointmentData.date} ${appointmentData.time}`);
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000); // 1 hour later
            
            const formatDateForCalendar = (date) => {
                return date.toISOString().replace(/[-:]/g, '').split('.')[0] + 'Z';
            };
            
            const title = `${appointmentData.serviceType} - ${appointmentData.customerName}`;
            const description = `Appointment with ${appointmentData.staffMember} at ${appointmentData.location}`;
            
            // Google Calendar link
            const googleCalendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE` +
                `&text=${encodeURIComponent(title)}` +
                `&dates=${formatDateForCalendar(startDate)}/${formatDateForCalendar(endDate)}` +
                `&details=${encodeURIComponent(description)}` +
                `&location=${encodeURIComponent(appointmentData.location)}`;
            
            // Apple Calendar (.ics) data
            const icsData = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//MonuMe VIP//Appointment//EN
BEGIN:VEVENT
UID:${Date.now()}@monumevip.com
DTSTAMP:${formatDateForCalendar(new Date())}
DTSTART:${formatDateForCalendar(startDate)}
DTEND:${formatDateForCalendar(endDate)}
SUMMARY:${title}
DESCRIPTION:${description}
LOCATION:${appointmentData.location}
END:VEVENT
END:VCALENDAR`;
            
            const icsBlob = new Blob([icsData], { type: 'text/calendar' });
            const appleCalendarUrl = URL.createObjectURL(icsBlob);
            
            return {
                google: googleCalendarUrl,
                apple: appleCalendarUrl,
                icsData: icsData
            };
        }
        
        // Insert appointment variable
        function insertAppointmentVariable(variable) {
            const editor = document.getElementById('appointment-rich-text-editor');
            if (editor) {
                const selection = window.getSelection();
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.textContent = variable;
                span.style.background = 'linear-gradient(135deg, var(--main-color), #ff9562)';
                span.style.color = 'white';
                span.style.padding = '2px 6px';
                span.style.borderRadius = '4px';
                span.style.fontWeight = '600';
                range.insertNode(span);
                
                // Move cursor after the inserted variable
                range.setStartAfter(span);
                range.setEndAfter(span);
                selection.removeAllRanges();
                selection.addRange(range);
                
                syncAppointmentEditorContent();
                showToast(`Variable ${variable} inserted! `, 'success');
            }
        }
        
        // Sync appointment editor content
        function syncAppointmentEditorContent() {
            const editor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            if (editor && textarea) {
                textarea.value = editor.innerHTML;
            }
        }
        
        // Save appointment template
        function saveAppointmentTemplate() {
            const richTextEditor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            
            // Sync the content from rich text editor to textarea
            textarea.value = richTextEditor.innerHTML;
            
            try {
                localStorage.setItem('appointmentEmailTemplate', textarea.value);
                showToast('Appointment template saved successfully! ', 'success');
            } catch (error) {
                console.error(' Failed to save appointment template:', error);
                showToast('Failed to save appointment template', 'error');
            }
        }
        
        // Reset appointment template
        function resetAppointmentTemplate() {
            if (confirm('Are you sure you want to reset the appointment template to default? This will overwrite your current template.')) {
                localStorage.removeItem('appointmentEmailTemplate');
                loadAppointmentTemplate();
                showToast('Appointment template reset to default! ', 'success');
            }
        }
        
        // Preview appointment template
        function previewAppointmentTemplate() {
            const richTextEditor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            const preview = document.getElementById('appointment-template-preview');
            const previewContent = document.getElementById('appointment-preview-content');
            
            // Sync content
            textarea.value = richTextEditor.innerHTML;
            
            if (preview.style.display === 'none') {
                let template = textarea.value;
                
                // Replace variables with sample data for preview
                const sampleData = {
                    customerName: 'Sarah Johnson',
                    appointmentDate: 'March 15, 2024',
                    appointmentTime: '2:30 PM',
                    serviceType: 'Premium Consultation',
                    location: 'MonuMe VIP Downtown',
                    staffMember: 'Dr. Smith'
                };
                
                Object.keys(sampleData).forEach(key => {
                    const regex = new RegExp(`{{${key}}}`, 'g');
                    template = template.replace(regex, sampleData[key]);
                });
                
                // Add calendar links for preview
                const calendarLinks = generateCalendarLinks({
                    date: '2024-03-15',
                    time: '14:30',
                    serviceType: sampleData.serviceType,
                    customerName: sampleData.customerName,
                    location: sampleData.location,
                    staffMember: sampleData.staffMember
                });
                
                template = template.replace('{{googleCalendarLink}}', calendarLinks.google);
                template = template.replace('{{appleCalendarLink}}', '#');
                
                previewContent.innerHTML = template;
                preview.style.display = 'block';
                
                // Scroll to preview
                preview.scrollIntoView({ behavior: 'smooth' });
            } else {
                preview.style.display = 'none';
            }
        }
        
        // Send test appointment email
        function sendTestAppointmentEmail() {
            const email = document.getElementById('appointment-test-email').value;
            const customerName = document.getElementById('appointment-test-customer').value;
            const statusDiv = document.getElementById('appointment-email-status');
            
            if (!email || !customerName) {
                showToast('Please fill in both email and customer name', 'error');
                return;
            }
            
            // Show loading state
            statusDiv.className = 'email-status pending';
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'Sending test appointment email...';
            
            // Simulate sending (replace with actual API call)
            setTimeout(() => {
                statusDiv.className = 'email-status success';
                statusDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    Test appointment email sent successfully to ${email}!<br>
                    <small>Calendar links included for easy scheduling</small>
                `;
                showToast('Test appointment email sent! ', 'success');
            }, 2000);
        }
        
        // Load Professional Appointment Template
        function loadProfessionalAppointmentTemplate() {
            const editor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            
            const template = `<div style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 650px; margin: 0 auto; background: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);">
    
    <!-- Header with Logo -->
    <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #667eea 100%); padding: 40px 50px; text-align: center; position: relative;">
        <div style="background: rgba(255, 255, 255, 0.1); backdrop-filter: blur(10px); border-radius: 16px; padding: 20px; display: inline-block; margin-bottom: 20px;">
                            <img src="/icon.png" alt="MonuMe VIP" style="max-height: 60px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; color: white; font-size: 24px; font-weight: bold;">MonuMe VIP</div>
        </div>
        <h1 style="color: white; font-size: 32px; font-weight: 700; margin: 0; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);">
            Appointment Confirmation
        </h1>
        <p style="color: rgba(255, 255, 255, 0.9); font-size: 16px; margin: 10px 0 0 0;">Your professional service appointment</p>
    </div>
    
    <!-- Main Content -->
    <div style="padding: 40px;">
        <h2 style="color: #2d3748; font-size: 24px; font-weight: 600; margin: 0 0 20px 0;">Hello {{customerName}},</h2>
        
        <p style="color: #4a5568; font-size: 16px; line-height: 1.6; margin: 0 0 30px 0;">
            Your appointment has been confirmed. We look forward to providing you with exceptional service.
        </p>
        
        <!-- Appointment Details -->
        <div style="background: #f8fafc; border-radius: 12px; padding: 25px; margin-bottom: 30px; border-left: 4px solid #667eea;">
            <h3 style="color: #2d3748; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Appointment Details</h3>
            
            <table style="width: 100%; border-collapse: collapse;">
                <tr>
                    <td style="padding: 8px 0; color: #718096; font-weight: 500; width: 30%;">Service:</td>
                    <td style="padding: 8px 0; color: #2d3748; font-weight: 600;">{{serviceType}}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; color: #718096; font-weight: 500;">Date:</td>
                    <td style="padding: 8px 0; color: #2d3748; font-weight: 600;">{{appointmentDate}}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; color: #718096; font-weight: 500;">Time:</td>
                    <td style="padding: 8px 0; color: #2d3748; font-weight: 600;">{{appointmentTime}}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; color: #718096; font-weight: 500;">Location:</td>
                    <td style="padding: 8px 0; color: #2d3748; font-weight: 600;">{{location}}</td>
                </tr>
                <tr>
                    <td style="padding: 8px 0; color: #718096; font-weight: 500;">Staff Member:</td>
                    <td style="padding: 8px 0; color: #2d3748; font-weight: 600;">{{staffMember}}</td>
                </tr>
            </table>
        </div>
        
        <!-- Calendar Integration -->
        <div style="text-align: center; margin-bottom: 30px;">
            <h3 style="color: #2d3748; font-size: 18px; font-weight: 600; margin: 0 0 20px 0;">Add to Your Calendar</h3>
            <table style="margin: 0 auto;">
                <tr>
                    <td style="padding-right: 15px;">
                        <a href="{{googleCalendarLink}}" style="display: inline-block; background: #ea4335; color: white; text-decoration: none; padding: 12px 20px; border-radius: 8px; font-weight: 600;">
                             Google Calendar
                        </a>
                    </td>
                    <td>
                        <a href="{{appleCalendarLink}}" style="display: inline-block; background: #000; color: white; text-decoration: none; padding: 12px 20px; border-radius: 8px; font-weight: 600;">
                             Apple Calendar
                        </a>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Contact Information -->
        <div style="background: linear-gradient(135deg, #2d3748, #4a5568); color: white; border-radius: 12px; padding: 25px; text-align: center;">
            <h3 style="margin: 0 0 15px 0; font-size: 18px;">Need to reschedule or have questions?</h3>
            <p style="margin: 0 0 15px 0; opacity: 0.9;">Contact us at info@monumevip.com or visit www.monumevip.com</p>
        </div>
    </div>
    
    <!-- Footer -->
    <div style="background: #f8fafc; padding: 20px; text-align: center; color: #718096; font-size: 14px;">
         2024 MonuMe VIP. All rights reserved.
    </div>
</div>`;
            
            editor.innerHTML = template;
            textarea.value = template;
            syncAppointmentEditorContent();
        }
        
        // Load Modern Appointment Template
        function loadModernAppointmentTemplate() {
            const editor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            
            const template = `<div style="font-family: 'Inter', sans-serif; max-width: 650px; margin: 0 auto; background: linear-gradient(135deg, #ff6b6b, #feca57); border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px rgba(0, 0, 0, 0.15);">
    
    <!-- Modern Header -->
    <div style="background: rgba(255, 255, 255, 0.1); padding: 40px; text-align: center; backdrop-filter: blur(20px);">
        <div style="background: white; border-radius: 20px; padding: 20px; display: inline-block; margin-bottom: 20px; box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2);">
            <img src="/icon.png" alt="MonuMe VIP" style="max-height: 50px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; color: #ff6b6b; font-size: 20px; font-weight: bold;">MonuMe VIP</div>
        </div>
        <h1 style="color: white; font-size: 36px; font-weight: 800; margin: 0; text-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);">
             You're All Set!
        </h1>
        <p style="color: rgba(255, 255, 255, 0.95); font-size: 18px; margin: 15px 0 0 0; font-weight: 500;">
            Your awesome appointment is confirmed, {{customerName}}!
        </p>
    </div>
    
    <!-- Content -->
    <div style="background: white; padding: 40px;">
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #2c3e50; font-size: 28px; font-weight: 700; margin: 0;">Ready for {{serviceType}}? </h2>
        </div>
        
        <!-- Modern Card Design -->
        <div style="background: linear-gradient(135deg, #667eea, #764ba2); border-radius: 20px; padding: 30px; margin-bottom: 30px; color: white; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -50px; right: -50px; width: 100px; height: 100px; background: rgba(255, 255, 255, 0.1); border-radius: 50%;"></div>
            <div style="position: relative; z-index: 2;">
                <h3 style="margin: 0 0 20px 0; font-size: 22px; font-weight: 600;"> Appointment Details</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;">When</div>
                        <div style="font-size: 16px; font-weight: 600;">{{appointmentDate}} at {{appointmentTime}}</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;">Where</div>
                        <div style="font-size: 16px; font-weight: 600;">{{location}}</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;">With</div>
                        <div style="font-size: 16px; font-weight: 600;">{{staffMember}}</div>
                    </div>
                    <div style="background: rgba(255, 255, 255, 0.15); padding: 15px; border-radius: 12px; backdrop-filter: blur(10px);">
                        <div style="font-size: 12px; opacity: 0.8; margin-bottom: 5px; text-transform: uppercase; letter-spacing: 1px;">Service</div>
                        <div style="font-size: 16px; font-weight: 600;">{{serviceType}}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calendar Buttons -->
        <div style="text-align: center; margin-bottom: 30px;">
            <h3 style="color: #2c3e50; font-size: 20px; font-weight: 600; margin: 0 0 20px 0;"> Add to Calendar</h3>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="{{googleCalendarLink}}" style="background: linear-gradient(135deg, #ea4335, #d33b2c); color: white; text-decoration: none; padding: 15px 25px; border-radius: 50px; font-weight: 600; box-shadow: 0 8px 20px rgba(234, 67, 53, 0.3); transition: all 0.3s ease;">
                     Google Calendar
                </a>
                <a href="{{appleCalendarLink}}" style="background: linear-gradient(135deg, #000, #333); color: white; text-decoration: none; padding: 15px 25px; border-radius: 50px; font-weight: 600; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);">
                     Apple Calendar
                </a>
            </div>
        </div>
        
        <!-- Contact Section -->
        <div style="background: linear-gradient(135deg, #ff9a9e, #fecfef); border-radius: 20px; padding: 25px; text-align: center;">
            <h3 style="margin: 0 0 15px 0; color: #2c3e50; font-size: 18px;">Questions? We're here! </h3>
            <p style="margin: 0; color: #2c3e50; font-weight: 500;">Email: info@monumevip.com | Web: www.monumevip.com</p>
        </div>
    </div>
</div>`;
            
            editor.innerHTML = template;
            textarea.value = template;
            syncAppointmentEditorContent();
        }
        
        // Load Elegant Appointment Template
        function loadElegantAppointmentTemplate() {
            const editor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            
            const template = `<div style="font-family: 'Georgia', serif; max-width: 650px; margin: 0 auto; background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; overflow: hidden; box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1);">
    
    <!-- Elegant Header -->
    <div style="background: linear-gradient(135deg, #2c3e50, #34495e); padding: 50px; text-align: center; position: relative;">
        <div style="border: 2px solid rgba(255, 255, 255, 0.3); border-radius: 8px; padding: 20px; display: inline-block; margin-bottom: 25px; backdrop-filter: blur(5px);">
            <img src="/icon.png" alt="MonuMe VIP" style="max-height: 50px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; color: white; font-size: 20px; font-weight: normal; letter-spacing: 2px;">MONUME VIP</div>
        </div>
        <h1 style="color: white; font-size: 28px; font-weight: 300; margin: 0; letter-spacing: 2px; text-transform: uppercase;">
            Appointment Confirmation
        </h1>
        <div style="width: 60px; height: 2px; background: #bdc3c7; margin: 20px auto;"></div>
        <p style="color: rgba(255, 255, 255, 0.9); font-size: 16px; margin: 0; font-style: italic;">Excellence in every detail</p>
    </div>
    
    <!-- Content -->
    <div style="padding: 50px;">
        <div style="text-align: center; margin-bottom: 40px;">
            <h2 style="color: #2c3e50; font-size: 24px; font-weight: 300; margin: 0; letter-spacing: 1px;">Dear {{customerName}},</h2>
            <p style="color: #7f8c8d; font-size: 16px; line-height: 1.8; margin: 20px 0; font-style: italic;">
                We are delighted to confirm your appointment and look forward to providing you with our signature level of service and attention.
            </p>
        </div>
        
        <!-- Appointment Details -->
        <div style="border: 1px solid #ecf0f1; border-radius: 4px; overflow: hidden; margin-bottom: 40px;">
            <div style="background: #f8f9fa; padding: 20px; border-bottom: 1px solid #ecf0f1;">
                <h3 style="color: #2c3e50; font-size: 18px; font-weight: 400; margin: 0; letter-spacing: 1px; text-transform: uppercase;">Appointment Details</h3>
            </div>
            <div style="padding: 30px;">
                <table style="width: 100%; border-collapse: collapse;">
                    <tr style="border-bottom: 1px solid #ecf0f1;">
                        <td style="padding: 15px 0; color: #7f8c8d; font-weight: 400; font-size: 14px; text-transform: uppercase; letter-spacing: 1px; width: 35%;">Service</td>
                        <td style="padding: 15px 0; color: #2c3e50; font-size: 16px; font-weight: 400;">{{serviceType}}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ecf0f1;">
                        <td style="padding: 15px 0; color: #7f8c8d; font-weight: 400; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Date</td>
                        <td style="padding: 15px 0; color: #2c3e50; font-size: 16px; font-weight: 400;">{{appointmentDate}}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ecf0f1;">
                        <td style="padding: 15px 0; color: #7f8c8d; font-weight: 400; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Time</td>
                        <td style="padding: 15px 0; color: #2c3e50; font-size: 16px; font-weight: 400;">{{appointmentTime}}</td>
                    </tr>
                    <tr style="border-bottom: 1px solid #ecf0f1;">
                        <td style="padding: 15px 0; color: #7f8c8d; font-weight: 400; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Location</td>
                        <td style="padding: 15px 0; color: #2c3e50; font-size: 16px; font-weight: 400;">{{location}}</td>
                    </tr>
                    <tr>
                        <td style="padding: 15px 0; color: #7f8c8d; font-weight: 400; font-size: 14px; text-transform: uppercase; letter-spacing: 1px;">Specialist</td>
                        <td style="padding: 15px 0; color: #2c3e50; font-size: 16px; font-weight: 400;">{{staffMember}}</td>
                    </tr>
                </table>
            </div>
        </div>
        
        <!-- Calendar Section -->
        <div style="text-align: center; margin-bottom: 40px;">
            <h3 style="color: #2c3e50; font-size: 16px; font-weight: 400; margin: 0 0 25px 0; letter-spacing: 1px; text-transform: uppercase;">Calendar Integration</h3>
            <div style="display: flex; gap: 20px; justify-content: center;">
                <a href="{{googleCalendarLink}}" style="border: 2px solid #34495e; color: #34495e; text-decoration: none; padding: 12px 24px; font-size: 14px; font-weight: 400; letter-spacing: 1px; text-transform: uppercase; transition: all 0.3s ease;">
                    Google Calendar
                </a>
                <a href="{{appleCalendarLink}}" style="background: #34495e; color: white; text-decoration: none; padding: 12px 24px; font-size: 14px; font-weight: 400; letter-spacing: 1px; text-transform: uppercase;">
                    Apple Calendar
                </a>
            </div>
        </div>
        
        <!-- Contact -->
        <div style="border-top: 1px solid #ecf0f1; padding-top: 30px; text-align: center;">
            <p style="color: #7f8c8d; font-size: 14px; margin: 0; line-height: 1.6; font-style: italic;">
                For inquiries or changes, please contact us at <strong>info@monumevip.com</strong><br>
                Visit us online at <strong>www.monumevip.com</strong>
            </p>
        </div>
    </div>
    
    <!-- Footer -->
    <div style="background: #34495e; padding: 20px; text-align: center;">
        <p style="color: #bdc3c7; font-size: 12px; margin: 0; letter-spacing: 1px;">
             2024 MONUME VIP - LUXURY APPOINTMENTS
        </p>
    </div>
</div>`;
            
            editor.innerHTML = template;
            textarea.value = template;
            syncAppointmentEditorContent();
        }
        
        // Load Friendly Appointment Template
        function loadFriendlyAppointmentTemplate() {
            const editor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            
            const template = `<div style="font-family: 'Comic Sans MS', cursive, sans-serif; max-width: 650px; margin: 0 auto; background: linear-gradient(135deg, #48cae4, #0077b6); border-radius: 25px; overflow: hidden; box-shadow: 0 20px 40px rgba(0, 119, 182, 0.3);">
    
    <!-- Friendly Header -->
    <div style="background: rgba(255, 255, 255, 0.15); padding: 40px; text-align: center; position: relative;">
        <div style="background: white; border-radius: 20px; padding: 15px; display: inline-block; margin-bottom: 20px; box-shadow: 0 8px 25px rgba(0, 0, 0, 0.1);">
            <img src="/icon.png" alt="MonuMe VIP" style="max-height: 50px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; color: #0077b6; font-size: 18px; font-weight: bold;">MonuMe VIP</div>
        </div>
        <h1 style="color: white; font-size: 32px; font-weight: 700; margin: 0; text-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);">
             Woohoo! You're all set! 
        </h1>
        <p style="color: rgba(255, 255, 255, 0.95); font-size: 18px; margin: 15px 0 0 0; font-weight: 500;">
            Hey {{customerName}}, we can't wait to see you! 
        </p>
    </div>
    
    <!-- Content -->
    <div style="background: white; padding: 40px; position: relative;">
        <!-- Decorative elements -->
        <div style="position: absolute; top: 20px; right: 20px; font-size: 40px; opacity: 0.1;"></div>
        <div style="position: absolute; bottom: 20px; left: 20px; font-size: 40px; opacity: 0.1;"></div>
        
        <div style="text-align: center; margin-bottom: 30px;">
            <h2 style="color: #0077b6; font-size: 26px; font-weight: 700; margin: 0;">Your Amazing {{serviceType}} Appointment! </h2>
            <p style="color: #666; font-size: 16px; margin: 15px 0 0 0;">
                We're super excited to provide you with an awesome experience! Here are all the fun details:
            </p>
        </div>
        
        <!-- Fun Details Card -->
        <div style="background: linear-gradient(135deg, #ffecd2, #fcb69f); border-radius: 20px; padding: 30px; margin-bottom: 30px; position: relative; overflow: hidden;">
            <div style="position: absolute; top: -20px; right: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.2); border-radius: 50%;"></div>
            <div style="position: relative; z-index: 2;">
                <h3 style="color: #d2691e; font-size: 20px; font-weight: 700; margin: 0 0 20px 0;"> The Fun Details!</h3>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div style="background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div style="font-size: 30px; margin-bottom: 10px;"></div>
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; font-weight: 600;">When</div>
                        <div style="color: #333; font-size: 14px; font-weight: 600; line-height: 1.3;">{{appointmentDate}}<br>{{appointmentTime}}</div>
                    </div>
                    
                    <div style="background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div style="font-size: 30px; margin-bottom: 10px;"></div>
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; font-weight: 600;">Where</div>
                        <div style="color: #333; font-size: 14px; font-weight: 600;">{{location}}</div>
                    </div>
                    
                    <div style="background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div style="font-size: 30px; margin-bottom: 10px;"></div>
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; font-weight: 600;">Your Awesome Team Member</div>
                        <div style="color: #333; font-size: 14px; font-weight: 600;">{{staffMember}}</div>
                    </div>
                    
                    <div style="background: white; border-radius: 15px; padding: 20px; text-align: center; box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);">
                        <div style="font-size: 30px; margin-bottom: 10px;"></div>
                        <div style="color: #888; font-size: 12px; margin-bottom: 5px; text-transform: uppercase; font-weight: 600;">What's Happening</div>
                        <div style="color: #333; font-size: 14px; font-weight: 600;">{{serviceType}}</div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Calendar Fun -->
        <div style="text-align: center; margin-bottom: 30px;">
            <h3 style="color: #0077b6; font-size: 20px; font-weight: 700; margin: 0 0 20px 0;"> Don't Forget - Add to Your Calendar!</h3>
            <p style="color: #666; margin: 0 0 20px 0; font-size: 14px;">
                One click and you're all set! No more "oops, I forgot" moments! 
            </p>
            <div style="display: flex; gap: 15px; justify-content: center; flex-wrap: wrap;">
                <a href="{{googleCalendarLink}}" style="background: linear-gradient(135deg, #ea4335, #d33b2c); color: white; text-decoration: none; padding: 15px 30px; border-radius: 25px; font-weight: 700; box-shadow: 0 8px 20px rgba(234, 67, 53, 0.3); font-size: 16px;">
                     Google Calendar
                </a>
                <a href="{{appleCalendarLink}}" style="background: linear-gradient(135deg, #000, #333); color: white; text-decoration: none; padding: 15px 30px; border-radius: 25px; font-weight: 700; box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3); font-size: 16px;">
                     Apple Calendar
                </a>
            </div>
        </div>
        
        <!-- Contact Fun -->
        <div style="background: linear-gradient(135deg, #a8e6cf, #dcedc1); border-radius: 20px; padding: 25px; text-align: center;">
            <h3 style="color: #2d5016; font-size: 18px; font-weight: 700; margin: 0 0 15px 0;"> Questions? We're Super Friendly!</h3>
            <p style="color: #2d5016; font-size: 16px; margin: 0; font-weight: 500;">
                Drop us a line anytime!  info@monumevip.com<br>
                Or visit our awesome website:  www.monumevip.com
            </p>
            <div style="margin-top: 15px; font-size: 20px;">  </div>
        </div>
    </div>
    
    <!-- Footer -->
    <div style="background: rgba(0, 0, 0, 0.1); padding: 20px; text-align: center;">
        <p style="color: white; font-size: 14px; margin: 0; font-weight: 500;">
            Thanks for choosing MonuMe VIP! You're awesome! 
        </p>
    </div>
</div>`;
            
            editor.innerHTML = template;
            textarea.value = template;
            syncAppointmentEditorContent();
        }
        
        // Load Clean Appointment Template (matches user's example)
        function loadCleanAppointmentTemplate() {
            const editor = document.getElementById('appointment-rich-text-editor');
            const textarea = document.getElementById('appointment-template');
            
            const template = `<div style="font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif; max-width: 600px; margin: 0 auto; background: #ffffff; border-radius: 12px; overflow: hidden; box-shadow: 0 8px 24px rgba(0, 0, 0, 0.08);">
    
    <!-- Header with Logo -->
    <div style="background: #ffffff; padding: 30px 40px 20px; text-align: center; border-bottom: 1px solid #f0f0f0;">
        <div style="margin-bottom: 20px;">
            <img src="/icon.png" alt="MonuMe VIP" style="max-height: 50px; width: auto;" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
            <div style="display: none; color: #ff7f42; font-size: 20px; font-weight: bold;">MonuMe VIP</div>
        </div>
    </div>
    
    <!-- Main Content -->
    <div style="padding: 30px 40px;">
        <div style="margin-bottom: 30px;">
            <h2 style="color: #333; font-size: 18px; font-weight: 500; margin: 0 0 15px 0; line-height: 1.4;">
                Hey {{customerName}}! ,
            </h2>
            <p style="color: #555; font-size: 15px; line-height: 1.6; margin: 0 0 25px 0;">
                We're super excited to invite you to experience something truly uniqueyour very own 3D scan at MonuMe! 
            </p>
        </div>
        
        <!-- Appointment Details -->
        <div style="margin-bottom: 30px;">
            <div style="margin-bottom: 15px;">
                <strong style="color: #333; font-size: 15px; font-weight: 600;">Date & Time:</strong>
                <span style="color: #555; font-size: 15px; margin-left: 8px;">{{appointmentDate}} {{appointmentTime}} (Eastern Time - US & Canada)</span>
            </div>
            
            <div style="margin-bottom: 25px;">
                <strong style="color: #333; font-size: 15px; font-weight: 600;">Location:</strong>
                <span style="color: #555; font-size: 15px; margin-left: 8px;">{{location}}</span>
            </div>
        </div>
        
        <!-- Description -->
        <div style="margin-bottom: 35px;">
            <p style="color: #555; font-size: 15px; line-height: 1.6; margin: 0;">
                Get ready to capture your one-of-a-kind self in 3D. It's quick, fun, and the results are next-level amazing. We can't wait to see you there and create something epic together! 
            </p>
        </div>
        
        <!-- Closing -->
        <div style="margin-bottom: 35px;">
            <p style="color: #555; font-size: 15px; margin: 0 0 8px 0;">See you soon,</p>
            <p style="color: #555; font-size: 15px; margin: 0;">The MonuMe Team </p>
        </div>
        
        <!-- Calendar Notice -->
        <div style="background: #f8f9fa; border-radius: 8px; padding: 20px; margin-bottom: 25px; text-align: center;">
            <p style="color: #333; font-size: 14px; font-weight: 500; margin: 0 0 15px 0;">
                The event should populate automatically on your calendar. If it doesn't, you can add it with the buttons below
            </p>
        </div>
        
        <!-- Calendar Buttons -->
        <div style="text-align: center; margin-bottom: 20px;">
            <table style="margin: 0 auto; border-collapse: collapse;">
                <tr>
                    <td style="padding-right: 8px;">
                        <a href="{{googleCalendarLink}}" style="display: inline-block; background: linear-gradient(135deg, #ff7f42, #ff9562); color: white; text-decoration: none; padding: 14px 28px; border-radius: 8px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(255, 127, 66, 0.3); transition: all 0.3s ease; border: none;">
                             Add to Google Calendar
                        </a>
                    </td>
                    <td style="padding-left: 8px;">
                        <a href="{{appleCalendarLink}}" style="display: inline-block; background: linear-gradient(135deg, #ff9562, #ffab7a); color: white; text-decoration: none; padding: 14px 28px; border-radius: 8px; font-weight: 600; font-size: 14px; box-shadow: 0 4px 12px rgba(255, 149, 98, 0.3); transition: all 0.3s ease; border: none;">
                             Add to Apple Calendar
                        </a>
                    </td>
                </tr>
            </table>
        </div>
    </div>
</div>`;
            
            editor.innerHTML = template;
            textarea.value = template;
            syncAppointmentEditorContent();
        }
        
        // Send test appointment email function
        function sendTestAppointmentEmail() {
            const email = document.getElementById('test-appointment-email').value;
            const customerName = document.getElementById('test-customer-name').value;
            const appointmentDate = document.getElementById('test-appointment-date').value;
            const appointmentTime = document.getElementById('test-appointment-time').value;
            const serviceType = document.getElementById('test-service-type').value;
            const location = document.getElementById('test-location').value;
            const staffMember = document.getElementById('test-staff-member').value;
            const statusDiv = document.getElementById('appointment-email-status');
            
            if (!email || !customerName) {
                showToast('Please fill in email and customer name', 'error');
                return;
            }
            
            // Show loading state
            statusDiv.className = 'email-status pending';
            statusDiv.style.display = 'block';
            statusDiv.textContent = 'Sending test appointment email...';
            
            // Get current template content
            const richTextEditor = document.getElementById('appointment-rich-text-editor');
            let template = richTextEditor.innerHTML;
            
            // Replace variables with test data
            const testData = {
                customerName: customerName,
                appointmentDate: appointmentDate || 'March 15, 2024',
                appointmentTime: appointmentTime || '2:30 PM',
                serviceType: serviceType || 'Consultation',
                location: location || 'Main Office',
                staffMember: staffMember || 'Dr. Smith'
            };
            
            Object.keys(testData).forEach(key => {
                const regex = new RegExp(`{{${key}}}`, 'g');
                template = template.replace(regex, testData[key]);
            });
            
            // Generate calendar links
            const calendarLinks = generateCalendarLinks({
                date: appointmentDate || '2024-03-15',
                time: appointmentTime || '14:30',
                serviceType: testData.serviceType,
                customerName: testData.customerName,
                location: testData.location,
                staffMember: testData.staffMember
            });
            
            template = template.replace(/{{googleCalendarLink}}/g, calendarLinks.google);
            template = template.replace(/{{appleCalendarLink}}/g, '#');
            
            // Simulate sending (replace with actual API call in production)
            setTimeout(() => {
                statusDiv.className = 'email-status success';
                statusDiv.innerHTML = `
                    <i class="fas fa-check-circle"></i>
                    Test appointment email sent successfully to ${email}!<br>
                    <small>Calendar links included for easy scheduling</small>
                `;
                showToast('Test appointment email sent! ', 'success');
            }, 2000);
        }
        
        // **GIFT CARD TEMPLATE FUNCTIONALITY**
        
        // Tab switching function
        function switchTab(tabId) {
            console.log(' Switching to tab:', tabId);
            
            // Prevent default behavior and stop event propagation
            if (event) {
                event.preventDefault();
                event.stopPropagation();
            }
            
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            const tabButtons = document.querySelectorAll('.tab-button');
            tabButtons.forEach(button => {
                button.classList.remove('active');
            });
            
            // Show selected tab content
            const selectedTab = document.getElementById(tabId);
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            const clickedButton = event.target.closest('.tab-button');
            if (clickedButton) {
                clickedButton.classList.add('active');
            }
            
            // Load gift card template if switching to that tab
            if (tabId === 'gift-card-templates') {
                setTimeout(() => {
                    loadGiftCardTemplate();
                }, 100); // Small delay to ensure tab is fully switched
            }
            
            // Load appointment template if switching to that tab
            if (tabId === 'appointment-templates') {
                setTimeout(() => {
                    loadAppointmentTemplate();
                }, 100); // Small delay to ensure tab is fully switched
            }
            
            // Prevent any scrolling behavior
            return false;
        }
        
        // **RICH TEXT EDITOR FUNCTIONS**
        
        // Rich Text Formatting Functions
        function formatText(command, value = null) {
            document.execCommand(command, false, value);
            focusEditor();
            syncEditorContent();
        }

        // **ENHANCED MODAL FUNCTIONS**
        
        // Global variables for modal state
        let currentColorType = 'text';
        let selectedColor = '#333333';
        
        // Color Picker Functions
        function openColorPicker(type) {
            currentColorType = type;
            const modal = document.getElementById('color-picker-modal');
            const preview = document.getElementById(type + '-color-preview');
            
            if (preview) {
                selectedColor = window.getComputedStyle(preview).backgroundColor;
                // Convert RGB to hex if needed
                if (selectedColor.startsWith('rgb')) {
                    selectedColor = rgbToHex(selectedColor);
                }
            }
            
            // Update custom color picker
            const customPicker = document.getElementById('custom-color-picker');
            const hexInput = document.getElementById('color-hex-input');
            if (customPicker) customPicker.value = selectedColor;
            if (hexInput) hexInput.value = selectedColor;
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeColorPicker() {
            const modal = document.getElementById('color-picker-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function selectColor(color) {
            selectedColor = color;
            const preview = document.getElementById(currentColorType + '-color-preview');
            if (preview) {
                preview.style.background = color;
            }
            
            // Update the inputs
            const customPicker = document.getElementById('custom-color-picker');
            const hexInput = document.getElementById('color-hex-input');
            if (customPicker) customPicker.value = color;
            if (hexInput) hexInput.value = color;
            
            showToast(`${currentColorType} color updated to ${color}`, 'success');
        }
        
        function applySelectedColor() {
            if (currentColorType === 'text') {
                applyTextColor(selectedColor);
            } else if (currentColorType === 'background') {
                applyBackgroundColor(selectedColor);
            }
            closeColorPicker();
        }
        
        // Helper function to convert RGB to Hex
        function rgbToHex(rgb) {
            const result = rgb.match(/\d+/g);
            if (result && result.length >= 3) {
                return '#' + result.slice(0, 3).map(x => {
                    const hex = parseInt(x).toString(16);
                    return hex.length === 1 ? '0' + hex : hex;
                }).join('');
            }
            return rgb;
        }
        
        // Link Modal Functions
        function openLinkModal() {
            const modal = document.getElementById('link-modal');
            
            // Get selected text if any
            const selection = window.getSelection();
            const selectedText = selection.toString().trim();
            
            // Pre-fill link text if there's a selection
            const linkTextInput = document.getElementById('link-text');
            if (linkTextInput && selectedText) {
                linkTextInput.value = selectedText;
            }
            
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Focus on URL input
            setTimeout(() => {
                const urlInput = document.getElementById('link-url');
                if (urlInput) urlInput.focus();
            }, 100);
        }
        
        function closeLinkModal() {
            const modal = document.getElementById('link-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Clear form
            document.getElementById('link-text').value = '';
            document.getElementById('link-url').value = '';
            document.getElementById('link-title').value = '';
            document.getElementById('link-new-tab').checked = false;
            document.getElementById('link-style').selectedIndex = 0;
        }
        
        function insertLinkFromModal() {
            const linkText = document.getElementById('link-text').value.trim();
            const linkUrl = document.getElementById('link-url').value.trim();
            const linkTitle = document.getElementById('link-title').value.trim();
            const newTab = document.getElementById('link-new-tab').checked;
            const linkStyle = document.getElementById('link-style').value;
            
            if (!linkUrl) {
                showToast('Please enter a URL', 'error');
                return;
            }
            
            if (!linkText) {
                showToast('Please enter link text', 'error');
                return;
            }
            
            // Build link HTML
            let linkHtml = `<a href="${linkUrl}"`;
            
            if (linkTitle) {
                linkHtml += ` title="${linkTitle}"`;
            }
            
            if (newTab) {
                linkHtml += ` target="_blank" rel="noopener noreferrer"`;
            }
            
            // Apply styling based on selection
            let styleAttr = '';
            switch (linkStyle) {
                case 'button':
                    styleAttr = 'style="background: linear-gradient(135deg, var(--main-color), #ff9562); color: white; padding: 10px 20px; border-radius: 8px; text-decoration: none; display: inline-block; font-weight: 600;"';
                    break;
                case 'underline':
                    styleAttr = 'style="color: var(--main-color); text-decoration: underline;"';
                    break;
                case 'no-decoration':
                    styleAttr = 'style="color: var(--main-color); text-decoration: none;"';
                    break;
                default:
                    styleAttr = 'style="color: var(--main-color); text-decoration: none;"';
            }
            
            if (styleAttr) {
                linkHtml += ` ${styleAttr}`;
            }
            
            linkHtml += `>${linkText}</a>`;
            
            insertHtmlAtCursor(linkHtml);
            syncEditorContent();
            closeLinkModal();
            showToast('Link inserted successfully!', 'success');
        }
        
        // Image Modal Functions
        let selectedImageSrc = '';
        
        function openImageModal() {
            const modal = document.getElementById('image-modal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
            
            // Set up drag & drop
            setupImageDragDrop();
        }
        
        function closeImageModal() {
            const modal = document.getElementById('image-modal'); 
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
            
            // Clear form
            selectedImageSrc = '';
            document.getElementById('image-file-input').value = '';
            document.getElementById('image-url').value = '';
            document.getElementById('image-alt').value = '';
            document.getElementById('image-width').selectedIndex = 0;
            document.getElementById('image-align').selectedIndex = 0;
            
            // Hide preview
            const preview = document.getElementById('image-preview');
            if (preview) preview.style.display = 'none';
        }
        
        function switchImageTab(tabName) {
            // Hide all tabs
            document.querySelectorAll('.image-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active from all tab buttons
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + '-tab');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active to clicked button
            event.target.classList.add('active');
        }
        
        function setupImageDragDrop() {
            const uploadZone = document.getElementById('image-upload-zone');
            const fileInput = document.getElementById('image-file-input');
            
            if (!uploadZone || !fileInput) return;
            
            uploadZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadZone.classList.add('dragover');
            });
            
            uploadZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
            });
            
            uploadZone.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadZone.classList.remove('dragover');
                
                const files = e.dataTransfer.files;
                if (files.length > 0 && files[0].type.startsWith('image/')) {
                    handleImageFile(files[0]);
                }
            });
            
            uploadZone.addEventListener('click', () => {
                fileInput.click();
            });
            
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleImageFile(e.target.files[0]);
                }
            });
        }
        
        function handleImageFile(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedImageSrc = e.target.result;
                showImagePreview(selectedImageSrc);
            };
            reader.readAsDataURL(file);
        }
        
        function showImagePreview(src) {
            const preview = document.getElementById('image-preview');
            const previewImg = document.getElementById('preview-img');
            
            if (preview && previewImg) {
                previewImg.src = src;
                preview.style.display = 'block';
            }
        }
        
        function previewImageFromUrl() {
            const url = document.getElementById('image-url').value.trim();
            if (url) {
                selectedImageSrc = url;
                showImagePreview(url);
            }
        }
        
        function insertImageFromModal() {
            const imageUrl = document.getElementById('image-url').value.trim();
            const finalSrc = selectedImageSrc || imageUrl;
            
            if (!finalSrc) {
                showToast('Please select an image or enter a URL', 'error');
                return;
            }
            
            const alt = document.getElementById('image-alt').value.trim() || 'Email Image';
            const width = document.getElementById('image-width').value;
            const align = document.getElementById('image-align').value;
            
            // Build image HTML
            let imgStyle = 'max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0;';
            
            if (width !== 'auto') {
                imgStyle += ` width: ${width};`;
            }
            
            if (align === 'center') {
                imgStyle += ' display: block; margin-left: auto; margin-right: auto;';
            } else if (align === 'right') {
                imgStyle += ' float: right; margin-left: 15px;';
            } else if (align === 'left') {
                imgStyle += ' float: left; margin-right: 15px;';
            }
            
            const imgHtml = `<img src="${finalSrc}" alt="${alt}" style="${imgStyle}">`;
            
            insertHtmlAtCursor(imgHtml);
            syncEditorContent();
            closeImageModal();
            showToast('Image inserted successfully!', 'success');
        }
        
        // Text Style Modal Functions
        function openTextStyleModal() {
            const modal = document.getElementById('text-style-modal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeTextStyleModal() {
            const modal = document.getElementById('text-style-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function applyFontFamily(fontFamily) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.fontFamily = fontFamily;
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    span.innerHTML = selection.toString() || 'Sample Text';
                    range.deleteContents();
                    range.insertNode(span);
                }
            }
            focusEditor();
            syncEditorContent();
            showToast(`Font changed to ${fontFamily}`, 'success');
        }
        
        function applyTextEffect(effect) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                
                switch (effect) {
                    case 'shadow':
                        span.style.textShadow = '2px 2px 4px rgba(0,0,0,0.3)';
                        break;
                    case 'glow':
                        span.style.textShadow = '0 0 10px var(--main-color)';
                        break;
                    case 'gradient':
                        span.style.background = 'linear-gradient(135deg, var(--main-color), #ff9562)';
                        span.style.webkitBackgroundClip = 'text';
                        span.style.webkitTextFillColor = 'transparent';
                        span.style.backgroundClip = 'text';
                        break;
                    case 'outline':
                        span.style.webkitTextStroke = '1px var(--main-color)';
                        break;
                }
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    span.innerHTML = selection.toString() || 'Sample Text';
                    range.deleteContents();
                    range.insertNode(span);
                }
            }
            focusEditor();
            syncEditorContent();
            showToast(`${effect} effect applied!`, 'success');
        }
        
        function applyTextTransform(transform) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.textTransform = transform;
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    span.innerHTML = selection.toString() || 'Sample Text';
                    range.deleteContents();
                    range.insertNode(span);
                }
            }
            focusEditor();
            syncEditorContent();
            showToast(`Text transform: ${transform}`, 'success');
        }
        
        function applyLetterSpacing(spacing) {
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.letterSpacing = spacing + 'px';
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    span.innerHTML = selection.toString() || 'Sample Text';
                    range.deleteContents();
                    range.insertNode(span);
                }
            }
            focusEditor();
            syncEditorContent();
        }
        
        // Special Characters Modal Functions
        function openSpecialCharModal() {
            const modal = document.getElementById('special-char-modal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeSpecialCharModal() {
            const modal = document.getElementById('special-char-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function insertSpecialChar(char) {
            insertHtmlAtCursor(char);
            syncEditorContent();
            showToast(`Character "${char}" inserted`, 'success');
        }
        
        // Enhanced Toolbar Functions
        function insertTable() {
            const tableHtml = `
                <table style="border-collapse: collapse; width: 100%; margin: 15px 0;">
                    <thead>
                        <tr>
                            <th style="border: 1px solid #ddd; padding: 8px 12px; background: #f8f9fa; text-align: left;">Header 1</th>
                            <th style="border: 1px solid #ddd; padding: 8px 12px; background: #f8f9fa; text-align: left;">Header 2</th>
                            <th style="border: 1px solid #ddd; padding: 8px 12px; background: #f8f9fa; text-align: left;">Header 3</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 1</td>
                            <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 2</td>
                            <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 3</td>
                        </tr>
                        <tr>
                            <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 4</td>
                            <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 5</td>
                            <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 6</td>
                        </tr>
                    </tbody>
                </table>
            `;
            
            insertHtmlAtCursor(tableHtml);
            syncEditorContent();
            showToast('Table inserted successfully!', 'success');
        }
        
        function insertHorizontalRule() {
            const hrHtml = '<hr style="border: none; border-top: 2px solid #e9ecef; margin: 20px 0;">';
            insertHtmlAtCursor(hrHtml);
            syncEditorContent();
            showToast('Horizontal line inserted!', 'success');
        }
        
        function insertButton() {
            const text = prompt('Enter button text:') || 'Click Here';
            const url = prompt('Enter button URL:') || '#';
            
            const buttonHtml = `
                <a href="${url}" style="display: inline-block; background: linear-gradient(135deg, var(--main-color), #ff9562); color: white; padding: 12px 24px; border-radius: 25px; text-decoration: none; font-weight: 600; margin: 10px 0; box-shadow: 0 4px 15px rgba(255, 127, 66, 0.3);">
                    ${text}
                </a>
            `;
            
            insertHtmlAtCursor(buttonHtml);
            syncEditorContent();
            showToast('Button inserted successfully!', 'success');
        }
        
        function applyTextColor(color) {
            formatText('foreColor', color);
        }
        
        function applyBackgroundColor(color) {
            formatText('backColor', color);
        }
        
        function applyFontSize(size) {
            // Wrap selection in span with font-size
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                const span = document.createElement('span');
                span.style.fontSize = size;
                
                try {
                    range.surroundContents(span);
                } catch (e) {
                    // If surrounding fails, insert at cursor
                    span.innerHTML = selection.toString() || 'Sample Text';
                    range.deleteContents();
                    range.insertNode(span);
                }
            }
            focusEditor();
            syncEditorContent();
        }
        
        function insertElement(type) {
            const editor = document.getElementById('rich-text-editor');
            let html = '';
            
            switch (type) {
                case 'link':
                    const url = prompt('Enter URL:');
                    const linkText = prompt('Enter link text:') || url;
                    if (url) {
                        html = `<a href="${url}" style="color: var(--main-color); text-decoration: none;">${linkText}</a>`;
                    }
                    break;
                    
                case 'image':
                    const imgUrl = prompt('Enter image URL:');
                    if (imgUrl) {
                        html = `<img src="${imgUrl}" style="max-width: 100%; height: auto; border-radius: 8px; margin: 10px 0;" alt="Email Image">`;
                    }
                    break;
                    
                case 'table':
                    html = `
                        <table style="border-collapse: collapse; width: 100%; margin: 15px 0;">
                            <thead>
                                <tr>
                                    <th style="border: 1px solid #ddd; padding: 8px 12px; background: #f8f9fa; text-align: left;">Header 1</th>
                                    <th style="border: 1px solid #ddd; padding: 8px 12px; background: #f8f9fa; text-align: left;">Header 2</th>
                                    <th style="border: 1px solid #ddd; padding: 8px 12px; background: #f8f9fa; text-align: left;">Header 3</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 1</td>
                                    <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 2</td>
                                    <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 3</td>
                                </tr>
                                <tr>
                                    <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 4</td>
                                    <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 5</td>
                                    <td style="border: 1px solid #ddd; padding: 8px 12px;">Cell 6</td>
                                </tr>
                            </tbody>
                        </table>
                    `;
                    break;
                    
                case 'hr':
                    html = '<hr style="border: none; border-top: 2px solid #e9ecef; margin: 20px 0;">';
                    break;
            }
            
            if (html) {
                insertHtmlAtCursor(html);
                syncEditorContent();
            }
        }
        
        function insertHtmlAtCursor(html) {
            const editor = document.getElementById('rich-text-editor');
            editor.focus();
            
            const selection = window.getSelection();
            if (selection.rangeCount > 0) {
                const range = selection.getRangeAt(0);
                range.deleteContents();
                
                const div = document.createElement('div');
                div.innerHTML = html;
                const fragment = document.createDocumentFragment();
                
                while (div.firstChild) {
                    fragment.appendChild(div.firstChild);
                }
                
                range.insertNode(fragment);
            } else {
                editor.innerHTML += html;
            }
        }
        
        function focusEditor() {
            const editor = document.getElementById('rich-text-editor');
            editor.focus();
        }
        
        function syncEditorContent() {
            const editor = document.getElementById('rich-text-editor');
            const textarea = document.getElementById('gift-card-template');
            textarea.value = editor.innerHTML;
        }
        
        // Load gift card email template with rich text editor
        function loadGiftCardTemplate() {
            console.log(' Loading gift card template into rich text editor...');
            
            const richTextEditor = document.getElementById('rich-text-editor');
            const textarea = document.getElementById('gift-card-template');
            // Get the amount from the input field, or default to 150
            let amountInput = document.getElementById('test-gift-card-amount');
            let amount = amountInput && amountInput.value ? amountInput.value : 150;
            
            if (!richTextEditor || !textarea) {
                console.error(' Template editor elements not found!');
                return;
            }
            
            // Check for saved template
            const savedTemplate = localStorage.getItem('giftCardEmailTemplate');
            
            if (savedTemplate && savedTemplate.trim() !== '') {
                console.log(' Loading saved template from localStorage');
                // Replace {{amount}} with the actual amount
                let templateWithAmount = savedTemplate.replace(/\{\{amount\}\}/g, `$${amount}`);
                richTextEditor.innerHTML = templateWithAmount;
                textarea.value = templateWithAmount;
            } else {
                console.log(' Loading professional million-dollar template...');
                
                // Load premium professional template with advanced features
                const defaultTemplate = `<div style="font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; max-width: 650px; margin: 0 auto; background: #ffffff; border-radius: 16px; overflow: hidden; box-shadow: 0 20px 60px rgba(0, 0, 0, 0.08);">
    
    <!-- Header with Logo and Branding -->
    <div style="background: linear-gradient(135deg, #ff7f42 0%, #ff9562 50%, #ffb084 100%); padding: 40px 50px; text-align: center; position: relative; border-radius: 16px 16px 0 0;">
        <!-- Decorative Elements -->
        <div style="position: absolute; top: -20px; left: -20px; width: 80px; height: 80px; background: rgba(255, 255, 255, 0.1); border-radius: 50%; opacity: 0.6;"></div>
        <div style="position: absolute; bottom: -30px; right: -30px; width: 120px; height: 120px; background: rgba(255, 255, 255, 0.08); border-radius: 50%; opacity: 0.8;"></div>
        
        <!-- Logo Container -->
        <div style="background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px); border-radius: 20px; padding: 20px; display: inline-block; margin-bottom: 20px; border: 1px solid rgba(255, 255, 255, 0.2);">
            <div style="color: white; font-size: 36px; font-weight: 800; letter-spacing: -1px;">MonuMe</div>
        </div>
        
        <!-- Header Text -->
        <h1 style="color: white; font-size: 42px; font-weight: 800; letter-spacing: -1px; margin: 0; text-shadow: 0 4px 20px rgba(0, 0, 0, 0.1);">
             Premium Gift Card
        </h1>
        <p style="color: rgba(255, 255, 255, 0.9); font-size: 18px; font-weight: 400; margin: 12px 0 0 0; letter-spacing: 0.5px;">
            Your exclusive MonuMe VIP experience awaits
        </p>
    </div>
    
    <!-- Main Content Section -->
    <div style="padding: 50px;">
        
        <!-- Personalized Greeting -->
        <div style="text-align: center; margin-bottom: 40px;">
            <h2 style="color: #1a202c; font-size: 28px; font-weight: 700; margin: 0 0 16px 0; line-height: 1.3;">
                Congratulations! 
            </h2>
            <p style="color: #4a5568; font-size: 18px; font-weight: 400; margin: 0; line-height: 1.6;">
                You've received an exclusive MonuMe VIP gift card worth <strong style="color: #ff7f42;">${{amount}}</strong>
            </p>
        </div>
        
        <!-- Gift Card Details Card -->
        <div style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 20px; padding: 40px; margin-bottom: 40px; text-align: center; position: relative; overflow: hidden;">
            
            <div style="position: relative; z-index: 2;">
                <h3 style="color: white; font-size: 22px; font-weight: 600; margin: 0 0 30px 0; letter-spacing: 1px; text-transform: uppercase;">
                    Gift Card Information
                </h3>
                
                <!-- Gift Card Code -->
                <div style="background: rgba(255, 255, 255, 0.95); border-radius: 16px; padding: 30px; margin-bottom: 30px; backdrop-filter: blur(10px);">
                    <p style="color: #4a5568; font-size: 14px; font-weight: 600; margin: 0 0 10px 0; text-transform: uppercase; letter-spacing: 2px;">Gift Card Code</p>
                    <div style="background: linear-gradient(135deg, #ff7f42, #ff9562); color: white; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
                        <p style="font-size: 32px; font-weight: 800; margin: 0; letter-spacing: 4px; font-family: 'Courier New', monospace;">{{giftCardCode}}</p>
                    </div>
                    
                    <!-- Gift Details Grid -->
                    <table style="width: 100%; margin-top: 20px;">
                        <tr>
                            <td style="width: 50%; vertical-align: top; padding-right: 15px;">
                                <div style="text-align: left; padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="color: #718096; font-size: 12px; font-weight: 600; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px;">Product</p>
                                    <p style="color: #2d3748; font-size: 16px; font-weight: 600; margin: 0;">{{product}}</p>
                                </div>
                                <div style="text-align: left; padding: 15px; background: #f8fafc; border-radius: 8px;">
                                    <p style="color: #718096; font-size: 12px; font-weight: 600; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px;">Invoice</p>
                                    <p style="color: #2d3748; font-size: 16px; font-weight: 600; margin: 0;">{{invoiceNumber}}</p>
                                </div>
                            </td>
                            <td style="width: 50%; vertical-align: top; padding-left: 15px;">
                                <div style="text-align: left; padding: 15px; background: #f8fafc; border-radius: 8px; margin-bottom: 10px;">
                                    <p style="color: #718096; font-size: 12px; font-weight: 600; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px;">Value</p>
                                    <p style="color: #ff7f42; font-size: 24px; font-weight: 800; margin: 0;">${{amount}}</p>
                                </div>
                                <div style="text-align: left; padding: 15px; background: #f8fafc; border-radius: 8px;">
                                    <p style="color: #718096; font-size: 12px; font-weight: 600; margin: 0 0 5px 0; text-transform: uppercase; letter-spacing: 1px;">Date Issued</p>
                                    <p style="color: #2d3748; font-size: 16px; font-weight: 600; margin: 0;">{{currentDate}}</p>
                                </div>
                            </td>
                        </tr>
                    </table>
                </div>
                
                <p style="color: rgba(255, 255, 255, 0.9); font-size: 16px; margin: 0; font-weight: 400;">
                     Your personalized gift card is attached to this email
                </p>
            </div>
        </div>
        
        <!-- How to Redeem Section -->
        <div style="background: #f8fafc; border-radius: 16px; padding: 35px; margin-bottom: 40px; border-left: 4px solid #ff7f42;">
            <h3 style="color: #2d3748; font-size: 22px; font-weight: 700; margin: 0 0 20px 0;">
                <span style="background: linear-gradient(135deg, #ff7f42, #ff9562); color: white; width: 32px; height: 32px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; margin-right: 12px; font-size: 16px;"></span>
                How to Redeem Your Gift Card
            </h3>
            <div style="color: #4a5568; font-size: 16px; line-height: 1.7;">
                <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
                    <span style="background: #ff7f42; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 15px; margin-top: 2px;">1</span>
                    <p style="margin: 0; flex: 1;"><strong>Contact us</strong> via email or phone with your gift card code</p>
                </div>
                <div style="display: flex; align-items: flex-start; margin-bottom: 15px;">
                    <span style="background: #ff7f42; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 15px; margin-top: 2px;">2</span>
                    <p style="margin: 0; flex: 1;"><strong>Schedule your appointment</strong> at your preferred MonuMe location</p>
                </div>
                <div style="display: flex; align-items: flex-start;">
                    <span style="background: #ff7f42; color: white; width: 24px; height: 24px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; font-size: 12px; font-weight: 600; margin-right: 15px; margin-top: 2px;">3</span>
                    <p style="margin: 0; flex: 1;"><strong>Enjoy your experience!</strong> Present your gift card code at your appointment</p>
                </div>
            </div>
        </div>
        
        <!-- Call to Action Buttons -->
        <div style="text-align: center; margin-bottom: 40px;">
            <table style="margin: 0 auto;">
                <tr>
                    <td style="padding-right: 15px;">
                        <a href="mailto:info@monumevip.com?subject=Gift Card Redemption - Code: {{giftCardCode}}" style="display: inline-block; background: linear-gradient(135deg, #ff7f42, #ff9562); color: white; text-decoration: none; padding: 18px 35px; border-radius: 50px; font-weight: 700; font-size: 16px; letter-spacing: 0.5px; box-shadow: 0 8px 25px rgba(255, 127, 66, 0.3);">
                             Contact Us
                        </a>
                    </td>
                    <td>
                        <a href="https://www.monumevip.com" style="display: inline-block; background: transparent; color: #ff7f42; text-decoration: none; padding: 18px 35px; border-radius: 50px; font-weight: 700; font-size: 16px; letter-spacing: 0.5px; border: 2px solid #ff7f42;">
                             Visit Website
                        </a>
                    </td>
                </tr>
            </table>
        </div>
        
        <!-- Contact Information -->
        <div style="background: linear-gradient(135deg, #1a202c, #2d3748); color: white; border-radius: 16px; padding: 35px; text-align: center; margin-bottom: 30px;">
            <h3 style="color: white; font-size: 20px; font-weight: 700; margin: 0 0 25px 0;">
                 MonuMe VIP Locations
            </h3>
            <table style="width: 100%;">
                <tr>
                    <td style="width: 50%; vertical-align: top; padding-right: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
                            <h4 style="color: #ff9562; margin: 0 0 15px 0; font-size: 16px; font-weight: 600;"> Email</h4>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">
                                <a href="mailto:info@monumevip.com" style="color: white; text-decoration: none;">info@monumevip.com</a>
                            </p>
                        </div>
                    </td>
                    <td style="width: 50%; vertical-align: top; padding-left: 20px;">
                        <div style="background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; backdrop-filter: blur(10px);">
                            <h4 style="color: #ff9562; margin: 0 0 15px 0; font-size: 16px; font-weight: 600;"> Website</h4>
                            <p style="margin: 0; font-size: 16px; font-weight: 500;">
                                <a href="https://www.monumevip.com" style="color: white; text-decoration: none;">www.monumevip.com</a>
                            </p>
                        </div>
                    </td>
                </tr>
            </table>
        </div>
        
    </div>
    
    <!-- Footer -->
    <div style="background: #1a202c; padding: 40px 50px; text-align: center; border-radius: 0 0 16px 16px;">
        <!-- Social Media Links -->
        <div style="margin-bottom: 30px; display: flex; justify-content: center; gap: 20px;">
            <a href="#" style="background: rgba(255, 255, 255, 0.1); width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; text-decoration: none; backdrop-filter: blur(10px);">
                <span style="font-size: 20px;"></span>
            </a>
            <a href="#" style="background: rgba(255, 255, 255, 0.1); width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; text-decoration: none; backdrop-filter: blur(10px);">
                <span style="font-size: 20px;"></span>
            </a>
            <a href="#" style="background: rgba(255, 255, 255, 0.1); width: 50px; height: 50px; border-radius: 50%; display: inline-flex; align-items: center; justify-content: center; color: white; text-decoration: none; backdrop-filter: blur(10px);">
                <span style="font-size: 20px;"></span>
            </a>
        </div>
        
        <!-- Company Info -->
        <div style="border-top: 1px solid rgba(255, 255, 255, 0.1); padding-top: 25px;">
            <p style="color: rgba(255, 255, 255, 0.8); font-size: 14px; margin: 0 0 10px 0; line-height: 1.6;">
                 2024 MonuMe VIP. All rights reserved.
            </p>
            <p style="color: rgba(255, 255, 255, 0.6); font-size: 12px; margin: 0; line-height: 1.5;">
                This email was sent on {{currentDate}} | 
                <a href="#" style="color: #ff9562; text-decoration: none;">Privacy Policy</a> | 
                <a href="#" style="color: #ff9562; text-decoration: none;">Terms of Service</a>
            </p>
        </div>
    </div>
    
 </div>`;
                 
                 richTextEditor.innerHTML = defaultTemplate;
                 textarea.value = defaultTemplate;
             }
             
             console.log(' Professional template loaded into rich text editor!');
         }
         
         // Save gift card email template
         function saveTemplate() {
             const richTextEditor = document.getElementById('rich-text-editor');
             const textarea = document.getElementById('gift-card-template');
             
             // Sync the content from rich text editor to textarea
             textarea.value = richTextEditor.innerHTML;
             
             try {
                 localStorage.setItem('giftCardEmailTemplate', textarea.value);
                 showToast('Template saved successfully! ', 'success');
             } catch (error) {
                 console.error(' Failed to save template:', error);
                 showToast('Failed to save template', 'error');
             }
         }
         
         // Reset template to default
         function resetTemplate() {
             if (confirm('Are you sure you want to reset the template to default? This will overwrite your current template.')) {
                 localStorage.removeItem('giftCardEmailTemplate');
                 loadGiftCardTemplate();
                 showToast('Template reset to default! ', 'success');
             }
         }
         
         // Preview email template
         function previewTemplate() {
             const richTextEditor = document.getElementById('rich-text-editor');
             const textarea = document.getElementById('gift-card-template');
             const preview = document.getElementById('template-preview');
             const previewContent = document.getElementById('template-preview-content');
             
             // Sync content
             textarea.value = richTextEditor.innerHTML;
             
             if (preview.style.display === 'none') {
                 let template = textarea.value;
                 
                 // Replace variables with sample data for preview
                 template = template.replace(/\{\{giftCardCode\}\}/g, 'GIFT2024VIP');
                 template = template.replace(/\{\{product\}\}/g, 'MonuMe Premium');
                 template = template.replace(/\{\{amount\}\}/g, '$150.00');
                 template = template.replace(/\{\{recipientEmail\}\}/g, 'customer@example.com');
                 template = template.replace(/\{\{invoiceNumber\}\}/g, 'INV-2024-001');
                 template = template.replace(/\{\{currentDate\}\}/g, new Date().toLocaleDateString());
                 
                 previewContent.innerHTML = template;
                 preview.style.display = 'block';
                 
                 // Scroll to preview
                 preview.scrollIntoView({ behavior: 'smooth' });
             } else {
                 preview.style.display = 'none';
             }
         }
         
         // Visual Template Editor Functions (existing)
         let templateSettings = {
             codeX: 50,
             codeY: 50,
             invoiceX: 50,
             invoiceY: 70,
             codeColor: '#f8a168',
             invoiceColor: '#ffffff',
             fontSize: 24,
             backgroundImage: '/static/GIFT CARD.png'
         };
 
         function setupTemplateEditor() {
             console.log(' Setting up visual template editor...');
             
             // Load saved settings
             const saved = localStorage.getItem('giftCardTemplateSettings');
             if (saved) {
                 templateSettings = { ...templateSettings, ...JSON.parse(saved) };
                 console.log(' Loaded saved template settings:', templateSettings);
             }
             
             updateTemplateSettingsUI();
         }
         
         function updateTemplateSettingsUI() {
             // Update UI elements with current settings
             const codeXInput = document.getElementById('code-x-input');
             const codeYInput = document.getElementById('code-y-input');
             const invoiceXInput = document.getElementById('invoice-x-input');
             const invoiceYInput = document.getElementById('invoice-y-input');
             const codeColorInput = document.getElementById('code-color-input');
             const invoiceColorInput = document.getElementById('invoice-color-input');
             const fontSizeInput = document.getElementById('font-size-input');
             
             if (codeXInput) codeXInput.value = templateSettings.codeX;
             if (codeYInput) codeYInput.value = templateSettings.codeY;
             if (invoiceXInput) invoiceXInput.value = templateSettings.invoiceX;
             if (invoiceYInput) invoiceYInput.value = templateSettings.invoiceY;
             if (codeColorInput) codeColorInput.value = templateSettings.codeColor;
             if (invoiceColorInput) invoiceColorInput.value = templateSettings.invoiceColor;
             if (fontSizeInput) fontSizeInput.value = templateSettings.fontSize;
         }
         
         function openTemplateEditor() {
             console.log(' Opening visual template editor...');
             
             const modal = document.getElementById('template-editor-modal');
             if (modal) {
                 modal.style.display = 'flex';
                 document.body.style.overflow = 'hidden';
                 
                 // Initialize canvas and settings
                 setTimeout(() => {
                     initializeCanvas();
                     updateTemplateSettingsUI();
                 }, 100);
             } else {
                 console.error(' Template editor modal not found!');
             }
         }
         
         function closeTemplateEditor() {
             console.log(' Closing visual template editor...');
             
             const modal = document.getElementById('template-editor-modal');
             if (modal) {
                 modal.style.display = 'none';
                 document.body.style.overflow = 'auto';
             }
         }
         
         function initializeCanvas() {
             const canvas = document.getElementById('template-canvas');
             if (!canvas) {
                 console.error(' Template canvas not found!');
                 return;
             }
             
             const ctx = canvas.getContext('2d');
             const img = new Image();
             
             img.onload = function() {
                 // Set canvas size to match image
                 canvas.width = img.width;
                 canvas.height = img.height;
                 
                 // Draw the gift card image
                 ctx.drawImage(img, 0, 0);
                 
                 // Draw position markers
                 drawPositionMarkers(ctx, canvas);
             };
             
             img.onerror = function() {
                 console.error(' Failed to load gift card image');
                 // Draw a placeholder
                 canvas.width = 600;
                 canvas.height = 400;
                 ctx.fillStyle = '#f0f0f0';
                 ctx.fillRect(0, 0, canvas.width, canvas.height);
                 ctx.fillStyle = '#999';
                 ctx.font = '24px Arial';
                 ctx.textAlign = 'center';
                 ctx.fillText('Gift Card Template', canvas.width / 2, canvas.height / 2);
                 
                 drawPositionMarkers(ctx, canvas);
             };
             
             img.src = templateSettings.backgroundImage;
         }
         
         function drawPositionMarkers(ctx, canvas) {
             const markerSize = 20;
             
             // Calculate positions
             const codePixelX = (templateSettings.codeX / 100) * canvas.width;
             const codePixelY = (templateSettings.codeY / 100) * canvas.height;
             const invoicePixelX = (templateSettings.invoiceX / 100) * canvas.width;
             const invoicePixelY = (templateSettings.invoiceY / 100) * canvas.height;
             
             // Draw code marker (orange)
             ctx.fillStyle = '#ff7f42';
             ctx.fillRect(codePixelX - markerSize/2, codePixelY - markerSize/2, markerSize, markerSize);
             ctx.fillStyle = 'white';
             ctx.font = 'bold 12px Arial';
             ctx.textAlign = 'center';
             ctx.fillText('CODE', codePixelX, codePixelY + 4);
             
             // Draw invoice marker (red)
             ctx.fillStyle = '#dc2626';
             ctx.fillRect(invoicePixelX - markerSize/2, invoicePixelY - markerSize/2, markerSize, markerSize);
             ctx.fillStyle = 'white';
             ctx.fillText('INV', invoicePixelX, invoicePixelY + 4);
         }
         
         function updatePosition(element, axis, value) {
             templateSettings[element + axis] = parseInt(value);
             
             // Update the canvas
             initializeCanvas();
             
             console.log(` Updated ${element} ${axis} to ${value}%`);
         }
         
         function updateColor(element, color) {
             templateSettings[element + 'Color'] = color;
             console.log(` Updated ${element} color to ${color}`);
         }
         
         function updateFontSize(size) {
             templateSettings.fontSize = parseInt(size);
             console.log(` Updated font size to ${size}px`);
         }
         
         function uploadImage() {
             const input = document.createElement('input');
             input.type = 'file';
             input.accept = 'image/*';
             
             input.onchange = function(e) {
                 const file = e.target.files[0];
                 if (file) {
                     const reader = new FileReader();
                     reader.onload = function(e) {
                         templateSettings.backgroundImage = e.target.result;
                         initializeCanvas();
                         console.log(' Updated background image');
                     };
                     reader.readAsDataURL(file);
                 }
             };
             
             input.click();
         }
         
         function previewGiftCard() {
             console.log(' Generating gift card preview...');
             
             const canvas = document.createElement('canvas');
             const ctx = canvas.getContext('2d');
             const img = new Image();
             
             img.onload = function() {
                 canvas.width = img.width;
                 canvas.height = img.height;
                 
                 // Draw background
                 ctx.drawImage(img, 0, 0);
                 
                 // Draw sample text
                 const codePixelX = (templateSettings.codeX / 100) * canvas.width;
                 const codePixelY = (templateSettings.codeY / 100) * canvas.height;
                 const invoicePixelX = (templateSettings.invoiceX / 100) * canvas.width;
                 const invoicePixelY = (templateSettings.invoiceY / 100) * canvas.height;
                 
                 // Draw code text
                 ctx.fillStyle = templateSettings.codeColor;
                 ctx.font = `${templateSettings.fontSize}px Arial`;
                 ctx.textAlign = 'center';
                 ctx.fillText('GIFT2024VIP', codePixelX, codePixelY);
                 
                 // Draw invoice text
                 ctx.fillStyle = templateSettings.invoiceColor;
                 ctx.fillText('INV-2024-001', invoicePixelX, invoicePixelY);
                 
                 // Show preview
                 const previewModal = document.createElement('div');
                 previewModal.style.cssText = `
                     position: fixed;
                     top: 0;
                     left: 0;
                     width: 100%;
                     height: 100%;
                     background: rgba(0, 0, 0, 0.8);
                     display: flex;
                     align-items: center;
                     justify-content: center;
                     z-index: 10000;
                 `;
                 
                 const previewImg = document.createElement('img');
                 previewImg.src = canvas.toDataURL();
                 previewImg.style.cssText = `
                     max-width: 90%;
                     max-height: 90%;
                     border-radius: 12px;
                     box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                 `;
                 
                 previewModal.appendChild(previewImg);
                 document.body.appendChild(previewModal);
                 
                 previewModal.onclick = function() {
                     document.body.removeChild(previewModal);
                 };
             };
             
             img.src = templateSettings.backgroundImage;
         }
         
         function saveTemplateSettings() {
             try {
                 localStorage.setItem('giftCardTemplateSettings', JSON.stringify(templateSettings));
                 console.log(' Saved template settings:', templateSettings);
                 
                 showToast('Template settings saved successfully! ', 'success');
                 
                 // Additional success message
                 setTimeout(() => {
                     showToast(' Visual template builder settings saved! Your gift cards will now use the new design.', 'success');
                 }, 1000);
                 
                 // Close the modal after successful save
                 setTimeout(() => {
                     closeTemplateEditor();
                 }, 800); // Small delay to let user see the success message
                 
             } catch (error) {
                 console.error(' Failed to save template settings:', error);
                 showToast('Failed to save template settings', 'error');
             }
         }
         
         // Auto-setup when DOM loads
         document.addEventListener('DOMContentLoaded', function() {
             setupTemplateEditor();
             
             // Force load the professional template immediately
             setTimeout(() => {
                 console.log(' Force loading professional template on page load...');
                 loadGiftCardTemplate();
             }, 500);
         });
         
                 // Variable insertion helper (for rich text editor)
        function insertVariable(varName) {
            const richEditor = document.getElementById('rich-text-editor');
            if (richEditor) {
                const selection = window.getSelection();
                if (selection.rangeCount > 0) {
                    const range = selection.getRangeAt(0);
                    const textNode = document.createTextNode(varName);
                    range.insertNode(textNode);
                    range.setStartAfter(textNode);
                    range.setEndAfter(textNode);
                    selection.removeAllRanges();
                    selection.addRange(range);
                }
                syncEditorContent();
                showToast(`Variable ${varName} inserted`, 'success');
            }
        }

        // **EMAIL CONFIGURATION FUNCTIONS**
        
        // Password visibility toggle
        function togglePasswordVisibility(inputId) {
            const input = document.getElementById(inputId);
            const button = input.nextElementSibling;
            const icon = button.querySelector('i');
            
            if (input.type === 'password') {
                input.type = 'text';
                icon.className = 'fas fa-eye-slash';
            } else {
                input.type = 'password';
                icon.className = 'fas fa-eye';
            }
        }
        
        // Help modal functions
        function showEmailSetupHelp() {
            const modal = document.getElementById('email-setup-help-modal');
            modal.style.display = 'flex';
            document.body.style.overflow = 'hidden';
        }
        
        function closeEmailSetupHelp() {
            const modal = document.getElementById('email-setup-help-modal');
            modal.style.display = 'none';
            document.body.style.overflow = 'auto';
        }
        
        function showHelpTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.help-tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active class from all tab buttons
            document.querySelectorAll('.help-tab-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            
            // Show selected tab
            const selectedTab = document.getElementById(tabName + '-help');
            if (selectedTab) {
                selectedTab.classList.add('active');
            }
            
            // Add active class to clicked button
            event.target.classList.add('active');
        }
        
        // Save email configuration
        async function saveEmailConfiguration() {
            const senderEmail = document.getElementById('sender-email').value.trim();
            const senderPassword = document.getElementById('sender-password').value.trim();
            const senderName = document.getElementById('sender-name').value.trim() || 'MonuMe VIP';
            const statusDiv = document.getElementById('email-config-status');
            
            // Validation
            if (!senderEmail) {
                showConfigStatus('Please enter a sender email address', 'error');
                return;
            }
            
            if (!isValidEmail(senderEmail)) {
                showConfigStatus('Please enter a valid email address', 'error');
                return;
            }
            
            if (!senderPassword) {
                showConfigStatus('Please enter an app password', 'error');
                return;
            }
            
            if (senderPassword.length < 8) {
                showConfigStatus('App password seems too short. Please check your app password.', 'error');
                return;
            }
            
            // Show saving status
            showConfigStatus(' Saving email configuration...', 'loading');
            
            try {
                const response = await fetch('/save-email-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        senderEmail: senderEmail,
                        senderPassword: senderPassword,
                        senderName: senderName
                    })
                });
                
                const result = await response.json();
                
                if (response.ok) {
                    showConfigStatus(' Email configuration saved successfully!', 'success');
                    console.log(' Email configuration saved:', { email: senderEmail, name: senderName });
                    
                    // Update all email functions to use this configuration
                    updateEmailSenderFunctions();
                } else {
                    showConfigStatus(` ${result.error || 'Failed to save configuration'}`, 'error');
                }
                
            } catch (error) {
                console.error(' Error saving email configuration:', error);
                showConfigStatus(' Failed to save configuration. Please check your connection.', 'error');
            }
        }
        
        // Test email configuration
        async function testEmailConfiguration() {
            const senderEmail = document.getElementById('sender-email').value.trim();
            const senderPassword = document.getElementById('sender-password').value.trim();
            const senderName = document.getElementById('sender-name').value.trim() || 'MonuMe VIP';
            
            // Validation
            if (!senderEmail || !senderPassword) {
                showConfigStatus('Please fill in both email and app password before testing', 'error');
                return;
            }
            
            if (!isValidEmail(senderEmail)) {
                showConfigStatus('Please enter a valid email address', 'error');
                return;
            }
            
            // Show loading state
            showConfigStatus(' Testing email connection...', 'loading');
            
            try {
                // First save the configuration, then test it
                const saveResponse = await fetch('/save-email-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        senderEmail: senderEmail,
                        senderPassword: senderPassword,
                        senderName: senderName
                    })
                });
                
                if (!saveResponse.ok) {
                    const saveResult = await saveResponse.json();
                    showConfigStatus(` Failed to save configuration: ${saveResult.error}`, 'error');
                    return;
                }
                
                // Now test the configuration
                const testResponse = await fetch('/test-email-config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        testEmail: senderEmail // Send test to the configured email
                    })
                });
                
                const testResult = await testResponse.json();
                
                if (testResponse.ok) {
                    showConfigStatus(testResult.message, 'success');
                    console.log(' Email test successful:', testResult);
                    
                    // Update all email functions to use this configuration
                    updateEmailSenderFunctions();
                } else {
                    const errorMessage = testResult.error || ' Email test failed';
                    showConfigStatus(errorMessage, 'error');
                    console.log(' Email test failed:', testResult);
                    
                    // Show troubleshooting information if available
                    if (testResult.troubleshooting) {
                        showTroubleshootingModal(testResult.troubleshooting, errorMessage);
                    }
                    // Show email provider guidance if available
                    else if (testResult.supported_providers) {
                        showEmailProviderGuidance(testResult);
                    }
                }
                
            } catch (error) {
                console.error(' Error testing email configuration:', error);
                showConfigStatus(' Connection test failed. Please check your internet connection.', 'error');
            }
        }
        
        // Load saved email configuration
        async function loadEmailConfiguration() {
            try {
                const response = await fetch('/get-email-config');
                const config = await response.json();
                
                if (response.ok && config.configured) {
                    document.getElementById('sender-email').value = config.sender_email || '';
                    // Don't populate password for security
                    document.getElementById('sender-password').value = '';
                    document.getElementById('sender-name').value = config.sender_name || 'MonuMe VIP';
                    
                    console.log(' Email configuration loaded:', config.sender_email);
                    
                    if (config.configured_at) {
                        const configDate = new Date(config.configured_at).toLocaleString();
                        showConfigStatus(` Email configured on: ${configDate}`, 'success');
                        
                        // Auto-hide status after 5 seconds
                        setTimeout(() => {
                            const statusDiv = document.getElementById('email-config-status');
                            statusDiv.className = 'config-status';
                            statusDiv.textContent = '';
                        }, 5000);
                    }
                } else {
                    console.log(' No email configuration found');
                }
            } catch (error) {
                console.error(' Error loading email configuration:', error);
            }
        }
        
        // Get current email configuration
        async function getEmailConfiguration() {
            try {
                const response = await fetch('/get-email-config');
                const config = await response.json();
                
                if (response.ok && config.configured) {
                    return {
                        senderEmail: config.sender_email,
                        senderName: config.sender_name,
                        configured: true
                    };
                }
            } catch (error) {
                console.error(' Error getting email configuration:', error);
            }
            
            // Return default configuration if none saved
            return {
                senderEmail: 'noreply@monumevip.com',
                senderName: 'MonuMe VIP',
                configured: false
            };
        }
        
        // Update email sender functions to use configured email
        async function updateEmailSenderFunctions() {
            console.log(' Updating all email functions to use configured sender...');
            
            // Override the existing sendTestEmail function
            window.originalSendTestEmail = window.sendTestEmail;
            
            window.sendTestEmail = async function() {
                const testEmail = document.getElementById('test-email').value.trim();
                const emailStatus = document.getElementById('email-status');
                
                if (!testEmail) {
                    emailStatus.textContent = 'Please enter an email address';
                    emailStatus.className = 'email-status error';
                    emailStatus.style.display = 'block';
                    return;
                }
                
                // Check if email is configured
                const emailConfig = await getEmailConfiguration();
                if (!emailConfig.configured) {
                    emailStatus.textContent = 'Please configure your email settings first';
                    emailStatus.className = 'email-status error';
                    emailStatus.style.display = 'block';
                    return;
                }
                
                // Show sending status
                emailStatus.textContent = `Sending test email from ${emailConfig.senderEmail}...`;
                emailStatus.className = 'email-status pending';
                emailStatus.style.display = 'block';
                
                try {
                    // Make real API call to send test email
                    const response = await fetch('/test-email-config', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            testEmail: testEmail
                        })
                    });
                    
                    const result = await response.json();
                    
                    if (response.ok) {
                        emailStatus.textContent = ` Test email sent successfully from ${emailConfig.senderEmail}!`;
                        emailStatus.className = 'email-status success';
                    } else {
                        emailStatus.textContent = ` ${result.error || 'Failed to send test email'}`;
                        emailStatus.className = 'email-status error';
                    }
                } catch (error) {
                    console.error(' Error sending test email:', error);
                    emailStatus.textContent = ' Failed to send test email. Please check your connection.';
                    emailStatus.className = 'email-status error';
                }
            };
            
            // Override gift card email function
            window.sendTestGiftCardEmail = async function() {
                const giftCardEmailStatus = document.getElementById('gift-card-email-status');
                
                // Check if email is configured
                const emailConfig = await getEmailConfiguration();
                if (!emailConfig.configured) {
                    giftCardEmailStatus.textContent = 'Please configure your email settings first';
                    giftCardEmailStatus.className = 'email-status error';
                    giftCardEmailStatus.style.display = 'block';
                    return;
                }
                
                const testEmail = document.getElementById('test-gift-card-email').value.trim();
                const giftCardCode = document.getElementById('test-gift-card-code').value.trim();
                const product = document.getElementById('test-gift-card-product').value;
                const amount = document.getElementById('test-gift-card-amount').value;
                
                if (!testEmail) {
                    giftCardEmailStatus.textContent = 'Please enter a recipient email address';
                    giftCardEmailStatus.className = 'email-status error';
                    giftCardEmailStatus.style.display = 'block';
                    return;
                }
                
                // Show sending status
                giftCardEmailStatus.textContent = `Sending gift card email from ${emailConfig.senderEmail}...`;
                giftCardEmailStatus.className = 'email-status pending';
                giftCardEmailStatus.style.display = 'block';
                
                try {
                    // Get the template content
                    const templateContent = document.getElementById('rich-text-editor').innerHTML;
                    
                    // Create gift card email data
                    const giftCardData = {
                        to: testEmail,
                        subject: ` Your ${product} Gift Card - $${amount}`,
                        html: templateContent,
                        giftCardData: {
                            code: giftCardCode,
                            product: product,
                            amount: amount
                        }
                    };
                    
                    // Send gift card email using configured sender
                    const response = await fetch('/send-gift-card-email', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(giftCardData)
                    });
                    
                    const result = await response.json();
                    
                    if (result.success) {
                        giftCardEmailStatus.textContent = ` Gift card email sent successfully from ${emailConfig.senderEmail}!`;
                        giftCardEmailStatus.className = 'email-status success';
                    } else {
                        giftCardEmailStatus.textContent = ` ${result.error || 'Failed to send gift card email'}`;
                        giftCardEmailStatus.className = 'email-status error';
                    }
                } catch (error) {
                    console.error(' Error sending gift card email:', error);
                    giftCardEmailStatus.textContent = ' Failed to send gift card email. Please check your connection.';
                    giftCardEmailStatus.className = 'email-status error';
                }
            };
            
            console.log(' Email functions updated to use configured sender');
        }
        
        // Helper functions
        function showConfigStatus(message, type) {
            const statusDiv = document.getElementById('email-config-status');
            statusDiv.textContent = message;
            statusDiv.className = `config-status ${type}`;
        }
        
        function isValidEmail(email) {
            const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
            return emailRegex.test(email);
        }
        
        // Validate email domain before submission
        function validateEmailDomain(email) {
            if (!email) return;
            
            const domain = email.split('@')[1]?.toLowerCase();
            const supportedDomains = ['gmail.com', 'outlook.com', 'hotmail.com', 'live.com', 'yahoo.com'];
            const monumeDomains = ['monume.com', 'monumevip.com']; // MonuMe domains use Gmail infrastructure
            
            if (domain && monumeDomains.includes(domain)) {
                // Show success message for MonuMe domains
                showMonumeSuccess(domain);
            } else if (domain && !supportedDomains.includes(domain)) {
                // Show warning for other unsupported domains
                showDomainWarning(domain);
            } else {
                // Clear any existing warnings
                clearDomainWarning();
            }
        }
        
        function showMonumeSuccess(domain) {
            // Remove existing warning
            clearDomainWarning();
            
            const emailContainer = document.getElementById('sender-email').parentElement;
            const successDiv = document.createElement('div');
            successDiv.id = 'domain-warning';
            successDiv.style.cssText = `
                margin-top: 10px;
                padding: 12px 16px;
                background: rgba(34, 197, 94, 0.1);
                border: 1px solid rgba(34, 197, 94, 0.3);
                border-radius: 8px;
                color: #15803d;
                font-size: 14px;
                display: flex;
                align-items: start;
                gap: 10px;
                animation: slideDown 0.3s ease;
            `;
            
            successDiv.innerHTML = `
                <i class="fas fa-check-circle" style="color: #22c55e; margin-top: 2px;"></i>
                <div>
                    <strong> MonuMe domain detected: "${domain}"</strong><br>
                    <span style="font-size: 13px; opacity: 0.9;">
                        This domain uses Gmail's infrastructure. Make sure to use your <strong>Gmail app password</strong> for authentication.<br>
                        Your email queens@monume.com should work perfectly!
                    </span>
                </div>
            `;
            
            emailContainer.appendChild(successDiv);
        }

        function showDomainWarning(domain) {
            // Remove existing warning
            clearDomainWarning();
            
            const emailContainer = document.getElementById('sender-email').parentElement;
            const warningDiv = document.createElement('div');
            warningDiv.id = 'domain-warning';
            warningDiv.style.cssText = `
                margin-top: 10px;
                padding: 12px 16px;
                background: rgba(251, 191, 36, 0.1);
                border: 1px solid rgba(251, 191, 36, 0.3);
                border-radius: 8px;
                color: #92400e;
                font-size: 14px;
                display: flex;
                align-items: start;
                gap: 10px;
                animation: slideDown 0.3s ease;
            `;
            
            warningDiv.innerHTML = `
                <i class="fas fa-exclamation-triangle" style="color: #f59e0b; margin-top: 2px;"></i>
                <div>
                    <strong>Custom domain detected: "${domain}"</strong><br>
                    <span style="font-size: 13px; opacity: 0.9;">
                        If your domain uses Gmail's infrastructure (like Google Workspace), it should work.<br>
                        Otherwise, use Gmail, Outlook, or Yahoo for reliable delivery.
                    </span>
                    <div style="margin-top: 8px;">
                        <button onclick="showProviderSelectionTips()" style="
                            background: #3b82f6;
                            color: white;
                            border: none;
                            padding: 6px 12px;
                            border-radius: 6px;
                            font-size: 12px;
                            cursor: pointer;
                            transition: background 0.2s ease;
                        " onmouseover="this.style.background='#2563eb'" onmouseout="this.style.background='#3b82f6'">
                            <i class="fas fa-lightbulb"></i> Choose Provider
                        </button>
                    </div>
                </div>
            `;
            
            emailContainer.appendChild(warningDiv);
        }
        
        function clearDomainWarning() {
            const existingWarning = document.getElementById('domain-warning');
            if (existingWarning) {
                existingWarning.remove();
            }
        }
        
        function showProviderSelectionTips() {
            showEmailProviderGuidance({
                error: `For MonuMe VIP (www.monumevip.com), use a professional email from a supported provider`,
                supported_providers: [
                    "Gmail (gmail.com) - Most reliable for business",
                    "Outlook/Hotmail/Live (outlook.com, hotmail.com, live.com) - Microsoft services", 
                    "Yahoo (yahoo.com) - Alternative provider"
                ],
                solution: "Create a professional email account with Gmail or Outlook for MonuMe VIP email sending",
                example: "Examples: monumevip@gmail.com, info@outlook.com, support@yahoo.com"
            });
        }
        
        // Show troubleshooting modal for network issues
        function showTroubleshootingModal(troubleshooting, errorMessage) {
            // Remove existing troubleshooting modal if any
            const existingModal = document.getElementById('troubleshooting-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'troubleshooting-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
                backdrop-filter: blur(8px);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 16px;
                max-width: 600px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease;
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #f3f4f6;">
                        <div style="background: linear-gradient(135deg, #ef4444, #dc2626); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            <i class="fas fa-wifi"></i>
                        </div>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 24px;">Network Connectivity Issue</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 16px;">${troubleshooting.issue}</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #ef4444; margin-bottom: 15px; font-size: 18px;">
                            <i class="fas fa-exclamation-triangle"></i> Error Details
                        </h3>
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 15px; border-radius: 8px; font-family: monospace; font-size: 14px; color: #dc2626;">
                            ${errorMessage}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #f59e0b; margin-bottom: 15px; font-size: 18px;">
                            <i class="fas fa-search"></i> Possible Causes
                        </h3>
                        <ul style="margin: 0; padding-left: 20px; color: #374151;">
                            ${troubleshooting.possible_causes.map(cause => `<li style="margin-bottom: 8px;">${cause}</li>`).join('')}
                        </ul>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #10b981; margin-bottom: 15px; font-size: 18px;">
                            <i class="fas fa-tools"></i> Solutions to Try
                        </h3>
                        <ol style="margin: 0; padding-left: 20px; color: #374151;">
                            ${troubleshooting.solutions.map(solution => `<li style="margin-bottom: 8px;">${solution}</li>`).join('')}
                        </ol>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(147, 197, 253, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(59, 130, 246, 0.2);">
                        <h4 style="color: #3b82f6; margin: 0 0 15px 0; font-size: 16px;">
                            <i class="fas fa-lightbulb"></i> Quick Network Test
                        </h4>
                        <p style="margin: 0 0 15px 0; color: #374151; font-size: 14px;">Test your internet connectivity before trying again:</p>
                        <button onclick="testNetworkConnectivity()" style="
                            background: linear-gradient(135deg, #3b82f6, #2563eb);
                            color: white;
                            border: none;
                            padding: 12px 20px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            display: flex;
                            align-items: center;
                            gap: 8px;
                            font-size: 14px;
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(59, 130, 246, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='none'">
                            <i class="fas fa-globe"></i>
                            Test Internet Connection
                        </button>
                        <div id="network-test-result" style="margin-top: 15px;"></div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button onclick="closeTroubleshootingModal()" style="
                            background: #f3f4f6;
                            color: #374151;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            Close
                        </button>
                        <button onclick="retryEmailTest()" style="
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                            <i class="fas fa-redo"></i>
                            Try Again
                        </button>
                    </div>
                </div>
            `;
            
            // Add animation styles
            const style = document.createElement('style');
            style.textContent = `
                @keyframes modalSlideIn {
                    from {
                        opacity: 0;
                        transform: translateY(-50px) scale(0.9);
                    }
                    to {
                        opacity: 1;
                        transform: translateY(0) scale(1);
                    }
                }
            `;
            document.head.appendChild(style);
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeTroubleshootingModal();
                }
            });
            
            // Close on ESC key
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeTroubleshootingModal();
                    document.removeEventListener('keydown', escListener);
                }
            };
            document.addEventListener('keydown', escListener);
            
            console.log(' Troubleshooting modal displayed');
        }
        
        function closeTroubleshootingModal() {
            const modal = document.getElementById('troubleshooting-modal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        function retryEmailTest() {
            closeTroubleshootingModal();
            setTimeout(() => {
                testEmailConfiguration();
            }, 500);
        }
        
        // Test network connectivity
        async function testNetworkConnectivity() {
            const resultDiv = document.getElementById('network-test-result');
            const testBtn = event.target;
            
            // Show loading state
            testBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Testing...';
            testBtn.disabled = true;
            resultDiv.innerHTML = '<div style="color: #6b7280; font-size: 14px;"><i class="fas fa-circle-notch fa-spin"></i> Running connectivity tests...</div>';
            
            const tests = [
                { name: 'Google Public DNS', url: 'https://dns.google', service: 'DNS Resolution' },
                { name: 'Cloudflare', url: 'https://1.1.1.1', service: 'Internet Connectivity' },
                { name: 'Gmail SMTP', url: 'https://accounts.google.com', service: 'Google Services' }
            ];
            
            const results = [];
            
            for (const test of tests) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 5000); // 5 second timeout
                    
                    const response = await fetch(test.url, {
                        method: 'GET',
                        mode: 'no-cors', // Bypass CORS for testing
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    results.push({ ...test, status: 'success', message: 'Reachable' });
                } catch (error) {
                    if (error.name === 'AbortError') {
                        results.push({ ...test, status: 'timeout', message: 'Timeout (5s)' });
                    } else {
                        results.push({ ...test, status: 'error', message: 'Unreachable' });
                    }
                }
            }
            
            // Display results
            const successCount = results.filter(r => r.status === 'success').length;
            const overallStatus = successCount >= 2 ? 'good' : successCount >= 1 ? 'partial' : 'poor';
            
            const statusColors = {
                good: { bg: '#10b981', text: '#064e3b', icon: 'check-circle' },
                partial: { bg: '#f59e0b', text: '#92400e', icon: 'exclamation-triangle' },
                poor: { bg: '#ef4444', text: '#991b1b', icon: 'times-circle' }
            };
            
            const statusInfo = statusColors[overallStatus];
            
            resultDiv.innerHTML = `
                <div style="padding: 15px; background: rgba(${parseInt(statusInfo.bg.slice(1, 3), 16)}, ${parseInt(statusInfo.bg.slice(3, 5), 16)}, ${parseInt(statusInfo.bg.slice(5, 7), 16)}, 0.1); border-radius: 8px; border: 1px solid ${statusInfo.bg};">
                    <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 15px;">
                        <i class="fas fa-${statusInfo.icon}" style="color: ${statusInfo.bg}; font-size: 20px;"></i>
                        <div>
                            <strong style="color: ${statusInfo.text}; font-size: 16px;">
                                ${overallStatus === 'good' ? 'Good Connectivity' : overallStatus === 'partial' ? 'Partial Connectivity' : 'Poor Connectivity'}
                            </strong>
                            <div style="color: ${statusInfo.text}; font-size: 14px; opacity: 0.8;">
                                ${successCount}/${tests.length} services reachable
                            </div>
                        </div>
                    </div>
                    <div style="display: grid; gap: 8px;">
                        ${results.map(result => {
                            const color = result.status === 'success' ? '#10b981' : result.status === 'timeout' ? '#f59e0b' : '#ef4444';
                            const icon = result.status === 'success' ? 'check' : result.status === 'timeout' ? 'clock' : 'times';
                            return `
                                <div style="display: flex; justify-content: space-between; align-items: center; padding: 8px 12px; background: rgba(255, 255, 255, 0.5); border-radius: 6px;">
                                    <span style="font-size: 14px; color: #374151;">${result.name}</span>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-${icon}" style="color: ${color}; font-size: 12px;"></i>
                                        <span style="font-size: 12px; color: ${color}; font-weight: 600;">${result.message}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                    ${overallStatus !== 'good' ? `
                        <div style="margin-top: 15px; padding: 12px; background: rgba(239, 68, 68, 0.1); border-radius: 6px; font-size: 13px; color: #dc2626;">
                            <i class="fas fa-info-circle"></i>
                            ${overallStatus === 'partial' ? 
                                'Limited connectivity detected. Email sending may work but could be unreliable.' : 
                                'No connectivity detected. Please check your internet connection and try again.'
                            }
                        </div>
                    ` : ''}
                </div>
            `;
            
            // Reset button
            testBtn.innerHTML = '<i class="fas fa-globe"></i> Test Internet Connection';
            testBtn.disabled = false;
            
            console.log(' Network connectivity test completed:', results);
        }
        
        // Standalone network test function
        async function testNetworkOnly() {
            // Show a simplified network test modal
            const modal = document.createElement('div');
            modal.id = 'network-test-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
                backdrop-filter: blur(8px);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 16px;
                max-width: 500px;
                width: 90%;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease;
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #f3f4f6;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            <i class="fas fa-wifi"></i>
                        </div>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 24px;">Network Connectivity Test</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 16px;">Testing internet connection and SMTP accessibility</p>
                        </div>
                    </div>
                    
                    <div id="network-test-content">
                        <div style="text-align: center; padding: 40px 20px;">
                            <i class="fas fa-circle-notch fa-spin" style="font-size: 48px; color: #3b82f6; margin-bottom: 20px;"></i>
                            <h3 style="color: #374151; margin: 0 0 10px 0;">Running Network Tests...</h3>
                            <p style="color: #6b7280; margin: 0; font-size: 14px;">Testing connectivity to email servers</p>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end; margin-top: 25px;">
                        <button onclick="closeNetworkTestModal()" style="
                            background: #f3f4f6;
                            color: #374151;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            Close
                        </button>
                    </div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeNetworkTestModal();
                }
            });
            
            // Run the actual network test
            await runSimpleNetworkTest();
        }
        
        function closeNetworkTestModal() {
            const modal = document.getElementById('network-test-modal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        async function runSimpleNetworkTest() {
            const contentDiv = document.getElementById('network-test-content');
            
            const tests = [
                { name: 'Internet Connectivity', url: 'https://1.1.1.1', icon: 'globe' },
                { name: 'Google Services', url: 'https://accounts.google.com', icon: 'envelope' },
                { name: 'Microsoft Services', url: 'https://outlook.live.com', icon: 'envelope-open' },
                { name: 'DNS Resolution', url: 'https://dns.google', icon: 'server' }
            ];
            
            const results = [];
            
            // Test each service
            for (const test of tests) {
                try {
                    const controller = new AbortController();
                    const timeoutId = setTimeout(() => controller.abort(), 4000);
                    
                    await fetch(test.url, {
                        method: 'GET',
                        mode: 'no-cors',
                        signal: controller.signal
                    });
                    
                    clearTimeout(timeoutId);
                    results.push({ ...test, status: 'success' });
                } catch (error) {
                    results.push({ ...test, status: 'failed' });
                }
            }
            
            // Calculate overall status
            const successCount = results.filter(r => r.status === 'success').length;
            const overallStatus = successCount >= 3 ? 'excellent' : successCount >= 2 ? 'good' : successCount >= 1 ? 'limited' : 'poor';
            
            const statusConfig = {
                excellent: { color: '#10b981', icon: 'check-circle', title: 'Excellent Connectivity', message: 'All services are reachable. Email sending should work perfectly.' },
                good: { color: '#059669', icon: 'check-circle', title: 'Good Connectivity', message: 'Most services are reachable. Email sending should work well.' },
                limited: { color: '#f59e0b', icon: 'exclamation-triangle', title: 'Limited Connectivity', message: 'Some connectivity issues detected. Email sending may be unreliable.' },
                poor: { color: '#ef4444', icon: 'times-circle', title: 'Poor Connectivity', message: 'Significant connectivity issues. Email sending will likely fail.' }
            };
            
            const config = statusConfig[overallStatus];
            
            // Display results
            contentDiv.innerHTML = `
                <div style="text-align: center; margin-bottom: 25px;">
                    <div style="display: inline-flex; align-items: center; justify-content: center; width: 80px; height: 80px; background: ${config.color}; border-radius: 50%; margin-bottom: 20px;">
                        <i class="fas fa-${config.icon}" style="color: white; font-size: 32px;"></i>
                    </div>
                    <h3 style="color: ${config.color}; margin: 0 0 10px 0; font-size: 22px;">${config.title}</h3>
                    <p style="color: #6b7280; margin: 0; font-size: 14px; line-height: 1.5;">${config.message}</p>
                </div>
                
                <div style="background: #f8f9fa; border-radius: 12px; padding: 20px; margin-bottom: 20px;">
                    <h4 style="color: #374151; margin: 0 0 15px 0; font-size: 16px;">
                        <i class="fas fa-list-check"></i> Service Connectivity Results
                    </h4>
                    <div style="display: grid; gap: 10px;">
                        ${results.map(result => {
                            const statusColor = result.status === 'success' ? '#10b981' : '#ef4444';
                            const statusIcon = result.status === 'success' ? 'check' : 'times';
                            const statusText = result.status === 'success' ? 'Connected' : 'Failed';
                            
                            return `
                                <div style="display: flex; align-items: center; justify-content: space-between; padding: 12px 16px; background: white; border-radius: 8px; box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);">
                                    <div style="display: flex; align-items: center; gap: 12px;">
                                        <i class="fas fa-${result.icon}" style="color: #6b7280; font-size: 16px; width: 20px;"></i>
                                        <span style="color: #374151; font-weight: 500;">${result.name}</span>
                                    </div>
                                    <div style="display: flex; align-items: center; gap: 6px;">
                                        <i class="fas fa-${statusIcon}" style="color: ${statusColor}; font-size: 14px;"></i>
                                        <span style="color: ${statusColor}; font-weight: 600; font-size: 14px;">${statusText}</span>
                                    </div>
                                </div>
                            `;
                        }).join('')}
                    </div>
                </div>
                
                ${overallStatus === 'poor' || overallStatus === 'limited' ? `
                    <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                        <div style="display: flex; align-items: start; gap: 10px;">
                            <i class="fas fa-info-circle" style="color: #ef4444; margin-top: 2px;"></i>
                            <div>
                                <strong style="color: #dc2626; font-size: 14px;">Network Issue Detected</strong>
                                <p style="color: #dc2626; font-size: 13px; margin: 5px 0 0 0; line-height: 1.4;">
                                    ${overallStatus === 'poor' ? 
                                        'Multiple connectivity failures detected. Check your internet connection, firewall settings, or try a different network.' :
                                        'Some services are unreachable. Email sending may work but could be unreliable. Consider checking your network settings.'
                                    }
                                </p>
                            </div>
                        </div>
                    </div>
                ` : ''}
                
                <div style="text-align: center;">
                    <p style="color: #6b7280; font-size: 13px; margin: 0;">
                        Tested: ${new Date().toLocaleString()}  ${successCount}/${tests.length} services reachable
                    </p>
                </div>
            `;
            
            console.log(' Network test completed:', {
                overall: overallStatus,
                successCount,
                totalTests: tests.length,
                results
            });
        }
        
        // Show email provider guidance modal
        function showEmailProviderGuidance(errorData) {
            // Remove existing provider guidance modal if any
            const existingModal = document.getElementById('provider-guidance-modal');
            if (existingModal) {
                existingModal.remove();
            }
            
            const modal = document.createElement('div');
            modal.id = 'provider-guidance-modal';
            modal.style.cssText = `
                position: fixed;
                top: 0;
                left: 0;
                width: 100%;
                height: 100%;
                background: rgba(0, 0, 0, 0.6);
                display: flex;
                justify-content: center;
                align-items: center;
                z-index: 10001;
                backdrop-filter: blur(8px);
            `;
            
            const modalContent = document.createElement('div');
            modalContent.style.cssText = `
                background: white;
                border-radius: 16px;
                max-width: 650px;
                width: 90%;
                max-height: 80vh;
                overflow-y: auto;
                box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
                animation: modalSlideIn 0.3s ease;
            `;
            
            modalContent.innerHTML = `
                <div style="padding: 30px;">
                    <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 25px; padding-bottom: 20px; border-bottom: 2px solid #f3f4f6;">
                        <div style="background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 24px;">
                            <i class="fas fa-envelope-open"></i>
                        </div>
                        <div>
                            <h2 style="margin: 0; color: #1f2937; font-size: 24px;">Email Provider Setup</h2>
                            <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 16px;">Choose a supported email provider for MonuMe</p>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 25px;">
                        <h3 style="color: #ef4444; margin-bottom: 15px; font-size: 18px;">
                            <i class="fas fa-exclamation-triangle"></i> Current Issue
                        </h3>
                        <div style="background: rgba(239, 68, 68, 0.1); border: 1px solid rgba(239, 68, 68, 0.2); padding: 15px; border-radius: 8px; font-size: 14px; color: #dc2626;">
                            ${errorData.error}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <h3 style="color: #10b981; margin-bottom: 20px; font-size: 18px;">
                            <i class="fas fa-check-circle"></i> Supported Email Providers
                        </h3>
                        <div style="display: grid; gap: 15px;">
                            <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='#3b82f6'; this.style.background='rgba(59, 130, 246, 0.05)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                    <div style="background: #ea4335; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                        <i class="fab fa-google"></i>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #1f2937; font-size: 18px;">Gmail</h4>
                                        <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">Most reliable  Easy setup</p>
                                    </div>
                                </div>
                                <ul style="margin: 10px 0 0 20px; color: #374151; font-size: 14px;">
                                    <li>Create account at gmail.com</li>
                                    <li>Enable 2-Step Verification</li>
                                    <li>Generate App Password for MonuMe</li>
                                    <li>Example: yourname@gmail.com</li>
                                </ul>
                            </div>
                            
                            <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='#0078d4'; this.style.background='rgba(0, 120, 212, 0.05)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                    <div style="background: #0078d4; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                        <i class="fab fa-microsoft"></i>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #1f2937; font-size: 18px;">Outlook / Hotmail</h4>
                                        <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">Microsoft email service</p>
                                    </div>
                                </div>
                                <ul style="margin: 10px 0 0 20px; color: #374151; font-size: 14px;">
                                    <li>Create account at outlook.com</li>
                                    <li>Enable 2-Step Verification</li>
                                    <li>Generate App Password for MonuMe</li>
                                    <li>Example: yourname@outlook.com</li>
                                </ul>
                            </div>
                            
                            <div style="border: 2px solid #e5e7eb; border-radius: 12px; padding: 20px; transition: all 0.3s ease; cursor: pointer;" onmouseover="this.style.borderColor='#5f01d1'; this.style.background='rgba(95, 1, 209, 0.05)'" onmouseout="this.style.borderColor='#e5e7eb'; this.style.background='white'">
                                <div style="display: flex; align-items: center; gap: 15px; margin-bottom: 10px;">
                                    <div style="background: #5f01d1; color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 20px;">
                                        <i class="fab fa-yahoo"></i>
                                    </div>
                                    <div>
                                        <h4 style="margin: 0; color: #1f2937; font-size: 18px;">Yahoo Mail</h4>
                                        <p style="margin: 5px 0 0 0; color: #6b7280; font-size: 14px;">Alternative email provider</p>
                                    </div>
                                </div>
                                <ul style="margin: 10px 0 0 20px; color: #374151; font-size: 14px;">
                                    <li>Create account at yahoo.com</li>
                                    <li>Enable 2-Step Verification</li>
                                    <li>Generate App Password for MonuMe</li>
                                    <li>Example: yourname@yahoo.com</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1), rgba(5, 150, 105, 0.1)); padding: 20px; border-radius: 12px; margin-bottom: 25px; border: 1px solid rgba(16, 185, 129, 0.2);">
                        <h4 style="color: #10b981; margin: 0 0 15px 0; font-size: 16px;">
                            <i class="fas fa-star"></i> Recommendation
                        </h4>
                        <p style="margin: 0; color: #059669; font-size: 14px; line-height: 1.5;">
                            <strong>Gmail is recommended</strong> for MonuMe email sending as it has the most reliable SMTP service and easiest App Password setup process.
                        </p>
                    </div>
                    
                    ${errorData.example ? `
                        <div style="background: rgba(59, 130, 246, 0.1); padding: 15px; border-radius: 8px; margin-bottom: 25px; border: 1px solid rgba(59, 130, 246, 0.2);">
                            <h4 style="color: #3b82f6; margin: 0 0 10px 0; font-size: 14px;">
                                <i class="fas fa-lightbulb"></i> Examples of Valid Email Addresses:
                            </h4>
                            <p style="margin: 0; color: #1e40af; font-size: 13px; font-family: monospace;">
                                ${errorData.example}
                            </p>
                        </div>
                    ` : ''}
                    
                    <div style="display: flex; gap: 15px; justify-content: flex-end;">
                        <button onclick="closeProviderGuidanceModal()" style="
                            background: #f3f4f6;
                            color: #374151;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                        " onmouseover="this.style.background='#e5e7eb'" onmouseout="this.style.background='#f3f4f6'">
                            Close
                        </button>
                        <button onclick="openEmailSetupHelp()" style="
                            background: linear-gradient(135deg, #10b981, #059669);
                            color: white;
                            border: none;
                            padding: 12px 24px;
                            border-radius: 8px;
                            font-weight: 600;
                            cursor: pointer;
                            transition: all 0.3s ease;
                            box-shadow: 0 4px 12px rgba(16, 185, 129, 0.3);
                        " onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 8px 20px rgba(16, 185, 129, 0.4)'" onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 12px rgba(16, 185, 129, 0.3)'">
                            <i class="fas fa-question-circle"></i>
                            App Password Setup
                        </button>
                    </div>
                </div>
            `;
            
            modal.appendChild(modalContent);
            document.body.appendChild(modal);
            
            // Close on background click
            modal.addEventListener('click', function(e) {
                if (e.target === modal) {
                    closeProviderGuidanceModal();
                }
            });
            
            // Close on ESC key
            const escListener = function(e) {
                if (e.key === 'Escape') {
                    closeProviderGuidanceModal();
                    document.removeEventListener('keydown', escListener);
                }
            };
            document.addEventListener('keydown', escListener);
            
            console.log(' Email provider guidance modal displayed');
        }
        
        function closeProviderGuidanceModal() {
            const modal = document.getElementById('provider-guidance-modal');
            if (modal) {
                modal.style.opacity = '0';
                setTimeout(() => {
                    if (modal.parentNode) {
                        modal.remove();
                    }
                }, 300);
            }
        }
        
        // Load email configuration on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Load saved email configuration
            loadEmailConfiguration();
            
            // Update email functions to use configured sender
            setTimeout(() => {
                updateEmailSenderFunctions();
            }, 1000);
            
            // Set default date for appointment test
            const dateInput = document.getElementById('test-appointment-date');
            if (dateInput) {
                const today = new Date();
                const tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                dateInput.value = tomorrow.toISOString().split('T')[0];
            }
        });
         
     </script>
 </body>
 </html>
